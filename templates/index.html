<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Receiver - v{{ version }}</title>
    <!-- Quill.js Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            color: #000000;
            background-color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .left-menu {
            width: 60px;
            background-color: #ffffff;
            border-right: 2px solid #000000;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: width 0.2s ease;
            overflow: hidden;
        }

        .left-menu:hover {
            width: 220px;
        }

        .menu-button {
            width: 100%;
            padding: 15px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-family: Arial, sans-serif;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
        }

        .menu-button:hover {
            background-color: #f0f0f0;
        }

        .menu-button.active {
            background-color: #000000;
            color: #ffffff;
        }

        .right-content {
            flex: 1;
            background-color: #ffffff;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-overlay-content {
            text-align: center;
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
        }

        .loading-spinner {
            border: 3px solid #f0f0f0;
            border-top: 3px solid #000000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .content-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000000;
        }

        .content-header h2 {
            font-family: Arial, sans-serif;
            font-size: 24px;
            color: #000000;
            margin-bottom: 5px;
        }

        .version-info {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #000000;
        }

        .email-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .email-item {
            border: 1px solid #000000;
            background-color: #ffffff;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: stretch;
            overflow: hidden;
        }

        .email-item:hover {
            background-color: #f0f0f0;
        }

        .email-content {
            flex: 1 1 auto;
            min-width: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: hidden;
        }

        .email-actions {
            flex: 0 0 80px;
            border-left: 1px solid #000000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background-color: #ffffff;
        }

        .email-action-button {
            width: 100%;
            padding: 8px;
            font-size: 12px;
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .email-subject {
            font-family: Arial, sans-serif;
            font-size: 18px;
            font-weight: bold;
            color: #000000;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .email-sequence-inline {
            font-family: Arial, sans-serif;
            font-size: 14px;
            font-weight: normal;
            margin-left: 10px;
        }

        .email-date {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #000000;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .email-from {
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .email-preview {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #000000;
            margin-top: 10px;
            overflow: hidden;
            word-break: break-word;
            overflow-wrap: anywhere;
            display: -webkit-box;
            line-clamp: 3;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .email-attachments {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .task-attachment-entry {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 6px;
        }

        .task-attachment-display {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px;
            border: 1px solid #000000;
            margin-bottom: 10px;
            background-color: #ffffff;
        }

        .task-attachment-info {
            flex: 1;
        }

        .task-attachment-actions {
            display: flex;
            gap: 8px;
            margin-left: 10px;
        }

        .task-display-item {
            font-family: Arial, sans-serif;
        }

        #task-form-dropzone {
            cursor: pointer;
        }

        #task-form-dropzone:hover {
            background-color: #f0f0f0;
        }

        .attachment-view-link {
            text-decoration: underline;
            color: #0066cc;
            cursor: pointer;
        }

        .attachment-view-link:hover {
            color: #004a99;
        }

        .attachment-download-link {
            text-decoration: none;
            font-size: 16px;
        }

        .attachment-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border: 1px solid #000000;
            border-radius: 16px;
            font-size: 12px;
            text-decoration: none;
            color: #000000;
            background-color: #ffffff;
        }

        .attachment-chip:hover {
            background-color: #f0f0f0;
        }

        .attachment-button {
            font-size: 12px;
            margin-bottom: 8px;
        }

        .attachment-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .attachment-row {
            border: 1px solid #000000;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .attachment-row-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .attachment-filename {
            word-break: break-all;
            overflow-wrap: anywhere;
        }

        .attachment-size {
            font-size: 11px;
        }

        .task-attachment-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border: 1px solid #000000;
            margin-right: 10px;
            background-color: #ffffff;
        }

        .task-type-row {
            cursor: move;
        }

        .task-type-row.drag-over {
            background-color: #f0f0f0;
        }

        .task-type-handle {
            width: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            user-select: none;
            color: #000000;
        }

        .task-type-handle-icon {
            font-size: 16px;
            line-height: 1;
            margin-bottom: 4px;
        }

        .task-type-seq {
            font-size: 12px;
        }

        .autocomplete-wrapper {
            position: relative;
            width: 100%;
            display: flex;
            align-items: stretch;
        }

        .autocomplete-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #000000;
            border-right: none;
            background-color: #ffffff;
            color: #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }

        .autocomplete-dropdown-btn {
            width: 30px;
            padding: 8px;
            border: 1px solid #000000;
            background-color: #ffffff;
            color: #000000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            user-select: none;
        }

        .autocomplete-dropdown-btn:hover {
            background-color: #f0f0f0;
        }

        .autocomplete-dropdown-btn::after {
            content: '▼';
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border: 1px solid #000000;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.highlighted {
            background-color: #f0f0f0;
        }

        .autocomplete-item-name {
            font-weight: bold;
        }

        .autocomplete-item-email {
            font-size: 12px;
            color: #666666;
            margin-top: 2px;
        }

        .preview-modal-content {
            width: 100%;
            height: 100%;
            display: flex;
            position: relative;
        }

        .preview-modal-content img {
            max-width: none;
            max-height: none;
            height: auto;
            width: auto;
            object-fit: contain;
            cursor: grab;
            user-select: none;
            -webkit-user-drag: none;
            transition: transform 0.1s ease-out;
            display: block;
            margin: auto;
        }

        .preview-modal-content img:active {
            cursor: grabbing;
        }

        .preview-modal-content img.dragging {
            cursor: grabbing;
        }

        .preview-modal-content object,
        .preview-modal-content embed {
            width: 100%;
            height: 100%;
            min-height: 100%;
            border: none;
            display: block;
        }

        .preview-modal-content iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .preview-modal-content object {
            min-width: 100%;
        }

        .attachment-actions {
            display: flex;
            gap: 8px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
        }

        .error {
            padding: 15px;
            border: 2px solid #000000;
            background-color: #ffffff;
            color: #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .qq-login-form {
            border: 1px solid #000000;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        .qq-login-form h3 {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .customer-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 15px 20px;
        }

        .customer-form-grid .form-group-full {
            grid-column: 1 / -1;
        }

        .customer-form-grid .form-group-rich {
            display: flex;
            flex-direction: column;
        }

        .customer-form-grid .form-group-rich #customer-remark {
            flex: 1;
        }

        .customer-contacts-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .customer-contacts-row .contact-input {
            flex: 1;
            min-width: 140px;
        }

        .customer-contacts-row .contact-row-add-btn,
        .customer-contacts-row .contact-row-remove-btn {
            padding: 6px 10px;
            font-size: 14px;
            line-height: 1;
            border: 1px solid #000000;
            background-color: #ffffff;
            cursor: pointer;
            min-width: 32px;
        }

        .customer-contacts-row .contact-row-remove-btn {
            background-color: #dc3545;
            color: #ffffff;
        }

        .customer-contacts-row .contact-row-add-btn:hover,
        .customer-contacts-row .contact-row-remove-btn:hover {
            background-color: #000000;
            color: #ffffff;
        }

        /* Ensure Create Customer area is clean white with even spacing */
        #create-customer-content .settings-section {
            background-color: #ffffff;
        }

        .form-group label {
            display: block;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #000000;
            background-color: #ffffff;
            color: #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }

        .form-button {
            padding: 10px 20px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            cursor: pointer;
        }

        .form-button:hover {
            background-color: #f0f0f0;
        }

        .hidden {
            display: none;
        }

        .settings-section {
            border: 1px solid #000000;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        .profile-list-view {
            border: 1px solid #000000;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        .profile-list-view h3 {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
            margin-bottom: 15px;
            border-bottom: 1px solid #000000;
            padding-bottom: 10px;
        }

        .profile-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-controls input[type="text"] {
            padding: 10px;
            border: 1px solid #000000;
            background-color: #ffffff;
            color: #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            flex: 1;
        }

        .profile-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .profile-item {
            border: 1px solid #000000;
            padding: 15px;
            background-color: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-item.active {
            background-color: #f0f0f0;
        }

        .profile-item-name {
            font-family: Arial, sans-serif;
            font-size: 16px;
            color: #000000;
        }

        .profile-detail-view {
            border: 1px solid #000000;
            padding: 20px;
            background-color: #ffffff;
        }

        .profile-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-button {
            padding: 10px 20px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            cursor: pointer;
        }

        .back-button:hover {
            background-color: #f0f0f0;
        }

        .profile-detail-title {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
        }

        .profile-detail-actions {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .form-button.danger {
            border-color: #000000;
            color: #000000;
        }

        .message {
            margin-top: 10px;
            padding: 12px;
            border: 1px solid #000000;
            background-color: #f5f5f5;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
        .message.error {
            background-color: #f5dada;
        }
        .message.success {
            background-color: #d8f5d8;
        }
        .message.info {
            background-color: #e8e8e8;
        }

        /* Collapsed vs expanded labels */
        .label-short {
            font-weight: bold;
            width: 24px;
            min-width: 24px;
            text-align: center;
        }
        .label-full {
            white-space: nowrap;
        }
        .left-menu .label-full {
            display: none;
        }
        .left-menu:hover .label-full {
            display: inline;
        }
        .left-menu:hover .menu-button {
            justify-content: flex-start;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.4);
            padding: 40px;
            z-index: 1000;
        }

        #preview-modal {
            z-index: 2000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-dialog {
            width: 80vw;
            max-width: 1000px;
            max-height: 90vh;
            background-color: #ffffff;
            border: 2px solid #000000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #email-modal .modal-dialog {
            width: 80vw;
            height: 80vh;
            max-width: none;
            max-height: 80vh;
        }

        .preview-modal-dialog {
            width: 95vw;
            max-width: 95vw;
            height: 95vh;
            max-height: 95vh;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 2px solid #000000;
        }

        .modal-title {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
        }

        .modal-meta {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #000000;
            margin-top: 5px;
            white-space: pre-line;
        }

        .modal-close {
            padding: 8px 16px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            cursor: pointer;
        }

        .modal-close:hover {
            background-color: #f0f0f0;
        }

        .modal-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
        }

        #email-modal .modal-body {
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            min-height: 0;
        }

        .modal-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background-color: #ffffff;
        }

        #email-modal .modal-iframe {
            width: 100%;
            min-height: 100%;
            height: auto;
            display: block;
            border: none;
        }
        
        /* Ensure iframe content inside is scrollable */
        #email-modal-frame {
            overflow: visible;
        }
        
        /* Style for content inside iframe */
        #email-modal-frame body {
            margin: 0;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .task-modal-body {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
        }

        .task-template-cell {
            max-width: 300px;
            max-height: 150px;
            overflow: auto;
            white-space: normal;
        }

        .task-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: flex-start;
        }

        .task-editing-row {
            background-color: #fff7e6;
        }

        .task-editing-row input,
        .task-editing-row select,
        .task-editing-row textarea {
            width: 100%;
            box-sizing: border-box;
            font-size: 12px;
            border: 1px solid #000000;
            padding: 6px;
            border-radius: 3px;
        }

        .task-editing-row textarea {
            min-height: 120px;
            resize: vertical;
        }

        .task-modal-body textarea {
            flex: 1;
            width: 100%;
            border: 1px solid #000000;
            padding: 10px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            background-color: #ffffff;
        }

        .task-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .task-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        .email-compose {
            border: 1px solid #000000;
            padding: 20px;
            background-color: #ffffff;
            margin-bottom: 25px;
        }

        .email-compose h3 {
            font-family: Arial, sans-serif;
            font-size: 18px;
            margin-bottom: 15px;
            color: #000000;
        }

        .compose-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .compose-grid .form-group {
            flex: 1;
            min-width: 200px;
        }

        .email-compose textarea {
            width: 100%;
            min-height: 160px;
            border: 1px solid #000000;
            padding: 10px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
            background-color: #ffffff;
            margin-top: 10px;
        }

        .compose-options {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .compose-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .customer-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            position: relative;
        }
        
        .customer-table tbody {
            position: relative;
        }

        .customer-table th,
        .customer-table td {
            border: 1px solid #000000;
            padding: 10px;
            text-align: left;
            font-family: Arial, sans-serif;
            font-size: 14px;
            position: relative;
            overflow: visible;
        }

        .customer-table th {
            background-color: #f0f0f0;
        }

        .customer-filter-input {
            width: 100%;
            box-sizing: border-box;
            padding: 3px 4px;
            font-size: 12px;
        }

        /* Sticky header + filter row for task list */
        .task-table thead th {
            position: sticky;
            z-index: 2;
        }

        .task-table thead tr:nth-child(1) th {
            top: 0;
            background-color: #f0f0f0;
        }

        .task-table thead tr:nth-child(2) th {
            top: 40px; /* height of first header row */
            background-color: #ffffff;
        }

        #customer-remark.empty:before {
            content: attr(data-placeholder);
            color: #999;
            pointer-events: none;
        }

        #customer-remark:focus {
            outline: 2px solid #000000;
        }

        .customer-table td a {
            color: #0066cc;
            text-decoration: underline;
        }

        .customer-table td a:hover {
            color: #004499;
        }

        .country-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border: 1px solid #000000;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .country-dropdown-item {
            padding: 8px 10px;
            cursor: pointer;
            font-family: Arial, sans-serif;
            font-size: 14px;
            border-bottom: 1px solid #eee;
        }

        .country-dropdown-item:hover {
            background-color: #f0f0f0;
        }

        .country-dropdown-item.selected {
            background-color: #e0e0e0;
        }

        .attachment-drop-area {
            border: 2px dashed #000000;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background-color: #f9f9f9;
            transition: background-color 0.3s, border-color 0.3s;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .attachment-drop-area:hover {
            background-color: #f0f0f0;
        }

        .attachment-drop-area.drag-over {
            background-color: #e8f4f8;
            border-color: #0066cc;
        }

        .input-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 1px rgba(220, 53, 69, 0.3);
        }

        .attachment-drop-content {
            pointer-events: none;
        }

        .attachment-list {
            margin-top: 10px;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 12px;
        }

        .attachment-item-name {
            flex: 1;
            margin-right: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .attachment-item-size {
            color: #666;
            margin-right: 10px;
        }

        .attachment-item-remove {
            cursor: pointer;
            color: #cc0000;
            font-weight: bold;
            padding: 2px 6px;
        }

        .attachment-item-remove:hover {
            background-color: #ffcccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-menu">
            <button class="menu-button active" onclick="showReceiveMail()">
                <span class="label-short">R</span>
                <span class="label-full">Receive Mail</span>
            </button>
            <button class="menu-button" onclick="showSend()">
                <span class="label-short">S</span>
                <span class="label-full">Send</span>
            </button>
            <button class="menu-button" onclick="showCreateCustomer()">
                <span class="label-short">C</span>
                <span class="label-full">Create Customer</span>
            </button>
            <button class="menu-button" onclick="showTask()">
                <span class="label-short">T</span>
                <span class="label-full">Task</span>
            </button>
            <button class="menu-button" onclick="showTaskList()">
                <span class="label-short">TL</span>
                <span class="label-full">Task List</span>
            </button>
            <button class="menu-button" onclick="showDropdownList()">
                <span class="label-short">D</span>
                <span class="label-full">Dropdown List</span>
            </button>
            <button class="menu-button" onclick="showSettings()">
                <span class="label-short">S</span>
                <span class="label-full">Settings</span>
            </button>
        </div>
        <div class="right-content">
            <div class="loading-overlay" id="email-loading-overlay">
                <div class="loading-overlay-content">
                    <div class="loading-spinner"></div>
                    <div>Checking for new emails from web page...</div>
                </div>
            </div>
            <div class="content-header">
                <h2 id="content-title">Receive Mail</h2>
                <div class="version-info">Version: <span id="version">v{{ version }}</span></div>
            </div>
            <div id="receive-mail-content">
                <button class="form-button" onclick="fetchGmailEmails()" style="margin-bottom: 20px; margin-right: 10px;">Fetch Gmail</button>
                <button class="form-button" onclick="checkGmailStatus()" style="margin-bottom: 20px; margin-right: 10px; font-size: 12px;">Check Gmail Status</button>
                <button class="form-button" onclick="fetch163Emails()" style="margin-bottom: 20px; margin-right: 10px;">Fetch 163.com</button>
                <button class="form-button" onclick="fetchQQEmails()" style="margin-bottom: 20px;">Fetch QQ Email</button>
                <div id="error-message" class="message hidden"></div>
                <div id="email-list" class="email-list"></div>
            </div>
            <div id="create-customer-content" class="hidden">
                <div class="settings-section">
                    <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">Create Customer</h3>
                    <div class="customer-form-grid">
                        <!-- Row 1: Country | Company Name | Company Address -->
                        <div class="form-group">
                            <label for="customer-country">Country</label>
                            <div style="position: relative;">
                                <input type="text" id="customer-country" placeholder="Search or select country" autocomplete="off" oninput="filterCountries()" onfocus="showCountryDropdown()" onblur="setTimeout(() => hideCountryDropdown(), 200)">
                                <div id="country-dropdown" class="country-dropdown hidden"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="company-name">Company Name</label>
                            <input type="text" id="company-name" placeholder="Enter company name">
                        </div>
                        <div class="form-group">
                            <label for="company-address">Company Address</label>
                            <input type="text" id="company-address" placeholder="Enter company address">
                        </div>

                        <!-- Row 2: Customer Name | Title | Tel | Email (+) -->
                        <div class="form-group form-group-full">
                            <label>Customer Contacts</label>
                            <div id="customer-contacts-container">
                                <div class="customer-contacts-row" data-primary="true">
                                    <input type="text" id="customer-name" class="contact-input contact-name" placeholder="Customer name">
                                    <input type="text" id="customer-title" class="contact-input contact-title" placeholder="Title">
                                    <input type="tel" id="customer-tel" class="contact-input contact-tel" placeholder="Tel">
                                    <input type="email" id="customer-email-address" class="contact-input contact-email" placeholder="customer@example.com" pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}">
                                    <button type="button" class="contact-row-add-btn" onclick="addCustomerContactRow()" title="Add another customer">+</button>
                                </div>
                                <div id="customer-extra-contacts-container"></div>
                            </div>
                        </div>

                        <!-- Row 3: Web Site | Source (same line, divided evenly) -->
                        <div class="form-group">
                            <label for="customer-website">Web Site</label>
                            <input type="url" id="customer-website" placeholder="https://example.com">
                        </div>
                        <div class="form-group">
                            <label for="customer-source">Source</label>
                            <div style="position: relative;">
                                <input type="text" id="customer-source" placeholder="Search or select source" autocomplete="off" oninput="filterCustomerSources()" onfocus="showCustomerSourceDropdown()" onblur="setTimeout(() => hideCustomerSourceDropdown(), 200)">
                                <div id="customer-source-dropdown" class="country-dropdown hidden"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="customer-business-type">Business Type</label>
                            <div style="position: relative;">
                                <input type="text" id="customer-business-type" placeholder="Search or select business type" autocomplete="off" oninput="filterCustomerBusinessTypes()" onfocus="showCustomerBusinessTypeDropdown()" onblur="setTimeout(() => hideCustomerBusinessTypeDropdown(), 200)">
                                <div id="customer-business-type-dropdown" class="country-dropdown hidden"></div>
                            </div>
                        </div>

                        <!-- Row 4: Attachment (new line, full width) -->
                        <div class="form-group form-group-full">
                            <label>Attachment</label>
                            <div id="customer-attachment-dropzone" tabindex="0" style="border: 2px dashed #000000; padding: 20px; text-align: center; background-color: #f9f9f9; min-height: 100px; margin-bottom: 15px;">
                                <p style="margin: 0; color: #666;">Drag and drop files here, click the Browse button, or paste images (Ctrl+V)</p>
                                <button type="button" id="customer-attachment-browse-btn" class="form-button" style="margin-top: 12px; padding: 8px 20px;">Browse</button>
                                <input type="file" id="customer-attachment-file-input" multiple style="display: none;" onchange="handleCustomerAttachmentFileSelect(event)">
                            </div>
                            <div id="customer-attachment-list"></div>
                        </div>

                        <!-- Row 5: Remark (new line, full width) -->
                        <div class="form-group form-group-full form-group-rich">
                            <label for="customer-remark">Remark (Rich Text)</label>
                            <div id="customer-remark" contenteditable="true" style="min-height: 120px; border: 1px solid #000000; padding: 8px; font-family: Arial, sans-serif; font-size: 14px; background-color: #ffffff; color: #000000; overflow-y: auto;" data-placeholder="Enter remarks with HTML formatting..."></div>
                            <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                <button type="button" onclick="formatText('bold')" style="padding: 3px 8px; margin-right: 5px; font-size: 11px;">Bold</button>
                                <button type="button" onclick="formatText('italic')" style="padding: 3px 8px; margin-right: 5px; font-size: 11px;">Italic</button>
                                <button type="button" onclick="formatText('underline')" style="padding: 3px 8px; margin-right: 5px; font-size: 11px;">Underline</button>
                                <button type="button" onclick="formatText('insertUnorderedList')" style="padding: 3px 8px; margin-right: 5px; font-size: 11px;">List</button>
                            </div>
                        </div>
                    </div>
                    <div class="compose-actions">
                        <button class="form-button" onclick="saveCustomer()">Save Customer</button>
                        <div id="customer-status" class="message info hidden"></div>
                    </div>
                </div>
                <div id="customer-list-section" class="settings-section hidden">
                    <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">Customers</h3>
                    <table class="customer-table">
                        <thead>
                            <tr>
                                <th style="width: 12%;">Company Name</th>
                                <th style="width: 10%;">Name</th>
                                <th style="width: 12%;">Email Address</th>
                                <th style="width: 10%;">Tel</th>
                                <th style="width: 8%;">Country</th>
                                <th style="width: 10%;">Website</th>
                                <th style="width: 10%;">Source</th>
                                <th style="width: 10%;">Business Type</th>
                                <th style="width: 12%;">Remark</th>
                                <th style="width: 10%;">Attachments</th>
                                <th style="width: 10%;">Created At</th>
                                <th style="width: 6%;">Actions</th>
                            </tr>
                            <tr>
                                <th><input type="text" class="customer-filter-input" data-field="company_name" placeholder="Filter company"></th>
                                <th><input type="text" class="customer-filter-input" data-field="name" placeholder="Filter name"></th>
                                <th><input type="text" class="customer-filter-input" data-field="email_suffix" placeholder="Filter email"></th>
                                <th><input type="text" class="customer-filter-input" data-field="tel" placeholder="Filter tel"></th>
                                <th><input type="text" class="customer-filter-input" data-field="country" placeholder="Filter country"></th>
                                <th><input type="text" class="customer-filter-input" data-field="website" placeholder="Filter website"></th>
                                <th><input type="text" class="customer-filter-input" data-field="source" placeholder="Filter source"></th>
                                <th><input type="text" class="customer-filter-input" data-field="business_type" placeholder="Filter business type"></th>
                                <th><input type="text" class="customer-filter-input" data-field="remark" placeholder="Filter remark"></th>
                                <th><input type="text" class="customer-filter-input" data-field="attachments" placeholder="Filter attachments"></th>
                                <th><input type="text" class="customer-filter-input" data-field="created_at" placeholder="Filter created"></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="customer-table-body">
                        </tbody>
                    </table>
                    <div id="customer-empty" class="message info hidden">No customers yet. Add one above.</div>
                </div>
            </div>
            <div id="send-mail-content" class="hidden">
                <div class="email-compose">
                    <h3>Send Email (SMTP)</h3>
                    <div class="compose-grid">
                        <div class="form-group">
                            <label for="compose-to">To:</label>
                            <input type="text" id="compose-to" placeholder="recipient@example.com">
                        </div>
                        <div class="form-group">
                            <label for="compose-subject">Subject:</label>
                            <input type="text" id="compose-subject" placeholder="Subject line">
                        </div>
                        <div class="form-group">
                            <label for="compose-sender-name">Sender Name (optional):</label>
                            <input type="text" id="compose-sender-name" placeholder="Mail Task">
                        </div>
                    </div>
                    <textarea id="compose-body" placeholder="Write your email content here..."></textarea>
                    <div class="compose-options">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="compose-is-html">
                            <span>Send as HTML</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="use-primary-smtp" checked>
                            <span>Use Primary SMTP</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="use-backup-smtp" checked>
                            <span>Use Backup SMTP</span>
                        </label>
                    </div>
                    <div class="compose-actions">
                        <button class="form-button" onclick="sendEmail()">Send Email</button>
                        <div id="send-email-status" class="message info hidden"></div>
                    </div>
                </div>
            </div>
            <div id="task-content" class="hidden">
                <div id="task-display-container"></div>
            </div>
            <div id="task-list-content" class="hidden">
                <div id="task-list-container"></div>
            </div>
            <div id="dropdown-list-content" class="hidden">
                <div>
                    <h3 id="task-type-dropdown-header" style="margin-bottom: 15px; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;" onclick="toggleTaskTypeDropdown()">
                        <span id="task-type-dropdown-icon" style="display: inline-block; transition: transform 0.2s;">▶</span>
                        <span>Task - Type</span>
                    </h3>
                    <div id="task-type-dropdown-content" style="display: none;">
                        <div style="margin-bottom: 20px; position: relative;">
                            <input type="text" id="new-task-type-input" placeholder="Enter new task type name" style="width: 300px; padding: 8px; border: 1px solid #000000; margin-right: 10px;" onkeypress="if(event.key === 'Enter') addTaskType()" oninput="showTaskTypeSuggestions()" onfocus="showTaskTypeSuggestions()" onblur="setTimeout(() => hideTaskTypeSuggestions(), 200)">
                            <div id="task-type-suggestions" class="country-dropdown hidden" style="position: absolute; top: 100%; left: 0; width: 300px; z-index: 1000;"></div>
                            <button class="form-button" onclick="addTaskType()" style="padding: 8px 20px;">Add New Type</button>
                            <div id="task-type-duplicate-warning" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: none;"></div>
                        </div>
                        <div id="task-types-list" style="border: 1px solid #000000; padding: 15px; background-color: #ffffff;">
                            <div style="text-align: center; padding: 20px; color: #666;">Loading task types...</div>
                        </div>
                    </div>
                    <h3 id="country-dropdown-header" style="margin-bottom: 15px; margin-top: 30px; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;" onclick="toggleCountryDropdown()">
                        <span id="country-dropdown-icon" style="display: inline-block; transition: transform 0.2s;">▶</span>
                        <span>Create Customer - Country</span>
                    </h3>
                    <div id="country-dropdown-content" style="display: none;">
                        <div style="margin-bottom: 20px; position: relative;">
                            <input type="text" id="new-country-input" placeholder="Enter new country name" style="width: 300px; padding: 8px; border: 1px solid #000000; margin-right: 10px;" onkeypress="if(event.key === 'Enter') addCountry()" oninput="showCountrySuggestions()" onfocus="showCountrySuggestions()" onblur="setTimeout(() => hideCountrySuggestions(), 200)">
                            <div id="country-suggestions" class="country-dropdown hidden" style="position: absolute; top: 100%; left: 0; width: 300px; z-index: 1000;"></div>
                            <button class="form-button" onclick="addCountry()" style="padding: 8px 20px;">Add New Country</button>
                            <div id="country-duplicate-warning" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: none;"></div>
                        </div>
                        <div id="countries-list" style="border: 1px solid #000000; padding: 15px; background-color: #ffffff;">
                            <div style="text-align: center; padding: 20px; color: #666;">Loading countries...</div>
                        </div>
                    </div>
                    <h3 id="customer-source-dropdown-header" style="margin-bottom: 15px; margin-top: 30px; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;" onclick="toggleCustomerSourceDropdown()">
                        <span id="customer-source-dropdown-icon" style="display: inline-block; transition: transform 0.2s;">▶</span>
                        <span>Create Customer - Source</span>
                    </h3>
                    <div id="customer-source-dropdown-content" style="display: none;">
                        <div style="margin-bottom: 20px; position: relative;">
                            <input type="text" id="new-customer-source-input" placeholder="Enter new customer source name" style="width: 300px; padding: 8px; border: 1px solid #000000; margin-right: 10px;" onkeypress="if(event.key === 'Enter') addCustomerSource()" oninput="showCustomerSourceSuggestions()" onfocus="showCustomerSourceSuggestions()" onblur="setTimeout(() => hideCustomerSourceSuggestions(), 200)">
                            <div id="customer-source-suggestions" class="country-dropdown hidden" style="position: absolute; top: 100%; left: 0; width: 300px; z-index: 1000;"></div>
                            <button class="form-button" onclick="addCustomerSource()" style="padding: 8px 20px;">Add New Source</button>
                            <div id="customer-source-duplicate-warning" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: none;"></div>
                        </div>
                        <div id="customer-sources-list" style="border: 1px solid #000000; padding: 15px; background-color: #ffffff;">
                            <div style="text-align: center; padding: 20px; color: #666;">Loading customer sources...</div>
                        </div>
                    </div>
                    <h3 id="customer-business-type-dropdown-header" style="margin-bottom: 15px; margin-top: 30px; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;" onclick="toggleCustomerBusinessTypeDropdown()">
                        <span id="customer-business-type-dropdown-icon" style="display: inline-block; transition: transform 0.2s;">▶</span>
                        <span>Create Customers - Business Type</span>
                    </h3>
                    <div id="customer-business-type-dropdown-content" style="display: none;">
                        <div style="margin-bottom: 20px; position: relative;">
                            <input type="text" id="new-customer-business-type-input" placeholder="Enter new business type name" style="width: 300px; padding: 8px; border: 1px solid #000000; margin-right: 10px;" onkeypress="if(event.key === 'Enter') addCustomerBusinessType()" oninput="showCustomerBusinessTypeSuggestions()" onfocus="showCustomerBusinessTypeSuggestions()" onblur="setTimeout(() => hideCustomerBusinessTypeSuggestions(), 200)">
                            <div id="customer-business-type-suggestions" class="country-dropdown hidden" style="position: absolute; top: 100%; left: 0; width: 300px; z-index: 1000;"></div>
                            <button class="form-button" onclick="addCustomerBusinessType()" style="padding: 8px 20px;">Add New Business Type</button>
                            <div id="customer-business-type-duplicate-warning" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: none;"></div>
                        </div>
                        <div id="customer-business-types-list" style="border: 1px solid #000000; padding: 15px; background-color: #ffffff;">
                            <div style="text-align: center; padding: 20px; color: #666;">Loading customer business types...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="settings-content" class="hidden">
                <div id="profile-list-view" class="profile-list-view">
                    <h3>Profile Management</h3>
                    <div class="profile-controls">
                        <input type="text" id="new-profile-name" placeholder="New profile name">
                        <button class="form-button" onclick="createProfile()">Create Profile</button>
                    </div>
                    <div id="profile-list" class="profile-list"></div>
                </div>
                <div id="profile-detail-view" class="profile-detail-view hidden">
                    <div class="profile-detail-header">
                        <button class="back-button" onclick="showProfileList()">Back</button>
                        <div class="profile-detail-title">Profile: <span id="profile-name-display"></span></div>
                        <div style="width: 120px;"></div>
                    </div>
                    <div class="settings-section">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">Gmail Configuration</h3>
                        <div class="form-group">
                            <label for="gmail-imap-server">IMAP Server:</label>
                            <input type="text" id="gmail-imap-server" placeholder="imap.gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="gmail-port">Port:</label>
                            <input type="number" id="gmail-port" placeholder="993">
                        </div>
                        <div class="form-group">
                            <label for="gmail-username">Username:</label>
                            <input type="text" id="gmail-username" placeholder="your-email@gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="gmail-password">App Password:</label>
                            <input type="password" id="gmail-password" placeholder="Enter app password">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="gmail-use-ssl" checked>
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="gmail-use-tls">
                                <span>Use TLS</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top: 30px; background-color: #f9f9f9; padding: 20px; border: 2px solid #000000;">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">Gmail API OAuth 2.0 (Required for Fetching Emails)</h3>
                        
                        <div style="background-color: #e7f3ff; border: 2px solid #0066cc; padding: 20px; margin-bottom: 20px; font-family: Arial, sans-serif; font-size: 14px; border-radius: 4px;">
                            <h4 style="color: #0066cc; margin-top: 0; margin-bottom: 15px; font-size: 16px;">📖 Step-by-Step Guide to Get Gmail OAuth Credentials</h4>
                            
                            <div style="background-color: #ffffff; padding: 15px; margin-bottom: 15px; border: 1px solid #0066cc; border-radius: 4px;">
                                <strong style="color: #0066cc;">Step 1: Open Google Cloud Console</strong>
                                <p style="margin: 5px 0;">Click this button to open the credentials page:</p>
                                <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="display: inline-block; padding: 10px 20px; background-color: #0066cc; color: white; text-decoration: none; border-radius: 4px; margin-top: 10px; font-weight: bold;">🔗 Open Google Cloud Console</a>
                                <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">(This will open in a new tab. Keep this page open!)</p>
                            </div>

                            <div style="background-color: #ffffff; padding: 15px; margin-bottom: 15px; border: 1px solid #0066cc; border-radius: 4px;">
                                <strong style="color: #0066cc;">Step 2: Create a New Project (if you don't have one)</strong>
                                <ol style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                    <li>At the top of the page, click the project dropdown (next to "Google Cloud")</li>
                                    <li>Click <strong>"NEW PROJECT"</strong></li>
                                    <li>Enter project name: <code style="background: #f0f0f0; padding: 2px 5px;">Mail Task</code></li>
                                    <li>Click <strong>"CREATE"</strong></li>
                                    <li>Wait a few seconds, then select your new project from the dropdown</li>
                                </ol>
                            </div>

                            <div style="background-color: #ffffff; padding: 15px; margin-bottom: 15px; border: 1px solid #0066cc; border-radius: 4px;">
                                <strong style="color: #0066cc;">Step 3: Enable Gmail API</strong>
                                <ol style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                    <li>In the left menu, click <strong>"APIs & Services"</strong> → <strong>"Library"</strong></li>
                                    <li>Search for <strong>"Gmail API"</strong></li>
                                    <li>Click on <strong>"Gmail API"</strong></li>
                                    <li>Click the blue <strong>"ENABLE"</strong> button</li>
                                    <li>Wait for it to enable (takes a few seconds)</li>
                                </ol>
                            </div>

                            <div style="background-color: #ffffff; padding: 15px; margin-bottom: 15px; border: 1px solid #0066cc; border-radius: 4px;">
                                <strong style="color: #0066cc;">Step 4: Configure OAuth Consent Screen (First Time Only)</strong>
                                <ol style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                    <li>Go to <strong>"APIs & Services"</strong> → <strong>"OAuth consent screen"</strong> (in left menu)</li>
                                    <li>Select <strong>"External"</strong> → Click <strong>"CREATE"</strong></li>
                                    <li><strong>App name:</strong> Enter <code style="background: #f0f0f0; padding: 2px 5px;">Mail Task</code></li>
                                    <li><strong>User support email:</strong> Select your email</li>
                                    <li><strong>Developer contact:</strong> Enter your email</li>
                                    <li>Click <strong>"SAVE AND CONTINUE"</strong></li>
                                    <li>On "Scopes" page, click <strong>"SAVE AND CONTINUE"</strong> (no need to add scopes)</li>
                                    <li>On "Test users" page, click <strong>"+ ADD USERS"</strong></li>
                                    <li>Enter <strong>YOUR Gmail address</strong> (the one you want to fetch emails from)</li>
                                    <li>Click <strong>"ADD"</strong> → Click <strong>"SAVE AND CONTINUE"</strong></li>
                                    <li>Review and click <strong>"BACK TO DASHBOARD"</strong></li>
                                </ol>
                                <p style="margin: 10px 0 0 0; padding: 10px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; font-size: 12px;">
                                    <strong>⚠️ Important:</strong> You MUST add yourself as a test user, otherwise authentication will fail!
                                </p>
                            </div>

                            <div style="background-color: #ffffff; padding: 15px; margin-bottom: 15px; border: 1px solid #0066cc; border-radius: 4px;">
                                <strong style="color: #0066cc;">Step 5: Create OAuth Client ID</strong>
                                <ol style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                    <li>Go to <strong>"APIs & Services"</strong> → <strong>"Credentials"</strong> (in left menu)</li>
                                    <li>At the top, click <strong>"+ CREATE CREDENTIALS"</strong></li>
                                    <li>Select <strong>"OAuth client ID"</strong></li>
                                    <li>If you see "Application type", select <strong>"Web application"</strong></li>
                                    <li><strong>Name:</strong> Enter <code style="background: #f0f0f0; padding: 2px 5px;">Mail Task App</code></li>
                                    <li>Under <strong>"Authorized redirect URIs"</strong>, click <strong>"+ ADD URI"</strong></li>
                                    <li>Paste this exact URL: <code style="background: #f0f0f0; padding: 2px 5px; font-weight: bold;">http://localhost:5000/oauth2callback</code></li>
                                    <li>Click <strong>"CREATE"</strong></li>
                                </ol>
                            </div>

                            <div style="background-color: #ffffff; padding: 15px; margin-bottom: 15px; border: 1px solid #0066cc; border-radius: 4px;">
                                <strong style="color: #0066cc;">Step 6: Copy Your Credentials</strong>
                                <p style="margin: 5px 0;">After clicking "CREATE", a popup will appear with your credentials:</p>
                                <ol style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                    <li><strong>Client ID:</strong> A long string ending in <code style="background: #f0f0f0; padding: 2px 5px;">.apps.googleusercontent.com</code>
                                        <br><span style="color: #666; font-size: 12px;">Example: 123456789-abcdefghijklmnop.apps.googleusercontent.com</span></li>
                                    <li><strong>Client Secret:</strong> A shorter string starting with <code style="background: #f0f0f0; padding: 2px 5px;">GOCSPX-</code>
                                        <br><span style="color: #666; font-size: 12px;">Example: GOCSPX-abcdefghijklmnopqrstuvwxyz</span></li>
                                    <li>Click the <strong>copy icon</strong> next to each one, or select and copy manually</li>
                                    <li>Click <strong>"OK"</strong> to close the popup</li>
                                </ol>
                                <p style="margin: 10px 0 0 0; padding: 10px; background-color: #f8d7da; border: 1px solid #dc3545; border-radius: 4px; font-size: 12px;">
                                    <strong>⚠️ Important:</strong> You can only see the Client Secret ONCE! Copy it now or you'll need to create a new one.
                                </p>
                            </div>

                            <div style="background-color: #ffffff; padding: 15px; margin-bottom: 15px; border: 1px solid #0066cc; border-radius: 4px;">
                                <strong style="color: #0066cc;">Step 7: Paste Credentials Below</strong>
                                <p style="margin: 5px 0;">Now paste the Client ID and Client Secret into the fields below, then:</p>
                                <ol style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                    <li>Click <strong>"Save Profile"</strong> button (at the bottom of this page)</li>
                                    <li>Click <strong>"🔐 Authenticate Gmail"</strong> button</li>
                                    <li>A new window will open - sign in with your Gmail account</li>
                                    <li>Click <strong>"Allow"</strong> to grant permissions</li>
                                    <li>The window will close automatically</li>
                                    <li>You're done! Try fetching emails now.</li>
                                </ol>
                            </div>

                            <div style="margin-top: 15px; padding: 10px; background-color: #f8d7da; border: 1px solid #dc3545; border-radius: 4px;">
                                <strong style="color: #721c24;">⚠️ IMPORTANT: You Need a "Web Application" OAuth Client!</strong>
                                <p style="margin: 5px 0; font-size: 12px;">I see you have a "Desktop client 1" (Type: Desktop). We need a <strong>"Web application"</strong> type instead.</p>
                                <div style="background-color: #fff3cd; border: 1px solid #ffc107; padding: 10px; margin: 10px 0; border-radius: 4px;">
                                    <strong style="color: #856404;">📝 Create a NEW Web Application OAuth Client:</strong>
                                    <ol style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                                        <li>On the Credentials page, click <strong>"+ CREATE CREDENTIALS"</strong> (top blue button)</li>
                                        <li>Select <strong>"OAuth client ID"</strong> from the dropdown</li>
                                        <li>If asked for "Application type", select <strong>"Web application"</strong> (NOT Desktop!)</li>
                                        <li>Name it: <code style="background: #f0f0f0; padding: 2px 5px;">Mail Task Web App</code></li>
                                        <li><strong>IMPORTANT:</strong> There are TWO different fields - fill BOTH:</li>
                                        <li style="margin-left: 20px;">
                                            <strong>1. "Authorized JavaScript origins"</strong> (if shown):
                                            <ul style="margin: 5px 0; padding-left: 20px;">
                                                <li>Click <strong>"+ ADD URI"</strong></li>
                                                <li>Enter ONLY: <code style="background: #f0f0f0; padding: 2px 5px;">http://localhost:5000</code> (NO path!)</li>
                                            </ul>
                                        </li>
                                        <li style="margin-left: 20px;">
                                            <strong>2. "Authorized redirect URIs"</strong>:
                                            <ul style="margin: 5px 0; padding-left: 20px;">
                                                <li>Click <strong>"+ ADD URI"</strong></li>
                                                <li>Enter FULL path: <code style="background: #f0f0f0; padding: 2px 5px;">http://localhost:5000/oauth2callback</code></li>
                                            </ul>
                                        </li>
                                        <li>Click <strong>"CREATE"</strong></li>
                                        <li>A popup will show your <strong>Client ID</strong> and <strong>Client Secret</strong></li>
                                        <li><strong>Copy BOTH immediately</strong> (the secret won't be shown again!)</li>
                                        <li>Paste them in the fields below</li>
                                    </ol>
                                    <div style="background-color: #f8d7da; border: 1px solid #dc3545; padding: 8px; margin-top: 10px; border-radius: 4px; font-size: 11px;">
                                        <strong style="color: #721c24;">⚠️ Common Error:</strong> If you see "Invalid origin: URIs must not contain a path", you're entering the redirect URI in the wrong field. Use <code>http://localhost:5000</code> (no path) for "Authorized JavaScript origins" and <code>http://localhost:5000/oauth2callback</code> (with path) for "Authorized redirect URIs".
                                    </div>
                                </div>
                                <p style="margin: 10px 0 0 0; font-size: 11px; color: #721c24;"><strong>Note:</strong> The existing "Desktop client 1" won't work for web redirects. You must create a new "Web application" client.</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="gmail-oauth-client-id">OAuth Client ID:</label>
                            <input type="text" id="gmail-oauth-client-id" placeholder="123456789-abc123def456.apps.googleusercontent.com" style="font-family: monospace; font-size: 12px;" value="">
                            <small style="font-size: 11px; color: #666;">Enter your Client ID from Google Cloud Console</small>
                        </div>
                        <div class="form-group">
                            <label for="gmail-oauth-client-secret">OAuth Client Secret:</label>
                            <input type="password" id="gmail-oauth-client-secret" placeholder="GOCSPX-xxxxxxxxxxxxx" style="font-family: monospace; font-size: 12px;" value="">
                            <small style="font-size: 11px; color: #666;">Enter your Client Secret from Google Cloud Console (starts with GOCSPX-)</small>
                        </div>
                        <div class="form-group">
                            <label for="gmail-oauth-redirect-uri">Redirect URI:</label>
                            <input type="text" id="gmail-oauth-redirect-uri" placeholder="http://localhost:5000/oauth2callback" value="http://localhost:5000/oauth2callback" readonly style="background-color: #f5f5f5;">
                            <small style="font-size: 11px; color: #666;">This should match what you entered in Google Cloud Console</small>
                        </div>
                        <div style="background-color: #f8d7da; border: 2px solid #dc3545; padding: 15px; margin: 15px 0; border-radius: 4px; font-family: Arial, sans-serif; font-size: 13px;">
                            <strong style="color: #721c24; font-size: 14px;">🚨 CRITICAL: You MUST Add Yourself as Test User!</strong>
                            <p style="margin: 10px 0 8px 0; color: #721c24; font-weight: bold;">If you see "403: access_denied" or "尚未完成 Google 验证流程", follow these steps:</p>
                            <div style="background-color: #fff3cd; border: 1px solid #ffc107; padding: 12px; margin: 10px 0; border-radius: 4px;">
                                <strong style="color: #856404;">Step-by-Step Instructions:</strong>
                                <ol style="margin: 8px 0; padding-left: 25px; color: #856404; line-height: 1.8;">
                                    <li>Click this link: <a href="https://console.cloud.google.com/apis/credentials/consent" target="_blank" style="color: #0066cc; font-weight: bold; text-decoration: underline;">Open OAuth Consent Screen</a></li>
                                    <li>Make sure you're on the <strong>"OAuth consent screen"</strong> page</li>
                                    <li>Scroll down to find the section titled <strong>"Test users"</strong> (测试用户)</li>
                                    <li>You should see a button <strong>"+ ADD USERS"</strong> or <strong>"添加用户"</strong> - Click it!</li>
                                    <li>In the popup/dialog, enter your Gmail address: <code style="background: #f0f0f0; padding: 3px 6px; border: 1px solid #ccc; font-weight: bold;">eric.brilliant@gmail.com</code></li>
                                    <li>Click <strong>"ADD"</strong> or <strong>"添加"</strong> button</li>
                                    <li>You should see your email appear in the test users list</li>
                                    <li><strong>Wait 1-2 minutes</strong> for Google to process the change</li>
                                    <li>Come back to this page and click <strong>"🔐 Authenticate Gmail"</strong> again</li>
                                </ol>
                                <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 8px; margin-top: 10px; border-radius: 4px; font-size: 11px;">
                                    <strong style="color: #0c5460;">💡 Tip:</strong> Make sure you're logged into Google Cloud Console with the same Google account that owns the project. The test user email must match exactly (case-sensitive).
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
                            <button class="form-button" onclick="authenticateGmail()" style="margin-top: 10px;">🔐 Authenticate Gmail</button>
                            <button class="form-button" onclick="checkGmailStatus()" style="margin-top: 10px; font-size: 12px;">✓ Check Status</button>
                        </div>
                        <div id="gmail-auth-status" style="margin-top: 10px; font-family: Arial, sans-serif; font-size: 12px;"></div>
                    </div>

                    <div class="settings-section" style="margin-top: 30px;">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">163.com Configuration</h3>
                        <div class="form-group">
                            <label for="163-imap-server">IMAP Server:</label>
                            <input type="text" id="163-imap-server" placeholder="imap.163.com">
                        </div>
                        <div class="form-group">
                            <label for="163-port">Port:</label>
                            <input type="number" id="163-port" placeholder="993">
                        </div>
                        <div class="form-group">
                            <label for="163-username">Username:</label>
                            <input type="text" id="163-username" placeholder="your-email@163.com">
                        </div>
                        <div class="form-group">
                            <label for="163-password">Authorization Code:</label>
                            <input type="password" id="163-password" placeholder="Enter authorization code">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="163-use-ssl" checked>
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="163-use-tls">
                                <span>Use TLS</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top: 30px;">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">QQ Email Configuration</h3>
                        <div class="form-group">
                            <label for="qq-imap-server">IMAP Server:</label>
                            <input type="text" id="qq-imap-server" placeholder="imap.qq.com">
                        </div>
                        <div class="form-group">
                            <label for="qq-port">Port:</label>
                            <input type="number" id="qq-port" placeholder="993">
                        </div>
                        <div class="form-group">
                            <label for="qq-username">Username:</label>
                            <input type="text" id="qq-username" placeholder="your-email@qq.com">
                        </div>
                        <div class="form-group">
                            <label for="qq-password">Authorization Code:</label>
                            <input type="password" id="qq-password" placeholder="Enter authorization code">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="qq-use-ssl" checked>
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="qq-use-tls">
                                <span>Use TLS</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top: 30px;">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">SMTP Configuration</h3>
                        <div class="form-group">
                            <label for="smtp-sender-name">Default Sender Name:</label>
                            <input type="text" id="smtp-sender-name" placeholder="Mail Task">
                        </div>
                        <div class="form-group">
                            <strong style="font-family: Arial, sans-serif; font-size: 14px;">Primary SMTP (Gmail)</strong>
                        </div>
                        <div class="form-group">
                            <label for="smtp-primary-server">Server:</label>
                            <input type="text" id="smtp-primary-server" placeholder="smtp.gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="smtp-primary-port">Port:</label>
                            <input type="number" id="smtp-primary-port" placeholder="587">
                        </div>
                        <div class="form-group">
                            <label for="smtp-primary-username">Username:</label>
                            <input type="text" id="smtp-primary-username" placeholder="your-email@gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="smtp-primary-password">App Password:</label>
                            <input type="password" id="smtp-primary-password" placeholder="Enter app password">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="smtp-primary-use-ssl">
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="smtp-primary-use-tls" checked>
                                <span>Use TLS</span>
                            </label>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <strong style="font-family: Arial, sans-serif; font-size: 14px;">Backup SMTP (163.com)</strong>
                        </div>
                        <div class="form-group">
                            <label for="smtp-backup-server">Server:</label>
                            <input type="text" id="smtp-backup-server" placeholder="smtp.163.com">
                        </div>
                        <div class="form-group">
                            <label for="smtp-backup-port">Port:</label>
                            <input type="number" id="smtp-backup-port" placeholder="465">
                        </div>
                        <div class="form-group">
                            <label for="smtp-backup-username">Username:</label>
                            <input type="text" id="smtp-backup-username" placeholder="your-email@163.com">
                        </div>
                        <div class="form-group">
                            <label for="smtp-backup-password">Authorization Code:</label>
                            <input type="password" id="smtp-backup-password" placeholder="Enter authorization code">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="smtp-backup-use-ssl" checked>
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="smtp-backup-use-tls">
                                <span>Use TLS</span>
                            </label>
                        </div>
                    </div>
                    <div class="profile-detail-actions">
                        <button class="form-button danger" onclick="deleteCurrentProfile()">Delete Profile</button>
                        <button class="form-button" onclick="saveCurrentProfile()" style="padding: 15px 30px; font-size: 16px;">Save Profile</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="email-modal" class="modal hidden" onclick="closeEmailModal()" role="dialog" aria-modal="true" aria-labelledby="email-modal-subject">
        <div class="modal-dialog" onclick="event.stopPropagation();">
            <div class="modal-header">
                <div>
                    <div class="modal-title" id="email-modal-subject">Email</div>
                    <div class="modal-meta" id="email-modal-meta"></div>
                </div>
                <button class="modal-close" onclick="closeEmailModal()">Close</button>
            </div>
            <div class="modal-body">
                <iframe id="email-modal-frame" class="modal-iframe" title="Email content"></iframe>
            </div>
        </div>
    </div>

    <div id="attachment-modal" class="modal hidden" onclick="closeAttachmentModal()" role="dialog" aria-modal="true" aria-labelledby="attachment-modal-title">
        <div class="modal-dialog" onclick="event.stopPropagation();">
            <div class="modal-header">
                <div class="modal-title" id="attachment-modal-title">Attachments</div>
                <button class="modal-close" onclick="closeAttachmentModal()">Close</button>
            </div>
            <div class="modal-body">
                <div id="attachment-list" class="attachment-list"></div>
            </div>
        </div>
    </div>

    <div id="preview-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="preview-modal-title">
        <div class="modal-dialog preview-modal-dialog" onclick="event.stopPropagation();">
            <div class="modal-header">
                <div class="modal-title" id="preview-modal-title">Preview</div>
                <button class="modal-close" onclick="closePreviewModal()">Close</button>
            </div>
            <div class="modal-body">
                <div id="preview-modal-content"></div>
            </div>
        </div>
    </div>

    <div id="task-modal" class="modal hidden" onclick="closeTaskModal()" role="dialog" aria-modal="true" aria-labelledby="task-modal-title">
        <div class="modal-dialog" onclick="event.stopPropagation();">
            <div class="modal-header">
                <div class="modal-title" id="task-modal-title">Create Task</div>
                <button class="modal-close" onclick="closeTaskModal()">Close</button>
            </div>
            <div class="task-modal-body">
                <div class="task-row">
                    <div class="form-group">
                        <label for="task-sequence">Sequence</label>
                        <input type="text" id="task-sequence" readonly>
                    </div>
                    <div class="form-group">
                        <label for="task-customer-select">Selected Customer</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="task-customer-select" class="autocomplete-input" placeholder="Type to search customer..." autocomplete="off">
                            <div class="autocomplete-dropdown-btn" id="task-customer-dropdown-btn"></div>
                            <div id="task-customer-dropdown" class="autocomplete-dropdown"></div>
                        </div>
                        <input type="hidden" id="task-customer-value" value="">
                    </div>
                    <div class="form-group">
                        <label for="task-email">Email</label>
                        <input type="email" id="task-email" style="width: 100%; padding: 8px; border: 1px solid #000000;">
                    </div>
                    <div class="form-group">
                        <label for="task-catalogue">Type</label>
                        <select id="task-catalogue">
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-deadline">Deadline</label>
                        <input type="date" id="task-deadline" style="width: 100%; padding: 8px; border: 1px solid #000000;">
                    </div>
                </div>
                <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
                    <label for="task-notes">Template</label>
                    <div id="task-notes-editor" style="height: 300px; background-color: #ffffff;"></div>
                </div>
                <div class="form-group">
                    <label>Attachments</label>
                    <div id="task-attachments" class="attachment-list"></div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <button class="form-button" onclick="submitTask()" style="width: 100%; padding: 15px; font-size: 16px;">Submit Task</button>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-task-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">Edit Task</div>
                <button class="modal-close" onclick="closeEditTaskModal()">Close</button>
            </div>
            <div class="task-modal-body">
                <div class="task-row">
                    <div class="form-group">
                        <label for="edit-task-sequence">Sequence</label>
                        <input type="text" id="edit-task-sequence" readonly>
                    </div>
                    <div class="form-group">
                        <label for="edit-task-customer">Customer</label>
                        <input type="text" id="edit-task-customer" readonly>
                    </div>
                    <div class="form-group">
                        <label for="edit-task-email">Email</label>
                        <input type="email" id="edit-task-email" style="width: 100%; padding: 8px; border: 1px solid #000000;">
                    </div>
                </div>
                <div class="task-row">
                    <div class="form-group">
                        <label for="edit-task-type">Type</label>
                        <select id="edit-task-type"></select>
                    </div>
                    <div class="form-group">
                        <label for="edit-task-deadline">Deadline</label>
                        <input type="date" id="edit-task-deadline" style="width: 100%; padding: 8px; border: 1px solid #000000;">
                    </div>
                </div>
                <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
                    <label for="edit-task-template">Template</label>
                    <div id="edit-task-template-editor" style="height: 250px; background-color: #ffffff;"></div>
                </div>
                <div class="form-group">
                    <label>Attachments</label>
                    <div id="edit-task-attachments" class="attachment-list"></div>
                </div>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <button class="form-button" style="flex: 1;" onclick="saveTaskEdit()">Save Changes</button>
                    <button class="form-button" style="flex: 1; background-color: #6c757d; color: #ffffff;" onclick="closeEditTaskModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const VERSION = '{{ version }}';
        document.getElementById('version').textContent = 'v' + VERSION;
        const emailModal = document.getElementById('email-modal');
        const emailModalSubject = document.getElementById('email-modal-subject');
        const emailModalMeta = document.getElementById('email-modal-meta');
        const emailModalFrame = document.getElementById('email-modal-frame');
        const attachmentModal = document.getElementById('attachment-modal');
        const attachmentList = document.getElementById('attachment-list');
        const previewModal = document.getElementById('preview-modal');
        const previewModalTitle = document.getElementById('preview-modal-title');
        const previewModalContent = document.getElementById('preview-modal-content');
        const taskModal = document.getElementById('task-modal');
        const taskCustomerSelect = document.getElementById('task-customer-select');
        const taskEmailInput = document.getElementById('task-email');
        const taskSequenceInput = document.getElementById('task-sequence');
        const taskAttachmentsDiv = document.getElementById('task-attachments');
        const taskCatalogueSelect = document.getElementById('task-catalogue');
        const taskDeadlineInput = document.getElementById('task-deadline');
        const taskNotesEditorDiv = document.getElementById('task-notes-editor');
        const editTaskModal = document.getElementById('edit-task-modal');
        const editTaskSequenceInput = document.getElementById('edit-task-sequence');
        const editTaskCustomerInput = document.getElementById('edit-task-customer');
        const editTaskEmailInput = document.getElementById('edit-task-email');
        const editTaskTypeSelect = document.getElementById('edit-task-type');
        const editTaskDeadlineInput = document.getElementById('edit-task-deadline');
        const editTaskAttachmentsDiv = document.getElementById('edit-task-attachments');
        const editTaskTemplateEditorDiv = document.getElementById('edit-task-template-editor');
        
        // Initialize Quill editor for task modal
        let taskNotesEditor = null;
        if (taskNotesEditorDiv) {
            taskNotesEditor = new Quill('#task-notes-editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        [{ 'table': true }],
                        ['clean']
                    ]
                }
            });
        }

        let editTaskEditor = null;
        if (editTaskTemplateEditorDiv) {
            editTaskEditor = new Quill('#edit-task-template-editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        [{ 'table': true }],
                        ['clean']
                    ]
                }
            });
        }
        const customerStatusDiv = document.getElementById('customer-status');
        const customerEmailAddressInput = document.getElementById('customer-email-address');
        const customerListSection = document.getElementById('customer-list-section');
        const customerTableBody = document.getElementById('customer-table-body');
        const customerEmptyMessage = document.getElementById('customer-empty');
        let currentEmails = [];
        let currentProvider = null;
        let customerCache = [];
        let currentPreviewObjectUrl = null;
        let customerAttachments = [];
        let lastSelectedCustomerForTask = null;

        // Autocomplete functions
        function filterCustomers(query) {
            if (!query || !customerCache) return [];
            const lowerQuery = query.toLowerCase();
            return customerCache.filter(customer => {
                const name = (customer.name || '').toLowerCase();
                const companyName = (customer.company_name || '').toLowerCase();
                const email = (customer.email_suffix || '').toLowerCase();
                return name.includes(lowerQuery) || companyName.includes(lowerQuery) || email.includes(lowerQuery);
            });
        }

        function renderAutocompleteDropdown(dropdown, customers, onSelect) {
            dropdown.innerHTML = '';
            if (customers.length === 0) {
                dropdown.classList.remove('show');
                return;
            }
            
            customers.forEach((customer, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.dataset.index = index;
                const companyName = customer.company_name || '';
                const customerName = customer.name || '';
                const email = customer.email_suffix || '';
                const parts = [];
                if (companyName) parts.push(escapeHtml(companyName));
                if (customerName) parts.push(escapeHtml(customerName));
                const nameDisplay = parts.length > 0 ? parts.join(' • ') : escapeHtml(email);
                item.innerHTML = `
                    <div class="autocomplete-item-name">${nameDisplay}</div>
                    <div class="autocomplete-item-email">${escapeHtml(email)}</div>
                `;
                item.addEventListener('click', () => {
                    onSelect(customer);
                });
                dropdown.appendChild(item);
            });
            
            dropdown.classList.add('show');
        }

        function setupAutocomplete(inputId, dropdownId, valueInputId, emailInputId, onSelectCallback) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            const valueInput = document.getElementById(valueInputId);
            const emailInput = emailInputId ? document.getElementById(emailInputId) : null;
            // Find dropdown button - it's a sibling of the input
            const wrapper = input ? input.closest('.autocomplete-wrapper') : null;
            const dropdownBtn = wrapper ? wrapper.querySelector('.autocomplete-dropdown-btn') : null;
            
            if (!input || !dropdown || !valueInput) return;
            
            let highlightedIndex = -1;
            let filteredCustomers = [];
            let showingAllCustomers = false;
            
            function selectCustomer(customer) {
                input.value = customer.name || customer.email_suffix || '';
                valueInput.value = customer.email_suffix || '';
                dropdown.classList.remove('show');
                highlightedIndex = -1;
                showingAllCustomers = false;
                
                if (emailInput) {
                    const storedEmail = (customer.email_suffix || '').trim();
                    if (storedEmail.includes('@')) {
                        emailInput.value = storedEmail;
                    }
                }
                
                if (onSelectCallback) {
                    onSelectCallback(customer);
                }
            }
            
            function showAllCustomers() {
                if (!customerCache || customerCache.length === 0) return;
                filteredCustomers = customerCache;
                showingAllCustomers = true;
                renderAutocompleteDropdown(dropdown, filteredCustomers, selectCustomer);
                highlightedIndex = -1;
            }
            
            // Dropdown button click - show all customers
            if (dropdownBtn) {
                dropdownBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    if (dropdown.classList.contains('show') && showingAllCustomers) {
                        dropdown.classList.remove('show');
                    } else {
                        showAllCustomers();
                    }
                });
            }
            
            // Input focus - show all customers if empty, or filter if has text
            input.addEventListener('focus', (e) => {
                const query = e.target.value.trim();
                if (query === '') {
                    showAllCustomers();
                } else {
                    filteredCustomers = filterCustomers(query);
                    renderAutocompleteDropdown(dropdown, filteredCustomers, selectCustomer);
                }
            });
            
            input.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                showingAllCustomers = false;
                if (query === '') {
                    filteredCustomers = customerCache || [];
                } else {
                    filteredCustomers = filterCustomers(query);
                }
                renderAutocompleteDropdown(dropdown, filteredCustomers, selectCustomer);
                highlightedIndex = -1;
            });
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (filteredCustomers.length > 0) {
                        highlightedIndex = Math.min(highlightedIndex + 1, filteredCustomers.length - 1);
                        updateHighlight();
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIndex = Math.max(highlightedIndex - 1, -1);
                    updateHighlight();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (highlightedIndex >= 0 && filteredCustomers[highlightedIndex]) {
                        selectCustomer(filteredCustomers[highlightedIndex]);
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                    highlightedIndex = -1;
                }
            });
            
            function updateHighlight() {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                items.forEach((item, index) => {
                    if (index === highlightedIndex) {
                        item.classList.add('highlighted');
                        item.scrollIntoView({ block: 'nearest' });
                    } else {
                        item.classList.remove('highlighted');
                    }
                });
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target) && (!dropdownBtn || !dropdownBtn.contains(e.target))) {
                    dropdown.classList.remove('show');
                }
            });
        }

        // Country list - will be populated from database
        let COUNTRIES = [];
        // Customer sources list - will be populated from database
        let CUSTOMER_SOURCES = [];
        // Customer business types list - will be populated from database
        let CUSTOMER_BUSINESS_TYPES = [];
        let customerBusinessTypesCache = [];
        const PROVIDER_LABELS = {
            gmail: 'Gmail',
            qq: 'QQ',
            '163': '163.com'
        };

        function getTodayKey() {
            const d = new Date();
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function getYesterdayKey() {
            const d = new Date();
            d.setDate(d.getDate() - 1);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function normalizeEmailDate(email) {
            const raw = (email?.date || '').slice(0, 10);
            if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
                return raw;
            }
            return getTodayKey();
        }

        function extractEmailAddress(rawFrom) {
            if (!rawFrom) return '';
            const match = rawFrom.match(/<([^>]+)>/);
            const address = match ? match[1] : rawFrom;
            return (address || '').trim().toLowerCase();
        }

        function computeSequence(email) {
            const dateString = email?.date;
            let timestamp = Date.now();
            if (dateString) {
                const parsed = new Date(dateString);
                if (!isNaN(parsed.getTime())) {
                    timestamp = parsed.getTime();
                }
            }
            const dt = new Date(timestamp);
            const yyyy = dt.getFullYear();
            const mm = String(dt.getMonth() + 1).padStart(2, '0');
            const dd = String(dt.getDate()).padStart(2, '0');
            const hh = String(dt.getHours()).padStart(2, '0');
            const mi = String(dt.getMinutes()).padStart(2, '0');
            const ss = String(dt.getSeconds()).padStart(2, '0');
            const sequenceDate = `${yyyy}${mm}${dd}_${hh}${mi}${ss}`;
            
            const address = extractEmailAddress(email?.from || '');
            let localPart = '';
            let domainPart = '';
            if (address && address.includes('@')) {
                const parts = address.split('@');
                localPart = parts[0] || '';
                domainPart = parts[1] || '';
            } else {
                localPart = address;
            }

            const letters = (localPart.match(/[a-z]/gi) || []).map(ch => ch.toLowerCase());
            let prefix = letters.slice(0, 2).join('');
            if (prefix.length === 1) {
                prefix += 'x';
            } else if (prefix.length === 0) {
                prefix = 'xx';
            }

            const firstDomainLabel = (domainPart.split('.')[0] || '').replace(/[^a-z0-9]/gi, '').toLowerCase();
            const domainLabel = firstDomainLabel || 'domain';

            return `${sequenceDate}_${prefix}_${domainLabel}`;
        }

        function ensureEmailSequence(email) {
            if (!email) return email;
            // Always recompute sequence to ensure new format (yyyymmdd_hhmmss)
            // This ensures consistency even if old data has old format sequence
            email.sequence = computeSequence(email);
            return email;
        }

        function groupEmailsByDate(emails) {
            const grouped = {};
            (emails || []).forEach(item => {
                const enriched = ensureEmailSequence({ ...item });
                const dateKey = normalizeEmailDate(enriched);
                if (!grouped[dateKey]) {
                    grouped[dateKey] = [];
                }
                grouped[dateKey].push(enriched);
            });
            return grouped;
        }

        function cacheEmails(provider, emails) {
            if (!provider) {
                return;
            }
            try {
                const grouped = groupEmailsByDate(emails);
                Object.entries(grouped).forEach(([dateKey, list]) => {
                    const storageKey = `emails:${provider}:${dateKey}`;
                    localStorage.setItem(storageKey, JSON.stringify({ date: dateKey, emails: list }));
                });
                localStorage.setItem('lastEmailProvider', provider);
            } catch (error) {
                console.error('Failed to cache emails', error);
            }
        }

        function loadCachedEmails(provider) {
            if (!provider) return null;
            try {
                const dateKeys = [getTodayKey(), getYesterdayKey()];
                const collected = [];
                dateKeys.forEach(dateKey => {
                    const storageKey = `emails:${provider}:${dateKey}`;
                    const raw = localStorage.getItem(storageKey);
                    if (!raw) return;
                    const parsed = JSON.parse(raw);
                    if (parsed?.date === dateKey && Array.isArray(parsed.emails)) {
                        parsed.emails.forEach(email => {
                            collected.push(ensureEmailSequence({ ...email }));
                        });
                    }
                });
                return collected.length > 0 ? collected : null;
            } catch (error) {
                console.error('Failed to load cached emails', error);
            }
            return null;
        }

        function registerEmailKeys(emailObj, keySet) {
            if (!emailObj || !keySet) return;
            const id = (emailObj.id || emailObj.email_uid || '').trim();
            if (id) {
                keySet.add(`id:${id}`);
            } else {
                const sequence = (emailObj.sequence || '').trim();
                if (sequence) {
                    keySet.add(`seq:${sequence}`);
                }
            }
            const subject = (emailObj.subject || '').trim();
            const date = (emailObj.date || '').trim();
            const from = (emailObj.from || '').trim();
            if (subject && date && from) {
                keySet.add(`key:${subject}|${date}|${from}`);
            }
        }

        function deduplicateEmails(emails) {
            if (!Array.isArray(emails) || emails.length === 0) return [];
            
            const seenKeys = new Set();
            const uniqueEmails = [];
            
            emails.forEach(email => {
                const emailObj = ensureEmailSequence({ ...email });
                let isDuplicate = false;
                
                // Check by ID first
                const id = (emailObj.id || emailObj.email_uid || '').trim();
                if (id) {
                    const idKey = `id:${id}`;
                    if (seenKeys.has(idKey)) {
                        isDuplicate = true;
                    } else {
                        seenKeys.add(idKey);
                    }
                }
                
                // Check by sequence if no ID or ID not found
                if (!isDuplicate) {
                    const sequence = (emailObj.sequence || '').trim();
                    if (sequence) {
                        const seqKey = `seq:${sequence}`;
                        if (seenKeys.has(seqKey)) {
                            isDuplicate = true;
                        } else {
                            seenKeys.add(seqKey);
                        }
                    }
                }
                
                // Check by fallback key (subject+date+from)
                if (!isDuplicate) {
                    const subject = (emailObj.subject || '').trim();
                    const date = (emailObj.date || '').trim();
                    const from = (emailObj.from || '').trim();
                    if (subject && date && from) {
                        const fallbackKey = `key:${subject}|${date}|${from}`;
                        if (seenKeys.has(fallbackKey)) {
                            isDuplicate = true;
                        } else {
                            seenKeys.add(fallbackKey);
                        }
                    }
                }
                
                if (!isDuplicate) {
                    uniqueEmails.push(emailObj);
                }
            });
            
            return uniqueEmails;
        }

        function updateContentTitle(provider, cached = false) {
            const titleEl = document.getElementById('content-title');
            if (!titleEl) return;
            if (provider && PROVIDER_LABELS[provider]) {
                titleEl.textContent = `Receive Mail (${PROVIDER_LABELS[provider]}${cached ? ' - Cached' : ''})`;
            } else {
                titleEl.textContent = 'Receive Mail';
            }
        }

        function renderCachedEmailsFor(provider) {
            const cached = loadCachedEmails(provider);
            if (cached && Array.isArray(cached)) {
                const uniqueCached = deduplicateEmails(cached);
                displayEmails(uniqueCached, { provider, cached: true });
                return true;
            }
            return false;
        }

        function findCustomerByEmail(rawFrom) {
            if (!rawFrom) return null;
            const address = extractEmailAddress(rawFrom);
            if (!address || !address.includes('@')) return null;
            const addressLower = address.toLowerCase();
            
            // Try to find by full email address first (new format)
            let match = customerCache.find(customer => {
                const storedEmail = (customer.email_suffix || '').toLowerCase();
                return storedEmail === addressLower;
            });
            
            if (match) return match;
            
            // Fallback: try to find by domain suffix (backward compatibility)
            const domain = '@' + address.split('@')[1].toLowerCase();
            match = customerCache.find(customer => {
                const storedEmail = (customer.email_suffix || '').toLowerCase();
                // Check if stored email is old format (starts with @) or matches domain
                return storedEmail === domain || (storedEmail.startsWith('@') && storedEmail === domain);
            });
            
            return match || null;
        }

        function fetchStoredEmails(provider) {
            if (!provider) {
                return Promise.resolve([]);
            }
            const daysToLoad = 2; // fetch emails from the past 2 days by default
            return fetch(`/api/emails?provider=${encodeURIComponent(provider)}&days=${daysToLoad}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    const emails = (data.emails || []).map(item => ensureEmailSequence({ ...item }));
                    return emails;
                });
        }

        async function loadCachedEmailsOnStartup() {
            const emailList = document.getElementById('email-list');
            const candidates = [];
            const lastProvider = localStorage.getItem('lastEmailProvider');
            if (lastProvider) {
                candidates.push(lastProvider);
            }
            ['gmail', 'qq', '163'].forEach((provider) => {
                if (!candidates.includes(provider)) {
                    candidates.push(provider);
                }
            });

            for (const provider of candidates) {
                try {
                    const stored = await fetchStoredEmails(provider);
                    if (stored.length > 0) {
                        cacheEmails(provider, stored);
                        displayEmails(stored, { provider, cached: false });
                        currentProvider = provider;
                        return;
                    }
                } catch (error) {
                    console.error('Failed to load stored emails:', error);
                }

                if (renderCachedEmailsFor(provider)) {
                    currentProvider = provider;
                    return;
                }
            }

            if (emailList) {
                currentEmails = [];
                emailList.innerHTML = '<div class="loading">No cached emails for today. Click a fetch button to load the latest messages.</div>';
                emailList.dataset.cached = 'false';
            }
            currentProvider = null;
            updateContentTitle(null);
        }

        // Initialize Profile 1 with default values from configuration
        function initializeProfile1() {
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            // Always set Profile 1 with the correct configuration values
            profiles.profile1 = {
                name: 'Profile 1',
                gmail: {
                    imap_server: 'imap.gmail.com',
                    port: 993,
                    username: 'eric.brilliant@gmail.com',
                    password: 'opqx pfna kagb bznr',
                    use_ssl: true,
                    use_tls: false
                },
                email163: {
                    imap_server: 'imap.163.com',
                    port: 993,
                    username: '19902475292@163.com',
                    password: 'JDy8MigeNmsESZRa',
                    use_ssl: true,
                    use_tls: false
                },
                qq: {
                    imap_server: 'imap.qq.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                },
                smtp: {
                    sender_name: 'Mail Task',
                    primary: {
                        server: 'smtp.gmail.com',
                        port: 587,
                        username: 'eric.brilliant@gmail.com',
                        password: 'opqx pfna kagb bznr',
                        use_ssl: false,
                        use_tls: true
                    },
                    backup: {
                        server: 'smtp.163.com',
                        port: 465,
                        username: '19902475292@163.com',
                        password: 'JDy8MigeNmsESZRa',
                    use_ssl: true,
                    use_tls: false
                    }
                }
            };
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
        }

        // Profile list/detail workflow (Level 1 -> Level 2)
        let currentProfileKey = localStorage.getItem('selectedProfile') || 'profile1';

        function renderProfileList() {
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            const listContainer = document.getElementById('profile-list');
            if (!listContainer) return;

            listContainer.innerHTML = '';
            const selected = localStorage.getItem('selectedProfile') || 'profile1';
            const keys = Object.keys(profiles);
            if (keys.length === 0) {
                const none = document.createElement('div');
                none.className = 'profile-item-name';
                none.textContent = 'No profiles.';
                listContainer.appendChild(none);
                return;
            }
            keys.forEach((key) => {
                const profile = profiles[key];
                const item = document.createElement('div');
                item.className = 'profile-item' + (selected === key ? ' active' : '');

                const name = document.createElement('div');
                name.className = 'profile-item-name';
                name.textContent = profile.name || key;

                const openBtn = document.createElement('button');
                openBtn.className = 'form-button';
                openBtn.textContent = 'Open';
                openBtn.onclick = () => openProfileDetail(key);

                item.appendChild(name);
                item.appendChild(openBtn);
                listContainer.appendChild(item);
            });
        }

        function showProfileList() {
            document.getElementById('profile-list-view').classList.remove('hidden');
            document.getElementById('profile-detail-view').classList.add('hidden');
            renderProfileList();
        }

        function openProfileDetail(profileKey) {
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            const profile = profiles[profileKey];
            if (!profile) return;
            currentProfileKey = profileKey;
            setCurrentProfile(profileKey);
            document.getElementById('profile-name-display').textContent = profile.name || profileKey;
            // Fill fields
            document.getElementById('gmail-imap-server').value = profile.gmail?.imap_server || '';
            document.getElementById('gmail-port').value = profile.gmail?.port || 993;
            document.getElementById('gmail-username').value = profile.gmail?.username || '';
            document.getElementById('gmail-password').value = profile.gmail?.password || '';
            document.getElementById('gmail-use-ssl').checked = profile.gmail?.use_ssl ?? true;
            document.getElementById('gmail-use-tls').checked = profile.gmail?.use_tls ?? false;

            document.getElementById('gmail-oauth-client-id').value = profile.gmail?.oauth_client_id || '';
            document.getElementById('gmail-oauth-client-secret').value = profile.gmail?.oauth_client_secret || '';
            document.getElementById('gmail-oauth-redirect-uri').value = profile.gmail?.oauth_redirect_uri || 'http://localhost:5000/oauth2callback';

            document.getElementById('163-imap-server').value = profile.email163?.imap_server || '';
            document.getElementById('163-port').value = profile.email163?.port || 993;
            document.getElementById('163-username').value = profile.email163?.username || '';
            document.getElementById('163-password').value = profile.email163?.password || '';
            document.getElementById('163-use-ssl').checked = profile.email163?.use_ssl ?? true;
            document.getElementById('163-use-tls').checked = profile.email163?.use_tls ?? false;

            document.getElementById('qq-imap-server').value = profile.qq?.imap_server || '';
            document.getElementById('qq-port').value = profile.qq?.port || 993;
            document.getElementById('qq-username').value = profile.qq?.username || '';
            document.getElementById('qq-password').value = profile.qq?.password || '';
            document.getElementById('qq-use-ssl').checked = profile.qq?.use_ssl ?? true;
            document.getElementById('qq-use-tls').checked = profile.qq?.use_tls ?? false;

            const smtp = profile.smtp || {};
            const primarySmtp = smtp.primary || {};
            const backupSmtp = smtp.backup || {};

            document.getElementById('smtp-sender-name').value = smtp.sender_name || '';

            document.getElementById('smtp-primary-server').value = primarySmtp.server || '';
            document.getElementById('smtp-primary-port').value = primarySmtp.port || 587;
            document.getElementById('smtp-primary-username').value = primarySmtp.username || '';
            document.getElementById('smtp-primary-password').value = primarySmtp.password || '';
            document.getElementById('smtp-primary-use-ssl').checked = primarySmtp.use_ssl ?? false;
            document.getElementById('smtp-primary-use-tls').checked = primarySmtp.use_tls ?? true;

            document.getElementById('smtp-backup-server').value = backupSmtp.server || '';
            document.getElementById('smtp-backup-port').value = backupSmtp.port || 465;
            document.getElementById('smtp-backup-username').value = backupSmtp.username || '';
            document.getElementById('smtp-backup-password').value = backupSmtp.password || '';
            document.getElementById('smtp-backup-use-ssl').checked = backupSmtp.use_ssl ?? true;
            document.getElementById('smtp-backup-use-tls').checked = backupSmtp.use_tls ?? false;

            document.getElementById('profile-list-view').classList.add('hidden');
            document.getElementById('profile-detail-view').classList.remove('hidden');
        }

        // Save current profile
        function saveCurrentProfile() {
            const profileKey = currentProfileKey || (localStorage.getItem('selectedProfile') || 'profile1');
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            
            if (!profiles[profileKey]) {
                profiles[profileKey] = { name: profiles[profileKey]?.name || profileKey };
            }
            
            // Save Gmail settings
            profiles[profileKey].gmail = {
                imap_server: document.getElementById('gmail-imap-server').value.trim(),
                port: parseInt(document.getElementById('gmail-port').value) || 993,
                username: document.getElementById('gmail-username').value.trim(),
                password: document.getElementById('gmail-password').value.trim(),
                use_ssl: document.getElementById('gmail-use-ssl').checked,
                use_tls: document.getElementById('gmail-use-tls').checked,
                oauth_client_id: document.getElementById('gmail-oauth-client-id').value.trim(),
                oauth_client_secret: document.getElementById('gmail-oauth-client-secret').value.trim(),
                oauth_redirect_uri: document.getElementById('gmail-oauth-redirect-uri').value.trim() || 'http://localhost:5000/oauth2callback'
            };
            
            // Save 163.com settings
            profiles[profileKey].email163 = {
                imap_server: document.getElementById('163-imap-server').value.trim(),
                port: parseInt(document.getElementById('163-port').value) || 993,
                username: document.getElementById('163-username').value.trim(),
                password: document.getElementById('163-password').value.trim(),
                use_ssl: document.getElementById('163-use-ssl').checked,
                use_tls: document.getElementById('163-use-tls').checked
            };
            
            // Save QQ settings
            profiles[profileKey].qq = {
                imap_server: document.getElementById('qq-imap-server').value.trim(),
                port: parseInt(document.getElementById('qq-port').value) || 993,
                username: document.getElementById('qq-username').value.trim(),
                password: document.getElementById('qq-password').value.trim(),
                use_ssl: document.getElementById('qq-use-ssl').checked,
                use_tls: document.getElementById('qq-use-tls').checked
            };

            profiles[profileKey].smtp = {
                sender_name: document.getElementById('smtp-sender-name').value.trim(),
                primary: {
                    server: document.getElementById('smtp-primary-server').value.trim(),
                    port: parseInt(document.getElementById('smtp-primary-port').value) || 0,
                    username: document.getElementById('smtp-primary-username').value.trim(),
                    password: document.getElementById('smtp-primary-password').value.trim(),
                    use_ssl: document.getElementById('smtp-primary-use-ssl').checked,
                    use_tls: document.getElementById('smtp-primary-use-tls').checked
                },
                backup: {
                    server: document.getElementById('smtp-backup-server').value.trim(),
                    port: parseInt(document.getElementById('smtp-backup-port').value) || 0,
                    username: document.getElementById('smtp-backup-username').value.trim(),
                    password: document.getElementById('smtp-backup-password').value.trim(),
                    use_ssl: document.getElementById('smtp-backup-use-ssl').checked,
                    use_tls: document.getElementById('smtp-backup-use-tls').checked
                }
            };
            
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
            showError('Profile saved successfully', false);
            renderProfileList();
            updateComposeDefaults();
        }

        // Create new profile
        function createProfile() {
            const newName = document.getElementById('new-profile-name').value.trim();
            if (!newName) {
                showError('Please enter a profile name');
                return;
            }
            
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            const profileKey = 'profile' + Date.now();
            
            profiles[profileKey] = {
                name: newName,
                gmail: {
                    imap_server: 'imap.gmail.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                },
                email163: {
                    imap_server: 'imap.163.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                },
                qq: {
                    imap_server: 'imap.qq.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                },
                smtp: {
                    sender_name: '',
                    primary: {
                        server: 'smtp.gmail.com',
                        port: 587,
                        username: '',
                        password: '',
                        use_ssl: false,
                        use_tls: true
                    },
                    backup: {
                        server: 'smtp.163.com',
                        port: 465,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                    }
                }
            };
            
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
            document.getElementById('new-profile-name').value = '';
            currentProfileKey = profileKey;
            setCurrentProfile(profileKey);
            openProfileDetail(profileKey);
            renderProfileList();
            showError('Profile created successfully', false);
            updateComposeDefaults();
        }

        // Delete current profile
        function deleteCurrentProfile() {
            const profileKey = currentProfileKey || 'profile1';
            if (profileKey === 'profile1') {
                showError('Cannot delete Profile 1');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this profile?')) {
                return;
            }
            
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            delete profiles[profileKey];
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
            setCurrentProfile('profile1');
            currentProfileKey = 'profile1';
            showProfileList();
            showError('Profile deleted successfully', false);
        }

        async function saveYesterdayEmailsToSQLite() {
            const yesterdayKey = getYesterdayKey();
            const providers = ['gmail', 'qq', '163'];
            
            for (const provider of providers) {
                try {
                    const key = `emails:${provider}:${yesterdayKey}`;
                    const raw = localStorage.getItem(key);
                    if (!raw) continue;
                    
                    const parsed = JSON.parse(raw);
                    if (parsed?.date === yesterdayKey && Array.isArray(parsed.emails) && parsed.emails.length > 0) {
                        const emails = parsed.emails.map(item => ensureEmailSequence(item));
                        await fetch('/api/emails', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                provider: provider,
                                emails: emails,
                                date: yesterdayKey
                            })
                        });
                        console.log(`Saved ${emails.length} yesterday emails for ${provider} to SQLite`);
                        localStorage.removeItem(key);
                    }
                } catch (error) {
                    console.error(`Failed to save yesterday emails for ${provider}:`, error);
                }
            }
        }

        // Handle placeholder for contenteditable div
        function setupRemarkPlaceholder() {
            const remarkDiv = document.getElementById('customer-remark');
            if (!remarkDiv) return;
            
            const placeholder = remarkDiv.getAttribute('data-placeholder') || 'Enter remarks with HTML formatting...';
            
            function updatePlaceholder() {
                if (remarkDiv.innerHTML.trim() === '' || remarkDiv.textContent.trim() === '') {
                    remarkDiv.classList.add('empty');
                } else {
                    remarkDiv.classList.remove('empty');
                }
            }
            
            remarkDiv.addEventListener('focus', function() {
                if (remarkDiv.innerHTML.trim() === '' || remarkDiv.textContent.trim() === '') {
                    remarkDiv.classList.remove('empty');
                }
            });
            
            remarkDiv.addEventListener('blur', updatePlaceholder);
            remarkDiv.addEventListener('input', updatePlaceholder);
            updatePlaceholder();
        }

        // Load settings on page load
        window.onload = async function() {
            initializeProfile1();
            if (!localStorage.getItem('selectedProfile')) {
                setCurrentProfile('profile1');
            }
            showProfileList();
            updateComposeDefaults();
            setupRemarkPlaceholder();
            await loadCustomers(false);
            await saveYesterdayEmailsToSQLite();
            await loadCachedEmailsOnStartup();
            // Load countries for dropdown
            loadCountries();
            // Load customer sources for dropdown
            loadCustomerSources();
            document.addEventListener('keydown', (evt) => {
                if (evt.key === 'Escape' && !emailModal.classList.contains('hidden')) {
                    closeEmailModal();
                }
                if (evt.key === 'Escape' && !taskModal.classList.contains('hidden')) {
                    closeTaskModal();
                }
                if (evt.key === 'Escape' && editTaskModal && !editTaskModal.classList.contains('hidden')) {
                    closeEditTaskModal();
                }
                if (evt.key === 'Escape' && !attachmentModal.classList.contains('hidden')) {
                    closeAttachmentModal();
                }
                // Intentionally do NOT close the preview modal on Escape so it can only be closed via the (X) button
            });

            if (customerSuffixInput) {
                customerSuffixInput.addEventListener('input', () => {
                    if (customerSuffixInput.value.includes('@')) {
                        customerSuffixInput.value = customerSuffixInput.value.replace(/@/g, '');
                        showCustomerStatus('Removed "@". Please enter only the domain, e.g. example.com.', true);
                    }
                });
            }
        };

        function showReceiveMail() {
            document.getElementById('receive-mail-content').classList.remove('hidden');
            document.getElementById('send-mail-content').classList.add('hidden');
            document.getElementById('create-customer-content').classList.add('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('task-list-content').classList.add('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Receive Mail';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
            event.target.classList.add('active');
            }
            const emailList = document.getElementById('email-list');
            if (currentProvider && emailList) {
                const cached = emailList.dataset && emailList.dataset.cached === 'true';
                updateContentTitle(currentProvider, cached);
            }
        }

        function showSend() {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('send-mail-content').classList.remove('hidden');
            document.getElementById('create-customer-content').classList.add('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('task-list-content').classList.add('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Send Email';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        function showCreateCustomer() {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('send-mail-content').classList.add('hidden');
            document.getElementById('create-customer-content').classList.remove('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('task-list-content').classList.add('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Create Customer';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
            // Ensure countries and customer sources are loaded for dropdowns
            if (COUNTRIES.length === 0) {
                loadCountries();
            }
            if (CUSTOMER_SOURCES.length === 0) {
                loadCustomerSources();
            }
            // Ensure attachment drag & drop is initialized
            setupCustomerAttachmentDragAndDrop();
            loadCustomers(true);
        }

        function showTask() {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('send-mail-content').classList.add('hidden');
            document.getElementById('create-customer-content').classList.add('hidden');
            document.getElementById('task-content').classList.remove('hidden');
            document.getElementById('task-list-content').classList.add('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('dropdown-list-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Task';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
            event.target.classList.add('active');
            }
            loadTaskDisplay();
            loadTaskTypesForDropdown();
        }

        function loadTaskDisplay() {
            const container = document.getElementById('task-display-container');
            if (!container) return;
            
            // Load customers if not cached
            if (!customerCache || customerCache.length === 0) {
                loadCustomers(false).then(() => {
                    renderTaskForm(container);
                });
            } else {
                renderTaskForm(container);
            }
        }

        function loadTaskDisplayForDropdown() {
            const container = document.getElementById('task-display-container-dropdown');
            if (!container) return;
            
            // Load customers if not cached
            if (!customerCache || customerCache.length === 0) {
                loadCustomers(false).then(() => {
                    renderTaskForm(container);
                });
            } else {
                renderTaskForm(container);
            }
        }

        function renderTaskForm(container) {
            const customerOptions = customerCache.map(customer => 
                `<option value="${escapeHtml(customer.email_suffix || '')}">${escapeHtml(customer.name || customer.email_suffix || '')}</option>`
            ).join('');
            
            container.innerHTML = `
                <div class="task-display-item" style="border: 1px solid #000000; padding: 20px; background-color: #ffffff;">
                    <form id="task-form" onsubmit="submitTaskFromForm(event)">
                        <div class="task-row" style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Selected Customer</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="task-form-customer" class="autocomplete-input" placeholder="Type to search customer..." autocomplete="off" required>
                                    <div class="autocomplete-dropdown-btn" id="task-form-customer-dropdown-btn"></div>
                                    <div id="task-form-customer-dropdown" class="autocomplete-dropdown"></div>
                                </div>
                                <input type="hidden" id="task-form-customer-value" value="">
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email</label>
                                <input type="email" id="task-form-email" required style="width: 100%; padding: 8px; border: 1px solid #000000;" placeholder="customer@example.com">
                            </div>
                        </div>
                        <div class="task-row" style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Type</label>
                                <select id="task-form-catalogue" required style="width: 100%; padding: 8px; border: 1px solid #000000;">
                                    <option value="">-- Select Type --</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Deadline</label>
                                <input type="date" id="task-form-deadline" style="width: 100%; padding: 8px; border: 1px solid #000000;">
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Template</label>
                            <div id="task-form-template-editor" style="height: 300px; background-color: #ffffff;"></div>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Attachments</label>
                            <div id="task-form-dropzone" tabindex="0" style="border: 2px dashed #000000; padding: 20px; text-align: center; background-color: #f9f9f9; min-height: 100px; margin-bottom: 15px;">
                                <p style="margin: 0; color: #666;">Drag and drop files here, click the Browse button, or paste images (Ctrl+V)</p>
                                <button type="button" id="task-form-browse-btn" class="form-button" style="margin-top: 12px; padding: 8px 20px;">Browse</button>
                                <input type="file" id="task-form-file-input" multiple style="display: none;" onchange="handleTaskFileSelect(event)">
                            </div>
                            <div id="task-form-attachments-list"></div>
                        </div>
                        <div class="form-group" style="margin-top: 20px;">
                            <button type="submit" class="form-button" style="width: 100%; padding: 15px; font-size: 16px;">Submit Task</button>
                        </div>
                    </form>
                </div>
            `;
            
            // Setup drag and drop
            setupTaskDragAndDrop();
            
            // Setup autocomplete for customer field
            setTimeout(() => {
                setupAutocomplete('task-form-customer', 'task-form-customer-dropdown', 'task-form-customer-value', 'task-form-email');
            }, 50);
            
            // Load task types
            loadTaskTypesForDropdown();
            
            // Initialize Quill editor for task form (after DOM is ready)
            setTimeout(() => {
                const taskFormEditorDiv = document.getElementById('task-form-template-editor');
                if (taskFormEditorDiv) {
                    // Destroy existing editor if it exists
                    if (window.taskFormEditor) {
                        try {
                            window.taskFormEditor = null;
                        } catch (e) {
                            console.warn('Error destroying existing editor:', e);
                        }
                    }
                    // Create new editor
                    window.taskFormEditor = new Quill('#task-form-template-editor', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'script': 'sub'}, { 'script': 'super' }],
                                [{ 'indent': '-1'}, { 'indent': '+1' }],
                                [{ 'align': [] }],
                                ['link', 'image'],
                                [{ 'table': true }],
                                ['clean']
                            ]
                        }
                    });
                }
            }, 100);
        }
        
        function setupCustomerEmailAutoFill() {
            const customerSelect = document.getElementById('task-form-customer');
            const emailInput = document.getElementById('task-form-email');
            
            if (!customerSelect || !emailInput) return;
            
            customerSelect.addEventListener('change', function() {
                const selectedEmailSuffix = this.value;
                
                if (!selectedEmailSuffix) {
                    // If no customer selected, clear email field
                    emailInput.value = '';
                    return;
                }
                
                // Find the customer in cache
                const selectedCustomer = customerCache.find(c => c.email_suffix === selectedEmailSuffix);
                
                if (selectedCustomer) {
                    // Use the stored email address directly
                    const storedEmail = (selectedCustomer.email_suffix || '').trim();
                    
                    if (storedEmail.includes('@')) {
                        // If it's a full email address (new format), use it directly
                        emailInput.value = storedEmail;
                    } else {
                        // Backward compatibility: if it's old format without @, build email from name
                        const customerName = (selectedCustomer.name || '').trim();
                        let emailAddress = '';
                        
                        if (customerName.includes('@')) {
                            // If customer name already contains @, use it as email
                            emailAddress = customerName;
                        } else {
                            // Convert customer name to email username (lowercase, remove spaces and special chars)
                            let username = customerName
                                .toLowerCase()
                                .replace(/\s+/g, '')  // Remove spaces
                                .replace(/[^a-z0-9._-]/g, '');  // Remove special chars except . _ -
                            
                            // If username is empty after processing, use a default value
                            if (!username) {
                                username = 'customer';
                            }
                            
                            // Combine username with email suffix
                            if (storedEmail.startsWith('@')) {
                                emailAddress = username + storedEmail;
                            } else {
                                emailAddress = username + '@' + storedEmail;
                            }
                        }
                        
                        emailInput.value = emailAddress;
                    }
                }
            });
        }

        function setupTaskDragAndDrop() {
            const dropzone = document.getElementById('task-form-dropzone');
            const fileInput = document.getElementById('task-form-file-input');
            const browseButton = document.getElementById('task-form-browse-btn');
            
            if (!dropzone || !fileInput || !browseButton) return;
            
            // Dedicated browse button to open file picker
            browseButton.addEventListener('click', (e) => {
                e.stopPropagation();
                fileInput.click();
            });
            
            // Drag and drop handlers
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.style.backgroundColor = '#e9e9e9';
            });
            
            dropzone.addEventListener('dragleave', () => {
                dropzone.style.backgroundColor = '#f9f9f9';
            });
            
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.style.backgroundColor = '#f9f9f9';
                const files = Array.from(e.dataTransfer.files);
                handleTaskFiles(files);
            });

            // Paste image from clipboard
            dropzone.addEventListener('paste', (e) => {
                const clipboardData = e.clipboardData || window.clipboardData;
                if (!clipboardData || !clipboardData.items) {
                    return;
                }
                const files = [];
                for (let i = 0; i < clipboardData.items.length; i++) {
                    const item = clipboardData.items[i];
                    if (item.kind === 'file') {
                        const file = item.getAsFile();
                        if (file && file.type && file.type.startsWith('image/')) {
                            files.push(file);
                        }
                    }
                }
                if (files.length > 0) {
                    e.preventDefault();
                    handleTaskFiles(files);
                }
            });
        }

        function handleTaskFileSelect(event) {
            const files = Array.from(event.target.files);
            handleTaskFiles(files);
        }

        function handleTaskFiles(files) {
            if (!window.taskFormAttachments) {
                window.taskFormAttachments = [];
            }
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64Data = e.target.result.split(',')[1];
                    window.taskFormAttachments.push({
                        filename: file.name,
                        content_type: file.type || 'application/octet-stream',
                        size: file.size,
                        data: base64Data,
                        caption: ''
                    });
                    renderTaskAttachmentsList();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderTaskAttachmentsList() {
            const container = document.getElementById('task-form-attachments-list');
            if (!container) return;
            
            if (!window.taskFormAttachments || window.taskFormAttachments.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = window.taskFormAttachments.map((att, idx) => {
                const filename = escapeHtml(att.filename || 'attachment');
                const size = formatAttachmentSize(att.size || 0);
                const contentType = att.content_type || 'application/octet-stream';
                const isImage = (contentType || '').toLowerCase().startsWith('image/');
                const thumbHtml = isImage
                    ? `<img src="data:${contentType};base64,${att.data}" alt="${filename}" class="task-attachment-thumb" data-index="${idx}" onclick="openTaskFormAttachmentPreview(${idx})">`
                    : '';
                return `
                    <div class="task-attachment-display" style="margin-bottom: 10px; display: flex; align-items: flex-start;">
                        ${thumbHtml}
                        <div class="task-attachment-info" style="flex: 1;">
                            <div style="font-weight: bold;">${filename}</div>
                            <div style="font-size: 12px; color: #666;">${contentType} • ${size}</div>
                            <input type="text" class="task-attachment-caption" data-index="${idx}" placeholder="Enter caption for this attachment" style="width: 100%; margin-top: 5px; padding: 5px; border: 1px solid #000000;" value="${escapeHtml(att.caption || '')}">
                        </div>
                        <div class="task-attachment-actions">
                            <button type="button" class="form-button" onclick="removeTaskFormAttachment(${idx})" style="font-size: 12px; background-color: #dc3545; color: white;">X</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Attach caption input handlers
            container.querySelectorAll('.task-attachment-caption').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    if (window.taskFormAttachments && window.taskFormAttachments[index]) {
                        window.taskFormAttachments[index].caption = e.target.value;
                    }
                });
            });
        }

        function removeTaskFormAttachment(index) {
            if (!window.taskFormAttachments || !window.taskFormAttachments[index]) {
                return;
            }
            window.taskFormAttachments.splice(index, 1);
            renderTaskAttachmentsList();
        }

        function submitTaskFromForm(event) {
            event.preventDefault();
            
            const customerInput = document.getElementById('task-form-customer');
            const customerValueInput = document.getElementById('task-form-customer-value');
            const emailInput = document.getElementById('task-form-email');
            const catalogueSelect = document.getElementById('task-form-catalogue');
            const deadlineInput = document.getElementById('task-form-deadline');
            
            if (!customerInput || !customerValueInput || !emailInput || !catalogueSelect) {
                alert('Form fields not found');
                return;
            }
            
            // Get content from Quill editor
            let template = '';
            if (window.taskFormEditor) {
                template = window.taskFormEditor.root.innerHTML;
            }
            
            const customerEmailSuffix = customerValueInput.value;
            const customerName = customerInput.value;
            const email = emailInput.value.trim();
            const catalogue = catalogueSelect.value;
            const deadline = deadlineInput ? deadlineInput.value.trim() : '';
            
            if (!customerEmailSuffix || !customerName) {
                alert('Please select a customer');
                return;
            }
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            if (!catalogue) {
                alert('Please select a type');
                return;
            }
            
            if (!template || template.trim() === '' || template === '<p><br></p>') {
                alert('Please enter template content');
                return;
            }
            
            // Generate sequence code (yyyymmdd_hhmmss)
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const mi = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            const sequence = `${yyyy}${mm}${dd}_${hh}${mi}${ss}`;
            
            // Prepare task data
            const taskData = {
                sequence: sequence,
                customer: customerName,
                email: email,
                catalogue: catalogue,
                template: template,
                deadline: deadline || null,
                attachments: (window.taskFormAttachments || []).map(att => ({
                    filename: att.filename,
                    content_type: att.content_type,
                    size: att.size,
                    data: att.data,
                    caption: att.caption || ''
                }))
            };
            
            // Save to database
            fetch('/api/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(taskData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error saving task: ' + data.error);
                } else {
                    alert('Task saved successfully!');
                    // Reset form
                    document.getElementById('task-form').reset();
                    window.taskFormAttachments = [];
                    renderTaskAttachmentsList();
                    // Refresh task list if it's displayed
                    if (document.getElementById('task-list-content') && !document.getElementById('task-list-content').classList.contains('hidden')) {
                        loadTaskList();
                    }
                }
            })
            .catch(error => {
                alert('Error saving task: ' + error.message);
            });
        }

        function showDropdownList() {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('send-mail-content').classList.add('hidden');
            document.getElementById('create-customer-content').classList.add('hidden');
            document.getElementById('task-list-content').classList.add('hidden');
            document.getElementById('dropdown-list-content').classList.remove('hidden');
            document.getElementById('content-title').textContent = 'Dropdown List';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
            // Load task types list
            loadTaskTypes();
            // Load countries list
            loadCountries();
        }

        function showSettings() {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('settings-content').classList.remove('hidden');
            document.getElementById('send-mail-content').classList.add('hidden');
            document.getElementById('create-customer-content').classList.add('hidden');
            document.getElementById('dropdown-list-content').classList.add('hidden');
            document.getElementById('task-list-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Settings';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
            event.target.classList.add('active');
            }
            showProfileList();
        }

        // Task Types Management Functions
        let taskTypesCache = [];

        function toggleTaskTypeDropdown() {
            const content = document.getElementById('task-type-dropdown-content');
            const icon = document.getElementById('task-type-dropdown-icon');
            if (!content || !icon) return;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▼';
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'none';
                icon.textContent = '▶';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function toggleCountryDropdown() {
            const content = document.getElementById('country-dropdown-content');
            const icon = document.getElementById('country-dropdown-icon');
            if (!content || !icon) return;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▼';
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'none';
                icon.textContent = '▶';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function ensureTaskTypesLoaded() {
            if (taskTypesCache && taskTypesCache.length > 0) {
                return Promise.resolve(taskTypesCache);
            }
            return fetch('/api/task-types')
                .then(response => response.json())
                .then(types => {
                    taskTypesCache = types;
                    return taskTypesCache;
                })
                .catch(error => {
                    console.error('Error loading task types:', error);
                    return [];
                });
        }

        function loadTaskTypes() {
            fetch('/api/task-types')
                .then(response => response.json())
                .then(types => {
                    taskTypesCache = types;
                    renderTaskTypesList(types);
                    updateTaskTypeDropdowns(types);
                })
                .catch(error => {
                    console.error('Error loading task types:', error);
                    document.getElementById('task-types-list').innerHTML = '<div style="padding: 20px; color: #dc3545;">Error loading task types</div>';
                });
        }

        let currentTaskTypeDragId = null;

        function renderTaskTypesList(types) {
            const container = document.getElementById('task-types-list');
            if (!container) return;
            
            if (!types || types.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No task types found. Add one above.</div>';
                return;
            }
            
            // Sort by display_order
            const sortedTypes = [...types].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            
            container.innerHTML = sortedTypes.map((type, index) => `
                <div class="task-type-row" draggable="true"
                     data-type-id="${type.id}"
                     ondragstart="onTaskTypeDragStart(event, ${type.id})"
                     ondragover="onTaskTypeDragOver(event, ${type.id})"
                     ondrop="onTaskTypeDrop(event, ${type.id})"
                     ondragend="onTaskTypeDragEnd(event)"
                     style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #f0f0f0;">
                    <div class="task-type-handle">
                        <div class="task-type-handle-icon">≡</div>
                        <div class="task-type-seq">#${index + 1}</div>
                    </div>
                    <div style="flex: 1;">
                        <input type="text" value="${escapeHtml(type.name)}" 
                               id="task-type-name-${type.id}" 
                               style="width: 100%; padding: 5px; border: 1px solid #000000; font-size: 14px;"
                               onblur="updateTaskType(${type.id})">
                    </div>
                    <div style="margin-left: 15px; display: flex; gap: 5px;">
                        <button class="form-button" onclick="updateTaskType(${type.id})" style="padding: 5px 15px; font-size: 12px;">Save</button>
                        <button class="form-button" onclick="deleteTaskType(${type.id})" style="padding: 5px 15px; font-size: 12px; background-color: #dc3545; color: white;">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function showTaskTypeSuggestions() {
            const input = document.getElementById('new-task-type-input');
            const suggestionsDiv = document.getElementById('task-type-suggestions');
            const warningDiv = document.getElementById('task-type-duplicate-warning');
            
            if (!input || !suggestionsDiv) return;
            
            const query = input.value.trim().toLowerCase();
            
            if (!query) {
                suggestionsDiv.classList.add('hidden');
                warningDiv.style.display = 'none';
                return;
            }
            
            // Check for duplicates
            const existingTypes = taskTypesCache || [];
            const isDuplicate = existingTypes.some(type => 
                type.name.toLowerCase() === query
            );
            
            if (isDuplicate) {
                suggestionsDiv.classList.add('hidden');
                warningDiv.textContent = 'This task type already exists!';
                warningDiv.style.display = 'block';
                input.style.borderColor = '#dc3545';
                return;
            } else {
                warningDiv.style.display = 'none';
                input.style.borderColor = '#000000';
            }
            
            // Show similar suggestions
            const similar = existingTypes
                .filter(type => type.name.toLowerCase().includes(query))
                .slice(0, 5);
            
            if (similar.length === 0) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            
            suggestionsDiv.innerHTML = similar.map(type => 
                `<div class="country-dropdown-item" onclick="selectTaskTypeSuggestion('${type.name.replace(/'/g, "\\'")}')">${escapeHtml(type.name)}</div>`
            ).join('');
            suggestionsDiv.classList.remove('hidden');
        }

        function hideTaskTypeSuggestions() {
            const suggestionsDiv = document.getElementById('task-type-suggestions');
            if (suggestionsDiv) {
                suggestionsDiv.classList.add('hidden');
            }
        }

        function selectTaskTypeSuggestion(name) {
            const input = document.getElementById('new-task-type-input');
            if (input) {
                input.value = name;
            }
            hideTaskTypeSuggestions();
            showTaskTypeSuggestions(); // Re-check for duplicates
        }

        function addTaskType() {
            const input = document.getElementById('new-task-type-input');
            const warningDiv = document.getElementById('task-type-duplicate-warning');
            const name = input.value.trim();
            
            if (!name) {
                alert('Please enter a task type name');
                return;
            }
            
            // Check for duplicates before submitting
            const existingTypes = taskTypesCache || [];
            const isDuplicate = existingTypes.some(type => 
                type.name.toLowerCase() === name.toLowerCase()
            );
            
            if (isDuplicate) {
                warningDiv.textContent = 'This task type already exists!';
                warningDiv.style.display = 'block';
                input.style.borderColor = '#dc3545';
                input.focus();
                return;
            }
            
            fetch('/api/task-types', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: name })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    if (data.error.includes('already exists')) {
                        warningDiv.textContent = 'This task type already exists!';
                        warningDiv.style.display = 'block';
                        input.style.borderColor = '#dc3545';
                        input.focus();
                    } else {
                        alert('Error: ' + data.error);
                    }
                } else {
                    input.value = '';
                    warningDiv.style.display = 'none';
                    input.style.borderColor = '#000000';
                    hideTaskTypeSuggestions();
                    loadTaskTypes();
                    // Clear suggestions after successful add
                    setTimeout(() => {
                        const suggestionsDiv = document.getElementById('task-type-suggestions');
                        if (suggestionsDiv) {
                            suggestionsDiv.classList.add('hidden');
                        }
                    }, 100);
                }
            })
            .catch(error => {
                alert('Error adding task type: ' + error.message);
            });
        }

        function updateTaskType(typeId) {
            const nameInput = document.getElementById(`task-type-name-${typeId}`);
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Task type name cannot be empty');
                loadTaskTypes(); // Reload to reset
                return;
            }
            
            // Find current type to preserve display_order
            const currentType = taskTypesCache.find(t => t.id === typeId);
            const displayOrder = currentType ? (currentType.display_order || 0) : 0;
            
            fetch(`/api/task-types/${typeId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: name, display_order: displayOrder })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    loadTaskTypes(); // Reload to reset
                } else {
                    loadTaskTypes();
                }
            })
            .catch(error => {
                alert('Error updating task type: ' + error.message);
                loadTaskTypes(); // Reload to reset
            });
        }

        function deleteTaskType(typeId) {
            if (!confirm('Are you sure you want to delete this task type?')) {
                return;
            }
            
            fetch(`/api/task-types/${typeId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    loadTaskTypes();
                }
            })
            .catch(error => {
                alert('Error deleting task type: ' + error.message);
            });
        }

        function onTaskTypeDragStart(event, typeId) {
            currentTaskTypeDragId = typeId;
            event.dataTransfer.effectAllowed = 'move';
        }

        function onTaskTypeDragOver(event, typeId) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            const row = event.currentTarget;
            row.classList.add('drag-over');
        }

        function onTaskTypeDragEnd(event) {
            document.querySelectorAll('.task-type-row.drag-over').forEach(row => {
                row.classList.remove('drag-over');
            });
        }

        function onTaskTypeDrop(event, targetTypeId) {
            event.preventDefault();
            const targetRow = event.currentTarget;
            targetRow.classList.remove('drag-over');
            
            if (!currentTaskTypeDragId || currentTaskTypeDragId === targetTypeId) {
                currentTaskTypeDragId = null;
                return;
            }
            
            // Reorder in memory
            const sortedTypes = [...taskTypesCache].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            const fromIndex = sortedTypes.findIndex(t => t.id === currentTaskTypeDragId);
            const toIndex = sortedTypes.findIndex(t => t.id === targetTypeId);
            
            if (fromIndex < 0 || toIndex < 0 || fromIndex === toIndex) {
                currentTaskTypeDragId = null;
                return;
            }
            
            const [moved] = sortedTypes.splice(fromIndex, 1);
            sortedTypes.splice(toIndex, 0, moved);
            
            // Re-assign display_order sequentially
            sortedTypes.forEach((type, index) => {
                type.display_order = index + 1;
            });
            
            // Persist all updated orders
            Promise.all(sortedTypes.map(type => 
                fetch(`/api/task-types/${type.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: type.name,
                        display_order: type.display_order
                    })
                })
            ))
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(results => {
                if (results.some(r => r.error)) {
                    alert('Error updating order');
                } else {
                    loadTaskTypes();
                }
            })
            .catch(error => {
                alert('Error reordering task types: ' + error.message);
            })
            .finally(() => {
                currentTaskTypeDragId = null;
            });
        }

        function loadTaskTypesForDropdown() {
            if (taskTypesCache && taskTypesCache.length > 0) {
                updateTaskTypeDropdowns(taskTypesCache);
            } else {
                fetch('/api/task-types')
                    .then(response => response.json())
                    .then(types => {
                        taskTypesCache = types;
                        updateTaskTypeDropdowns(types);
                    })
                    .catch(error => {
                        console.error('Error loading task types:', error);
                    });
            }
        }

        function updateTaskTypeDropdowns(types) {
            // Sort by display_order
            const sortedTypes = [...types].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            
            // Update task form dropdown
            const taskFormCatalogue = document.getElementById('task-form-catalogue');
            if (taskFormCatalogue) {
                const currentValue = taskFormCatalogue.value;
                taskFormCatalogue.innerHTML = '<option value="">-- Select Type --</option>' + 
                    sortedTypes.map(type => `<option value="${escapeHtml(type.name)}">${escapeHtml(type.name)}</option>`).join('');
                if (currentValue) {
                    taskFormCatalogue.value = currentValue;
                }
            }
            
            // Update task modal dropdown
            const taskCatalogueSelect = document.getElementById('task-catalogue');
            if (taskCatalogueSelect) {
                const currentValue = taskCatalogueSelect.value;
                taskCatalogueSelect.innerHTML = sortedTypes.map(type => 
                    `<option value="${escapeHtml(type.name)}">${escapeHtml(type.name)}</option>`
                ).join('');
                if (currentValue) {
                    taskCatalogueSelect.value = currentValue;
                }
            }
        }

        // Countries Management Functions
        let countriesCache = [];

        function loadCountries() {
            fetch('/api/countries')
                .then(response => response.json())
                .then(countries => {
                    countriesCache = countries;
                    renderCountriesList(countries);
                    updateCountryDropdown(countries);
                })
                .catch(error => {
                    console.error('Error loading countries:', error);
                    const container = document.getElementById('countries-list');
                    if (container) {
                        container.innerHTML = '<div style="padding: 20px; color: #dc3545;">Error loading countries</div>';
                    }
                });
        }

        let currentCountryDragId = null;

        function renderCountriesList(countries) {
            const container = document.getElementById('countries-list');
            if (!container) return;
            
            if (!countries || countries.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No countries found. Add one above.</div>';
                return;
            }
            
            // Sort by display_order
            const sortedCountries = [...countries].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            
            container.innerHTML = sortedCountries.map(country => `
                <div class="task-type-item" draggable="true" 
                     ondragstart="currentCountryDragId = ${country.id}; event.dataTransfer.effectAllowed = 'move';" 
                     ondragover="event.preventDefault(); event.dataTransfer.dropEffect = 'move';" 
                     ondrop="handleCountryDrop(event, ${country.id})" 
                     ondragenter="event.preventDefault(); this.style.backgroundColor = '#e0e0e0';" 
                     ondragleave="this.style.backgroundColor = '';" 
                     style="padding: 10px; margin-bottom: 5px; border: 1px solid #ddd; background-color: #f9f9f9; cursor: move; display: flex; align-items: center; gap: 10px;">
                    <span style="cursor: move; user-select: none;">☰</span>
                    <input type="text" id="country-name-${country.id}" value="${escapeHtml(country.name)}" 
                           style="flex: 1; padding: 5px; border: 1px solid #000000;" 
                           onblur="updateCountry(${country.id})">
                    <button class="form-button" onclick="deleteCountry(${country.id})" style="padding: 5px 10px; font-size: 12px; background-color: #dc3545; color: white;">Delete</button>
                </div>
            `).join('');
        }

        function showCountrySuggestions() {
            const input = document.getElementById('new-country-input');
            const suggestionsDiv = document.getElementById('country-suggestions');
            const warningDiv = document.getElementById('country-duplicate-warning');
            
            if (!input || !suggestionsDiv) return;
            
            const query = input.value.trim().toLowerCase();
            
            if (!query) {
                suggestionsDiv.classList.add('hidden');
                warningDiv.style.display = 'none';
                return;
            }
            
            // Check for duplicates
            const existingCountries = countriesCache || [];
            const isDuplicate = existingCountries.some(country => 
                country.name.toLowerCase() === query
            );
            
            if (isDuplicate) {
                suggestionsDiv.classList.add('hidden');
                warningDiv.textContent = 'This country already exists!';
                warningDiv.style.display = 'block';
                input.style.borderColor = '#dc3545';
                return;
            } else {
                warningDiv.style.display = 'none';
                input.style.borderColor = '#000000';
            }
            
            // Show similar suggestions
            const similar = existingCountries
                .filter(country => country.name.toLowerCase().includes(query))
                .slice(0, 5);
            
            if (similar.length === 0) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            
            suggestionsDiv.innerHTML = similar.map(country => 
                `<div class="country-dropdown-item" onclick="selectCountrySuggestion('${country.name.replace(/'/g, "\\'")}')">${escapeHtml(country.name)}</div>`
            ).join('');
            suggestionsDiv.classList.remove('hidden');
        }

        function hideCountrySuggestions() {
            const suggestionsDiv = document.getElementById('country-suggestions');
            if (suggestionsDiv) {
                suggestionsDiv.classList.add('hidden');
            }
        }

        function selectCountrySuggestion(name) {
            const input = document.getElementById('new-country-input');
            if (input) {
                input.value = name;
            }
            hideCountrySuggestions();
            showCountrySuggestions(); // Re-check for duplicates
        }

        function addCountry() {
            const input = document.getElementById('new-country-input');
            const warningDiv = document.getElementById('country-duplicate-warning');
            if (!input) return;
            
            const name = input.value.trim();
            if (!name) {
                alert('Country name cannot be empty');
                return;
            }
            
            // Check for duplicates before submitting
            const existingCountries = countriesCache || [];
            const isDuplicate = existingCountries.some(country => 
                country.name.toLowerCase() === name.toLowerCase()
            );
            
            if (isDuplicate) {
                warningDiv.textContent = 'This country already exists!';
                warningDiv.style.display = 'block';
                input.style.borderColor = '#dc3545';
                input.focus();
                return;
            }
            
            fetch('/api/countries', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    if (data.error.includes('already exists')) {
                        warningDiv.textContent = 'This country already exists!';
                        warningDiv.style.display = 'block';
                        input.style.borderColor = '#dc3545';
                        input.focus();
                    } else {
                        alert('Error: ' + data.error);
                    }
                } else {
                    input.value = '';
                    warningDiv.style.display = 'none';
                    input.style.borderColor = '#000000';
                    hideCountrySuggestions();
                    loadCountries();
                    // Clear suggestions after successful add
                    setTimeout(() => {
                        const suggestionsDiv = document.getElementById('country-suggestions');
                        if (suggestionsDiv) {
                            suggestionsDiv.classList.add('hidden');
                        }
                    }, 100);
                }
            })
            .catch(error => {
                alert('Error adding country: ' + error.message);
            });
        }

        function updateCountry(countryId) {
            const nameInput = document.getElementById(`country-name-${countryId}`);
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Country name cannot be empty');
                loadCountries(); // Reload to reset
                return;
            }
            
            // Find current country to preserve display_order
            const currentCountry = countriesCache.find(c => c.id === countryId);
            if (!currentCountry) {
                loadCountries();
                return;
            }
            
            fetch(`/api/countries/${countryId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    display_order: currentCountry.display_order || 0
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    loadCountries(); // Reload to reset
                } else {
                    loadCountries();
                }
            })
            .catch(error => {
                alert('Error updating country: ' + error.message);
                loadCountries(); // Reload to reset
            });
        }

        function deleteCountry(countryId) {
            if (!confirm('Are you sure you want to delete this country?')) {
                return;
            }
            
            fetch(`/api/countries/${countryId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    loadCountries();
                }
            })
            .catch(error => {
                alert('Error deleting country: ' + error.message);
            });
        }

        function handleCountryDrop(event, targetId) {
            event.preventDefault();
            if (!currentCountryDragId || currentCountryDragId === targetId) {
                currentCountryDragId = null;
                return;
            }
            
            const fromIndex = countriesCache.findIndex(c => c.id === currentCountryDragId);
            const toIndex = countriesCache.findIndex(c => c.id === targetId);
            
            if (fromIndex === -1 || toIndex === -1) {
                currentCountryDragId = null;
                return;
            }
            
            // Reorder in memory
            const sortedCountries = [...countriesCache].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            const fromIndexSorted = sortedCountries.findIndex(c => c.id === currentCountryDragId);
            const toIndexSorted = sortedCountries.findIndex(c => c.id === targetId);
            
            const [moved] = sortedCountries.splice(fromIndexSorted, 1);
            sortedCountries.splice(toIndexSorted, 0, moved);
            
            // Re-assign display_order sequentially
            sortedCountries.forEach((country, index) => {
                country.display_order = index + 1;
            });
            
            // Persist all updated orders
            Promise.all(sortedCountries.map(country => 
                fetch(`/api/countries/${country.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: country.name,
                        display_order: country.display_order
                    })
                })
            ))
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(results => {
                if (results.some(r => r.error)) {
                    alert('Error updating order');
                } else {
                    loadCountries();
                }
            })
            .catch(error => {
                alert('Error reordering countries: ' + error.message);
            })
            .finally(() => {
                currentCountryDragId = null;
            });
        }

        function updateCountryDropdown(countries) {
            // Build alphabetically sorted list of country names for Create Customer dropdown
            const sortedNames = [...countries.map(c => c.name)].sort((a, b) => 
                (a || '').localeCompare(b || '')
            );
            // Update COUNTRIES array for the country input field (always A→Z)
            COUNTRIES = sortedNames;
            
            // If country dropdown is visible, refresh it
            const countryInput = document.getElementById('customer-country');
            const countryDropdown = document.getElementById('country-dropdown');
            if (countryInput && countryDropdown && !countryDropdown.classList.contains('hidden')) {
                filterCountries();
            }
        }


        function showError(message, isError = true, timeoutMs = 3000) {
            const errorDiv = document.getElementById('error-message');
            if (!errorDiv) return;
            errorDiv.textContent = message;
            errorDiv.className = `message ${isError ? 'error' : 'success'}`;
            errorDiv.classList.remove('hidden');
            if (timeoutMs > 0) {
            setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, timeoutMs);
            }
        }

        function showMessage(message, type = 'info', timeoutMs = 5000) {
            // Use error-message div or create a new one
            let messageDiv = document.getElementById('error-message');
            if (!messageDiv) {
                // Create message div if it doesn't exist
                messageDiv = document.createElement('div');
                messageDiv.id = 'error-message';
                messageDiv.className = 'message';
                const contentArea = document.getElementById('content-area');
                if (contentArea) {
                    contentArea.insertBefore(messageDiv, contentArea.firstChild);
                }
            }
            messageDiv.textContent = message;
            const typeClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            messageDiv.className = `message ${typeClass}`;
            messageDiv.classList.remove('hidden');
            if (timeoutMs > 0) {
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, timeoutMs);
            }
        }

        function hideMessage() {
            const messageDiv = document.getElementById('error-message');
            if (messageDiv) {
                messageDiv.classList.add('hidden');
            }
        }

        function showEmailLoadingOverlay() {
            const overlay = document.getElementById('email-loading-overlay');
            if (overlay) {
                overlay.classList.add('active');
            }
        }

        function hideEmailLoadingOverlay() {
            const overlay = document.getElementById('email-loading-overlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
        }

        function getCurrentProfile() {
            // Get selected profile from localStorage or default to profile1
            const selectedProfile = localStorage.getItem('selectedProfile') || 'profile1';
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            return profiles[selectedProfile] || profiles.profile1 || {};
        }

        function setCurrentProfile(profileKey) {
            localStorage.setItem('selectedProfile', profileKey);
            updateComposeDefaults();
        }

        function updateComposeDefaults() {
            const profile = getCurrentProfile();
            const senderInput = document.getElementById('compose-sender-name');
            if (!senderInput) return;
            const defaultName = profile.smtp?.sender_name || profile.name || 'Mail Task';
            senderInput.placeholder = defaultName;
            if (!senderInput.value.trim()) {
                senderInput.value = defaultName;
            }
        }

        function authenticateGmail() {
            // Get values from form fields (in case user just entered them)
            const clientId = document.getElementById('gmail-oauth-client-id').value.trim();
            const clientSecret = document.getElementById('gmail-oauth-client-secret').value.trim();
            const redirectUri = document.getElementById('gmail-oauth-redirect-uri').value.trim() || 'http://localhost:5000/oauth2callback';
            
            // If form fields are empty, try to get from profile
            const profile = getCurrentProfile();
            const gmail = profile.gmail || {};
            const finalClientId = clientId || gmail.oauth_client_id || '';
            const finalClientSecret = clientSecret || gmail.oauth_client_secret || '';
            const finalRedirectUri = redirectUri || gmail.oauth_redirect_uri || 'http://localhost:5000/oauth2callback';
            
            const statusDiv = document.getElementById('gmail-auth-status');
            if (statusDiv) {
                statusDiv.innerHTML = '<span style="color: #0066cc;">Starting authentication...</span>';
            }
            
            if (!finalClientId || !finalClientSecret) {
                const msg = 'Please enter Gmail OAuth Client ID and Client Secret in the fields above first.';
                if (statusDiv) {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">❌ ${msg}</span>`;
                } else {
                    alert(msg);
                }
                return;
            }
            
            // Validate format
            if (!finalClientId.includes('.apps.googleusercontent.com')) {
                const msg = 'Client ID should end with .apps.googleusercontent.com';
                if (statusDiv) {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">❌ ${msg}</span>`;
                } else {
                    alert(msg);
                }
                return;
            }
            
            const params = new URLSearchParams({
                client_id: finalClientId,
                client_secret: finalClientSecret,
                redirect_uri: finalRedirectUri
            });
            
            fetch(`/api/gmail-auth?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        const msg = `Authentication error: ${data.error}`;
                        if (statusDiv) {
                            statusDiv.innerHTML = `<span style="color: #dc3545;">❌ ${msg}</span>`;
                        } else {
                            alert(msg);
                        }
                    } else if (data.auth_url) {
                        if (statusDiv) {
                            statusDiv.innerHTML = '<span style="color: #28a745;">Opening authentication window...</span>';
                        }
                        // Open OAuth window
                        const authWindow = window.open(data.auth_url, 'Gmail Auth', 'width=600,height=700,scrollbars=yes');
                        
                        if (!authWindow) {
                            alert('Popup blocked! Please allow popups for this site and try again.');
                            if (statusDiv) {
                                statusDiv.innerHTML = '<span style="color: #dc3545;">❌ Popup blocked. Please allow popups.</span>';
                            }
                            return;
                        }
                        
                        // Check if window was closed (user completed auth)
                        const checkClosed = setInterval(() => {
                            if (authWindow.closed) {
                                clearInterval(checkClosed);
                                if (statusDiv) {
                                    statusDiv.innerHTML = '<span style="color: #0066cc;">Checking authentication...</span>';
                                }
                                // Check status after a delay
                                setTimeout(() => {
                                    checkGmailStatus();
                                    // Try fetching emails after auth
                                    setTimeout(() => {
                                        if (window.location.hash !== '#settings') {
                                            fetchGmailEmails();
                                        }
                                    }, 2000);
                                }, 1000);
                            }
                        }, 500);
                    }
                })
                .catch(error => {
                    const msg = `Error starting authentication: ${error.message}`;
                    if (statusDiv) {
                        statusDiv.innerHTML = `<span style="color: #dc3545;">❌ ${msg}</span>`;
                    } else {
                        alert(msg);
                    }
                });
        }

        function checkGmailStatus() {
            const statusDiv = document.getElementById('gmail-auth-status');
            if (statusDiv) {
                statusDiv.innerHTML = '<span style="color: #0066cc;">Checking...</span>';
            }
            
            fetch('/api/gmail-status')
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        const msg = `✅ Authenticated!\nEmail: ${data.email}\nTotal messages: ${data.messages_total}`;
                        if (statusDiv) {
                            statusDiv.innerHTML = `<span style="color: #28a745;">${msg.replace(/\n/g, '<br>')}</span>`;
                        } else {
                            alert(msg);
                        }
                    } else {
                        const msg = data.message || 'Gmail OAuth is not authenticated. Please configure it above.';
                        if (statusDiv) {
                            statusDiv.innerHTML = `<span style="color: #dc3545;">❌ ${msg}</span>`;
                        } else {
                            alert(msg);
                        }
                    }
                })
                .catch(error => {
                    const msg = `Error checking status: ${error.message}`;
                    if (statusDiv) {
                        statusDiv.innerHTML = `<span style="color: #dc3545;">❌ ${msg}</span>`;
                    } else {
                        alert(msg);
                    }
                });
        }

        function fetchGmailEmails() {
            const emailList = document.getElementById('email-list');
            
            // Show loading overlay
            showEmailLoadingOverlay();
            
            // Create a set of unique identifiers for existing emails
            // Use multiple fields to catch duplicates: sequence code, ID, or subject+date+from
            const existingEmailKeys = new Set();
            (currentEmails || []).forEach(email => {
                const emailObj = ensureEmailSequence({ ...email });
                registerEmailKeys(emailObj, existingEmailKeys);
            });
            
            const existingCount = existingEmailKeys.size;
            
            // Show popup message: "Checking for new emails from web page"
            showMessage('Checking for new emails from web page...', 'info');
            
            // If no emails are displayed, load from cache first
            if (existingCount === 0) {
                const cached = loadCachedEmails('gmail');
                if (cached && Array.isArray(cached) && cached.length > 0) {
                    const uniqueCached = deduplicateEmails(cached);
                    displayEmails(uniqueCached, { provider: 'gmail', cached: true });
                    // Update existing keys after displaying cached emails
                    currentEmails.forEach(email => {
                        const emailObj = ensureEmailSequence({ ...email });
                        registerEmailKeys(emailObj, existingEmailKeys);
                    });
                }
            }
            
            const gmailDaysBack = 1; // fetch today + previous day
            fetch('/api/fetch-gmail', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ limit: 50, days_back: gmailDaysBack })
            })
                .then(async response => {
                    const data = await response.json();
                    if (response.status === 401 && data.needs_auth) {
                        const errorMsg = data.error || 'Gmail OAuth authentication required.';
                        emailList.innerHTML = `
                            <div class="message error" style="white-space: pre-line;">
                                <p><strong>Gmail OAuth Setup Required</strong></p>
                                <p>${escapeHtml(errorMsg)}</p>
                                <div style="margin-top: 15px;">
                                    <button class="form-button" onclick="showSettings(); setTimeout(() => { const detail = document.getElementById('profile-detail-view'); if (detail && !detail.classList.contains('hidden')) { detail.scrollIntoView({ behavior: 'smooth', block: 'start' }); } }, 500);" style="margin-right: 10px;">Go to Settings</button>
                                    <button class="form-button" onclick="authenticateGmail()">Authenticate Gmail</button>
                                </div>
                                <p style="margin-top: 15px; font-size: 12px;">
                                    <a href="${data.setup_url || 'https://console.cloud.google.com/'}" target="_blank">Get OAuth Credentials from Google Cloud Console</a>
                                </p>
                            </div>
                        `;
                        hideMessage();
                        hideEmailLoadingOverlay();
                    } else if (data.error) {
                        // Check if authentication is needed
                        if (data.needs_auth) {
                            emailList.innerHTML = `
                                <div class="message error" style="white-space: pre-line;">
                                    <p><strong>Gmail Authentication Required</strong></p>
                                    <p>${escapeHtml(data.error)}</p>
                                    <div style="margin-top: 15px;">
                                        <button class="form-button" onclick="showSettings(); setTimeout(() => { const detail = document.getElementById('profile-detail-view'); if (detail && !detail.classList.contains('hidden')) { detail.scrollIntoView({ behavior: 'smooth', block: 'start' }); } }, 500);" style="margin-right: 10px;">Go to Settings</button>
                                        <button class="form-button" onclick="authenticateGmail()">Re-authenticate Gmail</button>
                                    </div>
                                </div>
                            `;
                    } else {
                            showMessage(`Error: ${escapeHtml(data.error)}`, 'error');
                        }
                        hideEmailLoadingOverlay();
                    } else {
                        const fetchedEmails = (data.emails || []).map(item => ensureEmailSequence({ ...item }));
                        
                        // Filter out emails that are already displayed using multiple criteria
                        const newEmails = fetchedEmails.filter(email => {
                            const emailObj = ensureEmailSequence({ ...email });
                            
                            const id = (emailObj.id || emailObj.email_uid || '').trim();
                            if (id) {
                                if (existingEmailKeys.has(`id:${id}`)) {
                                    return false;
                                }
                            } else {
                                const sequenceKey = (emailObj.sequence || '').trim();
                                if (sequenceKey && existingEmailKeys.has(`seq:${sequenceKey}`)) {
                                    return false;
                                }
                            }
                            
                            const subject = (emailObj.subject || '').trim();
                            const date = (emailObj.date || '').trim();
                            const from = (emailObj.from || '').trim();
                            if (subject && date && from) {
                                const fallbackKey = `key:${subject}|${date}|${from}`;
                                if (existingEmailKeys.has(fallbackKey)) {
                                    return false;
                                }
                            }
                            
                            registerEmailKeys(emailObj, existingEmailKeys);
                            return true;
                        });
                        
                        // Merge new emails with existing ones
                        const mergedEmails = [...currentEmails, ...newEmails];
                        
                        // Deduplicate the merged list to remove any duplicates
                        const uniqueEmails = deduplicateEmails(mergedEmails);
                        
                        // Sort by date (newest first)
                        uniqueEmails.sort((a, b) => {
                            const dateA = new Date(a.date || 0);
                            const dateB = new Date(b.date || 0);
                            return dateB - dateA;
                        });
                        
                        // Update cache with deduplicated emails
                        cacheEmails('gmail', uniqueEmails);
                        
                        // Display deduplicated emails
                        displayEmails(uniqueEmails, { provider: 'gmail' });
                        
                        // Show result message
                        if (newEmails.length > 0) {
                            showMessage(`Found ${newEmails.length} new email(s) and added to the list.`, 'success');
                        } else {
                            showMessage('No new emails found. All emails are up to date.', 'info');
                        }
                        hideEmailLoadingOverlay();
                    }
                })
                .catch(error => {
                    showMessage(`Error fetching emails: ${escapeHtml(error.message)}`, 'error');
                    hideEmailLoadingOverlay();
                });
        }

        function fetchQQEmails() {
            const profile = getCurrentProfile();
            const qq = profile.qq || {};
            
            if (!qq.username || !qq.password) {
                showError('Please save QQ settings first in Settings page');
                return;
            }

            // Show loading overlay
            showEmailLoadingOverlay();

            const emailList = document.getElementById('email-list');
            emailList.innerHTML = '<div class="loading">Loading QQ emails...</div>';
            const cached = loadCachedEmails('qq');
            if (cached && Array.isArray(cached)) {
                const uniqueCached = deduplicateEmails(cached);
                displayEmails(uniqueCached, { provider: 'qq', cached: true });
            }
            
            fetch('/api/fetch-qq', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    imap_server: qq.imap_server || 'imap.qq.com',
                    port: qq.port || 993,
                    username: qq.username,
                    password: qq.password,
                    use_ssl: qq.use_ssl !== undefined ? qq.use_ssl : true,
                    use_tls: qq.use_tls || false,
                    limit: 50
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        emailList.innerHTML = `<div class="message error">Error: ${escapeHtml(data.error)}</div>`;
                    } else {
                        const list = (data.emails || []).map(item => ensureEmailSequence({ ...item }));
                        const uniqueList = deduplicateEmails(list);
                        cacheEmails('qq', uniqueList);
                        displayEmails(uniqueList, { provider: 'qq' });
                    }
                    hideEmailLoadingOverlay();
                })
                .catch(error => {
                    emailList.innerHTML = `<div class="message error">Error fetching emails: ${escapeHtml(error.message)}</div>`;
                    hideEmailLoadingOverlay();
                });
        }

        function fetch163Emails() {
            // Show loading overlay
            showEmailLoadingOverlay();

            const emailList = document.getElementById('email-list');
            emailList.innerHTML = '<div class="loading">Loading 163.com emails...</div>';
            const cached = loadCachedEmails('163');
            if (cached && Array.isArray(cached)) {
                const uniqueCached = deduplicateEmails(cached);
                displayEmails(uniqueCached, { provider: '163', cached: true });
            }
            
            const profile = getCurrentProfile();
            const email163 = profile.email163 || {};
            const requestData = {
                limit: 50,
                imap_server: email163.imap_server || 'imap.163.com',
                port: email163.port || 993,
                username: email163.username || '',
                password: email163.password || '',
                use_ssl: email163.use_ssl !== undefined ? email163.use_ssl : true,
                use_tls: email163.use_tls || false
            };
            
            fetch('/api/fetch-163', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        emailList.innerHTML = `<div class="message error">Error: ${escapeHtml(data.error)}</div>`;
                    } else {
                        const list = (data.emails || []).map(item => ensureEmailSequence({ ...item }));
                        const uniqueList = deduplicateEmails(list);
                        cacheEmails('163', uniqueList);
                        displayEmails(uniqueList, { provider: '163' });
                    }
                    hideEmailLoadingOverlay();
                })
                .catch(error => {
                    emailList.innerHTML = `<div class="message error">Error fetching emails: ${escapeHtml(error.message)}</div>`;
                    hideEmailLoadingOverlay();
                });
        }

        function parseEmailList(value) {
            if (!value) {
                return [];
            }
            return value
                .split(/[;,]+/)
                .map(addr => addr.trim())
                .filter(addr => addr.length > 0);
        }

        function showSendStatus(message, state = 'info', timeoutMs = 4000) {
            const statusDiv = document.getElementById('send-email-status');
            if (!statusDiv) return;
            statusDiv.textContent = message;
            statusDiv.className = `message ${state}`;
            statusDiv.classList.remove('hidden');
            if (timeoutMs > 0) {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, timeoutMs);
            }
        }

        function sendEmail() {
            const recipientsValue = document.getElementById('compose-to').value;
            const subjectValue = document.getElementById('compose-subject').value;
            const bodyValue = document.getElementById('compose-body').value;
            const senderNameInput = document.getElementById('compose-sender-name').value.trim();
            const sendAsHtml = document.getElementById('compose-is-html').checked;
            const usePrimary = document.getElementById('use-primary-smtp').checked;
            const useBackup = document.getElementById('use-backup-smtp').checked;

            const recipients = parseEmailList(recipientsValue);
            if (recipients.length === 0) {
                showSendStatus('Please enter at least one recipient email address.', 'error');
                return;
            }

            if (!bodyValue.trim()) {
                showSendStatus('Email body cannot be empty.', 'error');
                return;
            }

            const profile = getCurrentProfile();
            const smtpConfig = profile.smtp || {};
            const configs = [];

            const primary = smtpConfig.primary || {};
            if (usePrimary && primary.server && primary.username && primary.password) {
                configs.push({
                    name: 'Primary SMTP',
                    server: primary.server,
                    port: primary.port,
                    username: primary.username,
                    password: primary.password,
                    use_ssl: !!primary.use_ssl,
                    use_tls: !!primary.use_tls,
                    sender_name: smtpConfig.sender_name,
                    from_address: primary.username
                });
            }

            const backup = smtpConfig.backup || {};
            if (useBackup && backup.server && backup.username && backup.password) {
                configs.push({
                    name: 'Backup SMTP',
                    server: backup.server,
                    port: backup.port,
                    username: backup.username,
                    password: backup.password,
                    use_ssl: !!backup.use_ssl,
                    use_tls: !!backup.use_tls,
                    sender_name: smtpConfig.sender_name,
                    from_address: backup.username
                });
            }

            const payload = {
                to: recipients,
                subject: subjectValue,
                body: bodyValue,
                is_html: sendAsHtml,
                sender_name: senderNameInput || smtpConfig.sender_name || profile.name || 'Mail Task'
            };

            if (configs.length > 0) {
                payload.configs = configs;
            }

            showSendStatus('Sending email...', 'info', 0);

            fetch('/api/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
                .then(async response => {
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to send email');
                    }
                    document.getElementById('compose-body').value = '';
                    showSendStatus(`Email sent via ${data.provider || 'SMTP provider'}.`, 'success');
                })
                .catch(error => {
                    showSendStatus(`Send failed: ${error.message}`, 'error');
                });
        }

        function formatAttachmentSize(bytes) {
            const size = Number(bytes) || 0;
            if (size >= 1024 * 1024) {
                return `${(size / (1024 * 1024)).toFixed(1)} MB`;
            }
            return `${(size / 1024).toFixed(1)} KB`;
        }

        function displayEmails(emails, options = {}) {
            const emailList = document.getElementById('email-list');
            currentEmails = Array.isArray(emails) ? emails.map(email => ensureEmailSequence({ ...email })) : [];
            const provider = options.provider || currentProvider;
            const isCached = !!options.cached;
            if (provider) {
                currentProvider = provider;
                updateContentTitle(provider, isCached);
            }
            if (!emailList) {
                return;
            }
            emailList.dataset.cached = isCached ? 'true' : 'false';

            if (currentEmails.length === 0) {
                emailList.innerHTML = '<div class="loading">No emails found for today or yesterday</div>';
                return;
            }
            
            emailList.innerHTML = currentEmails.map((email, index) => `
                <div class="email-item" data-index="${index}">
                    <div class="email-content">
                    <div class="email-header">
                            <div class="email-subject">
                                ${escapeHtml(email.subject || 'No Subject')}
                                ${email.sequence ? `<span class="email-sequence-inline">${escapeHtml(email.sequence)}</span>` : ''}
                            </div>
                        <div class="email-date">${escapeHtml(email.date || '')}</div>
                    </div>
                    <div class="email-from">From: ${escapeHtml(email.from || '')}</div>
                        <div class="email-preview">${escapeHtml(email.preview || '')}</div>
                        ${Array.isArray(email.attachments) && email.attachments.length > 0 ? `
                            <div class="email-attachments">
                                ${email.attachments.map(att => `
                                    <a class="attachment-chip" href="data:${att.content_type || 'application/octet-stream'};base64,${att.data}" download="${escapeHtml(att.filename || 'attachment')}">
                                        📎 ${escapeHtml(att.filename || 'attachment')} (${formatAttachmentSize(att.size || 0)})
                                    </a>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="email-actions">
                        ${Array.isArray(email.attachments) && email.attachments.length > 0 ? `
                            <button class="form-button email-action-button attachment-button" data-index="${index}" data-attachment="true" title="View attachments">
                                📎 (${email.attachments.length})
                            </button>
                        ` : ''}
                        <button class="form-button email-action-button" data-index="${index}">Task</button>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.email-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.getAttribute('data-index'), 10);
                    openEmailModal(index);
                });
            });

            document.querySelectorAll('.email-action-button').forEach(button => {
                button.addEventListener('click', (evt) => {
                    evt.stopPropagation();
                    const index = parseInt(button.getAttribute('data-index'), 10);
                    if (button.dataset.attachment === 'true') {
                        openAttachmentModal(index);
                    } else {
                        openTaskModal(index);
                    }
                });
            });
        }

        function openEmailModal(index) {
            if (Number.isNaN(index)) {
                return;
            }
            const email = currentEmails[index];
            if (!email) {
                return;
            }

            emailModalSubject.textContent = email.subject || 'No Subject';
            const metaLines = [
                `From: ${email.from || 'Unknown sender'}`,
                `Date: ${email.date || 'Unknown date'}`
            ];
            emailModalMeta.textContent = metaLines.join('\n');

            if (email.html_body) {
                // Wrap HTML content with proper styling for scrolling
                emailModalFrame.srcdoc = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body {
                                margin: 0;
                                padding: 20px;
                                font-family: Arial, sans-serif;
                                overflow-y: auto;
                                overflow-x: hidden;
                            }
                        </style>
                    </head>
                    <body>
                        ${email.html_body}
                    </body>
                    </html>
                `;
            } else {
                const plain = email.plain_body || '';
                emailModalFrame.srcdoc = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body {
                                margin: 0;
                                padding: 20px;
                                font-family: Arial, sans-serif;
                                overflow-y: auto;
                                overflow-x: hidden;
                            }
                            pre {
                                white-space: pre-wrap;
                                word-wrap: break-word;
                            }
                        </style>
                    </head>
                    <body>
                        <pre>${escapeHtml(plain)}</pre>
                    </body>
                    </html>
                `;
            }

            emailModal.classList.remove('hidden');
        }

        function closeEmailModal() {
            emailModal.classList.add('hidden');
            emailModalFrame.srcdoc = '';
        }

        function openAttachmentModal(index) {
            if (Number.isNaN(index)) {
                return;
            }
            const email = currentEmails[index];
            if (!email || !Array.isArray(email.attachments) || email.attachments.length === 0) {
                return;
            }
            attachmentList.innerHTML = email.attachments.map((att, idx) => `
                <div class="attachment-row">
                    <div class="attachment-row-info">
                        <strong>${escapeHtml(att.filename || `Attachment ${idx + 1}`)}</strong>
                        <span>${att.content_type || 'application/octet-stream'} • ${formatAttachmentSize(att.size || 0)}</span>
                    </div>
                    <a class="form-button" href="data:${att.content_type || 'application/octet-stream'};base64,${att.data}" download="${escapeHtml(att.filename || `attachment-${idx + 1}`)}">
                        Download
                    </a>
                </div>
            `).join('');
            attachmentModal.classList.remove('hidden');
        }

        function closeAttachmentModal() {
            attachmentModal.classList.add('hidden');
            attachmentList.innerHTML = '';
        }

        function openTaskModal(index) {
            if (Number.isNaN(index)) {
                return;
            }
            const email = currentEmails[index];
            if (!email) {
                return;
            }

            // Populate customer autocomplete
            const populateCustomerAutocomplete = () => {
                if (!taskCustomerSelect) return;
                
                // Setup autocomplete
                setupAutocomplete('task-customer-select', 'task-customer-dropdown', 'task-customer-value', 'task-email');
                
                // Try to find and select matching customer
                const match = findCustomerByEmail(email.from || '');
                if (match) {
                    taskCustomerSelect.value = match.name || match.email_suffix || '';
                    const valueInput = document.getElementById('task-customer-value');
                    if (valueInput) {
                        valueInput.value = match.email_suffix || '';
                    }
                    // Auto-fill email
                    const storedEmail = (match.email_suffix || '').trim();
                    if (storedEmail.includes('@')) {
                        taskEmailInput.value = storedEmail;
                    } else {
                        taskEmailInput.value = extractEmailAddress(email.from || '');
                    }
                } else {
                    taskCustomerSelect.value = '';
                    const valueInput = document.getElementById('task-customer-value');
                    if (valueInput) {
                        valueInput.value = '';
                    }
                    taskEmailInput.value = extractEmailAddress(email.from || '');
                }
            };

            // Load customers if needed
            if (!customerCache || customerCache.length === 0) {
                loadCustomers(false).then(() => populateCustomerAutocomplete()).catch(() => {
                    populateCustomerAutocomplete();
                });
            } else {
                populateCustomerAutocomplete();
            }

            // Load task types for dropdown
            loadTaskTypesForDropdown();

            taskSequenceInput.value = email.sequence || 'N/A';
            if (taskDeadlineInput) {
                taskDeadlineInput.value = '';
            }
            // Set default value after types are loaded
            setTimeout(() => {
                if (taskTypesCache && taskTypesCache.length > 0) {
                    taskCatalogueSelect.value = taskTypesCache[0].name || '';
                }
            }, 100);
            
            // Clear rich text editor
            if (taskNotesEditor) {
                taskNotesEditor.setContents([]);
            }

            // Display attachments
            if (taskAttachmentsDiv) {
                if (Array.isArray(email.attachments) && email.attachments.length > 0) {
                    taskAttachmentsDiv.innerHTML = email.attachments.map((att, idx) => {
                        const contentType = att.content_type || 'application/octet-stream';
                        const isImage = contentType.startsWith('image/');
                        const isPDF = contentType === 'application/pdf' || (att.filename && att.filename.toLowerCase().endsWith('.pdf'));
                        const dataUrl = `data:${contentType};base64,${att.data}`;
                        const filename = escapeHtml(att.filename || `Attachment ${idx + 1}`);
                        const attachmentIndex = idx;
                        
                        return `
                            <div class="attachment-row" data-attachment-index="${idx}">
                                <div class="attachment-row-info">
                                    <strong>${filename}</strong>
                                    <span>${contentType} • ${formatAttachmentSize(att.size || 0)}</span>
                                </div>
                                <div class="attachment-actions">
                                    ${(isImage || isPDF) ? `<button class="form-button" onclick="openTaskAttachmentPreview(${attachmentIndex})" style="font-size: 12px;">View</button>` : ''}
                                    <a class="form-button" href="${dataUrl}" download="${escapeHtml(att.filename || `attachment-${idx + 1}`)}" style="font-size: 12px;">
                                        Download
                                    </a>
                                    <button class="form-button" onclick="removeTaskAttachment(${idx})" style="font-size: 12px; background-color: #dc3545; color: white;">X</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Store attachment data for preview and submission
                    if (!window.taskModalAttachments) {
                        window.taskModalAttachments = [];
                    }
                    window.taskModalAttachments = email.attachments;
                    window.taskModalEmailIndex = index;
                } else {
                    taskAttachmentsDiv.innerHTML = '<div style="padding: 10px; color: #666; font-style: italic;">No attachments</div>';
                }
            }

            taskModal.classList.remove('hidden');
        }

        function openTaskForCustomer(customerId) {
            const customer = (customerCache || []).find(c => c.id === customerId);
            if (!customer) {
                alert('Customer not found. Please refresh the customer list and try again.');
                return;
            }

            // Switch to Task view (right content). This will call loadTaskDisplay(),
            // which renders the inline task form (including the rich text editor) if needed.
            showTask();

            // Prefill the inline task form once it is available.
            // loadTaskDisplay() and renderTaskForm() are asynchronous (customers may need loading,
            // Quill editor needs time to attach), so we retry a few times.
            (function applyPrefill(retries) {
                const customerInput = document.getElementById('task-form-customer');
                const customerValueInput = document.getElementById('task-form-customer-value');
                const emailInput = document.getElementById('task-form-email');

                if (customerInput && customerValueInput && emailInput) {
                    customerInput.value = customer.name || customer.company_name || customer.email_suffix || '';
                    customerValueInput.value = customer.email_suffix || '';
                    const storedEmail = (customer.email_suffix || '').trim();
                    emailInput.value = storedEmail.includes('@') ? storedEmail : '';
                    return;
                }

                if (retries > 0) {
                    setTimeout(() => applyPrefill(retries - 1), 100);
                }
            })(20);
        }

        function closeTaskModal() {
            taskModal.classList.add('hidden');
            // Clear attachments display
            if (taskAttachmentsDiv) {
                taskAttachmentsDiv.innerHTML = '';
            }
            if (taskDeadlineInput) {
                taskDeadlineInput.value = '';
            }
            window.taskModalAttachments = [];
            window.taskModalEmailIndex = null;
        }

        function removeTaskAttachment(index) {
            if (!window.taskModalAttachments || !window.taskModalAttachments[index]) {
                return;
            }
            
            // Remove attachment from array
            window.taskModalAttachments.splice(index, 1);
            
            // Re-render attachments list
            const email = currentEmails[window.taskModalEmailIndex];
            if (!email) return;
            
            if (taskAttachmentsDiv) {
                if (window.taskModalAttachments.length > 0) {
                    taskAttachmentsDiv.innerHTML = window.taskModalAttachments.map((att, idx) => {
                        const contentType = att.content_type || 'application/octet-stream';
                        const isImage = contentType.startsWith('image/');
                        const isPDF = contentType === 'application/pdf' || (att.filename && att.filename.toLowerCase().endsWith('.pdf'));
                        const dataUrl = `data:${contentType};base64,${att.data}`;
                        const filename = escapeHtml(att.filename || `Attachment ${idx + 1}`);
                        
                        return `
                            <div class="attachment-row" data-attachment-index="${idx}">
                                <div class="attachment-row-info">
                                    <strong>${filename}</strong>
                                    <span>${contentType} • ${formatAttachmentSize(att.size || 0)}</span>
                                </div>
                                <div class="attachment-actions">
                                    ${(isImage || isPDF) ? `<button class="form-button" onclick="openTaskAttachmentPreview(${idx})" style="font-size: 12px;">View</button>` : ''}
                                    <a class="form-button" href="${dataUrl}" download="${escapeHtml(att.filename || `attachment-${idx + 1}`)}" style="font-size: 12px;">
                                        Download
                                    </a>
                                    <button class="form-button" onclick="removeTaskAttachment(${idx})" style="font-size: 12px; background-color: #dc3545; color: white;">X</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    taskAttachmentsDiv.innerHTML = '<div style="padding: 10px; color: #666; font-style: italic;">No attachments</div>';
                }
            }
        }

        function submitTask() {
            const catalogue = taskCatalogueSelect.value;
            // Get content from Quill editor
            let template = '';
            if (taskNotesEditor) {
                const delta = taskNotesEditor.getContents();
                template = taskNotesEditor.root.innerHTML;
            }
            const sequence = taskSequenceInput.value;
            const customerValueInput = document.getElementById('task-customer-value');
            const customerEmailSuffix = customerValueInput ? customerValueInput.value : '';
            const customer = taskCustomerSelect ? taskCustomerSelect.value : '';
            const email = taskEmailInput.value;
            const deadline = taskDeadlineInput ? (taskDeadlineInput.value || '').trim() : '';
            
            // Validate required fields
            if (!catalogue || catalogue === '') {
                alert('Please select a Type');
                return;
            }
            
            if (!template || template.trim() === '' || template === '<p><br></p>') {
                alert('Please enter Template content');
                return;
            }
            
            // Prepare task data
            const taskData = {
                sequence: sequence,
                customer: customer,
                email: email,
                catalogue: catalogue,
                template: template,
                attachments: window.taskModalAttachments || [],
                deadline: deadline || null
            };
            
            // Save to database
            fetch('/api/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(taskData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error saving task: ' + data.error);
                } else {
                    alert('Task saved successfully!');
                    closeTaskModal();
                    // Refresh task list if it's displayed
                    if (document.getElementById('task-list-content') && !document.getElementById('task-list-content').classList.contains('hidden')) {
                        loadTaskList();
                    }
                }
            })
            .catch(error => {
                alert('Error saving task: ' + error.message);
            });
        }

        function showTaskList(event) {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('send-mail-content').classList.add('hidden');
            document.getElementById('create-customer-content').classList.add('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('task-list-content').classList.remove('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('dropdown-list-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Task List';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            } else if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            loadTaskList();
        }

        let inlineTaskEditId = null;

        function formatDateForInput(dateStr) {
            if (!dateStr) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            const parsed = new Date(dateStr);
            if (Number.isNaN(parsed.getTime())) {
                return '';
            }
            const month = String(parsed.getMonth() + 1).padStart(2, '0');
            const day = String(parsed.getDate()).padStart(2, '0');
            return `${parsed.getFullYear()}-${month}-${day}`;
        }

        function escapeTextareaContent(value) {
            return (value || '').replace(/<\/textarea>/gi, '&lt;/textarea&gt;');
        }

        function getTaskTypeOptions(selectedValue) {
            const types = [...(taskTypesCache || [])].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            const options = types.map(type => {
                const name = type.name || '';
                const isSelected = name === selectedValue ? ' selected' : '';
                return `<option value="${escapeHtml(name)}"${isSelected}>${escapeHtml(name)}</option>`;
            }).join('');
            return `<option value="">-- Select Type --</option>${options}`;
        }

        function renderTaskRow(task, isEditing = false) {
            const attachments = task.attachments || [];
            const attachmentsText = attachments.map(att => att.filename || 'attachment').join(', ');
            const companyName = task.company_name || '';
            const source = task.source || '';
            const businessType = task.business_type || '';
            const createdAtDisplay = task.created_at ? escapeHtml(new Date(task.created_at).toLocaleString()) : '';
            const lastUpdatedDisplay = task.updated_at ? escapeHtml(new Date(task.updated_at).toLocaleString()) : '';
            const rowAttributes = [
                `id="task-row-${task.id}"`,
                `data-task-id="${task.id}"`,
                `data-sequence="${escapeHtml(task.sequence || '')}"`,
                `data-business_type="${escapeHtml(businessType)}"`,
                `data-customer="${escapeHtml(task.customer || '')}"`,
                `data-company_name="${escapeHtml(companyName)}"`,
                `data-email="${escapeHtml(task.email || '')}"`,
                `data-catalogue="${escapeHtml(task.catalogue || '')}"`,
                `data-template="${escapeHtml(task.template || '')}"`,
                `data-deadline="${escapeHtml(task.deadline || '')}"`,
                `data-created_at="${escapeHtml(task.created_at || '')}"`,
                `data-updated_at="${escapeHtml(task.updated_at || '')}"`,
                `data-source="${escapeHtml(source)}"`,
                `data-attachments="${escapeHtml(attachmentsText)}"`
            ].join(' ');

            if (!isEditing) {
                return `
                    <tr ${rowAttributes}>
                        <td>${escapeHtml(task.sequence || '')}</td>
                        <td>${escapeHtml(businessType)}</td>
                        <td>${escapeHtml(task.customer || '')}</td>
                        <td>${escapeHtml(companyName)}</td>
                        <td>${escapeHtml(task.email || '')}</td>
                        <td>${escapeHtml(task.catalogue || '')}</td>
                        <td class="task-template-cell" title="${escapeHtml(task.template || '')}">
                            ${task.template || ''}
                        </td>
                        <td>${task.deadline ? escapeHtml(task.deadline) : ''}</td>
                        <td>${createdAtDisplay}</td>
                        <td>${escapeHtml(source)}</td>
                        <td>${lastUpdatedDisplay}</td>
                        <td>${renderTaskAttachments(task)}</td>
                        <td>
                            <div class="task-actions">
                                <button class="form-button" onclick="openTaskEditModal(${task.id})" style="font-size: 12px; padding: 5px 10px;">Edit</button>
                                <button class="form-button" onclick="deleteTask(${task.id})" style="font-size: 12px; padding: 5px 10px; background-color: #dc3545; color: #ffffff;">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }

            const typeOptions = getTaskTypeOptions(task.catalogue || '');
            return `
                <tr class="task-editing-row" ${rowAttributes}>
                    <td>${escapeHtml(task.sequence || '')}</td>
                    <td>${escapeHtml(businessType)}</td>
                    <td><input type="text" class="inline-task-input" data-field="customer" value="${escapeHtml(task.customer || '')}"></td>
                    <td><input type="text" class="inline-task-input" data-field="company_name" value="${escapeHtml(companyName)}" readonly></td>
                    <td><input type="text" class="inline-task-input" data-field="email" value="${escapeHtml(task.email || '')}"></td>
                    <td>
                        <select class="inline-task-type-select" data-field="catalogue">
                            ${typeOptions}
                        </select>
                    </td>
                    <td>
                        <textarea class="inline-task-template-input" data-field="template" placeholder="Enter template...">${escapeTextareaContent(task.template || '')}</textarea>
                    </td>
                    <td><input type="date" class="inline-task-input" data-field="deadline" value="${formatDateForInput(task.deadline || '')}"></td>
                    <td>${createdAtDisplay}</td>
                    <td>${escapeHtml(source)}</td>
                    <td>${lastUpdatedDisplay}</td>
                    <td>${renderTaskAttachments(task)}</td>
                    <td>
                        <div class="task-actions">
                            <button class="form-button" style="font-size: 12px; padding: 5px 10px; background-color: #28a745; color: #ffffff;" onclick="saveTaskEdit(${task.id})">Save</button>
                            <button class="form-button" style="font-size: 12px; padding: 5px 10px; background-color: #6c757d; color: #ffffff;" onclick="cancelInlineTaskEdit()">Cancel</button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function refreshTaskRow(taskId, isEditing = false) {
            const tasks = window.taskListCache || [];
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            const row = document.querySelector(`#task-table-body tr[data-task-id="${taskId}"]`);
            if (!row) return;
            row.outerHTML = renderTaskRow(task, isEditing);
        }

        function loadTaskList() {
            const container = document.getElementById('task-list-container');
            if (!container) return;

            container.innerHTML = '<div class="loading">Loading tasks...</div>';

            fetch('/api/tasks')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        container.innerHTML = `<div class="message error">Error: ${escapeHtml(data.error)}</div>`;
                    } else {
                        const tasks = data.tasks || [];
                        window.taskListCache = tasks;
                        inlineTaskEditId = null;
                        if (tasks.length === 0) {
                            container.innerHTML = '<div class="message info">No tasks found.</div>';
                        } else {
                            const tableHtml = `
                                <div style="margin-bottom: 10px; font-family: Arial, sans-serif; font-size: 14px;">
                                    <strong>Filters:</strong> type to filter rows
                                </div>
                                <table class="customer-table task-table">
                                    <thead>
                                        <tr>
                                            <th>Sequence</th>
                                            <th>Business Type</th>
                                            <th>Customer</th>
                                            <th>Company Name</th>
                                            <th>Email</th>
                                            <th>Type</th>
                                            <th>Template</th>
                                            <th>Deadline</th>
                                            <th>Created At</th>
                                            <th>Source</th>
                                            <th>Last Updated</th>
                                            <th>Attachments</th>
                                            <th>Delete</th>
                                        </tr>
                                        <tr>
                                            <th><input type="text" class="task-filter-input" data-field="sequence" placeholder="Filter sequence"></th>
                                            <th><input type="text" class="task-filter-input" data-field="business_type" placeholder="Filter business type"></th>
                                            <th><input type="text" class="task-filter-input" data-field="customer" placeholder="Filter customer"></th>
                                            <th><input type="text" class="task-filter-input" data-field="company_name" placeholder="Filter company name"></th>
                                            <th><input type="text" class="task-filter-input" data-field="email" placeholder="Filter email"></th>
                                            <th><input type="text" class="task-filter-input" data-field="catalogue" placeholder="Filter type"></th>
                                            <th><input type="text" class="task-filter-input" data-field="template" placeholder="Filter template"></th>
                                            <th><input type="text" class="task-filter-input" data-field="deadline" placeholder="Filter deadline"></th>
                                            <th><input type="text" class="task-filter-input" data-field="created_at" placeholder="Filter date"></th>
                                            <th><input type="text" class="task-filter-input" data-field="source" placeholder="Filter source"></th>
                                            <th><input type="text" class="task-filter-input" data-field="updated_at" placeholder="Filter last updated"></th>
                                            <th><input type="text" class="task-filter-input" data-field="attachments" placeholder="Filter attachments"></th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="task-table-body">
                                        ${tasks.map(task => renderTaskRow(task)).join('')}
                                    </tbody>
                                </table>
                            `;
                            container.innerHTML = tableHtml;

                            // Attach filter handlers
                            const filterInputs = container.querySelectorAll('.task-filter-input');
                            filterInputs.forEach(input => {
                                input.addEventListener('input', applyTaskTableFilters);
                            });
                        }
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="message error">Error loading tasks: ${escapeHtml(error.message)}</div>`;
                });
        }

        function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }
            
            fetch(`/api/tasks/${taskId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error deleting task: ' + data.error);
                } else {
                    // Reload task list
                    loadTaskList();
                }
            })
            .catch(error => {
                alert('Error deleting task: ' + error.message);
            });
        }

        function renderEditTaskAttachments(attachments) {
            if (!editTaskAttachmentsDiv) return;
            if (!attachments || attachments.length === 0) {
                editTaskAttachmentsDiv.innerHTML = '<div style="padding: 10px; color: #666;">No attachments</div>';
                return;
            }
            editTaskAttachmentsDiv.innerHTML = attachments.map((att, idx) => {
                const filename = escapeHtml(att.filename || `attachment-${idx + 1}`);
                const contentType = att.content_type || 'application/octet-stream';
                const dataUrl = att.data ? `data:${contentType};base64,${att.data}` : null;
                return `
                    <div class="task-attachment-entry">
                        <div class="task-attachment-info">
                            <div class="task-attachment-filename">${filename}</div>
                            <div class="task-attachment-size" style="font-size: 12px; color: #666;">${contentType}</div>
                        </div>
                        <div class="task-attachment-actions" style="display: flex; gap: 8px;">
                            ${dataUrl ? `<a class="form-button" style="font-size: 12px;" href="${dataUrl}" download="${filename}">Download</a>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function populateEditTaskTypeSelect(selectedValue) {
            if (!editTaskTypeSelect) return;
            const sortedTypes = [...(taskTypesCache || [])].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            const options = sortedTypes.map(type => 
                `<option value="${escapeHtml(type.name)}">${escapeHtml(type.name)}</option>`
            ).join('');
            editTaskTypeSelect.innerHTML = `<option value="">-- Select Type --</option>${options}`;
            editTaskTypeSelect.value = selectedValue || '';
        }

        function cancelInlineTaskEdit() {
            if (!inlineTaskEditId) return;
            refreshTaskRow(inlineTaskEditId, false);
            inlineTaskEditId = null;
        }

        function openTaskEditModal(taskId) {
            const tasks = window.taskListCache || [];
            const task = tasks.find(t => t.id === taskId);
            if (!task) {
                alert('Task not found');
                return;
            }
            ensureTaskTypesLoaded().then(() => {
                if (inlineTaskEditId && inlineTaskEditId !== taskId) {
                    cancelInlineTaskEdit();
                }
                inlineTaskEditId = taskId;
                refreshTaskRow(taskId, true);
                const textarea = document.querySelector(`#task-table-body tr[data-task-id="${taskId}"] .inline-task-template-input`);
                if (textarea) {
                    textarea.focus();
                }
            }).catch(() => {
                alert('Unable to load task types');
            });
        }

        function closeEditTaskModal() {
            cancelInlineTaskEdit();
            if (editTaskModal) {
                editTaskModal.classList.add('hidden');
                editTaskModal.dataset.taskId = '';
            }
        }

        function saveTaskEdit(taskId = null) {
            const inlineId = typeof taskId === 'number' ? taskId : inlineTaskEditId;
            if (inlineId) {
                const inlineRow = document.querySelector(`#task-table-body tr[data-task-id="${inlineId}"]`);
                if (inlineRow && inlineRow.classList.contains('task-editing-row')) {
                    const typeSelect = inlineRow.querySelector('.inline-task-type-select');
                    const templateInput = inlineRow.querySelector('.inline-task-template-input');
                    const emailInput = inlineRow.querySelector('.inline-task-input[data-field="email"]');
                    const customerInput = inlineRow.querySelector('.inline-task-input[data-field="customer"]');
                    const deadlineInput = inlineRow.querySelector('.inline-task-input[data-field="deadline"]');

                    const catalogue = typeSelect ? typeSelect.value : '';
                    if (!catalogue) {
                        alert('Please select a Type');
                        return;
                    }
                    const template = templateInput ? templateInput.value.trim() : '';
                    if (!template || template === '<p><br></p>') {
                        alert('Please enter Template content');
                        return;
                    }

                    const payload = {
                        catalogue,
                        template,
                        email: emailInput ? emailInput.value.trim() : '',
                        customer: customerInput ? customerInput.value.trim() : '',
                        deadline: deadlineInput ? (deadlineInput.value || null) : null
                    };

                    fetch(`/api/tasks/${inlineId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Error updating task: ' + data.error);
                        } else {
                            alert('Task updated successfully!');
                            inlineTaskEditId = null;
                            loadTaskList();
                        }
                    })
                    .catch(error => {
                        alert('Error updating task: ' + error.message);
                    });
                    return;
                }
            }

            if (!editTaskModal) {
                alert('No task selected');
                return;
            }

            const modalTaskId = editTaskModal.dataset.taskId;
            if (!modalTaskId) {
                alert('No task selected');
                return;
            }
            const catalogue = editTaskTypeSelect ? editTaskTypeSelect.value : '';
            if (!catalogue) {
                alert('Please select a Type');
                return;
            }
            const template = editTaskEditor ? editTaskEditor.root.innerHTML : '';
            if (!template || template.trim() === '' || template === '<p><br></p>') {
                alert('Please enter Template content');
                return;
            }
            const payload = {
                catalogue,
                template,
                email: editTaskEmailInput ? editTaskEmailInput.value.trim() : '',
                customer: editTaskCustomerInput ? editTaskCustomerInput.value.trim() : '',
                deadline: editTaskDeadlineInput ? (editTaskDeadlineInput.value || null) : null
            };
            fetch(`/api/tasks/${modalTaskId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error updating task: ' + data.error);
                } else {
                    alert('Task updated successfully!');
                    closeEditTaskModal();
                    loadTaskList();
                }
            })
            .catch(error => {
                alert('Error updating task: ' + error.message);
            });
        }

        function applyTaskTableFilters() {
            const container = document.getElementById('task-list-container');
            const tbody = container ? container.querySelector('#task-table-body') : null;
            if (!tbody) return;

            const filters = {};
            const filterInputs = container.querySelectorAll('.task-filter-input');
            filterInputs.forEach(input => {
                const field = input.dataset.field;
                const value = (input.value || '').trim().toLowerCase();
                if (field) {
                    filters[field] = value;
                }
            });

            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.forEach(row => {
                let visible = true;
                for (const [field, value] of Object.entries(filters)) {
                    if (!value) continue;
                    const dataValue = (row.dataset[field] || '').toLowerCase();
                    if (!dataValue.includes(value)) {
                        visible = false;
                        break;
                    }
                }
                row.style.display = visible ? '' : 'none';
            });
        }

        function isImageContent(filename, contentType) {
            const name = (filename || '').toLowerCase();
            const type = (contentType || '').toLowerCase();
            return type.startsWith('image/') || /\.(png|jpe?g|gif|bmp|webp|svg)$/.test(name);
        }

        function isPDFContent(filename, contentType) {
            const name = (filename || '').toLowerCase();
            const type = (contentType || '').toLowerCase();
            return type.includes('pdf') || name.endsWith('.pdf');
        }

        function isTextContent(filename, contentType) {
            const name = (filename || '').toLowerCase();
            const type = (contentType || '').toLowerCase();
            return type.startsWith('text/') || /\.(txt|text|log|md|markdown|json|xml|html|htm|css|js|ts|py|java|cpp|c|h|sh|bat|cmd)$/.test(name);
        }

        function renderTaskAttachments(task) {
            const attachments = task.attachments || [];
            if (attachments.length === 0) {
                return '';
            }
            return attachments.map((att, idx) => {
                const filename = escapeHtml(att.filename || 'attachment');
                const caption = escapeHtml(att.caption || att.filename || 'Attachment');
                const contentType = att.content_type || 'application/octet-stream';
                const isImage = isImageContent(att.filename, contentType);
                const isPDF = isPDFContent(att.filename, contentType);
                const isText = isTextContent(att.filename, contentType);
                const isViewable = Boolean(isImage || isPDF || isText);
                const thumbHtml = isImage
                    ? `<img src="data:${contentType};base64,${att.data}" alt="${filename}" class="task-attachment-thumb" onclick="openTaskListAttachment(${task.id}, ${idx})">`
                    : `<div class="task-attachment-thumb" style="display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;" onclick="openTaskListAttachment(${task.id}, ${idx})">📄</div>`;
                const downloadLink = `<a class="attachment-download-link" href="data:${contentType};base64,${att.data}" download="${escapeHtml(att.filename || `attachment-${idx + 1}`)}" title="Download">📎</a>`;
                return `
                    <div class="task-attachment-entry" style="display:flex;align-items:flex-start;gap:6px;margin-bottom:4px;">
                        ${thumbHtml}
                        <div style="display:flex;flex-direction:column;gap:2px;max-width:140px;">
                            <span class="attachment-caption-text" style="font-size:11px;cursor:pointer;color:#0066cc;" onclick="openTaskListAttachment(${task.id}, ${idx})">${caption}</span>
                            <div>
                                ${downloadLink}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openTaskListAttachment(taskId, attachmentIndex) {
            const tasks = window.taskListCache || [];
            const task = tasks.find(t => t.id === taskId);
            if (!task) {
                return;
            }
            const attachments = task.attachments || [];
            const att = attachments[attachmentIndex];
            if (!att) {
                return;
            }
            const contentType = att.content_type || 'application/octet-stream';
            const filename = att.filename || `Attachment ${attachmentIndex + 1}`;
            openPreviewModal(att.data || '', contentType, filename);
        }

        function openCustomerAttachment(customerId, attachmentIndex) {
            const customers = customerCache || [];
            const customer = customers.find(c => c.id === customerId);
            if (!customer || !customer.attachments) {
                return;
            }
            let attachments;
            try {
                attachments = JSON.parse(customer.attachments) || [];
            } catch (e) {
                console.error('Error parsing customer attachments for preview:', e);
                return;
            }
            const att = attachments[attachmentIndex];
            if (!att) {
                return;
            }
            const contentType = att.content_type || 'application/octet-stream';
            const filename = att.filename || `Attachment ${attachmentIndex + 1}`;
            openPreviewModal(att.data || '', contentType, filename);
        }

        function openTaskAttachmentPreview(attachmentIndex) {
            if (!window.taskModalAttachments || !window.taskModalAttachments[attachmentIndex]) {
                return;
            }
            
            const att = window.taskModalAttachments[attachmentIndex];
            const contentType = att.content_type || 'application/octet-stream';
            const filename = att.filename || `Attachment ${attachmentIndex + 1}`;
            
            openPreviewModal(att.data || '', contentType, filename);
        }

        function openTaskFormAttachmentPreview(attachmentIndex) {
            if (!window.taskFormAttachments || !window.taskFormAttachments[attachmentIndex]) {
                return;
            }

            const att = window.taskFormAttachments[attachmentIndex];
            const contentType = att.content_type || 'application/octet-stream';
            const filename = att.filename || `Attachment ${attachmentIndex + 1}`;

            openPreviewModal(att.data || '', contentType, filename);
        }

        function revokePreviewObjectUrl() {
            if (window.currentPreviewObjectUrl) {
                try {
                    URL.revokeObjectURL(window.currentPreviewObjectUrl);
                } catch (err) {
                    console.warn('Error revoking preview URL:', err);
                }
                window.currentPreviewObjectUrl = null;
            }
        }

        function createObjectUrlFromBase64(base64Data, contentType) {
            try {
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: contentType || 'application/octet-stream' });
                return URL.createObjectURL(blob);
            } catch (error) {
                console.warn('Failed to convert base64 to object URL:', error);
                return null;
            }
        }

        function openPreviewModal(base64Data, contentType, filename) {
            if (!previewModal || !previewModalContent || !previewModalTitle) {
                return;
            }

            revokePreviewObjectUrl();
            
            const isImage = isImageContent(filename, contentType);
            const isPDF = isPDFContent(filename, contentType);
            const isText = isTextContent(filename, contentType);
            
            previewModalTitle.textContent = filename || 'Preview';
            
            let previewContent = '';
            const dataUrl = `data:${contentType};base64,${base64Data}`;
            if (isImage) {
                previewContent = `<img src="${dataUrl}" alt="${escapeHtml(filename || 'image')}" id="preview-image">`;
            } else if (isPDF) {
                const pdfContentType = contentType && contentType.toLowerCase().includes('pdf')
                    ? contentType
                    : 'application/pdf';
                const objectUrl = createObjectUrlFromBase64(base64Data, pdfContentType);
                if (objectUrl) {
                    window.currentPreviewObjectUrl = objectUrl;
                    previewContent = `<iframe src="${objectUrl}" type="${pdfContentType}" style="width: 100%; height: 100%; border: none; display: block; position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></iframe>`;
                } else {
                    previewContent = `<p>Unable to preview PDF. <a href="${dataUrl}" download="${escapeHtml(filename || 'document.pdf')}">Download PDF</a></p>`;
                }
            } else if (isText) {
                try {
                    // Decode base64 text content
                    const textContent = atob(base64Data);
                    // Escape HTML but preserve line breaks
                    const escapedText = escapeHtml(textContent).replace(/\n/g, '<br>').replace(/\r/g, '');
                    previewContent = `<pre style="white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace; padding: 15px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; max-height: 80vh; overflow: auto; margin: 0;">${escapedText}</pre>`;
                } catch (error) {
                    console.warn('Failed to decode text content:', error);
                    previewContent = `<p>Unable to preview text file. <a href="${dataUrl}" download="${escapeHtml(filename)}">Download file</a></p>`;
                }
            } else {
                previewContent = `<p>Preview not available for this file type. <a href="${dataUrl}" download="${escapeHtml(filename)}">Download file</a></p>`;
            }
            
            previewModalContent.innerHTML = previewContent;
            
            // Set container style based on content type
            if (isImage) {
                previewModalContent.style.alignItems = 'center';
                previewModalContent.style.justifyContent = 'center';
                previewModalContent.style.overflow = 'auto';
                previewModalContent.style.cursor = 'grab';
                initImageDrag();
            } else if (isPDF) {
                previewModalContent.style.alignItems = 'stretch';
                previewModalContent.style.justifyContent = 'stretch';
                previewModalContent.style.overflow = 'hidden';
                previewModalContent.style.cursor = 'default';
                previewModalContent.style.position = 'relative';
                previewModalContent.style.width = '100%';
                previewModalContent.style.height = '100%';
            } else if (isText) {
                previewModalContent.style.alignItems = 'flex-start';
                previewModalContent.style.justifyContent = 'flex-start';
                previewModalContent.style.overflow = 'auto';
                previewModalContent.style.cursor = 'default';
                previewModalContent.style.padding = '20px';
            } else {
                previewModalContent.style.alignItems = 'center';
                previewModalContent.style.justifyContent = 'center';
                previewModalContent.style.overflow = 'auto';
                previewModalContent.style.cursor = 'default';
            }
            
            previewModal.classList.remove('hidden');
        }

        function initImageDrag() {
            const img = document.getElementById('preview-image');
            const container = previewModalContent;
            if (!img || !container) return;
            
            let isDragging = false;
            let startX, startY;
            let imgX = 0, imgY = 0;
            let scale = 1;
            
            // Reset image position and scale
            img.style.transform = 'translate(0, 0) scale(1)';
            img.style.position = 'relative';
            img.style.display = 'block';
            img.style.margin = 'auto';
            container.style.overflow = 'auto';
            imgX = 0;
            imgY = 0;
            scale = 1;
            
            // Mouse events
            img.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return; // Only left mouse button
                isDragging = true;
                img.classList.add('dragging');
                startX = e.pageX - imgX;
                startY = e.pageY - imgY;
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                imgX = e.pageX - startX;
                imgY = e.pageY - startY;
                img.style.transform = `translate(${imgX}px, ${imgY}px) scale(${scale})`;
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    img.classList.remove('dragging');
                }
            });
            
            // Touch events for mobile
            img.addEventListener('touchstart', (e) => {
                if (e.touches.length !== 1) return;
                isDragging = true;
                img.classList.add('dragging');
                const touch = e.touches[0];
                startX = touch.pageX - imgX;
                startY = touch.pageY - imgY;
                e.preventDefault();
            });
            
            document.addEventListener('touchmove', (e) => {
                if (!isDragging || e.touches.length !== 1) return;
                const touch = e.touches[0];
                imgX = touch.pageX - startX;
                imgY = touch.pageY - startY;
                img.style.transform = `translate(${imgX}px, ${imgY}px) scale(${scale})`;
                e.preventDefault();
            });
            
            document.addEventListener('touchend', () => {
                if (isDragging) {
                    isDragging = false;
                    img.classList.remove('dragging');
                }
            });
            
            // Zoom with mouse wheel
            img.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                scale = Math.max(0.5, Math.min(5, scale * delta));
                img.style.transform = `translate(${imgX}px, ${imgY}px) scale(${scale})`;
            }, { passive: false });
            
            // Double click to reset
            img.addEventListener('dblclick', () => {
                imgX = 0;
                imgY = 0;
                scale = 1;
                img.style.transform = 'translate(0, 0) scale(1)';
            });
        }

        function closePreviewModal() {
            if (previewModal) {
                previewModal.classList.add('hidden');
            }
            if (previewModalContent) {
                previewModalContent.innerHTML = '';
            }
            revokePreviewObjectUrl();
        }

        function formatText(command) {
            document.execCommand(command, false, null);
            const remarkDiv = document.getElementById('customer-remark');
            if (remarkDiv) {
                remarkDiv.focus();
            }
        }

        // Country dropdown functions
        function filterCountries() {
            const input = document.getElementById('customer-country');
            const dropdown = document.getElementById('country-dropdown');
            if (!input || !dropdown) return;
            
            // Ensure countries are loaded
            if (COUNTRIES.length === 0) {
                fetch('/api/countries')
                    .then(response => response.json())
                    .then(countries => {
                        // Alphabetical list for Create Customer dropdown
                        COUNTRIES = countries
                            .map(c => c.name)
                            .sort((a, b) => (a || '').localeCompare(b || ''));
                        filterCountries(); // Retry after loading
                    })
                    .catch(error => {
                        console.error('Error loading countries:', error);
                    });
                return;
            }
            
            const searchTerm = input.value.toLowerCase().trim();
            const filtered = COUNTRIES.filter(country => 
                country.toLowerCase().includes(searchTerm)
            ).slice(0, 10); // Show max 10 results
            
            if (filtered.length === 0 || searchTerm === '') {
                dropdown.classList.add('hidden');
                return;
            }
            
            dropdown.innerHTML = filtered.map(country => 
                `<div class="country-dropdown-item" onclick="selectCountry('${country.replace(/'/g, "\\'")}')">${escapeHtml(country)}</div>`
            ).join('');
            dropdown.classList.remove('hidden');
        }

        function showCountryDropdown() {
            const input = document.getElementById('customer-country');
            const dropdown = document.getElementById('country-dropdown');
            if (!input || !dropdown) return;
            
            // Ensure countries are loaded
            if (COUNTRIES.length === 0) {
                fetch('/api/countries')
                    .then(response => response.json())
                    .then(countries => {
                        // Alphabetical list for Create Customer dropdown
                        COUNTRIES = countries
                            .map(c => c.name)
                            .sort((a, b) => (a || '').localeCompare(b || ''));
                        showCountryDropdown(); // Retry after loading
                    })
                    .catch(error => {
                        console.error('Error loading countries:', error);
                    });
                return;
            }
            
            if (input.value.trim() === '') {
                // Show full alphabetically sorted list when field is empty and clicked
                const allCountries = COUNTRIES;
                dropdown.innerHTML = allCountries.map(country => 
                    `<div class="country-dropdown-item" onclick="selectCountry('${country.replace(/'/g, "\\'")}')">${escapeHtml(country)}</div>`
                ).join('');
                dropdown.classList.remove('hidden');
            } else {
                filterCountries();
            }
        }

        function hideCountryDropdown() {
            const dropdown = document.getElementById('country-dropdown');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
        }

        function selectCountry(country) {
            const input = document.getElementById('customer-country');
            if (input) {
                input.value = country;
            }
            hideCountryDropdown();
        }

        // Customer Sources Management Functions
        let customerSourcesCache = [];

        function toggleCustomerSourceDropdown() {
            const content = document.getElementById('customer-source-dropdown-content');
            const icon = document.getElementById('customer-source-dropdown-icon');
            if (!content || !icon) return;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(90deg)';
                loadCustomerSources();
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function loadCustomerSources() {
            fetch('/api/customer-sources')
                .then(response => response.json())
                .then(sources => {
                    customerSourcesCache = sources;
                    renderCustomerSourcesList(sources);
                    updateCustomerSourceDropdown(sources);
                })
                .catch(error => {
                    console.error('Error loading customer sources:', error);
                    const container = document.getElementById('customer-sources-list');
                    if (container) {
                        container.innerHTML = '<div style="padding: 20px; color: #dc3545;">Error loading customer sources</div>';
                    }
                });
        }

        let currentCustomerSourceDragId = null;

        function renderCustomerSourcesList(sources) {
            const container = document.getElementById('customer-sources-list');
            if (!container) return;
            
            if (!sources || sources.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No customer sources found. Add one above.</div>';
                return;
            }
            
            // Sort by display_order
            const sortedSources = [...sources].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            
            container.innerHTML = sortedSources.map(source => `
                <div class="task-type-item" draggable="true" 
                     ondragstart="currentCustomerSourceDragId = ${source.id}; event.dataTransfer.effectAllowed = 'move';" 
                     ondragover="event.preventDefault(); event.dataTransfer.dropEffect = 'move';" 
                     ondrop="handleCustomerSourceDrop(event, ${source.id})" 
                     ondragenter="event.preventDefault(); this.style.backgroundColor = '#e0e0e0';" 
                     ondragleave="this.style.backgroundColor = '';" 
                     style="padding: 10px; margin-bottom: 5px; border: 1px solid #ddd; background-color: #f9f9f9; cursor: move; display: flex; align-items: center; gap: 10px;">
                    <span style="cursor: move; user-select: none;">☰</span>
                    <input type="text" id="customer-source-name-${source.id}" value="${escapeHtml(source.name)}" 
                           style="flex: 1; padding: 5px; border: 1px solid #000000;" 
                           onblur="updateCustomerSource(${source.id})">
                    <button class="form-button" onclick="deleteCustomerSource(${source.id})" style="padding: 5px 10px; font-size: 12px; background-color: #dc3545; color: white;">Delete</button>
                </div>
            `).join('');
        }

        function showCustomerSourceSuggestions() {
            const input = document.getElementById('new-customer-source-input');
            const suggestionsDiv = document.getElementById('customer-source-suggestions');
            const warningDiv = document.getElementById('customer-source-duplicate-warning');
            
            if (!input || !suggestionsDiv) return;
            
            const query = input.value.trim().toLowerCase();
            
            if (!query) {
                suggestionsDiv.classList.add('hidden');
                warningDiv.style.display = 'none';
                return;
            }
            
            // Check for duplicates
            const existingSources = customerSourcesCache || [];
            const isDuplicate = existingSources.some(source => 
                source.name.toLowerCase() === query
            );
            
            if (isDuplicate) {
                suggestionsDiv.classList.add('hidden');
                warningDiv.textContent = 'This customer source already exists!';
                warningDiv.style.display = 'block';
                input.style.borderColor = '#dc3545';
                return;
            } else {
                warningDiv.style.display = 'none';
                input.style.borderColor = '#000000';
            }
            
            // Show similar suggestions
            const similar = existingSources
                .filter(source => source.name.toLowerCase().includes(query))
                .slice(0, 5);
            
            if (similar.length === 0) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            
            suggestionsDiv.innerHTML = similar.map(source => 
                `<div class="country-dropdown-item" onclick="selectCustomerSourceSuggestion('${source.name.replace(/'/g, "\\'")}')">${escapeHtml(source.name)}</div>`
            ).join('');
            suggestionsDiv.classList.remove('hidden');
        }

        function hideCustomerSourceSuggestions() {
            const suggestionsDiv = document.getElementById('customer-source-suggestions');
            if (suggestionsDiv) {
                suggestionsDiv.classList.add('hidden');
            }
        }

        function selectCustomerSourceSuggestion(name) {
            const input = document.getElementById('new-customer-source-input');
            if (input) {
                input.value = name;
            }
            hideCustomerSourceSuggestions();
            showCustomerSourceSuggestions(); // Re-check for duplicates
        }

        function addCustomerSource() {
            const input = document.getElementById('new-customer-source-input');
            const warningDiv = document.getElementById('customer-source-duplicate-warning');
            if (!input) return;
            
            const name = input.value.trim();
            if (!name) {
                alert('Customer source name cannot be empty');
                return;
            }
            
            // Check for duplicates before submitting
            const existingSources = customerSourcesCache || [];
            const isDuplicate = existingSources.some(source => 
                source.name.toLowerCase() === name.toLowerCase()
            );
            
            if (isDuplicate) {
                warningDiv.textContent = 'This customer source already exists!';
                warningDiv.style.display = 'block';
                input.style.borderColor = '#dc3545';
                input.focus();
                return;
            }
            
            fetch('/api/customer-sources', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    if (data.error.includes('already exists')) {
                        warningDiv.textContent = 'This customer source already exists!';
                        warningDiv.style.display = 'block';
                        input.style.borderColor = '#dc3545';
                        input.focus();
                    } else {
                        alert('Error: ' + data.error);
                    }
                } else {
                    input.value = '';
                    warningDiv.style.display = 'none';
                    input.style.borderColor = '#000000';
                    hideCustomerSourceSuggestions();
                    loadCustomerSources();
                    setTimeout(() => {
                        const suggestionsDiv = document.getElementById('customer-source-suggestions');
                        if (suggestionsDiv) {
                            suggestionsDiv.classList.add('hidden');
                        }
                    }, 100);
                }
            })
            .catch(error => {
                alert('Error adding customer source: ' + error.message);
            });
        }

        function updateCustomerSource(sourceId) {
            const nameInput = document.getElementById(`customer-source-name-${sourceId}`);
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Customer source name cannot be empty');
                loadCustomerSources(); // Reload to reset
                return;
            }
            
            // Find current source to preserve display_order
            const currentSource = customerSourcesCache.find(s => s.id === sourceId);
            if (!currentSource) {
                loadCustomerSources();
                return;
            }
            
            fetch(`/api/customer-sources/${sourceId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    display_order: currentSource.display_order || 0
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    loadCustomerSources(); // Reload to reset
                } else {
                    loadCustomerSources();
                }
            })
            .catch(error => {
                alert('Error updating customer source: ' + error.message);
                loadCustomerSources(); // Reload to reset
            });
        }

        function deleteCustomerSource(sourceId) {
            if (!confirm('Are you sure you want to delete this customer source?')) {
                return;
            }
            
            fetch(`/api/customer-sources/${sourceId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    loadCustomerSources();
                }
            })
            .catch(error => {
                alert('Error deleting customer source: ' + error.message);
            });
        }

        function handleCustomerSourceDrop(event, targetId) {
            event.preventDefault();
            if (!currentCustomerSourceDragId || currentCustomerSourceDragId === targetId) {
                currentCustomerSourceDragId = null;
                return;
            }
            
            const fromIndex = customerSourcesCache.findIndex(s => s.id === currentCustomerSourceDragId);
            const toIndex = customerSourcesCache.findIndex(s => s.id === targetId);
            
            if (fromIndex === -1 || toIndex === -1) {
                currentCustomerSourceDragId = null;
                return;
            }
            
            // Reorder in memory
            const sortedSources = [...customerSourcesCache].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            const fromIndexSorted = sortedSources.findIndex(s => s.id === currentCustomerSourceDragId);
            const toIndexSorted = sortedSources.findIndex(s => s.id === targetId);
            
            const [moved] = sortedSources.splice(fromIndexSorted, 1);
            sortedSources.splice(toIndexSorted, 0, moved);
            
            // Re-assign display_order sequentially
            sortedSources.forEach((source, index) => {
                source.display_order = index + 1;
            });
            
            // Persist all updated orders
            Promise.all(sortedSources.map(source => 
                fetch(`/api/customer-sources/${source.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: source.name,
                        display_order: source.display_order
                    })
                })
            ))
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(results => {
                if (results.some(r => r.error)) {
                    alert('Error updating order');
                } else {
                    loadCustomerSources();
                }
            })
            .catch(error => {
                alert('Error reordering customer sources: ' + error.message);
            })
            .finally(() => {
                currentCustomerSourceDragId = null;
            });
        }

        function updateCustomerSourceDropdown(sources) {
            // Sort by display_order
            const sortedSources = [...sources].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            
            // Update CUSTOMER_SOURCES array for the source input field
            CUSTOMER_SOURCES = sortedSources.map(s => s.name);
            
            // If source dropdown is visible, refresh it
            const sourceInput = document.getElementById('customer-source');
            const sourceDropdown = document.getElementById('customer-source-dropdown');
            if (sourceInput && sourceDropdown && !sourceDropdown.classList.contains('hidden')) {
                filterCustomerSources();
            }
        }

        // Toggle for customer business type dropdown list section
        function toggleCustomerBusinessTypeDropdown() {
            const header = document.getElementById('customer-business-type-dropdown-header');
            const content = document.getElementById('customer-business-type-dropdown-content');
            const icon = document.getElementById('customer-business-type-dropdown-icon');
            if (!header || !content || !icon) return;
            
            if (content.style.display === 'none' || !content.style.display) {
                content.style.display = 'block';
                icon.textContent = '▼';
                icon.style.transform = 'rotate(90deg)';
                loadCustomerBusinessTypes();
            } else {
                content.style.display = 'none';
                icon.textContent = '▶';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function loadCustomerBusinessTypes() {
            fetch('/api/customer-business-types')
                .then(response => response.json())
                .then(types => {
                    customerBusinessTypesCache = types;
                    renderCustomerBusinessTypesList(types);
                    updateCustomerBusinessTypeDropdown(types);
                })
                .catch(error => {
                    console.error('Error loading customer business types:', error);
                    const container = document.getElementById('customer-business-types-list');
                    if (container) {
                        container.innerHTML = '<div style="padding: 20px; color: #dc3545;">Error loading customer business types</div>';
                    }
                });
        }

        let currentCustomerBusinessTypeDragId = null;

        function renderCustomerBusinessTypesList(types) {
            const container = document.getElementById('customer-business-types-list');
            if (!container) return;
            
            if (!types || types.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No customer business types found. Add one above.</div>';
                return;
            }
            
            // Sort by display_order
            const sortedTypes = [...types].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            
            container.innerHTML = sortedTypes.map(type => `
                <div class="task-type-item" draggable="true" 
                     ondragstart="currentCustomerBusinessTypeDragId = ${type.id}; event.dataTransfer.effectAllowed = 'move';" 
                     ondragover="event.preventDefault(); event.dataTransfer.dropEffect = 'move';" 
                     ondrop="handleCustomerBusinessTypeDrop(event, ${type.id})" 
                     ondragenter="event.preventDefault(); this.style.backgroundColor = '#e0e0e0';" 
                     ondragleave="this.style.backgroundColor = '';" 
                     style="padding: 10px; margin-bottom: 5px; border: 1px solid #ddd; background-color: #f9f9f9; cursor: move; display: flex; align-items: center; gap: 10px;">
                    <span style="cursor: move; user-select: none;">☰</span>
                    <input type="text" id="customer-business-type-name-${type.id}" value="${escapeHtml(type.name)}" 
                           style="flex: 1; padding: 5px; border: 1px solid #000000;" 
                           onblur="updateCustomerBusinessType(${type.id})">
                    <button class="form-button" onclick="deleteCustomerBusinessType(${type.id})" style="padding: 5px 10px; font-size: 12px; background-color: #dc3545; color: white;">Delete</button>
                </div>
            `).join('');
        }

        function showCustomerBusinessTypeSuggestions() {
            const input = document.getElementById('new-customer-business-type-input');
            const suggestionsDiv = document.getElementById('customer-business-type-suggestions');
            const warningDiv = document.getElementById('customer-business-type-duplicate-warning');
            
            if (!input || !suggestionsDiv) return;
            
            const query = input.value.trim().toLowerCase();
            
            if (!query) {
                suggestionsDiv.classList.add('hidden');
                warningDiv.style.display = 'none';
                return;
            }
            
            // Check for duplicates
            const existingTypes = customerBusinessTypesCache || [];
            const isDuplicate = existingTypes.some(type => 
                type.name.toLowerCase() === query
            );
            
            if (isDuplicate) {
                suggestionsDiv.classList.add('hidden');
                warningDiv.textContent = 'This customer business type already exists!';
                warningDiv.style.display = 'block';
                input.style.borderColor = '#dc3545';
                return;
            } else {
                warningDiv.style.display = 'none';
                input.style.borderColor = '#000000';
            }
            
            // Show similar suggestions
            const similar = existingTypes
                .filter(type => type.name.toLowerCase().includes(query))
                .slice(0, 5);
            
            if (similar.length === 0) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            
            suggestionsDiv.innerHTML = similar.map(type => 
                `<div class="country-dropdown-item" onclick="selectCustomerBusinessTypeSuggestion('${type.name.replace(/'/g, "\\'")}')">${escapeHtml(type.name)}</div>`
            ).join('');
            suggestionsDiv.classList.remove('hidden');
        }

        function hideCustomerBusinessTypeSuggestions() {
            const suggestionsDiv = document.getElementById('customer-business-type-suggestions');
            if (suggestionsDiv) {
                suggestionsDiv.classList.add('hidden');
            }
        }

        function selectCustomerBusinessTypeSuggestion(name) {
            const input = document.getElementById('new-customer-business-type-input');
            if (input) {
                input.value = name;
            }
            hideCustomerBusinessTypeSuggestions();
            showCustomerBusinessTypeSuggestions(); // Re-check for duplicates
        }

        function addCustomerBusinessType() {
            const input = document.getElementById('new-customer-business-type-input');
            const warningDiv = document.getElementById('customer-business-type-duplicate-warning');
            if (!input) return;
            
            const name = input.value.trim();
            if (!name) {
                alert('Business type name cannot be empty');
                return;
            }
            
            // Check for duplicates before submitting
            const existingTypes = customerBusinessTypesCache || [];
            const isDuplicate = existingTypes.some(type => 
                type.name.toLowerCase() === name.toLowerCase()
            );
            
            if (isDuplicate) {
                warningDiv.textContent = 'This customer business type already exists!';
                warningDiv.style.display = 'block';
                input.style.borderColor = '#dc3545';
                input.focus();
                return;
            }
            
            fetch('/api/customer-business-types', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    if (data.error.includes('already exists')) {
                        warningDiv.textContent = 'This customer business type already exists!';
                        warningDiv.style.display = 'block';
                        input.style.borderColor = '#dc3545';
                        input.focus();
                    } else {
                        alert('Error: ' + data.error);
                    }
                } else {
                    input.value = '';
                    warningDiv.style.display = 'none';
                    input.style.borderColor = '#000000';
                    hideCustomerBusinessTypeSuggestions();
                    loadCustomerBusinessTypes();
                }
            })
            .catch(error => {
                alert('Error adding customer business type: ' + error.message);
            });
        }

        function updateCustomerBusinessType(typeId) {
            const nameInput = document.getElementById(`customer-business-type-name-${typeId}`);
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Business type name cannot be empty');
                loadCustomerBusinessTypes(); // Reload to reset
                return;
            }
            
            // Find current type to preserve display_order
            const currentType = customerBusinessTypesCache.find(t => t.id === typeId);
            if (!currentType) {
                loadCustomerBusinessTypes();
                return;
            }
            
            fetch(`/api/customer-business-types/${typeId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    display_order: currentType.display_order || 0
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    loadCustomerBusinessTypes(); // Reload to reset
                } else {
                    loadCustomerBusinessTypes();
                }
            })
            .catch(error => {
                alert('Error updating customer business type: ' + error.message);
                loadCustomerBusinessTypes(); // Reload to reset
            });
        }

        function deleteCustomerBusinessType(typeId) {
            if (!confirm('Are you sure you want to delete this customer business type?')) {
                return;
            }
            
            fetch(`/api/customer-business-types/${typeId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    loadCustomerBusinessTypes();
                }
            })
            .catch(error => {
                alert('Error deleting customer business type: ' + error.message);
            });
        }

        function handleCustomerBusinessTypeDrop(event, targetId) {
            event.preventDefault();
            if (!currentCustomerBusinessTypeDragId || currentCustomerBusinessTypeDragId === targetId) {
                currentCustomerBusinessTypeDragId = null;
                return;
            }
            
            const fromIndex = customerBusinessTypesCache.findIndex(t => t.id === currentCustomerBusinessTypeDragId);
            const toIndex = customerBusinessTypesCache.findIndex(t => t.id === targetId);
            
            if (fromIndex === -1 || toIndex === -1) {
                currentCustomerBusinessTypeDragId = null;
                return;
            }
            
            // Reorder in memory
            const sortedTypes = [...customerBusinessTypesCache].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            const fromIndexSorted = sortedTypes.findIndex(t => t.id === currentCustomerBusinessTypeDragId);
            const toIndexSorted = sortedTypes.findIndex(t => t.id === targetId);
            
            const [moved] = sortedTypes.splice(fromIndexSorted, 1);
            sortedTypes.splice(toIndexSorted, 0, moved);
            
            // Re-assign display_order sequentially
            sortedTypes.forEach((type, index) => {
                type.display_order = index + 1;
            });
            
            // Persist all updated orders
            Promise.all(sortedTypes.map(type => 
                fetch(`/api/customer-business-types/${type.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: type.name,
                        display_order: type.display_order
                    })
                })
            ))
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(results => {
                if (results.some(r => r.error)) {
                    alert('Error updating order');
                } else {
                    loadCustomerBusinessTypes();
                }
            })
            .catch(error => {
                alert('Error reordering customer business types: ' + error.message);
            })
            .finally(() => {
                currentCustomerBusinessTypeDragId = null;
            });
        }

        function updateCustomerBusinessTypeDropdown(types) {
            // Sort by display_order
            const sortedTypes = [...types].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            
            // Update CUSTOMER_BUSINESS_TYPES array for the business type input field
            CUSTOMER_BUSINESS_TYPES = sortedTypes.map(t => t.name);
        }

        // Customer source dropdown functions for Create Customer form
        function filterCustomerSources() {
            const input = document.getElementById('customer-source');
            const dropdown = document.getElementById('customer-source-dropdown');
            if (!input || !dropdown) return;
            
            // Ensure customer sources are loaded
            if (CUSTOMER_SOURCES.length === 0) {
                fetch('/api/customer-sources')
                    .then(response => response.json())
                    .then(sources => {
                        const sortedSources = [...sources].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
                        CUSTOMER_SOURCES = sortedSources.map(s => s.name);
                        filterCustomerSources(); // Retry after loading
                    })
                    .catch(error => {
                        console.error('Error loading customer sources:', error);
                    });
                return;
            }
            
            const searchTerm = input.value.toLowerCase().trim();
            const filtered = CUSTOMER_SOURCES.filter(source => 
                source.toLowerCase().includes(searchTerm)
            ).slice(0, 10); // Show max 10 results
            
            if (filtered.length === 0 || searchTerm === '') {
                dropdown.classList.add('hidden');
                return;
            }
            
            dropdown.innerHTML = filtered.map(source => 
                `<div class="country-dropdown-item" onclick="selectCustomerSource('${source.replace(/'/g, "\\'")}')">${escapeHtml(source)}</div>`
            ).join('');
            dropdown.classList.remove('hidden');
        }

        function showCustomerSourceDropdown() {
            const input = document.getElementById('customer-source');
            const dropdown = document.getElementById('customer-source-dropdown');
            if (!input || !dropdown) return;
            
            // Ensure customer sources are loaded
            if (CUSTOMER_SOURCES.length === 0) {
                fetch('/api/customer-sources')
                    .then(response => response.json())
                    .then(sources => {
                        const sortedSources = [...sources].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
                        CUSTOMER_SOURCES = sortedSources.map(s => s.name);
                        showCustomerSourceDropdown(); // Retry after loading
                    })
                    .catch(error => {
                        console.error('Error loading customer sources:', error);
                    });
                return;
            }
            
            if (input.value.trim() === '') {
                const topSources = CUSTOMER_SOURCES.slice(0, 10);
                dropdown.innerHTML = topSources.map(source => 
                    `<div class="country-dropdown-item" onclick="selectCustomerSource('${source.replace(/'/g, "\\'")}')">${escapeHtml(source)}</div>`
                ).join('');
                dropdown.classList.remove('hidden');
            } else {
                filterCustomerSources();
            }
        }

        function hideCustomerSourceDropdown() {
            const dropdown = document.getElementById('customer-source-dropdown');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
        }

        function selectCustomerSource(source) {
            const input = document.getElementById('customer-source');
            if (input) {
                input.value = source;
            }
            hideCustomerSourceDropdown();
        }

        // Customer business type dropdown functions for Create Customer form
        function filterCustomerBusinessTypes() {
            const input = document.getElementById('customer-business-type');
            const dropdown = document.getElementById('customer-business-type-dropdown');
            if (!input || !dropdown) return;

            // Ensure business types are loaded from server
            if (CUSTOMER_BUSINESS_TYPES.length === 0) {
                fetch('/api/customer-business-types')
                    .then(response => response.json())
                    .then(types => {
                        const sortedTypes = [...types].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
                        CUSTOMER_BUSINESS_TYPES = sortedTypes.map(t => t.name);
                        filterCustomerBusinessTypes(); // Retry after loading
                    })
                    .catch(error => {
                        console.error('Error loading customer business types:', error);
                    });
                return;
            }

            const searchTerm = input.value.toLowerCase().trim();
            const filtered = CUSTOMER_BUSINESS_TYPES.filter(type =>
                type.toLowerCase().includes(searchTerm)
            ).slice(0, 10); // Show max 10 results

            if (filtered.length === 0 || searchTerm === '') {
                dropdown.classList.add('hidden');
                return;
            }

            dropdown.innerHTML = filtered.map(type =>
                `<div class="country-dropdown-item" onclick="selectCustomerBusinessType('${type.replace(/'/g, "\\'")}')">${escapeHtml(type)}</div>`
            ).join('');
            dropdown.classList.remove('hidden');
        }

        function showCustomerBusinessTypeDropdown() {
            const input = document.getElementById('customer-business-type');
            const dropdown = document.getElementById('customer-business-type-dropdown');
            if (!input || !dropdown) return;

            // Ensure business types are loaded from server
            if (CUSTOMER_BUSINESS_TYPES.length === 0) {
                fetch('/api/customer-business-types')
                    .then(response => response.json())
                    .then(types => {
                        const sortedTypes = [...types].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
                        CUSTOMER_BUSINESS_TYPES = sortedTypes.map(t => t.name);
                        showCustomerBusinessTypeDropdown(); // Retry after loading
                    })
                    .catch(error => {
                        console.error('Error loading customer business types:', error);
                    });
                return;
            }

            if (input.value.trim() === '') {
                const topTypes = CUSTOMER_BUSINESS_TYPES.slice(0, 10);
                dropdown.innerHTML = topTypes.map(type =>
                    `<div class="country-dropdown-item" onclick="selectCustomerBusinessType('${type.replace(/'/g, "\\'")}')">${escapeHtml(type)}</div>`
                ).join('');
                dropdown.classList.remove('hidden');
            } else {
                filterCustomerBusinessTypes();
            }
        }

        function hideCustomerBusinessTypeDropdown() {
            const dropdown = document.getElementById('customer-business-type-dropdown');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
        }

        function selectCustomerBusinessType(type) {
            const input = document.getElementById('customer-business-type');
            if (input) {
                input.value = type;
            }
            hideCustomerBusinessTypeDropdown();
        }

        // Edit mode dropdown functions for Country
        function filterEditCountry(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            if (!input || !dropdown) return;
            
            // Ensure countries are loaded
            if (COUNTRIES.length === 0) {
                fetch('/api/countries')
                    .then(response => response.json())
                    .then(countries => {
                        const sortedCountries = [...countries].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
                        COUNTRIES = sortedCountries.map(c => c.name);
                        filterEditCountry(inputId, dropdownId); // Retry after loading
                    })
                    .catch(error => {
                        console.error('Error loading countries:', error);
                    });
                return;
            }
            
            const searchTerm = input.value.toLowerCase().trim();
            const filtered = COUNTRIES.filter(country => 
                country.toLowerCase().includes(searchTerm)
            ).slice(0, 10);
            
            if (filtered.length === 0) {
                // Show top countries if no match
                const topCountries = COUNTRIES.slice(0, 10);
                dropdown.innerHTML = topCountries.map(country => 
                    `<div class="country-dropdown-item" onmousedown="event.preventDefault(); selectEditCountry('${inputId}', '${dropdownId}', '${country.replace(/'/g, "\\'")}')">${escapeHtml(country)}</div>`
                ).join('');
            } else {
                dropdown.innerHTML = filtered.map(country => 
                    `<div class="country-dropdown-item" onmousedown="event.preventDefault(); selectEditCountry('${inputId}', '${dropdownId}', '${country.replace(/'/g, "\\'")}')">${escapeHtml(country)}</div>`
                ).join('');
            }
            dropdown.classList.remove('hidden');
        }

        function showEditCountryDropdown(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            if (!input || !dropdown) return;
            
            // Ensure countries are loaded
            if (COUNTRIES.length === 0) {
                fetch('/api/countries')
                    .then(response => response.json())
                    .then(countries => {
                        const sortedCountries = [...countries].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
                        COUNTRIES = sortedCountries.map(c => c.name);
                        showEditCountryDropdown(inputId, dropdownId); // Retry after loading
                    })
                    .catch(error => {
                        console.error('Error loading countries:', error);
                    });
                return;
            }
            
            // Always show full list when focused/clicked, regardless of input value
            const allCountries = COUNTRIES.slice(0, 200); // Show up to 200 countries
            dropdown.innerHTML = allCountries.map(country => 
                `<div class="country-dropdown-item" onmousedown="event.preventDefault(); selectEditCountry('${inputId}', '${dropdownId}', '${country.replace(/'/g, "\\'")}')">${escapeHtml(country)}</div>`
            ).join('');
            dropdown.classList.remove('hidden');
        }

        function hideEditCountryDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
        }

        function selectEditCountry(inputId, dropdownId, country) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = country;
                // Trigger both input and change events to ensure the value is synced
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
                // Also trigger focus to keep the field active
                input.focus();
            }
            // Use a small delay before hiding to ensure the value is set
            setTimeout(() => {
                hideEditCountryDropdown(dropdownId);
            }, 100);
        }

        // Edit mode dropdown functions for Customer Source
        function filterEditCustomerSource(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            if (!input || !dropdown) return;
            
            // Ensure customer sources are loaded
            if (CUSTOMER_SOURCES.length === 0) {
                fetch('/api/customer-sources')
                    .then(response => response.json())
                    .then(sources => {
                        const sortedSources = [...sources].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
                        CUSTOMER_SOURCES = sortedSources.map(s => s.name);
                        filterEditCustomerSource(inputId, dropdownId); // Retry after loading
                    })
                    .catch(error => {
                        console.error('Error loading customer sources:', error);
                    });
                return;
            }
            
            const searchTerm = input.value.toLowerCase().trim();
            const filtered = CUSTOMER_SOURCES.filter(source => 
                source.toLowerCase().includes(searchTerm)
            ).slice(0, 10);
            
            if (filtered.length === 0) {
                // Show top sources if no match
                const topSources = CUSTOMER_SOURCES.slice(0, 10);
                dropdown.innerHTML = topSources.map(source => 
                    `<div class="country-dropdown-item" onmousedown="event.preventDefault(); selectEditCustomerSource('${inputId}', '${dropdownId}', '${source.replace(/'/g, "\\'")}')">${escapeHtml(source)}</div>`
                ).join('');
            } else {
                dropdown.innerHTML = filtered.map(source => 
                    `<div class="country-dropdown-item" onmousedown="event.preventDefault(); selectEditCustomerSource('${inputId}', '${dropdownId}', '${source.replace(/'/g, "\\'")}')">${escapeHtml(source)}</div>`
                ).join('');
            }
            dropdown.classList.remove('hidden');
        }

        function showEditCustomerSourceDropdown(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            if (!input || !dropdown) return;
            
            // Ensure customer sources are loaded
            if (CUSTOMER_SOURCES.length === 0) {
                fetch('/api/customer-sources')
                    .then(response => response.json())
                    .then(sources => {
                        const sortedSources = [...sources].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
                        CUSTOMER_SOURCES = sortedSources.map(s => s.name);
                        showEditCustomerSourceDropdown(inputId, dropdownId); // Retry after loading
                    })
                    .catch(error => {
                        console.error('Error loading customer sources:', error);
                    });
                return;
            }
            
            // Always show full list when focused/clicked, regardless of input value
            const allSources = CUSTOMER_SOURCES.slice(0, 200); // Show all sources
            dropdown.innerHTML = allSources.map(source => 
                `<div class="country-dropdown-item" onmousedown="event.preventDefault(); selectEditCustomerSource('${inputId}', '${dropdownId}', '${source.replace(/'/g, "\\'")}')">${escapeHtml(source)}</div>`
            ).join('');
            dropdown.classList.remove('hidden');
        }

        function hideEditCustomerSourceDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
        }

        function selectEditCustomerSource(inputId, dropdownId, source) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = source;
                // Trigger both input and change events to ensure the value is synced
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
                // Also trigger focus to keep the field active
                input.focus();
            }
            // Use a small delay before hiding to ensure the value is set
            setTimeout(() => {
                hideEditCustomerSourceDropdown(dropdownId);
            }, 100);
        }

        // Edit mode dropdown functions for Customer Business Type
        function filterEditCustomerBusinessType(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            if (!input || !dropdown) return;
            
            // Ensure customer business types are loaded
            if (CUSTOMER_BUSINESS_TYPES.length === 0) {
                fetch('/api/customer-business-types')
                    .then(response => response.json())
                    .then(types => {
                        const sortedTypes = [...types].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
                        CUSTOMER_BUSINESS_TYPES = sortedTypes.map(t => t.name);
                        filterEditCustomerBusinessType(inputId, dropdownId); // Retry after loading
                    })
                    .catch(error => {
                        console.error('Error loading customer business types:', error);
                    });
                return;
            }
            
            const searchTerm = input.value.toLowerCase().trim();
            const filtered = CUSTOMER_BUSINESS_TYPES.filter(type => 
                type.toLowerCase().includes(searchTerm)
            ).slice(0, 10);
            
            if (filtered.length === 0) {
                // Show top types if no match
                const topTypes = CUSTOMER_BUSINESS_TYPES.slice(0, 10);
                dropdown.innerHTML = topTypes.map(type => 
                    `<div class="country-dropdown-item" onmousedown="event.preventDefault(); selectEditCustomerBusinessType('${inputId}', '${dropdownId}', '${type.replace(/'/g, "\\'")}')">${escapeHtml(type)}</div>`
                ).join('');
            } else {
                dropdown.innerHTML = filtered.map(type => 
                    `<div class="country-dropdown-item" onmousedown="event.preventDefault(); selectEditCustomerBusinessType('${inputId}', '${dropdownId}', '${type.replace(/'/g, "\\'")}')">${escapeHtml(type)}</div>`
                ).join('');
            }
            dropdown.classList.remove('hidden');
        }

        function showEditCustomerBusinessTypeDropdown(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            if (!input || !dropdown) return;
            
            // Ensure customer business types are loaded
            if (CUSTOMER_BUSINESS_TYPES.length === 0) {
                fetch('/api/customer-business-types')
                    .then(response => response.json())
                    .then(types => {
                        const sortedTypes = [...types].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
                        CUSTOMER_BUSINESS_TYPES = sortedTypes.map(t => t.name);
                        showEditCustomerBusinessTypeDropdown(inputId, dropdownId); // Retry after loading
                    })
                    .catch(error => {
                        console.error('Error loading customer business types:', error);
                    });
                return;
            }
            
            // Always show full list when focused/clicked, regardless of input value
            const allTypes = CUSTOMER_BUSINESS_TYPES.slice(0, 200); // Show all types
            dropdown.innerHTML = allTypes.map(type => 
                `<div class="country-dropdown-item" onmousedown="event.preventDefault(); selectEditCustomerBusinessType('${inputId}', '${dropdownId}', '${type.replace(/'/g, "\\'")}')">${escapeHtml(type)}</div>`
            ).join('');
            dropdown.classList.remove('hidden');
        }

        function hideEditCustomerBusinessTypeDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
        }

        function selectEditCustomerBusinessType(inputId, dropdownId, type) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = type;
                // Trigger both input and change events to ensure the value is synced
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
                // Also trigger focus to keep the field active
                input.focus();
            }
            // Use a small delay before hiding to ensure the value is set
            setTimeout(() => {
                hideEditCustomerBusinessTypeDropdown(dropdownId);
            }, 100);
        }

        // Attachment handling functions for Create Customer (mirror task form attachments)
        function setupCustomerAttachmentDragAndDrop() {
            const dropzone = document.getElementById('customer-attachment-dropzone');
            const fileInput = document.getElementById('customer-attachment-file-input');
            const browseButton = document.getElementById('customer-attachment-browse-btn');
            
            if (!dropzone || !fileInput || !browseButton) return;
            
            // Dedicated browse button to open file picker
            browseButton.addEventListener('click', (e) => {
                e.stopPropagation();
                fileInput.click();
            });
            
            // Drag and drop handlers
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.style.backgroundColor = '#e9e9e9';
            });
            
            dropzone.addEventListener('dragleave', () => {
                dropzone.style.backgroundColor = '#f9f9f9';
            });
            
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.style.backgroundColor = '#f9f9f9';
                const files = Array.from(e.dataTransfer.files);
                handleCustomerAttachmentFiles(files);
            });

            // Paste image from clipboard
            dropzone.addEventListener('paste', (e) => {
                const clipboardData = e.clipboardData || window.clipboardData;
                if (!clipboardData || !clipboardData.items) {
                    return;
                }
                const files = [];
                for (let i = 0; i < clipboardData.items.length; i++) {
                    const item = clipboardData.items[i];
                    if (item.kind === 'file') {
                        const file = item.getAsFile();
                        if (file && file.type && file.type.startsWith('image/')) {
                            files.push(file);
                        }
                    }
                }
                if (files.length > 0) {
                    e.preventDefault();
                    handleCustomerAttachmentFiles(files);
                }
            });
        }

        function handleCustomerAttachmentFileSelect(event) {
            const files = Array.from(event.target.files || []);
            handleCustomerAttachmentFiles(files);
        }

        function handleCustomerAttachmentFiles(files) {
            if (!Array.isArray(files) || files.length === 0) return;
            
            files.forEach(file => {
                // Avoid adding exact duplicate files (same name and size), which can
                // happen on some browsers when pasting from clipboard.
                const isDuplicate = customerAttachments.some(att => 
                    att.filename === file.name && att.size === file.size
                );
                if (isDuplicate) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64Data = e.target.result.split(',')[1];
                    customerAttachments.push({
                        filename: file.name,
                        content_type: file.type || 'application/octet-stream',
                        size: file.size,
                        data: base64Data,
                        caption: ''
                    });
                    renderCustomerAttachmentsList();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderCustomerAttachmentsList() {
            const container = document.getElementById('customer-attachment-list');
            if (!container) return;
            
            if (!customerAttachments || customerAttachments.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = customerAttachments.map((att, idx) => {
                const filename = escapeHtml(att.filename || 'attachment');
                const size = formatAttachmentSize(att.size || 0);
                const contentType = att.content_type || 'application/octet-stream';
                const isImage = (contentType || '').toLowerCase().startsWith('image/');
                const thumbHtml = isImage
                    ? `<img src="data:${contentType};base64,${att.data}" alt="${filename}" class="task-attachment-thumb" data-index="${idx}" onclick="openCreateCustomerAttachmentPreview(${idx})">`
                    : '';
                return `
                    <div class="task-attachment-display" style="margin-bottom: 10px; display: flex; align-items: flex-start;">
                        ${thumbHtml}
                        <div class="task-attachment-info" style="flex: 1;">
                            <div style="font-weight: bold;">${filename}</div>
                            <div style="font-size: 12px; color: #666;">${contentType} • ${size}</div>
                        </div>
                        <div class="task-attachment-actions">
                            <button type="button" class="form-button" onclick="removeCustomerAttachment(${idx})" style="font-size: 12px; background-color: #dc3545; color: white;">X</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function removeCustomerAttachment(index) {
            if (!customerAttachments || !customerAttachments[index]) {
                return;
            }
            customerAttachments.splice(index, 1);
            renderCustomerAttachmentsList();
        }

        function openCreateCustomerAttachmentPreview(attachmentIndex) {
            if (!customerAttachments || !customerAttachments[attachmentIndex]) {
                return;
            }
            const att = customerAttachments[attachmentIndex];
            const contentType = att.content_type || 'application/octet-stream';
            const filename = att.filename || `Attachment ${attachmentIndex + 1}`;
            openPreviewModal(att.data || '', contentType, filename);
        }

        function formatAttachmentSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function addCustomerContactRow(initial = {}) {
            const container = document.getElementById('customer-extra-contacts-container');
            if (!container) return;
            const rowHtml = `
                <div class="customer-contacts-row">
                    <input type="text" class="contact-input contact-name" placeholder="Customer name" value="${escapeHtml(initial.name || '')}">
                    <input type="text" class="contact-input contact-title" placeholder="Title" value="${escapeHtml(initial.title || '')}">
                    <input type="tel" class="contact-input contact-tel" placeholder="Tel" value="${escapeHtml(initial.tel || '')}">
                    <input type="email" class="contact-input contact-email" placeholder="customer@example.com" value="${escapeHtml(initial.email || '')}">
                    <button type="button" class="contact-row-remove-btn" onclick="removeCustomerContactRow(this)" title="Remove">−</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', rowHtml);
        }

        function removeCustomerContactRow(button) {
            const row = button.closest('.customer-contacts-row');
            if (row && row.parentElement) {
                row.parentElement.removeChild(row);
            }
        }

        function collectCustomerContacts() {
            const contacts = [];
            const primaryNameInput = document.getElementById('customer-name');
            const primaryTitleInput = document.getElementById('customer-title');
            const primaryTelInput = document.getElementById('customer-tel');
            const primaryEmailInput = document.getElementById('customer-email-address');

            if (primaryNameInput || primaryEmailInput) {
                const name = (primaryNameInput && primaryNameInput.value || '').trim();
                const email = (primaryEmailInput && primaryEmailInput.value || '').trim();
                const title = (primaryTitleInput && primaryTitleInput.value || '').trim();
                const tel = (primaryTelInput && primaryTelInput.value || '').trim();
                if (name || email || title || tel) {
                    contacts.push({ name, title, tel, email });
                }
            }

            const extraContainer = document.getElementById('customer-extra-contacts-container');
            if (extraContainer) {
                const rows = extraContainer.querySelectorAll('.customer-contacts-row');
                rows.forEach(row => {
                    const name = (row.querySelector('.contact-name')?.value || '').trim();
                    const title = (row.querySelector('.contact-title')?.value || '').trim();
                    const tel = (row.querySelector('.contact-tel')?.value || '').trim();
                    const email = (row.querySelector('.contact-email')?.value || '').trim();
                    if (name || email || title || tel) {
                        contacts.push({ name, title, tel, email });
                    }
                });
            }

            return contacts;
        }

        function saveCustomer() {
            const companyInput = document.getElementById('company-name');
            const countryInput = document.getElementById('customer-country');
            const addressInput = document.getElementById('company-address');
            const websiteInput = document.getElementById('customer-website');
            const sourceInput = document.getElementById('customer-source');
            const businessTypeSelect = document.getElementById('customer-business-type');
            const remarkDiv = document.getElementById('customer-remark');
            
            const companyName = (companyInput && companyInput.value || '').trim();
            const country = (countryInput.value || '').trim();
            const address = (addressInput && addressInput.value || '').trim();
            const website = (websiteInput.value || '').trim();
            const source = (sourceInput && sourceInput.value || '').trim();
            const businessType = (businessTypeSelect && businessTypeSelect.value || '').trim();
            const remark = remarkDiv ? remarkDiv.innerHTML.trim() : '';

            // Clear previous validation highlights
            const customerForm = document.querySelector('#create-customer-content');
            if (customerForm) {
                customerForm.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
            }

            const contacts = collectCustomerContacts();
            if (!contacts.length) {
                // Highlight primary name/email as required
                const primaryNameInput = document.getElementById('customer-name');
                const primaryEmailInput = document.getElementById('customer-email-address');
                if (primaryNameInput) primaryNameInput.classList.add('input-error');
                if (primaryEmailInput) primaryEmailInput.classList.add('input-error');
                showCustomerStatus('Please enter at least one customer name and email.', true);
                return;
            }

            // Validate contacts
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            for (const contact of contacts) {
                const name = (contact.name || '').trim();
                const emailAddress = (contact.email || '').trim();
                if (!name) {
                    // Highlight offending name input(s)
                    const allNameInputs = document.querySelectorAll('.contact-name, #customer-name');
                    allNameInputs.forEach(input => {
                        if ((input.value || '').trim() === '') {
                            input.classList.add('input-error');
                        }
                    });
                    showCustomerStatus('Customer name is required for each contact.', true);
                    return;
                }
                if (!emailAddress) {
                    // Highlight offending email input(s)
                    const allEmailInputs = document.querySelectorAll('.contact-email, #customer-email-address');
                    allEmailInputs.forEach(input => {
                        if ((input.value || '').trim() === '') {
                            input.classList.add('input-error');
                        }
                    });
                    showCustomerStatus('Please enter an email address for each contact.', true);
                    return;
                }
                if (!emailRegex.test(emailAddress)) {
                    // Highlight invalid email input(s)
                    const allEmailInputs = document.querySelectorAll('.contact-email, #customer-email-address');
                    allEmailInputs.forEach(input => {
                        const value = (input.value || '').trim();
                        if (value && !emailRegex.test(value)) {
                            input.classList.add('input-error');
                        }
                    });
                    showCustomerStatus('Please enter a valid email address (e.g. customer@example.com) for each contact.', true);
                    return;
                }
            }

            // Website validation (optional, but if provided, should be valid URL)
            if (website && website.trim() !== '' && !website.match(/^https?:\/\/.+/)) {
                showCustomerStatus('Please enter a valid website URL (e.g. https://example.com) or leave it empty.', true);
                return;
            }

            showCustomerStatus('Saving customer...', false, 'info');

            const bodyBase = {
                country: country || null,
                website: website && website.trim() !== '' ? website : null,
                source: source || null,
                business_type: businessType || null,
                remark: remark || null,
                attachments: customerAttachments.length > 0 ? JSON.stringify(customerAttachments) : null,
                company_name: companyName || null,
                address: address || null
            };

            const requests = contacts.map(contact => {
                const namePart = (contact.name || '').trim();
                const titlePart = (contact.title || '').trim();
                const combinedName = titlePart ? `${namePart} (${titlePart})` : namePart;
                const telPart = (contact.tel || '').trim();
                const emailAddress = (contact.email || '').trim();

                return fetch('/api/customers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...bodyBase,
                        name: combinedName,
                        email_address: emailAddress,
                        tel: telPart || null
                    })
                }).then(async response => {
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to save customer');
                    }
                });
            });

            Promise.all(requests)
                .then(() => {
                    const nameInput = document.getElementById('customer-name');
                    const titleInput = document.getElementById('customer-title');
                    const emailInput = document.getElementById('customer-email-address');
                    const telInput = document.getElementById('customer-tel');
                    const businessTypeInput = document.getElementById('customer-business-type');
                    const extraContainer = document.getElementById('customer-extra-contacts-container');
                    const attachmentFileInput = document.getElementById('customer-attachment-file-input');

                    // Reset primary contact fields
                    if (nameInput) nameInput.value = '';
                    if (titleInput) titleInput.value = '';
                    if (emailInput) emailInput.value = '';
                    if (telInput) telInput.value = '';

                    // Reset company and meta fields
                    if (companyInput) companyInput.value = '';
                    if (countryInput) countryInput.value = '';
                    if (addressInput) addressInput.value = '';
                    if (websiteInput) websiteInput.value = '';
                    if (sourceInput) sourceInput.value = '';
                    if (businessTypeInput) businessTypeInput.value = '';

                    // Reset remark
                    if (remarkDiv) remarkDiv.innerHTML = '';

                    // Remove extra contact rows
                    if (extraContainer) extraContainer.innerHTML = '';

                    // Clear attachments both in memory and UI
                    customerAttachments = [];
                    renderCustomerAttachmentsList();
                    if (attachmentFileInput) attachmentFileInput.value = '';

                    showCustomerStatus('Customer(s) saved.', false);
                    loadCustomers(false);
                })
                .catch(error => {
                    showCustomerStatus(`Error: ${error.message}`, true);
                });
        }

        function showCustomerStatus(message, isError = false, statusType = 'auto') {
            if (!customerStatusDiv) return;
            let messageClass = 'info';
            if (statusType === 'auto') {
                messageClass = isError ? 'error' : 'success';
            } else {
                messageClass = statusType;
            }
            customerStatusDiv.textContent = message;
            customerStatusDiv.className = `message ${messageClass}`;
            customerStatusDiv.classList.remove('hidden');
            setTimeout(() => {
                customerStatusDiv.classList.add('hidden');
            }, 3000);
        }

        let editingCustomerId = null;
        let originalCustomerData = {};

        function editCustomer(customerId) {
            if (editingCustomerId && editingCustomerId !== customerId) {
                cancelCustomerEdit(editingCustomerId);
            }
            
            editingCustomerId = customerId;
            const row = document.getElementById(`customer-row-${customerId}`);
            if (!row) return;
            
            // Store original data first
            const cells = row.querySelectorAll('.editable-cell');
            originalCustomerData[customerId] = {};
            
            // Load countries, sources and business types if needed, then create input fields
            const loadPromises = [];
            
            if (COUNTRIES.length === 0) {
                loadPromises.push(
                    fetch('/api/countries')
                        .then(response => response.json())
                        .then(countries => {
                            const sortedCountries = [...countries].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
                            COUNTRIES = sortedCountries.map(c => c.name);
                        })
                        .catch(error => {
                            console.error('Error loading countries:', error);
                            COUNTRIES = []; // Ensure it's an array even on error
                        })
                );
            }
            
            if (CUSTOMER_SOURCES.length === 0) {
                loadPromises.push(
                    fetch('/api/customer-sources')
                        .then(response => response.json())
                        .then(sources => {
                            const sortedSources = [...sources].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
                            CUSTOMER_SOURCES = sortedSources.map(s => s.name);
                        })
                        .catch(error => {
                            console.error('Error loading customer sources:', error);
                            CUSTOMER_SOURCES = []; // Ensure it's an array even on error
                        })
                );
            }

            if (CUSTOMER_BUSINESS_TYPES.length === 0) {
                loadPromises.push(
                    fetch('/api/customer-business-types')
                        .then(response => response.json())
                        .then(types => {
                            const sortedTypes = [...types].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
                            CUSTOMER_BUSINESS_TYPES = sortedTypes.map(t => t.name);
                        })
                        .catch(error => {
                            console.error('Error loading customer business types:', error);
                            CUSTOMER_BUSINESS_TYPES = []; // Ensure it's an array even on error
                        })
                );
            }
            
            // Wait for data to load, then create input fields
            Promise.all(loadPromises).then(() => {
                // Make sure we're still editing the same customer
                if (editingCustomerId !== customerId) return;
                
                cells.forEach(cell => {
                const field = cell.dataset.field;
                let value = '';
                
                // Handle different field types
                if (field === 'website') {
                    const link = cell.querySelector('a');
                    if (link) {
                        value = link.href;
                    } else {
                        value = cell.textContent.trim();
                    }
                } else if (field === 'remark') {
                    // For remark, preserve HTML content
                    value = cell.innerHTML.trim();
                } else {
                    value = cell.textContent.trim();
                }
                
                originalCustomerData[customerId][field] = value;
                
                // Make cell editable
                if (field === 'remark') {
                    // Strip HTML tags for editing (show plain text)
                    const textValue = cell.textContent.trim();
                    cell.innerHTML = `<textarea style="width: 100%; min-height: 60px; padding: 5px; border: 1px solid #000000; font-family: Arial, sans-serif; font-size: 12px;" data-field="${field}">${escapeHtml(textValue)}</textarea>`;
                } else if (field === 'country') {
                    // Create country dropdown input
                    const uniqueId = `edit-country-${customerId}`;
                    const dropdownId = `edit-country-dropdown-${customerId}`;
                    cell.innerHTML = `
                        <div style="position: relative;">
                            <input type="text" id="${uniqueId}" value="${escapeHtml(value)}" 
                                   placeholder="Search or select country" 
                                   autocomplete="off" 
                                   style="width: 100%; padding: 5px; border: 1px solid #000000; font-size: 12px;" 
                                   data-field="${field}"
                                   oninput="filterEditCountry('${uniqueId}', '${dropdownId}')" 
                                   onfocus="showEditCountryDropdown('${uniqueId}', '${dropdownId}')" 
                                   onblur="setTimeout(() => hideEditCountryDropdown('${dropdownId}'), 200)">
                            <div id="${dropdownId}" class="country-dropdown hidden" style="position: absolute; top: 100%; left: 0; right: 0; min-width: 200px; z-index: 10000; max-height: 200px; overflow-y: auto; background-color: #ffffff; border: 1px solid #000000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onmousedown="event.preventDefault();"></div>
                        </div>
                    `;
                } else if (field === 'source') {
                    // Create source dropdown input
                    const uniqueId = `edit-source-${customerId}`;
                    const dropdownId = `edit-source-dropdown-${customerId}`;
                    cell.innerHTML = `
                        <div style="position: relative;">
                            <input type="text" id="${uniqueId}" value="${escapeHtml(value)}" 
                                   placeholder="Search or select source" 
                                   autocomplete="off" 
                                   style="width: 100%; padding: 5px; border: 1px solid #000000; font-size: 12px;" 
                                   data-field="${field}"
                                   oninput="filterEditCustomerSource('${uniqueId}', '${dropdownId}')" 
                                   onfocus="showEditCustomerSourceDropdown('${uniqueId}', '${dropdownId}')" 
                                   onblur="setTimeout(() => hideEditCustomerSourceDropdown('${dropdownId}'), 200)">
                            <div id="${dropdownId}" class="country-dropdown hidden" style="position: absolute; top: 100%; left: 0; right: 0; min-width: 200px; z-index: 10000; max-height: 200px; overflow-y: auto; background-color: #ffffff; border: 1px solid #000000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onmousedown="event.preventDefault();"></div>
                        </div>
                    `;
                } else if (field === 'business_type') {
                    // Create business type dropdown input
                    const uniqueId = `edit-business-type-${customerId}`;
                    const dropdownId = `edit-business-type-dropdown-${customerId}`;
                    cell.innerHTML = `
                        <div style="position: relative;">
                            <input type="text" id="${uniqueId}" value="${escapeHtml(value)}" 
                                   placeholder="Search or select business type" 
                                   autocomplete="off" 
                                   style="width: 100%; padding: 5px; border: 1px solid #000000; font-size: 12px;" 
                                   data-field="${field}"
                                   oninput="filterEditCustomerBusinessType('${uniqueId}', '${dropdownId}')" 
                                   onfocus="showEditCustomerBusinessTypeDropdown('${uniqueId}', '${dropdownId}')" 
                                   onblur="setTimeout(() => hideEditCustomerBusinessTypeDropdown('${dropdownId}'), 200)">
                            <div id="${dropdownId}" class="country-dropdown hidden" style="position: absolute; top: 100%; left: 0; right: 0; min-width: 200px; z-index: 10000; max-height: 200px; overflow-y: auto; background-color: #ffffff; border: 1px solid #000000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onmousedown="event.preventDefault();"></div>
                        </div>
                    `;
                } else {
                    cell.innerHTML = `<input type="text" value="${escapeHtml(value)}" style="width: 100%; padding: 5px; border: 1px solid #000000; font-size: 12px;" data-field="${field}">`;
                }
                cell.style.backgroundColor = '#fff9c4';
                });
                
                // Show/hide buttons
                row.querySelector('.edit-customer-btn').classList.add('hidden');
                row.querySelector('.save-customer-btn').classList.remove('hidden');
                row.querySelector('.cancel-customer-btn').classList.remove('hidden');
            });
        }

        function cancelCustomerEdit(customerId) {
            if (!editingCustomerId || editingCustomerId !== customerId) return;
            
            const row = document.getElementById(`customer-row-${customerId}`);
            if (!row) return;
            
            const original = originalCustomerData[customerId];
            if (!original) return;
            
            // Restore original values
            const cells = row.querySelectorAll('.editable-cell');
            cells.forEach(cell => {
                const field = cell.dataset.field;
                const value = original[field] || '';
                
                if (field === 'website' && value) {
                    const websiteLink = value.startsWith('http') ? value : `https://${value}`;
                    const displayValue = value.replace(/^https?:\/\//, '');
                    cell.innerHTML = `<a href="${escapeHtml(websiteLink)}" target="_blank" rel="noopener noreferrer">${escapeHtml(displayValue)}</a>`;
                } else if (field === 'remark') {
                    // Restore HTML content for remark
                    cell.innerHTML = value;
                } else {
                    cell.textContent = value;
                }
                cell.style.backgroundColor = '';
            });
            
            // Show/hide buttons
            row.querySelector('.edit-customer-btn').classList.remove('hidden');
            row.querySelector('.save-customer-btn').classList.add('hidden');
            row.querySelector('.cancel-customer-btn').classList.add('hidden');
            
            editingCustomerId = null;
            delete originalCustomerData[customerId];
        }

        function saveCustomerEdit(customerId) {
            if (!editingCustomerId || editingCustomerId !== customerId) return;
            
            const row = document.getElementById(`customer-row-${customerId}`);
            if (!row) return;
            
            // Collect edited values
            const editedData = {};
            const cells = row.querySelectorAll('.editable-cell');
            cells.forEach(cell => {
                const field = cell.dataset.field;
                const input = cell.querySelector('input, textarea');
                if (input) {
                    editedData[field] = input.value.trim();
                }
            });
            
            // Validate required fields
            if (!editedData.name) {
                alert('Customer name is required');
                return;
            }
            if (!editedData.email_suffix) {
                alert('Email address is required');
                return;
            }
            
            // Validate email format
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailPattern.test(editedData.email_suffix)) {
                alert('Please enter a valid email address');
                return;
            }
            
            // Get original customer data for attachments
            const originalCustomer = customerCache.find(c => c.id === customerId);
            const attachments = originalCustomer ? originalCustomer.attachments : null;
            
            showCustomerStatus('Saving customer...', false, 'info');
            
            fetch(`/api/customers/${customerId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: editedData.name,
                    email_address: editedData.email_suffix,
                    company_name: editedData.company_name || null,
                    tel: editedData.tel || null,
                    country: editedData.country || null,
                    website: editedData.website || null,
                    source: editedData.source || null,
                    business_type: editedData.business_type || null,
                    remark: editedData.remark || null,
                    attachments: attachments
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showCustomerStatus(`Error: ${data.error}`, true);
                } else {
                    showCustomerStatus('Customer updated.', false);
                    editingCustomerId = null;
                    delete originalCustomerData[customerId];
                    // Reload customer list
                    loadCustomers(false);
                }
            })
            .catch(error => {
                showCustomerStatus(`Error: ${error.message}`, true);
            });
        }

        function deleteCustomer(customerId, customerName) {
            if (!confirm(`Are you sure you want to delete customer "${customerName}"?`)) {
                return;
            }

            showCustomerStatus('Deleting customer...', false, 'info');

            fetch(`/api/customers/${customerId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(async response => {
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to delete customer');
                    }
                    showCustomerStatus('Customer deleted successfully.', false);
                    // Remove from cache
                    if (customerCache) {
                        customerCache = customerCache.filter(c => c.id !== customerId);
                    }
                    // Reload customer list
                    loadCustomers(false);
                })
                .catch(error => {
                    showCustomerStatus(`Error: ${error.message}`, true);
                });
        }

        function renderCustomers(customers) {
            if (!customerListSection || !customerTableBody || !customerEmptyMessage) {
                return;
            }
            customerCache = customers;
            customerTableBody.innerHTML = '';
            if (!customers || customers.length === 0) {
                customerEmptyMessage.classList.remove('hidden');
                customerListSection.classList.remove('hidden');
                return;
            }
            customerEmptyMessage.classList.add('hidden');
            const rows = customers.map(customer => {
                const country = customer.country || '';
                const website = customer.website || '';
                const remark = customer.remark || '';
                const websiteLink = website ? (website.startsWith('http') ? website : `https://${website}`) : '';
                
                // Parse attachments
                let attachmentsHtml = '';
                let attachmentsText = '';
                try {
                    if (customer.attachments) {
                        const attachments = JSON.parse(customer.attachments);
                        if (Array.isArray(attachments) && attachments.length > 0) {
                            attachmentsText = attachments.map(att => att.filename || 'attachment').join(', ');
                            attachmentsHtml = attachments.map((att, idx) => {
                                const filename = att.filename || 'attachment';
                                const safeFilename = escapeHtml(filename);
                                const sizeStr = formatAttachmentSize(att.size || 0);
                                const contentType = att.content_type || 'application/octet-stream';
                                const isImage = isImageContent(att.filename, contentType);
                                const isPDF = isPDFContent(att.filename, contentType);
                                let iconChar = '🎞️';
                                if (isPDF) {
                                    iconChar = '📄';
                                }
                                const thumbHtml = isImage
                                    ? `<img src="data:${contentType};base64,${att.data}" alt="${safeFilename}" class="task-attachment-thumb" onclick="openCustomerAttachment(${customer.id}, ${idx})">`
                                    : `<div class="task-attachment-thumb" style="display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;" onclick="openCustomerAttachment(${customer.id}, ${idx})">${iconChar}</div>`;
                                const metaHtml = `
                                    <div class="attachment-row-info">
                                        <div class="attachment-filename">${safeFilename}</div>
                                        <div class="attachment-size">${sizeStr}</div>
                                    </div>
                                `;
                                return `
                                    <div class="task-attachment-entry" style="display:flex;align-items:flex-start;gap:6px;margin-bottom:4px;">
                                        ${thumbHtml}
                                        ${metaHtml}
                                    </div>
                                `;
                            }).join('');
                        }
                    }
                } catch (e) {
                    console.error('Error parsing attachments:', e);
                }
                
                const plainRemark = (remark || '').replace(/<[^>]+>/g, '');
                
                return `
                <tr id="customer-row-${customer.id}" data-customer-id="${customer.id}"
                    data-company_name="${escapeHtml(customer.company_name || '')}"
                    data-name="${escapeHtml(customer.name || '')}"
                    data-email_suffix="${escapeHtml(customer.email_suffix || '')}"
                    data-tel="${escapeHtml(customer.tel || '')}"
                    data-country="${escapeHtml(country)}"
                    data-website="${escapeHtml(website)}"
                    data-source="${escapeHtml(customer.source || '')}"
                    data-business_type="${escapeHtml(customer.business_type || '')}"
                    data-remark="${escapeHtml(plainRemark)}"
                    data-attachments="${escapeHtml(attachmentsText)}"
                    data-created_at="${escapeHtml(customer.created_at || '')}">
                    <td class="editable-cell" data-field="company_name">${escapeHtml(customer.company_name || '')}</td>
                    <td class="editable-cell" data-field="name">${escapeHtml(customer.name || '')}</td>
                    <td class="editable-cell" data-field="email_suffix">${escapeHtml(customer.email_suffix || '')}</td>
                    <td class="editable-cell" data-field="tel">${escapeHtml(customer.tel || '')}</td>
                    <td class="editable-cell" data-field="country">${escapeHtml(country)}</td>
                    <td class="editable-cell" data-field="website">${websiteLink ? `<a href="${escapeHtml(websiteLink)}" target="_blank" rel="noopener noreferrer">${escapeHtml(website)}</a>` : ''}</td>
                    <td class="editable-cell" data-field="source">${escapeHtml(customer.source || '')}</td>
                    <td class="editable-cell" data-field="business_type">${escapeHtml(customer.business_type || '')}</td>
                    <td class="editable-cell" data-field="remark" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${remark}</td>
                    <td style="max-width: 150px; font-size: 11px;">${attachmentsHtml || '-'}</td>
                    <td>${escapeHtml(customer.created_at ? new Date(customer.created_at).toLocaleString() : '')}</td>
                    <td>
                        <button class="form-button edit-customer-btn" onclick="editCustomer(${customer.id})" style="padding: 5px 10px; font-size: 12px; cursor: pointer; margin-right: 5px;">Edit</button>
                        <button class="form-button save-customer-btn hidden" onclick="saveCustomerEdit(${customer.id})" style="padding: 5px 10px; font-size: 12px; cursor: pointer; margin-right: 5px; background-color: #28a745; color: white;">Save</button>
                        <button class="form-button cancel-customer-btn hidden" onclick="cancelCustomerEdit(${customer.id})" style="padding: 5px 10px; font-size: 12px; cursor: pointer; margin-right: 5px; background-color: #6c757d; color: white;">Cancel</button>
                        <button class="form-button" onclick="deleteCustomer(${customer.id}, '${escapeHtml(customer.name || '')}')" style="padding: 5px 10px; font-size: 12px; cursor: pointer; margin-right: 5px; background-color: #dc3545; color: white;">Delete</button>
                        <button class="form-button" onclick="openTaskForCustomer(${customer.id})" style="padding: 5px 10px; font-size: 12px; cursor: pointer; background-color: #007bff; color: white; margin-top: 5px;">Task</button>
                    </td>
                </tr>
            `;
            }).join('');
            customerTableBody.innerHTML = rows;
            customerListSection.classList.remove('hidden');

            // Attach header filter handlers
            const filterInputs = document.querySelectorAll('.customer-filter-input');
            filterInputs.forEach(input => {
                input.removeEventListener('input', applyCustomerTableFilters);
                input.addEventListener('input', applyCustomerTableFilters);
            });
        }

        function applyCustomerTableFilters() {
            if (!customerTableBody) return;

            const filters = {};
            const filterInputs = document.querySelectorAll('.customer-filter-input');
            filterInputs.forEach(input => {
                const field = input.dataset.field;
                const value = (input.value || '').trim().toLowerCase();
                if (field) {
                    filters[field] = value;
                }
            });

            const rows = Array.from(customerTableBody.querySelectorAll('tr'));
            rows.forEach(row => {
                let visible = true;
                for (const [field, value] of Object.entries(filters)) {
                    if (!value) continue;
                    const dataValue = (row.dataset[field] || '').toLowerCase();
                    if (!dataValue.includes(value)) {
                        visible = false;
                        break;
                    }
                }
                row.style.display = visible ? '' : 'none';
            });
        }

        function loadCustomers(showStatus = false) {
            if (!customerListSection) return Promise.resolve([]);
            if (showStatus) {
                showCustomerStatus('Loading customers...', false, 'info');
            }
            return fetch('/api/customers')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    renderCustomers(data.customers || []);
                    return customerCache;
                })
                .catch(error => {
                    showCustomerStatus(`Error: ${error.message}`, true);
                    customerCache = [];
                    return [];
                });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

