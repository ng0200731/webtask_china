<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Receiver - v{{ version }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            color: #000000;
            background-color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .left-menu {
            width: 60px;
            background-color: #ffffff;
            border-right: 2px solid #000000;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: width 0.2s ease;
            overflow: hidden;
        }

        .left-menu:hover {
            width: 220px;
        }

        .menu-button {
            width: 100%;
            padding: 15px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-family: Arial, sans-serif;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
        }

        .menu-button:hover {
            background-color: #f0f0f0;
        }

        .menu-button.active {
            background-color: #000000;
            color: #ffffff;
        }

        .right-content {
            flex: 1;
            background-color: #ffffff;
            padding: 20px;
            overflow-y: auto;
        }

        .content-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000000;
        }

        .content-header h2 {
            font-family: Arial, sans-serif;
            font-size: 24px;
            color: #000000;
            margin-bottom: 5px;
        }

        .version-info {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #000000;
        }

        .email-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .email-item {
            border: 1px solid #000000;
            padding: 15px;
            background-color: #ffffff;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .email-item:hover {
            background-color: #f0f0f0;
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .email-subject {
            font-family: Arial, sans-serif;
            font-size: 18px;
            font-weight: bold;
            color: #000000;
        }

        .email-date {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #000000;
        }

        .email-from {
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
            margin-bottom: 5px;
        }

        .email-preview {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #000000;
            margin-top: 10px;
            max-height: 60px;
            overflow: hidden;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
        }

        .error {
            padding: 15px;
            border: 2px solid #000000;
            background-color: #ffffff;
            color: #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .qq-login-form {
            border: 1px solid #000000;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        .qq-login-form h3 {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #000000;
            background-color: #ffffff;
            color: #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }

        .form-button {
            padding: 10px 20px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            cursor: pointer;
        }

        .form-button:hover {
            background-color: #f0f0f0;
        }

        .hidden {
            display: none;
        }

        .settings-section {
            border: 1px solid #000000;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        .profile-list-view {
            border: 1px solid #000000;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        .profile-list-view h3 {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
            margin-bottom: 15px;
            border-bottom: 1px solid #000000;
            padding-bottom: 10px;
        }

        .profile-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-controls input[type="text"] {
            padding: 10px;
            border: 1px solid #000000;
            background-color: #ffffff;
            color: #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            flex: 1;
        }

        .profile-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .profile-item {
            border: 1px solid #000000;
            padding: 15px;
            background-color: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-item.active {
            background-color: #f0f0f0;
        }

        .profile-item-name {
            font-family: Arial, sans-serif;
            font-size: 16px;
            color: #000000;
        }

        .profile-detail-view {
            border: 1px solid #000000;
            padding: 20px;
            background-color: #ffffff;
        }

        .profile-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-button {
            padding: 10px 20px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            cursor: pointer;
        }

        .back-button:hover {
            background-color: #f0f0f0;
        }

        .profile-detail-title {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
        }

        .profile-detail-actions {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .form-button.danger {
            border-color: #000000;
            color: #000000;
        }

        /* Collapsed vs expanded labels */
        .label-short {
            font-weight: bold;
            width: 24px;
            min-width: 24px;
            text-align: center;
        }
        .label-full {
            white-space: nowrap;
        }
        .left-menu .label-full {
            display: none;
        }
        .left-menu:hover .label-full {
            display: inline;
        }
        .left-menu:hover .menu-button {
            justify-content: flex-start;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-menu">
            <button class="menu-button active" onclick="showReceiveMail()">
                <span class="label-short">R</span>
                <span class="label-full">Receive Mail</span>
            </button>
            <button class="menu-button" onclick="showTask()">
                <span class="label-short">T</span>
                <span class="label-full">Task</span>
            </button>
            <button class="menu-button" onclick="showSettings()">
                <span class="label-short">S</span>
                <span class="label-full">Settings</span>
            </button>
        </div>
        <div class="right-content">
            <div class="content-header">
                <h2 id="content-title">Receive Mail</h2>
                <div class="version-info">Version: <span id="version">v{{ version }}</span></div>
            </div>
            <div id="receive-mail-content">
                <button class="form-button" onclick="fetchGmailEmails()" style="margin-bottom: 20px; margin-right: 10px;">Fetch Gmail</button>
                <button class="form-button" onclick="fetch163Emails()" style="margin-bottom: 20px; margin-right: 10px;">Fetch 163.com</button>
                <button class="form-button" onclick="fetchQQEmails()" style="margin-bottom: 20px;">Fetch QQ Email</button>
                <div id="error-message"></div>
                <div id="email-list" class="email-list"></div>
            </div>
            <div id="task-content" class="hidden">
                <p style="font-family: Arial, sans-serif; font-size: 14px; color: #000000;">Task feature is pending.</p>
            </div>
            <div id="settings-content" class="hidden">
                <div id="profile-list-view" class="profile-list-view">
                    <h3>Profile Management</h3>
                    <div class="profile-controls">
                        <input type="text" id="new-profile-name" placeholder="New profile name">
                        <button class="form-button" onclick="createProfile()">Create Profile</button>
                    </div>
                    <div id="profile-list" class="profile-list"></div>
                </div>
                <div id="profile-detail-view" class="profile-detail-view hidden">
                    <div class="profile-detail-header">
                        <button class="back-button" onclick="showProfileList()">Back</button>
                        <div class="profile-detail-title">Profile: <span id="profile-name-display"></span></div>
                        <div style="width: 120px;"></div>
                    </div>
                    <div class="settings-section">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">Gmail Configuration</h3>
                        <div class="form-group">
                            <label for="gmail-imap-server">IMAP Server:</label>
                            <input type="text" id="gmail-imap-server" placeholder="imap.gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="gmail-port">Port:</label>
                            <input type="number" id="gmail-port" placeholder="993">
                        </div>
                        <div class="form-group">
                            <label for="gmail-username">Username:</label>
                            <input type="text" id="gmail-username" placeholder="your-email@gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="gmail-password">App Password:</label>
                            <input type="password" id="gmail-password" placeholder="Enter app password">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="gmail-use-ssl" checked>
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="gmail-use-tls">
                                <span>Use TLS</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top: 30px;">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">163.com Configuration</h3>
                        <div class="form-group">
                            <label for="163-imap-server">IMAP Server:</label>
                            <input type="text" id="163-imap-server" placeholder="imap.163.com">
                        </div>
                        <div class="form-group">
                            <label for="163-port">Port:</label>
                            <input type="number" id="163-port" placeholder="993">
                        </div>
                        <div class="form-group">
                            <label for="163-username">Username:</label>
                            <input type="text" id="163-username" placeholder="your-email@163.com">
                        </div>
                        <div class="form-group">
                            <label for="163-password">Authorization Code:</label>
                            <input type="password" id="163-password" placeholder="Enter authorization code">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="163-use-ssl" checked>
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="163-use-tls">
                                <span>Use TLS</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top: 30px;">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">QQ Email Configuration</h3>
                        <div class="form-group">
                            <label for="qq-imap-server">IMAP Server:</label>
                            <input type="text" id="qq-imap-server" placeholder="imap.qq.com">
                        </div>
                        <div class="form-group">
                            <label for="qq-port">Port:</label>
                            <input type="number" id="qq-port" placeholder="993">
                        </div>
                        <div class="form-group">
                            <label for="qq-username">Username:</label>
                            <input type="text" id="qq-username" placeholder="your-email@qq.com">
                        </div>
                        <div class="form-group">
                            <label for="qq-password">Authorization Code:</label>
                            <input type="password" id="qq-password" placeholder="Enter authorization code">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="qq-use-ssl" checked>
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="qq-use-tls">
                                <span>Use TLS</span>
                            </label>
                        </div>
                    </div>
                    <div class="profile-detail-actions">
                        <button class="form-button danger" onclick="deleteCurrentProfile()">Delete Profile</button>
                        <button class="form-button" onclick="saveCurrentProfile()" style="padding: 15px 30px; font-size: 16px;">Save Profile</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const VERSION = '{{ version }}';
        document.getElementById('version').textContent = 'v' + VERSION;

        // Initialize Profile 1 with default values from configuration
        function initializeProfile1() {
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            // Always set Profile 1 with the correct configuration values
            profiles.profile1 = {
                name: 'Profile 1',
                gmail: {
                    imap_server: 'imap.gmail.com',
                    port: 993,
                    username: 'eric.brilliant@gmail.com',
                    password: 'opqx pfna kagb bznr',
                    use_ssl: true,
                    use_tls: false
                },
                email163: {
                    imap_server: 'imap.163.com',
                    port: 993,
                    username: '19902475292@163.com',
                    password: 'JDy8MigeNmsESZRa',
                    use_ssl: true,
                    use_tls: false
                },
                qq: {
                    imap_server: 'imap.qq.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                }
            };
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
        }

        // Profile list/detail workflow (Level 1 -> Level 2)
        let currentProfileKey = localStorage.getItem('selectedProfile') || 'profile1';

        function renderProfileList() {
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            const listContainer = document.getElementById('profile-list');
            if (!listContainer) return;

            listContainer.innerHTML = '';
            const selected = localStorage.getItem('selectedProfile') || 'profile1';
            const keys = Object.keys(profiles);
            if (keys.length === 0) {
                const none = document.createElement('div');
                none.className = 'profile-item-name';
                none.textContent = 'No profiles.';
                listContainer.appendChild(none);
                return;
            }
            keys.forEach((key) => {
                const profile = profiles[key];
                const item = document.createElement('div');
                item.className = 'profile-item' + (selected === key ? ' active' : '');

                const name = document.createElement('div');
                name.className = 'profile-item-name';
                name.textContent = profile.name || key;

                const openBtn = document.createElement('button');
                openBtn.className = 'form-button';
                openBtn.textContent = 'Open';
                openBtn.onclick = () => openProfileDetail(key);

                item.appendChild(name);
                item.appendChild(openBtn);
                listContainer.appendChild(item);
            });
        }

        function showProfileList() {
            document.getElementById('profile-list-view').classList.remove('hidden');
            document.getElementById('profile-detail-view').classList.add('hidden');
            renderProfileList();
        }

        function openProfileDetail(profileKey) {
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            const profile = profiles[profileKey];
            if (!profile) return;
            currentProfileKey = profileKey;
            setCurrentProfile(profileKey);
            document.getElementById('profile-name-display').textContent = profile.name || profileKey;
            // Fill fields
            document.getElementById('gmail-imap-server').value = profile.gmail?.imap_server || '';
            document.getElementById('gmail-port').value = profile.gmail?.port || 993;
            document.getElementById('gmail-username').value = profile.gmail?.username || '';
            document.getElementById('gmail-password').value = profile.gmail?.password || '';
            document.getElementById('gmail-use-ssl').checked = profile.gmail?.use_ssl ?? true;
            document.getElementById('gmail-use-tls').checked = profile.gmail?.use_tls ?? false;

            document.getElementById('163-imap-server').value = profile.email163?.imap_server || '';
            document.getElementById('163-port').value = profile.email163?.port || 993;
            document.getElementById('163-username').value = profile.email163?.username || '';
            document.getElementById('163-password').value = profile.email163?.password || '';
            document.getElementById('163-use-ssl').checked = profile.email163?.use_ssl ?? true;
            document.getElementById('163-use-tls').checked = profile.email163?.use_tls ?? false;

            document.getElementById('qq-imap-server').value = profile.qq?.imap_server || '';
            document.getElementById('qq-port').value = profile.qq?.port || 993;
            document.getElementById('qq-username').value = profile.qq?.username || '';
            document.getElementById('qq-password').value = profile.qq?.password || '';
            document.getElementById('qq-use-ssl').checked = profile.qq?.use_ssl ?? true;
            document.getElementById('qq-use-tls').checked = profile.qq?.use_tls ?? false;

            document.getElementById('profile-list-view').classList.add('hidden');
            document.getElementById('profile-detail-view').classList.remove('hidden');
        }

        // Save current profile
        function saveCurrentProfile() {
            const profileKey = currentProfileKey || (localStorage.getItem('selectedProfile') || 'profile1');
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            
            if (!profiles[profileKey]) {
                profiles[profileKey] = { name: profiles[profileKey]?.name || profileKey };
            }
            
            // Save Gmail settings
            profiles[profileKey].gmail = {
                imap_server: document.getElementById('gmail-imap-server').value.trim(),
                port: parseInt(document.getElementById('gmail-port').value) || 993,
                username: document.getElementById('gmail-username').value.trim(),
                password: document.getElementById('gmail-password').value.trim(),
                use_ssl: document.getElementById('gmail-use-ssl').checked,
                use_tls: document.getElementById('gmail-use-tls').checked
            };
            
            // Save 163.com settings
            profiles[profileKey].email163 = {
                imap_server: document.getElementById('163-imap-server').value.trim(),
                port: parseInt(document.getElementById('163-port').value) || 993,
                username: document.getElementById('163-username').value.trim(),
                password: document.getElementById('163-password').value.trim(),
                use_ssl: document.getElementById('163-use-ssl').checked,
                use_tls: document.getElementById('163-use-tls').checked
            };
            
            // Save QQ settings
            profiles[profileKey].qq = {
                imap_server: document.getElementById('qq-imap-server').value.trim(),
                port: parseInt(document.getElementById('qq-port').value) || 993,
                username: document.getElementById('qq-username').value.trim(),
                password: document.getElementById('qq-password').value.trim(),
                use_ssl: document.getElementById('qq-use-ssl').checked,
                use_tls: document.getElementById('qq-use-tls').checked
            };
            
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
            showError('Profile saved successfully', false);
            renderProfileList();
        }

        // Create new profile
        function createProfile() {
            const newName = document.getElementById('new-profile-name').value.trim();
            if (!newName) {
                showError('Please enter a profile name');
                return;
            }
            
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            const profileKey = 'profile' + Date.now();
            
            profiles[profileKey] = {
                name: newName,
                gmail: {
                    imap_server: 'imap.gmail.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                },
                email163: {
                    imap_server: 'imap.163.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                },
                qq: {
                    imap_server: 'imap.qq.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                }
            };
            
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
            document.getElementById('new-profile-name').value = '';
            currentProfileKey = profileKey;
            setCurrentProfile(profileKey);
            openProfileDetail(profileKey);
            renderProfileList();
            showError('Profile created successfully', false);
        }

        // Delete current profile
        function deleteCurrentProfile() {
            const profileKey = currentProfileKey || 'profile1';
            if (profileKey === 'profile1') {
                showError('Cannot delete Profile 1');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this profile?')) {
                return;
            }
            
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            delete profiles[profileKey];
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
            setCurrentProfile('profile1');
            currentProfileKey = 'profile1';
            showProfileList();
            showError('Profile deleted successfully', false);
        }

        // Load settings on page load
        window.onload = function() {
            initializeProfile1();
            if (!localStorage.getItem('selectedProfile')) {
                setCurrentProfile('profile1');
            }
            showProfileList();
        };

        function showReceiveMail() {
            document.getElementById('receive-mail-content').classList.remove('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Receive Mail';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function showTask() {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('task-content').classList.remove('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Task';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function showSettings() {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('settings-content').classList.remove('hidden');
            document.getElementById('content-title').textContent = 'Settings';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            showProfileList();
        }


        function showError(message, isError = true) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.className = isError ? 'error' : 'error';
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }

        function getCurrentProfile() {
            // Get selected profile from localStorage or default to profile1
            const selectedProfile = localStorage.getItem('selectedProfile') || 'profile1';
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            return profiles[selectedProfile] || profiles.profile1 || {};
        }

        function setCurrentProfile(profileKey) {
            localStorage.setItem('selectedProfile', profileKey);
        }

        function fetchGmailEmails() {
            const emailList = document.getElementById('email-list');
            emailList.innerHTML = '<div class="loading">Loading Gmail emails...</div>';
            
            const profile = getCurrentProfile();
            const gmail = profile.gmail || {};
            const requestData = {
                limit: 50,
                imap_server: gmail.imap_server || 'imap.gmail.com',
                port: gmail.port || 993,
                username: gmail.username || '',
                password: gmail.password || '',
                use_ssl: gmail.use_ssl !== undefined ? gmail.use_ssl : true,
                use_tls: gmail.use_tls || false
            };
            
            fetch('/api/fetch-gmail', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        emailList.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                    } else {
                        displayEmails(data.emails || []);
                    }
                })
                .catch(error => {
                    emailList.innerHTML = `<div class="error">Error fetching emails: ${error.message}</div>`;
                });
        }

        function fetchQQEmails() {
            const profile = getCurrentProfile();
            const qq = profile.qq || {};
            
            if (!qq.username || !qq.password) {
                showError('Please save QQ settings first in Settings page');
                return;
            }

            const emailList = document.getElementById('email-list');
            emailList.innerHTML = '<div class="loading">Loading QQ emails...</div>';
            
            fetch('/api/fetch-qq', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    imap_server: qq.imap_server || 'imap.qq.com',
                    port: qq.port || 993,
                    username: qq.username,
                    password: qq.password,
                    use_ssl: qq.use_ssl !== undefined ? qq.use_ssl : true,
                    use_tls: qq.use_tls || false,
                    limit: 50
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        emailList.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                    } else {
                        displayEmails(data.emails || []);
                    }
                })
                .catch(error => {
                    emailList.innerHTML = `<div class="error">Error fetching emails: ${error.message}</div>`;
                });
        }

        function fetch163Emails() {
            const emailList = document.getElementById('email-list');
            emailList.innerHTML = '<div class="loading">Loading 163.com emails...</div>';
            
            const profile = getCurrentProfile();
            const email163 = profile.email163 || {};
            const requestData = {
                limit: 50,
                imap_server: email163.imap_server || 'imap.163.com',
                port: email163.port || 993,
                username: email163.username || '',
                password: email163.password || '',
                use_ssl: email163.use_ssl !== undefined ? email163.use_ssl : true,
                use_tls: email163.use_tls || false
            };
            
            fetch('/api/fetch-163', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        emailList.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                    } else {
                        displayEmails(data.emails || []);
                    }
                })
                .catch(error => {
                    emailList.innerHTML = `<div class="error">Error fetching emails: ${error.message}</div>`;
                });
        }

        function displayEmails(emails) {
            const emailList = document.getElementById('email-list');
            
            if (emails.length === 0) {
                emailList.innerHTML = '<div class="loading">No emails found</div>';
                return;
            }
            
            emailList.innerHTML = emails.map(email => `
                <div class="email-item">
                    <div class="email-header">
                        <div class="email-subject">${escapeHtml(email.subject || 'No Subject')}</div>
                        <div class="email-date">${escapeHtml(email.date || '')}</div>
                    </div>
                    <div class="email-from">From: ${escapeHtml(email.from || '')}</div>
                    <div class="email-preview">${escapeHtml(email.body || '')}</div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

