<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Receiver - v{{ version }}</title>
    <!-- Quill.js Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            color: #000000;
            background-color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .left-menu {
            width: 60px;
            background-color: #ffffff;
            border-right: 2px solid #000000;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: width 0.2s ease;
            overflow: hidden;
        }

        .left-menu:hover {
            width: 220px;
        }

        .menu-button {
            width: 100%;
            padding: 15px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-family: Arial, sans-serif;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
        }

        .menu-button:hover {
            background-color: #f0f0f0;
        }

        .menu-button.active {
            background-color: #000000;
            color: #ffffff;
        }

        .right-content {
            flex: 1;
            background-color: #ffffff;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-overlay-content {
            text-align: center;
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
        }

        .loading-spinner {
            border: 3px solid #f0f0f0;
            border-top: 3px solid #000000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .content-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000000;
        }

        .content-header h2 {
            font-family: Arial, sans-serif;
            font-size: 24px;
            color: #000000;
            margin-bottom: 5px;
        }

        .version-info {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #000000;
        }

        .email-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .email-item {
            border: 1px solid #000000;
            background-color: #ffffff;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: stretch;
            overflow: hidden;
        }

        .email-item:hover {
            background-color: #f0f0f0;
        }

        .email-content {
            flex: 1 1 auto;
            min-width: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: hidden;
        }

        .email-actions {
            flex: 0 0 80px;
            border-left: 1px solid #000000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background-color: #ffffff;
        }

        .email-action-button {
            width: 100%;
            padding: 8px;
            font-size: 12px;
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .email-subject {
            font-family: Arial, sans-serif;
            font-size: 18px;
            font-weight: bold;
            color: #000000;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .email-sequence-inline {
            font-family: Arial, sans-serif;
            font-size: 14px;
            font-weight: normal;
            margin-left: 10px;
        }

        .email-date {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #000000;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .email-from {
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .email-preview {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #000000;
            margin-top: 10px;
            overflow: hidden;
            word-break: break-word;
            overflow-wrap: anywhere;
            display: -webkit-box;
            line-clamp: 3;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .email-attachments {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .task-attachment-entry {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 6px;
        }

        .task-attachment-display {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px;
            border: 1px solid #000000;
            margin-bottom: 10px;
            background-color: #ffffff;
        }

        .task-attachment-info {
            flex: 1;
        }

        .task-attachment-actions {
            display: flex;
            gap: 8px;
            margin-left: 10px;
        }

        .task-display-item {
            font-family: Arial, sans-serif;
        }

        #task-form-dropzone {
            cursor: pointer;
        }

        #task-form-dropzone:hover {
            background-color: #f0f0f0;
        }

        .attachment-view-link {
            text-decoration: underline;
            color: #0066cc;
            cursor: pointer;
        }

        .attachment-view-link:hover {
            color: #004a99;
        }

        .attachment-download-link {
            text-decoration: none;
            font-size: 16px;
        }

        .attachment-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border: 1px solid #000000;
            border-radius: 16px;
            font-size: 12px;
            text-decoration: none;
            color: #000000;
            background-color: #ffffff;
        }

        .attachment-chip:hover {
            background-color: #f0f0f0;
        }

        .attachment-button {
            font-size: 12px;
            margin-bottom: 8px;
        }

        .attachment-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .attachment-row {
            border: 1px solid #000000;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .attachment-row-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .attachment-filename {
            word-break: break-all;
            overflow-wrap: anywhere;
        }

        .attachment-size {
            font-size: 11px;
        }

        .task-type-row {
            cursor: move;
        }

        .task-type-row.drag-over {
            background-color: #f0f0f0;
        }

        .task-type-handle {
            width: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            user-select: none;
            color: #000000;
        }

        .task-type-handle-icon {
            font-size: 16px;
            line-height: 1;
            margin-bottom: 4px;
        }

        .task-type-seq {
            font-size: 12px;
        }

        .autocomplete-wrapper {
            position: relative;
            width: 100%;
            display: flex;
            align-items: stretch;
        }

        .autocomplete-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #000000;
            border-right: none;
            background-color: #ffffff;
            color: #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }

        .autocomplete-dropdown-btn {
            width: 30px;
            padding: 8px;
            border: 1px solid #000000;
            background-color: #ffffff;
            color: #000000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            user-select: none;
        }

        .autocomplete-dropdown-btn:hover {
            background-color: #f0f0f0;
        }

        .autocomplete-dropdown-btn::after {
            content: '‚ñº';
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border: 1px solid #000000;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.highlighted {
            background-color: #f0f0f0;
        }

        .autocomplete-item-name {
            font-weight: bold;
        }

        .autocomplete-item-email {
            font-size: 12px;
            color: #666666;
            margin-top: 2px;
        }

        .preview-modal-content {
            width: 100%;
            height: 100%;
            display: flex;
            position: relative;
        }

        .preview-modal-content img {
            max-width: none;
            max-height: none;
            height: auto;
            width: auto;
            object-fit: contain;
            cursor: grab;
            user-select: none;
            -webkit-user-drag: none;
            transition: transform 0.1s ease-out;
            display: block;
            margin: auto;
        }

        .preview-modal-content img:active {
            cursor: grabbing;
        }

        .preview-modal-content img.dragging {
            cursor: grabbing;
        }

        .preview-modal-content object,
        .preview-modal-content embed {
            width: 100%;
            height: 100%;
            min-height: 100%;
            border: none;
            display: block;
        }

        .preview-modal-content iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .preview-modal-content object {
            min-width: 100%;
        }

        .attachment-actions {
            display: flex;
            gap: 8px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
        }

        .error {
            padding: 15px;
            border: 2px solid #000000;
            background-color: #ffffff;
            color: #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .qq-login-form {
            border: 1px solid #000000;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        .qq-login-form h3 {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .customer-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 15px 20px;
        }

        .customer-form-grid .form-group-full {
            grid-column: 1 / -1;
        }

        .customer-form-grid .form-group-rich {
            display: flex;
            flex-direction: column;
        }

        .customer-form-grid .form-group-rich #customer-remark {
            flex: 1;
        }

        /* Ensure Create Customer area is clean white with even spacing */
        #create-customer-content .settings-section {
            background-color: #ffffff;
        }

        .form-group label {
            display: block;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #000000;
            background-color: #ffffff;
            color: #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }

        .form-button {
            padding: 10px 20px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            cursor: pointer;
        }

        .form-button:hover {
            background-color: #f0f0f0;
        }

        .hidden {
            display: none;
        }

        .settings-section {
            border: 1px solid #000000;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        .profile-list-view {
            border: 1px solid #000000;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        .profile-list-view h3 {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
            margin-bottom: 15px;
            border-bottom: 1px solid #000000;
            padding-bottom: 10px;
        }

        .profile-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-controls input[type="text"] {
            padding: 10px;
            border: 1px solid #000000;
            background-color: #ffffff;
            color: #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            flex: 1;
        }

        .profile-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .profile-item {
            border: 1px solid #000000;
            padding: 15px;
            background-color: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-item.active {
            background-color: #f0f0f0;
        }

        .profile-item-name {
            font-family: Arial, sans-serif;
            font-size: 16px;
            color: #000000;
        }

        .profile-detail-view {
            border: 1px solid #000000;
            padding: 20px;
            background-color: #ffffff;
        }

        .profile-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-button {
            padding: 10px 20px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            cursor: pointer;
        }

        .back-button:hover {
            background-color: #f0f0f0;
        }

        .profile-detail-title {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
        }

        .profile-detail-actions {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .form-button.danger {
            border-color: #000000;
            color: #000000;
        }

        .message {
            margin-top: 10px;
            padding: 12px;
            border: 1px solid #000000;
            background-color: #f5f5f5;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
        .message.error {
            background-color: #f5dada;
        }
        .message.success {
            background-color: #d8f5d8;
        }
        .message.info {
            background-color: #e8e8e8;
        }

        /* Collapsed vs expanded labels */
        .label-short {
            font-weight: bold;
            width: 24px;
            min-width: 24px;
            text-align: center;
        }
        .label-full {
            white-space: nowrap;
        }
        .left-menu .label-full {
            display: none;
        }
        .left-menu:hover .label-full {
            display: inline;
        }
        .left-menu:hover .menu-button {
            justify-content: flex-start;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.4);
            padding: 40px;
            z-index: 1000;
        }

        #preview-modal {
            z-index: 2000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-dialog {
            width: 80vw;
            max-width: 1000px;
            max-height: 90vh;
            background-color: #ffffff;
            border: 2px solid #000000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #email-modal .modal-dialog {
            width: 80vw;
            height: 80vh;
            max-width: none;
            max-height: 80vh;
        }

        .preview-modal-dialog {
            width: 95vw;
            max-width: 95vw;
            height: 95vh;
            max-height: 95vh;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 2px solid #000000;
        }

        .modal-title {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
        }

        .modal-meta {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #000000;
            margin-top: 5px;
            white-space: pre-line;
        }

        .modal-close {
            padding: 8px 16px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            cursor: pointer;
        }

        .modal-close:hover {
            background-color: #f0f0f0;
        }

        .modal-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
        }

        #email-modal .modal-body {
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            min-height: 0;
        }

        .modal-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background-color: #ffffff;
        }

        #email-modal .modal-iframe {
            width: 100%;
            min-height: 100%;
            height: auto;
            display: block;
            border: none;
        }
        
        /* Ensure iframe content inside is scrollable */
        #email-modal-frame {
            overflow: visible;
        }
        
        /* Style for content inside iframe */
        #email-modal-frame body {
            margin: 0;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .task-modal-body {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
        }

        .task-template-cell {
            max-width: 300px;
            max-height: 150px;
            overflow: auto;
            white-space: normal;
        }

        .task-modal-body textarea {
            flex: 1;
            width: 100%;
            border: 1px solid #000000;
            padding: 10px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            background-color: #ffffff;
        }

        .task-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .task-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        .email-compose {
            border: 1px solid #000000;
            padding: 20px;
            background-color: #ffffff;
            margin-bottom: 25px;
        }

        .email-compose h3 {
            font-family: Arial, sans-serif;
            font-size: 18px;
            margin-bottom: 15px;
            color: #000000;
        }

        .compose-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .compose-grid .form-group {
            flex: 1;
            min-width: 200px;
        }

        .email-compose textarea {
            width: 100%;
            min-height: 160px;
            border: 1px solid #000000;
            padding: 10px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
            background-color: #ffffff;
            margin-top: 10px;
        }

        .compose-options {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .compose-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .customer-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .customer-table th,
        .customer-table td {
            border: 1px solid #000000;
            padding: 10px;
            text-align: left;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }

        .customer-table th {
            background-color: #f0f0f0;
        }

        #customer-remark.empty:before {
            content: attr(data-placeholder);
            color: #999;
            pointer-events: none;
        }

        #customer-remark:focus {
            outline: 2px solid #000000;
        }

        .customer-table td a {
            color: #0066cc;
            text-decoration: underline;
        }

        .customer-table td a:hover {
            color: #004499;
        }

        .country-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border: 1px solid #000000;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .country-dropdown-item {
            padding: 8px 10px;
            cursor: pointer;
            font-family: Arial, sans-serif;
            font-size: 14px;
            border-bottom: 1px solid #eee;
        }

        .country-dropdown-item:hover {
            background-color: #f0f0f0;
        }

        .country-dropdown-item.selected {
            background-color: #e0e0e0;
        }

        .attachment-drop-area {
            border: 2px dashed #000000;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background-color: #f9f9f9;
            transition: background-color 0.3s, border-color 0.3s;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .attachment-drop-area:hover {
            background-color: #f0f0f0;
        }

        .attachment-drop-area.drag-over {
            background-color: #e8f4f8;
            border-color: #0066cc;
        }

        .attachment-drop-content {
            pointer-events: none;
        }

        .attachment-list {
            margin-top: 10px;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 12px;
        }

        .attachment-item-name {
            flex: 1;
            margin-right: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .attachment-item-size {
            color: #666;
            margin-right: 10px;
        }

        .attachment-item-remove {
            cursor: pointer;
            color: #cc0000;
            font-weight: bold;
            padding: 2px 6px;
        }

        .attachment-item-remove:hover {
            background-color: #ffcccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-menu">
            <button class="menu-button active" onclick="showReceiveMail()">
                <span class="label-short">R</span>
                <span class="label-full">Receive Mail</span>
            </button>
            <button class="menu-button" onclick="showSend()">
                <span class="label-short">S</span>
                <span class="label-full">Send</span>
            </button>
            <button class="menu-button" onclick="showCreateCustomer()">
                <span class="label-short">C</span>
                <span class="label-full">Create Customer</span>
            </button>
            <button class="menu-button" onclick="showTask()">
                <span class="label-short">T</span>
                <span class="label-full">Task</span>
            </button>
            <button class="menu-button" onclick="showTaskList()">
                <span class="label-short">TL</span>
                <span class="label-full">Task List</span>
            </button>
            <button class="menu-button" onclick="showDropdownList()">
                <span class="label-short">D</span>
                <span class="label-full">Dropdown List</span>
            </button>
            <button class="menu-button" onclick="showSettings()">
                <span class="label-short">S</span>
                <span class="label-full">Settings</span>
            </button>
        </div>
        <div class="right-content">
            <div class="loading-overlay" id="email-loading-overlay">
                <div class="loading-overlay-content">
                    <div class="loading-spinner"></div>
                    <div>Checking for new emails from web page...</div>
                </div>
            </div>
            <div class="content-header">
                <h2 id="content-title">Receive Mail</h2>
                <div class="version-info">Version: <span id="version">v{{ version }}</span></div>
            </div>
            <div id="receive-mail-content">
                <button class="form-button" onclick="fetchGmailEmails()" style="margin-bottom: 20px; margin-right: 10px;">Fetch Gmail</button>
                <button class="form-button" onclick="checkGmailStatus()" style="margin-bottom: 20px; margin-right: 10px; font-size: 12px;">Check Gmail Status</button>
                <button class="form-button" onclick="fetch163Emails()" style="margin-bottom: 20px; margin-right: 10px;">Fetch 163.com</button>
                <button class="form-button" onclick="fetchQQEmails()" style="margin-bottom: 20px;">Fetch QQ Email</button>
                <div id="error-message" class="message hidden"></div>
                <div id="email-list" class="email-list"></div>
            </div>
            <div id="create-customer-content" class="hidden">
                <div class="settings-section">
                    <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">Create Customer</h3>
                    <div class="customer-form-grid">
                        <!-- Row 1: Country | Company Name -->
                        <div class="form-group">
                            <label for="customer-country">Country</label>
                            <div style="position: relative;">
                                <input type="text" id="customer-country" placeholder="Search or select country" autocomplete="off" oninput="filterCountries()" onfocus="showCountryDropdown()" onblur="setTimeout(() => hideCountryDropdown(), 200)">
                                <div id="country-dropdown" class="country-dropdown hidden"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="company-name">Company Name</label>
                            <input type="text" id="company-name" placeholder="Enter company name">
                        </div>

                        <!-- Row 2: Customer Name | Email -->
                        <div class="form-group">
                            <label for="customer-name">Customer Name</label>
                            <input type="text" id="customer-name" placeholder="Enter customer name">
                        </div>
                        <div class="form-group">
                            <label for="customer-email-address">Email</label>
                            <input type="email" id="customer-email-address" placeholder="customer@example.com" pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}">
                        </div>

                        <!-- Row 3: Web Site (full width) -->
                        <div class="form-group form-group-full">
                            <label for="customer-website">Web Site</label>
                            <input type="url" id="customer-website" placeholder="https://example.com">
                        </div>

                        <!-- Row 4: Attachment | Remark (rich text) -->
                        <div class="form-group">
                            <label>Attachment</label>
                            <div id="customer-attachment-area" class="attachment-drop-area" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="document.getElementById('customer-attachment-input').click()">
                                <div class="attachment-drop-content">
                                    <div style="font-size: 24px; margin-bottom: 10px;">üìé</div>
                                    <div>Drag and drop files here or click to select</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Multiple files supported</div>
                                </div>
                                <input type="file" id="customer-attachment-input" multiple style="display: none;" onchange="handleAttachmentSelect(event)">
                            </div>
                            <div id="customer-attachment-list" class="attachment-list"></div>
                        </div>
                        <div class="form-group form-group-rich">
                            <label for="customer-remark">Remark (Rich Text)</label>
                            <div id="customer-remark" contenteditable="true" style="min-height: 120px; border: 1px solid #000000; padding: 8px; font-family: Arial, sans-serif; font-size: 14px; background-color: #ffffff; color: #000000; overflow-y: auto;" data-placeholder="Enter remarks with HTML formatting..."></div>
                            <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                <button type="button" onclick="formatText('bold')" style="padding: 3px 8px; margin-right: 5px; font-size: 11px;">Bold</button>
                                <button type="button" onclick="formatText('italic')" style="padding: 3px 8px; margin-right: 5px; font-size: 11px;">Italic</button>
                                <button type="button" onclick="formatText('underline')" style="padding: 3px 8px; margin-right: 5px; font-size: 11px;">Underline</button>
                                <button type="button" onclick="formatText('insertUnorderedList')" style="padding: 3px 8px; margin-right: 5px; font-size: 11px;">List</button>
                            </div>
                        </div>
                    </div>
                    <div class="compose-actions">
                        <button class="form-button" onclick="saveCustomer()">Save Customer</button>
                        <div id="customer-status" class="message info hidden"></div>
                    </div>
                </div>
                <div id="customer-list-section" class="settings-section hidden">
                    <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">Customers</h3>
                    <table class="customer-table">
                        <thead>
                            <tr>
                                <th style="width: 12%;">Name</th>
                                <th style="width: 15%;">Email Address</th>
                                <th style="width: 10%;">Country</th>
                                <th style="width: 12%;">Website</th>
                                <th style="width: 15%;">Remark</th>
                                <th style="width: 12%;">Attachments</th>
                                <th style="width: 12%;">Created At</th>
                                <th style="width: 10%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customer-table-body">
                        </tbody>
                    </table>
                    <div id="customer-empty" class="message info hidden">No customers yet. Add one above.</div>
                </div>
            </div>
            <div id="send-mail-content" class="hidden">
                <div class="email-compose">
                    <h3>Send Email (SMTP)</h3>
                    <div class="compose-grid">
                        <div class="form-group">
                            <label for="compose-to">To:</label>
                            <input type="text" id="compose-to" placeholder="recipient@example.com">
                        </div>
                        <div class="form-group">
                            <label for="compose-subject">Subject:</label>
                            <input type="text" id="compose-subject" placeholder="Subject line">
                        </div>
                        <div class="form-group">
                            <label for="compose-sender-name">Sender Name (optional):</label>
                            <input type="text" id="compose-sender-name" placeholder="Mail Task">
                        </div>
                    </div>
                    <textarea id="compose-body" placeholder="Write your email content here..."></textarea>
                    <div class="compose-options">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="compose-is-html">
                            <span>Send as HTML</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="use-primary-smtp" checked>
                            <span>Use Primary SMTP</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="use-backup-smtp" checked>
                            <span>Use Backup SMTP</span>
                        </label>
                    </div>
                    <div class="compose-actions">
                        <button class="form-button" onclick="sendEmail()">Send Email</button>
                        <div id="send-email-status" class="message info hidden"></div>
                    </div>
                </div>
            </div>
            <div id="task-content" class="hidden">
                <div id="task-display-container"></div>
            </div>
            <div id="task-list-content" class="hidden">
                <div id="task-list-container"></div>
            </div>
            <div id="dropdown-list-content" class="hidden">
                <div>
                    <h3 style="margin-bottom: 15px;">Manage Task Type Dropdown</h3>
                    <div style="margin-bottom: 20px;">
                        <input type="text" id="new-task-type-input" placeholder="Enter new task type name" style="width: 300px; padding: 8px; border: 1px solid #000000; margin-right: 10px;" onkeypress="if(event.key === 'Enter') addTaskType()">
                        <button class="form-button" onclick="addTaskType()" style="padding: 8px 20px;">Add New Type</button>
                    </div>
                    <div id="task-types-list" style="border: 1px solid #000000; padding: 15px; background-color: #ffffff;">
                        <div style="text-align: center; padding: 20px; color: #666;">Loading task types...</div>
                    </div>
                </div>
            </div>
            <div id="settings-content" class="hidden">
                <div id="profile-list-view" class="profile-list-view">
                    <h3>Profile Management</h3>
                    <div class="profile-controls">
                        <input type="text" id="new-profile-name" placeholder="New profile name">
                        <button class="form-button" onclick="createProfile()">Create Profile</button>
                    </div>
                    <div id="profile-list" class="profile-list"></div>
                </div>
                <div id="profile-detail-view" class="profile-detail-view hidden">
                    <div class="profile-detail-header">
                        <button class="back-button" onclick="showProfileList()">Back</button>
                        <div class="profile-detail-title">Profile: <span id="profile-name-display"></span></div>
                        <div style="width: 120px;"></div>
                    </div>
                    <div class="settings-section">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">Gmail Configuration</h3>
                        <div class="form-group">
                            <label for="gmail-imap-server">IMAP Server:</label>
                            <input type="text" id="gmail-imap-server" placeholder="imap.gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="gmail-port">Port:</label>
                            <input type="number" id="gmail-port" placeholder="993">
                        </div>
                        <div class="form-group">
                            <label for="gmail-username">Username:</label>
                            <input type="text" id="gmail-username" placeholder="your-email@gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="gmail-password">App Password:</label>
                            <input type="password" id="gmail-password" placeholder="Enter app password">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="gmail-use-ssl" checked>
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="gmail-use-tls">
                                <span>Use TLS</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top: 30px; background-color: #f9f9f9; padding: 20px; border: 2px solid #000000;">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">Gmail API OAuth 2.0 (Required for Fetching Emails)</h3>
                        
                        <div style="background-color: #e7f3ff; border: 2px solid #0066cc; padding: 20px; margin-bottom: 20px; font-family: Arial, sans-serif; font-size: 14px; border-radius: 4px;">
                            <h4 style="color: #0066cc; margin-top: 0; margin-bottom: 15px; font-size: 16px;">üìñ Step-by-Step Guide to Get Gmail OAuth Credentials</h4>
                            
                            <div style="background-color: #ffffff; padding: 15px; margin-bottom: 15px; border: 1px solid #0066cc; border-radius: 4px;">
                                <strong style="color: #0066cc;">Step 1: Open Google Cloud Console</strong>
                                <p style="margin: 5px 0;">Click this button to open the credentials page:</p>
                                <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="display: inline-block; padding: 10px 20px; background-color: #0066cc; color: white; text-decoration: none; border-radius: 4px; margin-top: 10px; font-weight: bold;">üîó Open Google Cloud Console</a>
                                <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">(This will open in a new tab. Keep this page open!)</p>
                            </div>

                            <div style="background-color: #ffffff; padding: 15px; margin-bottom: 15px; border: 1px solid #0066cc; border-radius: 4px;">
                                <strong style="color: #0066cc;">Step 2: Create a New Project (if you don't have one)</strong>
                                <ol style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                    <li>At the top of the page, click the project dropdown (next to "Google Cloud")</li>
                                    <li>Click <strong>"NEW PROJECT"</strong></li>
                                    <li>Enter project name: <code style="background: #f0f0f0; padding: 2px 5px;">Mail Task</code></li>
                                    <li>Click <strong>"CREATE"</strong></li>
                                    <li>Wait a few seconds, then select your new project from the dropdown</li>
                                </ol>
                            </div>

                            <div style="background-color: #ffffff; padding: 15px; margin-bottom: 15px; border: 1px solid #0066cc; border-radius: 4px;">
                                <strong style="color: #0066cc;">Step 3: Enable Gmail API</strong>
                                <ol style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                    <li>In the left menu, click <strong>"APIs & Services"</strong> ‚Üí <strong>"Library"</strong></li>
                                    <li>Search for <strong>"Gmail API"</strong></li>
                                    <li>Click on <strong>"Gmail API"</strong></li>
                                    <li>Click the blue <strong>"ENABLE"</strong> button</li>
                                    <li>Wait for it to enable (takes a few seconds)</li>
                                </ol>
                            </div>

                            <div style="background-color: #ffffff; padding: 15px; margin-bottom: 15px; border: 1px solid #0066cc; border-radius: 4px;">
                                <strong style="color: #0066cc;">Step 4: Configure OAuth Consent Screen (First Time Only)</strong>
                                <ol style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                    <li>Go to <strong>"APIs & Services"</strong> ‚Üí <strong>"OAuth consent screen"</strong> (in left menu)</li>
                                    <li>Select <strong>"External"</strong> ‚Üí Click <strong>"CREATE"</strong></li>
                                    <li><strong>App name:</strong> Enter <code style="background: #f0f0f0; padding: 2px 5px;">Mail Task</code></li>
                                    <li><strong>User support email:</strong> Select your email</li>
                                    <li><strong>Developer contact:</strong> Enter your email</li>
                                    <li>Click <strong>"SAVE AND CONTINUE"</strong></li>
                                    <li>On "Scopes" page, click <strong>"SAVE AND CONTINUE"</strong> (no need to add scopes)</li>
                                    <li>On "Test users" page, click <strong>"+ ADD USERS"</strong></li>
                                    <li>Enter <strong>YOUR Gmail address</strong> (the one you want to fetch emails from)</li>
                                    <li>Click <strong>"ADD"</strong> ‚Üí Click <strong>"SAVE AND CONTINUE"</strong></li>
                                    <li>Review and click <strong>"BACK TO DASHBOARD"</strong></li>
                                </ol>
                                <p style="margin: 10px 0 0 0; padding: 10px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; font-size: 12px;">
                                    <strong>‚ö†Ô∏è Important:</strong> You MUST add yourself as a test user, otherwise authentication will fail!
                                </p>
                            </div>

                            <div style="background-color: #ffffff; padding: 15px; margin-bottom: 15px; border: 1px solid #0066cc; border-radius: 4px;">
                                <strong style="color: #0066cc;">Step 5: Create OAuth Client ID</strong>
                                <ol style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                    <li>Go to <strong>"APIs & Services"</strong> ‚Üí <strong>"Credentials"</strong> (in left menu)</li>
                                    <li>At the top, click <strong>"+ CREATE CREDENTIALS"</strong></li>
                                    <li>Select <strong>"OAuth client ID"</strong></li>
                                    <li>If you see "Application type", select <strong>"Web application"</strong></li>
                                    <li><strong>Name:</strong> Enter <code style="background: #f0f0f0; padding: 2px 5px;">Mail Task App</code></li>
                                    <li>Under <strong>"Authorized redirect URIs"</strong>, click <strong>"+ ADD URI"</strong></li>
                                    <li>Paste this exact URL: <code style="background: #f0f0f0; padding: 2px 5px; font-weight: bold;">http://localhost:5000/oauth2callback</code></li>
                                    <li>Click <strong>"CREATE"</strong></li>
                                </ol>
                            </div>

                            <div style="background-color: #ffffff; padding: 15px; margin-bottom: 15px; border: 1px solid #0066cc; border-radius: 4px;">
                                <strong style="color: #0066cc;">Step 6: Copy Your Credentials</strong>
                                <p style="margin: 5px 0;">After clicking "CREATE", a popup will appear with your credentials:</p>
                                <ol style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                    <li><strong>Client ID:</strong> A long string ending in <code style="background: #f0f0f0; padding: 2px 5px;">.apps.googleusercontent.com</code>
                                        <br><span style="color: #666; font-size: 12px;">Example: 123456789-abcdefghijklmnop.apps.googleusercontent.com</span></li>
                                    <li><strong>Client Secret:</strong> A shorter string starting with <code style="background: #f0f0f0; padding: 2px 5px;">GOCSPX-</code>
                                        <br><span style="color: #666; font-size: 12px;">Example: GOCSPX-abcdefghijklmnopqrstuvwxyz</span></li>
                                    <li>Click the <strong>copy icon</strong> next to each one, or select and copy manually</li>
                                    <li>Click <strong>"OK"</strong> to close the popup</li>
                                </ol>
                                <p style="margin: 10px 0 0 0; padding: 10px; background-color: #f8d7da; border: 1px solid #dc3545; border-radius: 4px; font-size: 12px;">
                                    <strong>‚ö†Ô∏è Important:</strong> You can only see the Client Secret ONCE! Copy it now or you'll need to create a new one.
                                </p>
                            </div>

                            <div style="background-color: #ffffff; padding: 15px; margin-bottom: 15px; border: 1px solid #0066cc; border-radius: 4px;">
                                <strong style="color: #0066cc;">Step 7: Paste Credentials Below</strong>
                                <p style="margin: 5px 0;">Now paste the Client ID and Client Secret into the fields below, then:</p>
                                <ol style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                    <li>Click <strong>"Save Profile"</strong> button (at the bottom of this page)</li>
                                    <li>Click <strong>"üîê Authenticate Gmail"</strong> button</li>
                                    <li>A new window will open - sign in with your Gmail account</li>
                                    <li>Click <strong>"Allow"</strong> to grant permissions</li>
                                    <li>The window will close automatically</li>
                                    <li>You're done! Try fetching emails now.</li>
                                </ol>
                            </div>

                            <div style="margin-top: 15px; padding: 10px; background-color: #f8d7da; border: 1px solid #dc3545; border-radius: 4px;">
                                <strong style="color: #721c24;">‚ö†Ô∏è IMPORTANT: You Need a "Web Application" OAuth Client!</strong>
                                <p style="margin: 5px 0; font-size: 12px;">I see you have a "Desktop client 1" (Type: Desktop). We need a <strong>"Web application"</strong> type instead.</p>
                                <div style="background-color: #fff3cd; border: 1px solid #ffc107; padding: 10px; margin: 10px 0; border-radius: 4px;">
                                    <strong style="color: #856404;">üìù Create a NEW Web Application OAuth Client:</strong>
                                    <ol style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                                        <li>On the Credentials page, click <strong>"+ CREATE CREDENTIALS"</strong> (top blue button)</li>
                                        <li>Select <strong>"OAuth client ID"</strong> from the dropdown</li>
                                        <li>If asked for "Application type", select <strong>"Web application"</strong> (NOT Desktop!)</li>
                                        <li>Name it: <code style="background: #f0f0f0; padding: 2px 5px;">Mail Task Web App</code></li>
                                        <li><strong>IMPORTANT:</strong> There are TWO different fields - fill BOTH:</li>
                                        <li style="margin-left: 20px;">
                                            <strong>1. "Authorized JavaScript origins"</strong> (if shown):
                                            <ul style="margin: 5px 0; padding-left: 20px;">
                                                <li>Click <strong>"+ ADD URI"</strong></li>
                                                <li>Enter ONLY: <code style="background: #f0f0f0; padding: 2px 5px;">http://localhost:5000</code> (NO path!)</li>
                                            </ul>
                                        </li>
                                        <li style="margin-left: 20px;">
                                            <strong>2. "Authorized redirect URIs"</strong>:
                                            <ul style="margin: 5px 0; padding-left: 20px;">
                                                <li>Click <strong>"+ ADD URI"</strong></li>
                                                <li>Enter FULL path: <code style="background: #f0f0f0; padding: 2px 5px;">http://localhost:5000/oauth2callback</code></li>
                                            </ul>
                                        </li>
                                        <li>Click <strong>"CREATE"</strong></li>
                                        <li>A popup will show your <strong>Client ID</strong> and <strong>Client Secret</strong></li>
                                        <li><strong>Copy BOTH immediately</strong> (the secret won't be shown again!)</li>
                                        <li>Paste them in the fields below</li>
                                    </ol>
                                    <div style="background-color: #f8d7da; border: 1px solid #dc3545; padding: 8px; margin-top: 10px; border-radius: 4px; font-size: 11px;">
                                        <strong style="color: #721c24;">‚ö†Ô∏è Common Error:</strong> If you see "Invalid origin: URIs must not contain a path", you're entering the redirect URI in the wrong field. Use <code>http://localhost:5000</code> (no path) for "Authorized JavaScript origins" and <code>http://localhost:5000/oauth2callback</code> (with path) for "Authorized redirect URIs".
                                    </div>
                                </div>
                                <p style="margin: 10px 0 0 0; font-size: 11px; color: #721c24;"><strong>Note:</strong> The existing "Desktop client 1" won't work for web redirects. You must create a new "Web application" client.</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="gmail-oauth-client-id">OAuth Client ID:</label>
                            <input type="text" id="gmail-oauth-client-id" placeholder="123456789-abc123def456.apps.googleusercontent.com" style="font-family: monospace; font-size: 12px;" value="">
                            <small style="font-size: 11px; color: #666;">Enter your Client ID from Google Cloud Console</small>
                        </div>
                        <div class="form-group">
                            <label for="gmail-oauth-client-secret">OAuth Client Secret:</label>
                            <input type="password" id="gmail-oauth-client-secret" placeholder="GOCSPX-xxxxxxxxxxxxx" style="font-family: monospace; font-size: 12px;" value="">
                            <small style="font-size: 11px; color: #666;">Enter your Client Secret from Google Cloud Console (starts with GOCSPX-)</small>
                        </div>
                        <div class="form-group">
                            <label for="gmail-oauth-redirect-uri">Redirect URI:</label>
                            <input type="text" id="gmail-oauth-redirect-uri" placeholder="http://localhost:5000/oauth2callback" value="http://localhost:5000/oauth2callback" readonly style="background-color: #f5f5f5;">
                            <small style="font-size: 11px; color: #666;">This should match what you entered in Google Cloud Console</small>
                        </div>
                        <div style="background-color: #f8d7da; border: 2px solid #dc3545; padding: 15px; margin: 15px 0; border-radius: 4px; font-family: Arial, sans-serif; font-size: 13px;">
                            <strong style="color: #721c24; font-size: 14px;">üö® CRITICAL: You MUST Add Yourself as Test User!</strong>
                            <p style="margin: 10px 0 8px 0; color: #721c24; font-weight: bold;">If you see "403: access_denied" or "Â∞öÊú™ÂÆåÊàê Google È™åËØÅÊµÅÁ®ã", follow these steps:</p>
                            <div style="background-color: #fff3cd; border: 1px solid #ffc107; padding: 12px; margin: 10px 0; border-radius: 4px;">
                                <strong style="color: #856404;">Step-by-Step Instructions:</strong>
                                <ol style="margin: 8px 0; padding-left: 25px; color: #856404; line-height: 1.8;">
                                    <li>Click this link: <a href="https://console.cloud.google.com/apis/credentials/consent" target="_blank" style="color: #0066cc; font-weight: bold; text-decoration: underline;">Open OAuth Consent Screen</a></li>
                                    <li>Make sure you're on the <strong>"OAuth consent screen"</strong> page</li>
                                    <li>Scroll down to find the section titled <strong>"Test users"</strong> (ÊµãËØïÁî®Êà∑)</li>
                                    <li>You should see a button <strong>"+ ADD USERS"</strong> or <strong>"Ê∑ªÂä†Áî®Êà∑"</strong> - Click it!</li>
                                    <li>In the popup/dialog, enter your Gmail address: <code style="background: #f0f0f0; padding: 3px 6px; border: 1px solid #ccc; font-weight: bold;">eric.brilliant@gmail.com</code></li>
                                    <li>Click <strong>"ADD"</strong> or <strong>"Ê∑ªÂä†"</strong> button</li>
                                    <li>You should see your email appear in the test users list</li>
                                    <li><strong>Wait 1-2 minutes</strong> for Google to process the change</li>
                                    <li>Come back to this page and click <strong>"üîê Authenticate Gmail"</strong> again</li>
                                </ol>
                                <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 8px; margin-top: 10px; border-radius: 4px; font-size: 11px;">
                                    <strong style="color: #0c5460;">üí° Tip:</strong> Make sure you're logged into Google Cloud Console with the same Google account that owns the project. The test user email must match exactly (case-sensitive).
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
                            <button class="form-button" onclick="authenticateGmail()" style="margin-top: 10px;">üîê Authenticate Gmail</button>
                            <button class="form-button" onclick="checkGmailStatus()" style="margin-top: 10px; font-size: 12px;">‚úì Check Status</button>
                        </div>
                        <div id="gmail-auth-status" style="margin-top: 10px; font-family: Arial, sans-serif; font-size: 12px;"></div>
                    </div>

                    <div class="settings-section" style="margin-top: 30px;">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">163.com Configuration</h3>
                        <div class="form-group">
                            <label for="163-imap-server">IMAP Server:</label>
                            <input type="text" id="163-imap-server" placeholder="imap.163.com">
                        </div>
                        <div class="form-group">
                            <label for="163-port">Port:</label>
                            <input type="number" id="163-port" placeholder="993">
                        </div>
                        <div class="form-group">
                            <label for="163-username">Username:</label>
                            <input type="text" id="163-username" placeholder="your-email@163.com">
                        </div>
                        <div class="form-group">
                            <label for="163-password">Authorization Code:</label>
                            <input type="password" id="163-password" placeholder="Enter authorization code">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="163-use-ssl" checked>
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="163-use-tls">
                                <span>Use TLS</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top: 30px;">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">QQ Email Configuration</h3>
                        <div class="form-group">
                            <label for="qq-imap-server">IMAP Server:</label>
                            <input type="text" id="qq-imap-server" placeholder="imap.qq.com">
                        </div>
                        <div class="form-group">
                            <label for="qq-port">Port:</label>
                            <input type="number" id="qq-port" placeholder="993">
                        </div>
                        <div class="form-group">
                            <label for="qq-username">Username:</label>
                            <input type="text" id="qq-username" placeholder="your-email@qq.com">
                        </div>
                        <div class="form-group">
                            <label for="qq-password">Authorization Code:</label>
                            <input type="password" id="qq-password" placeholder="Enter authorization code">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="qq-use-ssl" checked>
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="qq-use-tls">
                                <span>Use TLS</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top: 30px;">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">SMTP Configuration</h3>
                        <div class="form-group">
                            <label for="smtp-sender-name">Default Sender Name:</label>
                            <input type="text" id="smtp-sender-name" placeholder="Mail Task">
                        </div>
                        <div class="form-group">
                            <strong style="font-family: Arial, sans-serif; font-size: 14px;">Primary SMTP (Gmail)</strong>
                        </div>
                        <div class="form-group">
                            <label for="smtp-primary-server">Server:</label>
                            <input type="text" id="smtp-primary-server" placeholder="smtp.gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="smtp-primary-port">Port:</label>
                            <input type="number" id="smtp-primary-port" placeholder="587">
                        </div>
                        <div class="form-group">
                            <label for="smtp-primary-username">Username:</label>
                            <input type="text" id="smtp-primary-username" placeholder="your-email@gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="smtp-primary-password">App Password:</label>
                            <input type="password" id="smtp-primary-password" placeholder="Enter app password">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="smtp-primary-use-ssl">
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="smtp-primary-use-tls" checked>
                                <span>Use TLS</span>
                            </label>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <strong style="font-family: Arial, sans-serif; font-size: 14px;">Backup SMTP (163.com)</strong>
                        </div>
                        <div class="form-group">
                            <label for="smtp-backup-server">Server:</label>
                            <input type="text" id="smtp-backup-server" placeholder="smtp.163.com">
                        </div>
                        <div class="form-group">
                            <label for="smtp-backup-port">Port:</label>
                            <input type="number" id="smtp-backup-port" placeholder="465">
                        </div>
                        <div class="form-group">
                            <label for="smtp-backup-username">Username:</label>
                            <input type="text" id="smtp-backup-username" placeholder="your-email@163.com">
                        </div>
                        <div class="form-group">
                            <label for="smtp-backup-password">Authorization Code:</label>
                            <input type="password" id="smtp-backup-password" placeholder="Enter authorization code">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="smtp-backup-use-ssl" checked>
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="smtp-backup-use-tls">
                                <span>Use TLS</span>
                            </label>
                        </div>
                    </div>
                    <div class="profile-detail-actions">
                        <button class="form-button danger" onclick="deleteCurrentProfile()">Delete Profile</button>
                        <button class="form-button" onclick="saveCurrentProfile()" style="padding: 15px 30px; font-size: 16px;">Save Profile</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="email-modal" class="modal hidden" onclick="closeEmailModal()" role="dialog" aria-modal="true" aria-labelledby="email-modal-subject">
        <div class="modal-dialog" onclick="event.stopPropagation();">
            <div class="modal-header">
                <div>
                    <div class="modal-title" id="email-modal-subject">Email</div>
                    <div class="modal-meta" id="email-modal-meta"></div>
                </div>
                <button class="modal-close" onclick="closeEmailModal()">Close</button>
            </div>
            <div class="modal-body">
                <iframe id="email-modal-frame" class="modal-iframe" title="Email content"></iframe>
            </div>
        </div>
    </div>

    <div id="attachment-modal" class="modal hidden" onclick="closeAttachmentModal()" role="dialog" aria-modal="true" aria-labelledby="attachment-modal-title">
        <div class="modal-dialog" onclick="event.stopPropagation();">
            <div class="modal-header">
                <div class="modal-title" id="attachment-modal-title">Attachments</div>
                <button class="modal-close" onclick="closeAttachmentModal()">Close</button>
            </div>
            <div class="modal-body">
                <div id="attachment-list" class="attachment-list"></div>
            </div>
        </div>
    </div>

    <div id="preview-modal" class="modal hidden" onclick="closePreviewModal()" role="dialog" aria-modal="true" aria-labelledby="preview-modal-title">
        <div class="modal-dialog preview-modal-dialog" onclick="event.stopPropagation();">
            <div class="modal-header">
                <div class="modal-title" id="preview-modal-title">Preview</div>
                <button class="modal-close" onclick="closePreviewModal()">Close</button>
            </div>
            <div class="modal-body">
                <div id="preview-modal-content"></div>
            </div>
        </div>
    </div>

    <div id="task-modal" class="modal hidden" onclick="closeTaskModal()" role="dialog" aria-modal="true" aria-labelledby="task-modal-title">
        <div class="modal-dialog" onclick="event.stopPropagation();">
            <div class="modal-header">
                <div class="modal-title" id="task-modal-title">Create Task</div>
                <button class="modal-close" onclick="closeTaskModal()">Close</button>
            </div>
            <div class="task-modal-body">
                <div class="task-row">
                    <div class="form-group">
                        <label for="task-sequence">Sequence</label>
                        <input type="text" id="task-sequence" readonly>
                    </div>
                    <div class="form-group">
                        <label for="task-customer-select">Selected Customer</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="task-customer-select" class="autocomplete-input" placeholder="Type to search customer..." autocomplete="off">
                            <div class="autocomplete-dropdown-btn" id="task-customer-dropdown-btn"></div>
                            <div id="task-customer-dropdown" class="autocomplete-dropdown"></div>
                        </div>
                        <input type="hidden" id="task-customer-value" value="">
                    </div>
                    <div class="form-group">
                        <label for="task-email">Email</label>
                        <input type="email" id="task-email" style="width: 100%; padding: 8px; border: 1px solid #000000;">
                    </div>
                </div>
                <div class="form-group">
                    <label for="task-catalogue">Type</label>
                    <select id="task-catalogue">
                    </select>
                </div>
                <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
                    <label for="task-notes">Template</label>
                    <div id="task-notes-editor" style="height: 300px; background-color: #ffffff;"></div>
                </div>
                <div class="form-group">
                    <label>Attachments</label>
                    <div id="task-attachments" class="attachment-list"></div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <button class="form-button" onclick="submitTask()" style="width: 100%; padding: 15px; font-size: 16px;">Submit Task</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const VERSION = '{{ version }}';
        document.getElementById('version').textContent = 'v' + VERSION;
        const emailModal = document.getElementById('email-modal');
        const emailModalSubject = document.getElementById('email-modal-subject');
        const emailModalMeta = document.getElementById('email-modal-meta');
        const emailModalFrame = document.getElementById('email-modal-frame');
        const attachmentModal = document.getElementById('attachment-modal');
        const attachmentList = document.getElementById('attachment-list');
        const previewModal = document.getElementById('preview-modal');
        const previewModalTitle = document.getElementById('preview-modal-title');
        const previewModalContent = document.getElementById('preview-modal-content');
        const taskModal = document.getElementById('task-modal');
        const taskCustomerSelect = document.getElementById('task-customer-select');
        const taskEmailInput = document.getElementById('task-email');
        const taskSequenceInput = document.getElementById('task-sequence');
        const taskAttachmentsDiv = document.getElementById('task-attachments');
        const taskCatalogueSelect = document.getElementById('task-catalogue');
        const taskNotesEditorDiv = document.getElementById('task-notes-editor');
        
        // Initialize Quill editor for task modal
        let taskNotesEditor = null;
        if (taskNotesEditorDiv) {
            taskNotesEditor = new Quill('#task-notes-editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        [{ 'table': true }],
                        ['clean']
                    ]
                }
            });
        }
        const customerStatusDiv = document.getElementById('customer-status');
        const customerEmailAddressInput = document.getElementById('customer-email-address');
        const customerListSection = document.getElementById('customer-list-section');
        const customerTableBody = document.getElementById('customer-table-body');
        const customerEmptyMessage = document.getElementById('customer-empty');
        let currentEmails = [];
        let currentProvider = null;
        let customerCache = [];
        let currentPreviewObjectUrl = null;
        let customerAttachments = [];

        // Autocomplete functions
        function filterCustomers(query) {
            if (!query || !customerCache) return [];
            const lowerQuery = query.toLowerCase();
            return customerCache.filter(customer => {
                const name = (customer.name || '').toLowerCase();
                const email = (customer.email_suffix || '').toLowerCase();
                return name.includes(lowerQuery) || email.includes(lowerQuery);
            });
        }

        function renderAutocompleteDropdown(dropdown, customers, onSelect) {
            dropdown.innerHTML = '';
            if (customers.length === 0) {
                dropdown.classList.remove('show');
                return;
            }
            
            customers.forEach((customer, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.dataset.index = index;
                item.innerHTML = `
                    <div class="autocomplete-item-name">${escapeHtml(customer.name || customer.email_suffix || '')}</div>
                    <div class="autocomplete-item-email">${escapeHtml(customer.email_suffix || '')}</div>
                `;
                item.addEventListener('click', () => {
                    onSelect(customer);
                });
                dropdown.appendChild(item);
            });
            
            dropdown.classList.add('show');
        }

        function setupAutocomplete(inputId, dropdownId, valueInputId, emailInputId, onSelectCallback) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            const valueInput = document.getElementById(valueInputId);
            const emailInput = emailInputId ? document.getElementById(emailInputId) : null;
            // Find dropdown button - it's a sibling of the input
            const wrapper = input ? input.closest('.autocomplete-wrapper') : null;
            const dropdownBtn = wrapper ? wrapper.querySelector('.autocomplete-dropdown-btn') : null;
            
            if (!input || !dropdown || !valueInput) return;
            
            let highlightedIndex = -1;
            let filteredCustomers = [];
            let showingAllCustomers = false;
            
            function selectCustomer(customer) {
                input.value = customer.name || customer.email_suffix || '';
                valueInput.value = customer.email_suffix || '';
                dropdown.classList.remove('show');
                highlightedIndex = -1;
                showingAllCustomers = false;
                
                if (emailInput) {
                    const storedEmail = (customer.email_suffix || '').trim();
                    if (storedEmail.includes('@')) {
                        emailInput.value = storedEmail;
                    }
                }
                
                if (onSelectCallback) {
                    onSelectCallback(customer);
                }
            }
            
            function showAllCustomers() {
                if (!customerCache || customerCache.length === 0) return;
                filteredCustomers = customerCache;
                showingAllCustomers = true;
                renderAutocompleteDropdown(dropdown, filteredCustomers, selectCustomer);
                highlightedIndex = -1;
            }
            
            // Dropdown button click - show all customers
            if (dropdownBtn) {
                dropdownBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    if (dropdown.classList.contains('show') && showingAllCustomers) {
                        dropdown.classList.remove('show');
                    } else {
                        showAllCustomers();
                    }
                });
            }
            
            // Input focus - show all customers if empty, or filter if has text
            input.addEventListener('focus', (e) => {
                const query = e.target.value.trim();
                if (query === '') {
                    showAllCustomers();
                } else {
                    filteredCustomers = filterCustomers(query);
                    renderAutocompleteDropdown(dropdown, filteredCustomers, selectCustomer);
                }
            });
            
            input.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                showingAllCustomers = false;
                if (query === '') {
                    filteredCustomers = customerCache || [];
                } else {
                    filteredCustomers = filterCustomers(query);
                }
                renderAutocompleteDropdown(dropdown, filteredCustomers, selectCustomer);
                highlightedIndex = -1;
            });
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (filteredCustomers.length > 0) {
                        highlightedIndex = Math.min(highlightedIndex + 1, filteredCustomers.length - 1);
                        updateHighlight();
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIndex = Math.max(highlightedIndex - 1, -1);
                    updateHighlight();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (highlightedIndex >= 0 && filteredCustomers[highlightedIndex]) {
                        selectCustomer(filteredCustomers[highlightedIndex]);
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                    highlightedIndex = -1;
                }
            });
            
            function updateHighlight() {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                items.forEach((item, index) => {
                    if (index === highlightedIndex) {
                        item.classList.add('highlighted');
                        item.scrollIntoView({ block: 'nearest' });
                    } else {
                        item.classList.remove('highlighted');
                    }
                });
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target) && (!dropdownBtn || !dropdownBtn.contains(e.target))) {
                    dropdown.classList.remove('show');
                }
            });
        }

        // Country list
        const COUNTRIES = [
            'Afghanistan', 'Albania', 'Algeria', 'Andorra', 'Angola', 'Antigua and Barbuda', 'Argentina', 'Armenia', 'Australia', 'Austria',
            'Azerbaijan', 'Bahamas', 'Bahrain', 'Bangladesh', 'Barbados', 'Belarus', 'Belgium', 'Belize', 'Benin', 'Bhutan',
            'Bolivia', 'Bosnia and Herzegovina', 'Botswana', 'Brazil', 'Brunei', 'Bulgaria', 'Burkina Faso', 'Burundi', 'Cabo Verde', 'Cambodia',
            'Cameroon', 'Canada', 'Central African Republic', 'Chad', 'Chile', 'China', 'Colombia', 'Comoros', 'Congo', 'Costa Rica',
            'Croatia', 'Cuba', 'Cyprus', 'Czech Republic', 'Denmark', 'Djibouti', 'Dominica', 'Dominican Republic', 'Ecuador', 'Egypt',
            'El Salvador', 'Equatorial Guinea', 'Eritrea', 'Estonia', 'Eswatini', 'Ethiopia', 'Fiji', 'Finland', 'France', 'Gabon',
            'Gambia', 'Georgia', 'Germany', 'Ghana', 'Greece', 'Grenada', 'Guatemala', 'Guinea', 'Guinea-Bissau', 'Guyana',
            'Haiti', 'Honduras', 'Hungary', 'Iceland', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland', 'Israel',
            'Italy', 'Jamaica', 'Japan', 'Jordan', 'Kazakhstan', 'Kenya', 'Kiribati', 'Korea, North', 'Korea, South', 'Kuwait',
            'Kyrgyzstan', 'Laos', 'Latvia', 'Lebanon', 'Lesotho', 'Liberia', 'Libya', 'Liechtenstein', 'Lithuania', 'Luxembourg',
            'Madagascar', 'Malawi', 'Malaysia', 'Maldives', 'Mali', 'Malta', 'Marshall Islands', 'Mauritania', 'Mauritius', 'Mexico',
            'Micronesia', 'Moldova', 'Monaco', 'Mongolia', 'Montenegro', 'Morocco', 'Mozambique', 'Myanmar', 'Namibia', 'Nauru',
            'Nepal', 'Netherlands', 'New Zealand', 'Nicaragua', 'Niger', 'Nigeria', 'North Macedonia', 'Norway', 'Oman', 'Pakistan',
            'Palau', 'Palestine', 'Panama', 'Papua New Guinea', 'Paraguay', 'Peru', 'Philippines', 'Poland', 'Portugal', 'Qatar',
            'Romania', 'Russia', 'Rwanda', 'Saint Kitts and Nevis', 'Saint Lucia', 'Saint Vincent and the Grenadines', 'Samoa', 'San Marino', 'Sao Tome and Principe', 'Saudi Arabia',
            'Senegal', 'Serbia', 'Seychelles', 'Sierra Leone', 'Singapore', 'Slovakia', 'Slovenia', 'Solomon Islands', 'Somalia', 'South Africa',
            'South Sudan', 'Spain', 'Sri Lanka', 'Sudan', 'Suriname', 'Sweden', 'Switzerland', 'Syria', 'Taiwan', 'Tajikistan',
            'Tanzania', 'Thailand', 'Timor-Leste', 'Togo', 'Tonga', 'Trinidad and Tobago', 'Tunisia', 'Turkey', 'Turkmenistan', 'Tuvalu',
            'Uganda', 'Ukraine', 'United Arab Emirates', 'United Kingdom', 'United States', 'Uruguay', 'Uzbekistan', 'Vanuatu', 'Vatican City', 'Venezuela',
            'Vietnam', 'Yemen', 'Zambia', 'Zimbabwe'
        ].sort();
        const PROVIDER_LABELS = {
            gmail: 'Gmail',
            qq: 'QQ',
            '163': '163.com'
        };

        function getTodayKey() {
            const d = new Date();
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function getYesterdayKey() {
            const d = new Date();
            d.setDate(d.getDate() - 1);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function normalizeEmailDate(email) {
            const raw = (email?.date || '').slice(0, 10);
            if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
                return raw;
            }
            return getTodayKey();
        }

        function extractEmailAddress(rawFrom) {
            if (!rawFrom) return '';
            const match = rawFrom.match(/<([^>]+)>/);
            const address = match ? match[1] : rawFrom;
            return (address || '').trim().toLowerCase();
        }

        function computeSequence(email) {
            const dateString = email?.date;
            let timestamp = Date.now();
            if (dateString) {
                const parsed = new Date(dateString);
                if (!isNaN(parsed.getTime())) {
                    timestamp = parsed.getTime();
                }
            }
            const dt = new Date(timestamp);
            const yyyy = dt.getFullYear();
            const mm = String(dt.getMonth() + 1).padStart(2, '0');
            const dd = String(dt.getDate()).padStart(2, '0');
            const hh = String(dt.getHours()).padStart(2, '0');
            const mi = String(dt.getMinutes()).padStart(2, '0');
            const ss = String(dt.getSeconds()).padStart(2, '0');
            const sequenceDate = `${yyyy}${mm}${dd}_${hh}${mi}${ss}`;
            
            const address = extractEmailAddress(email?.from || '');
            let localPart = '';
            let domainPart = '';
            if (address && address.includes('@')) {
                const parts = address.split('@');
                localPart = parts[0] || '';
                domainPart = parts[1] || '';
            } else {
                localPart = address;
            }

            const letters = (localPart.match(/[a-z]/gi) || []).map(ch => ch.toLowerCase());
            let prefix = letters.slice(0, 2).join('');
            if (prefix.length === 1) {
                prefix += 'x';
            } else if (prefix.length === 0) {
                prefix = 'xx';
            }

            const firstDomainLabel = (domainPart.split('.')[0] || '').replace(/[^a-z0-9]/gi, '').toLowerCase();
            const domainLabel = firstDomainLabel || 'domain';

            return `${sequenceDate}_${prefix}_${domainLabel}`;
        }

        function ensureEmailSequence(email) {
            if (!email) return email;
            // Always recompute sequence to ensure new format (yyyymmdd_hhmmss)
            // This ensures consistency even if old data has old format sequence
            email.sequence = computeSequence(email);
            return email;
        }

        function groupEmailsByDate(emails) {
            const grouped = {};
            (emails || []).forEach(item => {
                const enriched = ensureEmailSequence({ ...item });
                const dateKey = normalizeEmailDate(enriched);
                if (!grouped[dateKey]) {
                    grouped[dateKey] = [];
                }
                grouped[dateKey].push(enriched);
            });
            return grouped;
        }

        function cacheEmails(provider, emails) {
            if (!provider) {
                return;
            }
            try {
                const grouped = groupEmailsByDate(emails);
                Object.entries(grouped).forEach(([dateKey, list]) => {
                    const storageKey = `emails:${provider}:${dateKey}`;
                    localStorage.setItem(storageKey, JSON.stringify({ date: dateKey, emails: list }));
                });
                localStorage.setItem('lastEmailProvider', provider);
            } catch (error) {
                console.error('Failed to cache emails', error);
            }
        }

        function loadCachedEmails(provider) {
            if (!provider) return null;
            try {
                const dateKeys = [getTodayKey(), getYesterdayKey()];
                const collected = [];
                dateKeys.forEach(dateKey => {
                    const storageKey = `emails:${provider}:${dateKey}`;
                    const raw = localStorage.getItem(storageKey);
                    if (!raw) return;
                    const parsed = JSON.parse(raw);
                    if (parsed?.date === dateKey && Array.isArray(parsed.emails)) {
                        parsed.emails.forEach(email => {
                            collected.push(ensureEmailSequence({ ...email }));
                        });
                    }
                });
                return collected.length > 0 ? collected : null;
            } catch (error) {
                console.error('Failed to load cached emails', error);
            }
            return null;
        }

        function registerEmailKeys(emailObj, keySet) {
            if (!emailObj || !keySet) return;
            const id = (emailObj.id || emailObj.email_uid || '').trim();
            if (id) {
                keySet.add(`id:${id}`);
            } else {
                const sequence = (emailObj.sequence || '').trim();
                if (sequence) {
                    keySet.add(`seq:${sequence}`);
                }
            }
            const subject = (emailObj.subject || '').trim();
            const date = (emailObj.date || '').trim();
            const from = (emailObj.from || '').trim();
            if (subject && date && from) {
                keySet.add(`key:${subject}|${date}|${from}`);
            }
        }

        function deduplicateEmails(emails) {
            if (!Array.isArray(emails) || emails.length === 0) return [];
            
            const seenKeys = new Set();
            const uniqueEmails = [];
            
            emails.forEach(email => {
                const emailObj = ensureEmailSequence({ ...email });
                let isDuplicate = false;
                
                // Check by ID first
                const id = (emailObj.id || emailObj.email_uid || '').trim();
                if (id) {
                    const idKey = `id:${id}`;
                    if (seenKeys.has(idKey)) {
                        isDuplicate = true;
                    } else {
                        seenKeys.add(idKey);
                    }
                }
                
                // Check by sequence if no ID or ID not found
                if (!isDuplicate) {
                    const sequence = (emailObj.sequence || '').trim();
                    if (sequence) {
                        const seqKey = `seq:${sequence}`;
                        if (seenKeys.has(seqKey)) {
                            isDuplicate = true;
                        } else {
                            seenKeys.add(seqKey);
                        }
                    }
                }
                
                // Check by fallback key (subject+date+from)
                if (!isDuplicate) {
                    const subject = (emailObj.subject || '').trim();
                    const date = (emailObj.date || '').trim();
                    const from = (emailObj.from || '').trim();
                    if (subject && date && from) {
                        const fallbackKey = `key:${subject}|${date}|${from}`;
                        if (seenKeys.has(fallbackKey)) {
                            isDuplicate = true;
                        } else {
                            seenKeys.add(fallbackKey);
                        }
                    }
                }
                
                if (!isDuplicate) {
                    uniqueEmails.push(emailObj);
                }
            });
            
            return uniqueEmails;
        }

        function updateContentTitle(provider, cached = false) {
            const titleEl = document.getElementById('content-title');
            if (!titleEl) return;
            if (provider && PROVIDER_LABELS[provider]) {
                titleEl.textContent = `Receive Mail (${PROVIDER_LABELS[provider]}${cached ? ' - Cached' : ''})`;
            } else {
                titleEl.textContent = 'Receive Mail';
            }
        }

        function renderCachedEmailsFor(provider) {
            const cached = loadCachedEmails(provider);
            if (cached && Array.isArray(cached)) {
                const uniqueCached = deduplicateEmails(cached);
                displayEmails(uniqueCached, { provider, cached: true });
                return true;
            }
            return false;
        }

        function findCustomerByEmail(rawFrom) {
            if (!rawFrom) return null;
            const address = extractEmailAddress(rawFrom);
            if (!address || !address.includes('@')) return null;
            const addressLower = address.toLowerCase();
            
            // Try to find by full email address first (new format)
            let match = customerCache.find(customer => {
                const storedEmail = (customer.email_suffix || '').toLowerCase();
                return storedEmail === addressLower;
            });
            
            if (match) return match;
            
            // Fallback: try to find by domain suffix (backward compatibility)
            const domain = '@' + address.split('@')[1].toLowerCase();
            match = customerCache.find(customer => {
                const storedEmail = (customer.email_suffix || '').toLowerCase();
                // Check if stored email is old format (starts with @) or matches domain
                return storedEmail === domain || (storedEmail.startsWith('@') && storedEmail === domain);
            });
            
            return match || null;
        }

        function fetchStoredEmails(provider) {
            if (!provider) {
                return Promise.resolve([]);
            }
            const daysToLoad = 2; // fetch emails from the past 2 days by default
            return fetch(`/api/emails?provider=${encodeURIComponent(provider)}&days=${daysToLoad}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    const emails = (data.emails || []).map(item => ensureEmailSequence({ ...item }));
                    return emails;
                });
        }

        async function loadCachedEmailsOnStartup() {
            const emailList = document.getElementById('email-list');
            const candidates = [];
            const lastProvider = localStorage.getItem('lastEmailProvider');
            if (lastProvider) {
                candidates.push(lastProvider);
            }
            ['gmail', 'qq', '163'].forEach((provider) => {
                if (!candidates.includes(provider)) {
                    candidates.push(provider);
                }
            });

            for (const provider of candidates) {
                try {
                    const stored = await fetchStoredEmails(provider);
                    if (stored.length > 0) {
                        cacheEmails(provider, stored);
                        displayEmails(stored, { provider, cached: false });
                        currentProvider = provider;
                        return;
                    }
                } catch (error) {
                    console.error('Failed to load stored emails:', error);
                }

                if (renderCachedEmailsFor(provider)) {
                    currentProvider = provider;
                    return;
                }
            }

            if (emailList) {
                currentEmails = [];
                emailList.innerHTML = '<div class="loading">No cached emails for today. Click a fetch button to load the latest messages.</div>';
                emailList.dataset.cached = 'false';
            }
            currentProvider = null;
            updateContentTitle(null);
        }

        // Initialize Profile 1 with default values from configuration
        function initializeProfile1() {
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            // Always set Profile 1 with the correct configuration values
            profiles.profile1 = {
                name: 'Profile 1',
                gmail: {
                    imap_server: 'imap.gmail.com',
                    port: 993,
                    username: 'eric.brilliant@gmail.com',
                    password: 'opqx pfna kagb bznr',
                    use_ssl: true,
                    use_tls: false
                },
                email163: {
                    imap_server: 'imap.163.com',
                    port: 993,
                    username: '19902475292@163.com',
                    password: 'JDy8MigeNmsESZRa',
                    use_ssl: true,
                    use_tls: false
                },
                qq: {
                    imap_server: 'imap.qq.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                },
                smtp: {
                    sender_name: 'Mail Task',
                    primary: {
                        server: 'smtp.gmail.com',
                        port: 587,
                        username: 'eric.brilliant@gmail.com',
                        password: 'opqx pfna kagb bznr',
                        use_ssl: false,
                        use_tls: true
                    },
                    backup: {
                        server: 'smtp.163.com',
                        port: 465,
                        username: '19902475292@163.com',
                        password: 'JDy8MigeNmsESZRa',
                    use_ssl: true,
                    use_tls: false
                    }
                }
            };
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
        }

        // Profile list/detail workflow (Level 1 -> Level 2)
        let currentProfileKey = localStorage.getItem('selectedProfile') || 'profile1';

        function renderProfileList() {
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            const listContainer = document.getElementById('profile-list');
            if (!listContainer) return;

            listContainer.innerHTML = '';
            const selected = localStorage.getItem('selectedProfile') || 'profile1';
            const keys = Object.keys(profiles);
            if (keys.length === 0) {
                const none = document.createElement('div');
                none.className = 'profile-item-name';
                none.textContent = 'No profiles.';
                listContainer.appendChild(none);
                return;
            }
            keys.forEach((key) => {
                const profile = profiles[key];
                const item = document.createElement('div');
                item.className = 'profile-item' + (selected === key ? ' active' : '');

                const name = document.createElement('div');
                name.className = 'profile-item-name';
                name.textContent = profile.name || key;

                const openBtn = document.createElement('button');
                openBtn.className = 'form-button';
                openBtn.textContent = 'Open';
                openBtn.onclick = () => openProfileDetail(key);

                item.appendChild(name);
                item.appendChild(openBtn);
                listContainer.appendChild(item);
            });
        }

        function showProfileList() {
            document.getElementById('profile-list-view').classList.remove('hidden');
            document.getElementById('profile-detail-view').classList.add('hidden');
            renderProfileList();
        }

        function openProfileDetail(profileKey) {
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            const profile = profiles[profileKey];
            if (!profile) return;
            currentProfileKey = profileKey;
            setCurrentProfile(profileKey);
            document.getElementById('profile-name-display').textContent = profile.name || profileKey;
            // Fill fields
            document.getElementById('gmail-imap-server').value = profile.gmail?.imap_server || '';
            document.getElementById('gmail-port').value = profile.gmail?.port || 993;
            document.getElementById('gmail-username').value = profile.gmail?.username || '';
            document.getElementById('gmail-password').value = profile.gmail?.password || '';
            document.getElementById('gmail-use-ssl').checked = profile.gmail?.use_ssl ?? true;
            document.getElementById('gmail-use-tls').checked = profile.gmail?.use_tls ?? false;

            document.getElementById('gmail-oauth-client-id').value = profile.gmail?.oauth_client_id || '';
            document.getElementById('gmail-oauth-client-secret').value = profile.gmail?.oauth_client_secret || '';
            document.getElementById('gmail-oauth-redirect-uri').value = profile.gmail?.oauth_redirect_uri || 'http://localhost:5000/oauth2callback';

            document.getElementById('163-imap-server').value = profile.email163?.imap_server || '';
            document.getElementById('163-port').value = profile.email163?.port || 993;
            document.getElementById('163-username').value = profile.email163?.username || '';
            document.getElementById('163-password').value = profile.email163?.password || '';
            document.getElementById('163-use-ssl').checked = profile.email163?.use_ssl ?? true;
            document.getElementById('163-use-tls').checked = profile.email163?.use_tls ?? false;

            document.getElementById('qq-imap-server').value = profile.qq?.imap_server || '';
            document.getElementById('qq-port').value = profile.qq?.port || 993;
            document.getElementById('qq-username').value = profile.qq?.username || '';
            document.getElementById('qq-password').value = profile.qq?.password || '';
            document.getElementById('qq-use-ssl').checked = profile.qq?.use_ssl ?? true;
            document.getElementById('qq-use-tls').checked = profile.qq?.use_tls ?? false;

            const smtp = profile.smtp || {};
            const primarySmtp = smtp.primary || {};
            const backupSmtp = smtp.backup || {};

            document.getElementById('smtp-sender-name').value = smtp.sender_name || '';

            document.getElementById('smtp-primary-server').value = primarySmtp.server || '';
            document.getElementById('smtp-primary-port').value = primarySmtp.port || 587;
            document.getElementById('smtp-primary-username').value = primarySmtp.username || '';
            document.getElementById('smtp-primary-password').value = primarySmtp.password || '';
            document.getElementById('smtp-primary-use-ssl').checked = primarySmtp.use_ssl ?? false;
            document.getElementById('smtp-primary-use-tls').checked = primarySmtp.use_tls ?? true;

            document.getElementById('smtp-backup-server').value = backupSmtp.server || '';
            document.getElementById('smtp-backup-port').value = backupSmtp.port || 465;
            document.getElementById('smtp-backup-username').value = backupSmtp.username || '';
            document.getElementById('smtp-backup-password').value = backupSmtp.password || '';
            document.getElementById('smtp-backup-use-ssl').checked = backupSmtp.use_ssl ?? true;
            document.getElementById('smtp-backup-use-tls').checked = backupSmtp.use_tls ?? false;

            document.getElementById('profile-list-view').classList.add('hidden');
            document.getElementById('profile-detail-view').classList.remove('hidden');
        }

        // Save current profile
        function saveCurrentProfile() {
            const profileKey = currentProfileKey || (localStorage.getItem('selectedProfile') || 'profile1');
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            
            if (!profiles[profileKey]) {
                profiles[profileKey] = { name: profiles[profileKey]?.name || profileKey };
            }
            
            // Save Gmail settings
            profiles[profileKey].gmail = {
                imap_server: document.getElementById('gmail-imap-server').value.trim(),
                port: parseInt(document.getElementById('gmail-port').value) || 993,
                username: document.getElementById('gmail-username').value.trim(),
                password: document.getElementById('gmail-password').value.trim(),
                use_ssl: document.getElementById('gmail-use-ssl').checked,
                use_tls: document.getElementById('gmail-use-tls').checked,
                oauth_client_id: document.getElementById('gmail-oauth-client-id').value.trim(),
                oauth_client_secret: document.getElementById('gmail-oauth-client-secret').value.trim(),
                oauth_redirect_uri: document.getElementById('gmail-oauth-redirect-uri').value.trim() || 'http://localhost:5000/oauth2callback'
            };
            
            // Save 163.com settings
            profiles[profileKey].email163 = {
                imap_server: document.getElementById('163-imap-server').value.trim(),
                port: parseInt(document.getElementById('163-port').value) || 993,
                username: document.getElementById('163-username').value.trim(),
                password: document.getElementById('163-password').value.trim(),
                use_ssl: document.getElementById('163-use-ssl').checked,
                use_tls: document.getElementById('163-use-tls').checked
            };
            
            // Save QQ settings
            profiles[profileKey].qq = {
                imap_server: document.getElementById('qq-imap-server').value.trim(),
                port: parseInt(document.getElementById('qq-port').value) || 993,
                username: document.getElementById('qq-username').value.trim(),
                password: document.getElementById('qq-password').value.trim(),
                use_ssl: document.getElementById('qq-use-ssl').checked,
                use_tls: document.getElementById('qq-use-tls').checked
            };

            profiles[profileKey].smtp = {
                sender_name: document.getElementById('smtp-sender-name').value.trim(),
                primary: {
                    server: document.getElementById('smtp-primary-server').value.trim(),
                    port: parseInt(document.getElementById('smtp-primary-port').value) || 0,
                    username: document.getElementById('smtp-primary-username').value.trim(),
                    password: document.getElementById('smtp-primary-password').value.trim(),
                    use_ssl: document.getElementById('smtp-primary-use-ssl').checked,
                    use_tls: document.getElementById('smtp-primary-use-tls').checked
                },
                backup: {
                    server: document.getElementById('smtp-backup-server').value.trim(),
                    port: parseInt(document.getElementById('smtp-backup-port').value) || 0,
                    username: document.getElementById('smtp-backup-username').value.trim(),
                    password: document.getElementById('smtp-backup-password').value.trim(),
                    use_ssl: document.getElementById('smtp-backup-use-ssl').checked,
                    use_tls: document.getElementById('smtp-backup-use-tls').checked
                }
            };
            
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
            showError('Profile saved successfully', false);
            renderProfileList();
            updateComposeDefaults();
        }

        // Create new profile
        function createProfile() {
            const newName = document.getElementById('new-profile-name').value.trim();
            if (!newName) {
                showError('Please enter a profile name');
                return;
            }
            
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            const profileKey = 'profile' + Date.now();
            
            profiles[profileKey] = {
                name: newName,
                gmail: {
                    imap_server: 'imap.gmail.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                },
                email163: {
                    imap_server: 'imap.163.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                },
                qq: {
                    imap_server: 'imap.qq.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                },
                smtp: {
                    sender_name: '',
                    primary: {
                        server: 'smtp.gmail.com',
                        port: 587,
                        username: '',
                        password: '',
                        use_ssl: false,
                        use_tls: true
                    },
                    backup: {
                        server: 'smtp.163.com',
                        port: 465,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                    }
                }
            };
            
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
            document.getElementById('new-profile-name').value = '';
            currentProfileKey = profileKey;
            setCurrentProfile(profileKey);
            openProfileDetail(profileKey);
            renderProfileList();
            showError('Profile created successfully', false);
            updateComposeDefaults();
        }

        // Delete current profile
        function deleteCurrentProfile() {
            const profileKey = currentProfileKey || 'profile1';
            if (profileKey === 'profile1') {
                showError('Cannot delete Profile 1');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this profile?')) {
                return;
            }
            
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            delete profiles[profileKey];
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
            setCurrentProfile('profile1');
            currentProfileKey = 'profile1';
            showProfileList();
            showError('Profile deleted successfully', false);
        }

        async function saveYesterdayEmailsToSQLite() {
            const yesterdayKey = getYesterdayKey();
            const providers = ['gmail', 'qq', '163'];
            
            for (const provider of providers) {
                try {
                    const key = `emails:${provider}:${yesterdayKey}`;
                    const raw = localStorage.getItem(key);
                    if (!raw) continue;
                    
                    const parsed = JSON.parse(raw);
                    if (parsed?.date === yesterdayKey && Array.isArray(parsed.emails) && parsed.emails.length > 0) {
                        const emails = parsed.emails.map(item => ensureEmailSequence(item));
                        await fetch('/api/emails', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                provider: provider,
                                emails: emails,
                                date: yesterdayKey
                            })
                        });
                        console.log(`Saved ${emails.length} yesterday emails for ${provider} to SQLite`);
                        localStorage.removeItem(key);
                    }
                } catch (error) {
                    console.error(`Failed to save yesterday emails for ${provider}:`, error);
                }
            }
        }

        // Handle placeholder for contenteditable div
        function setupRemarkPlaceholder() {
            const remarkDiv = document.getElementById('customer-remark');
            if (!remarkDiv) return;
            
            const placeholder = remarkDiv.getAttribute('data-placeholder') || 'Enter remarks with HTML formatting...';
            
            function updatePlaceholder() {
                if (remarkDiv.innerHTML.trim() === '' || remarkDiv.textContent.trim() === '') {
                    remarkDiv.classList.add('empty');
                } else {
                    remarkDiv.classList.remove('empty');
                }
            }
            
            remarkDiv.addEventListener('focus', function() {
                if (remarkDiv.innerHTML.trim() === '' || remarkDiv.textContent.trim() === '') {
                    remarkDiv.classList.remove('empty');
                }
            });
            
            remarkDiv.addEventListener('blur', updatePlaceholder);
            remarkDiv.addEventListener('input', updatePlaceholder);
            updatePlaceholder();
        }

        // Load settings on page load
        window.onload = async function() {
            initializeProfile1();
            if (!localStorage.getItem('selectedProfile')) {
                setCurrentProfile('profile1');
            }
            showProfileList();
            updateComposeDefaults();
            setupRemarkPlaceholder();
            await loadCustomers(false);
            await saveYesterdayEmailsToSQLite();
            await loadCachedEmailsOnStartup();
            document.addEventListener('keydown', (evt) => {
                if (evt.key === 'Escape' && !emailModal.classList.contains('hidden')) {
                    closeEmailModal();
                }
                if (evt.key === 'Escape' && !taskModal.classList.contains('hidden')) {
                    closeTaskModal();
                }
                if (evt.key === 'Escape' && !attachmentModal.classList.contains('hidden')) {
                    closeAttachmentModal();
                }
                if (evt.key === 'Escape' && previewModal && !previewModal.classList.contains('hidden')) {
                    closePreviewModal();
                }
            });

            if (customerSuffixInput) {
                customerSuffixInput.addEventListener('input', () => {
                    if (customerSuffixInput.value.includes('@')) {
                        customerSuffixInput.value = customerSuffixInput.value.replace(/@/g, '');
                        showCustomerStatus('Removed "@". Please enter only the domain, e.g. example.com.', true);
                    }
                });
            }
        };

        function showReceiveMail() {
            document.getElementById('receive-mail-content').classList.remove('hidden');
            document.getElementById('send-mail-content').classList.add('hidden');
            document.getElementById('create-customer-content').classList.add('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('task-list-content').classList.add('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Receive Mail';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
            event.target.classList.add('active');
            }
            const emailList = document.getElementById('email-list');
            if (currentProvider && emailList) {
                const cached = emailList.dataset && emailList.dataset.cached === 'true';
                updateContentTitle(currentProvider, cached);
            }
        }

        function showSend() {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('send-mail-content').classList.remove('hidden');
            document.getElementById('create-customer-content').classList.add('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('task-list-content').classList.add('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Send Email';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        function showCreateCustomer() {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('send-mail-content').classList.add('hidden');
            document.getElementById('create-customer-content').classList.remove('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('task-list-content').classList.add('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Create Customer';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
            loadCustomers(true);
        }

        function showTask() {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('send-mail-content').classList.add('hidden');
            document.getElementById('create-customer-content').classList.add('hidden');
            document.getElementById('task-content').classList.remove('hidden');
            document.getElementById('task-list-content').classList.add('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('dropdown-list-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Task';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
            event.target.classList.add('active');
            }
            loadTaskDisplay();
            loadTaskTypesForDropdown();
        }

        function loadTaskDisplay() {
            const container = document.getElementById('task-display-container');
            if (!container) return;
            
            // Load customers if not cached
            if (!customerCache || customerCache.length === 0) {
                loadCustomers(false).then(() => {
                    renderTaskForm(container);
                });
            } else {
                renderTaskForm(container);
            }
        }

        function loadTaskDisplayForDropdown() {
            const container = document.getElementById('task-display-container-dropdown');
            if (!container) return;
            
            // Load customers if not cached
            if (!customerCache || customerCache.length === 0) {
                loadCustomers(false).then(() => {
                    renderTaskForm(container);
                });
            } else {
                renderTaskForm(container);
            }
        }

        function renderTaskForm(container) {
            const customerOptions = customerCache.map(customer => 
                `<option value="${escapeHtml(customer.email_suffix || '')}">${escapeHtml(customer.name || customer.email_suffix || '')}</option>`
            ).join('');
            
            container.innerHTML = `
                <div class="task-display-item" style="border: 1px solid #000000; padding: 20px; background-color: #ffffff;">
                    <form id="task-form" onsubmit="submitTaskFromForm(event)">
                        <div class="task-row" style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Selected Customer</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="task-form-customer" class="autocomplete-input" placeholder="Type to search customer..." autocomplete="off" required>
                                    <div class="autocomplete-dropdown-btn" id="task-form-customer-dropdown-btn"></div>
                                    <div id="task-form-customer-dropdown" class="autocomplete-dropdown"></div>
                                </div>
                                <input type="hidden" id="task-form-customer-value" value="">
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email</label>
                                <input type="email" id="task-form-email" required style="width: 100%; padding: 8px; border: 1px solid #000000;" placeholder="customer@example.com">
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Type</label>
                            <select id="task-form-catalogue" required style="width: 100%; padding: 8px; border: 1px solid #000000;">
                                <option value="">-- Select Type --</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Template</label>
                            <div id="task-form-template-editor" style="height: 300px; background-color: #ffffff;"></div>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Attachments</label>
                            <div id="task-form-dropzone" style="border: 2px dashed #000000; padding: 20px; text-align: center; background-color: #f9f9f9; min-height: 100px; margin-bottom: 15px;">
                                <p style="margin: 0; color: #666;">Drag and drop files here or click to select</p>
                                <input type="file" id="task-form-file-input" multiple style="display: none;" onchange="handleTaskFileSelect(event)">
                            </div>
                            <div id="task-form-attachments-list"></div>
                        </div>
                        <div class="form-group" style="margin-top: 20px;">
                            <button type="submit" class="form-button" style="width: 100%; padding: 15px; font-size: 16px;">Submit Task</button>
                        </div>
                    </form>
                </div>
            `;
            
            // Setup drag and drop
            setupTaskDragAndDrop();
            
            // Setup autocomplete for customer field
            setTimeout(() => {
                setupAutocomplete('task-form-customer', 'task-form-customer-dropdown', 'task-form-customer-value', 'task-form-email');
            }, 50);
            
            // Load task types
            loadTaskTypesForDropdown();
            
            // Initialize Quill editor for task form (after DOM is ready)
            setTimeout(() => {
                const taskFormEditorDiv = document.getElementById('task-form-template-editor');
                if (taskFormEditorDiv) {
                    // Destroy existing editor if it exists
                    if (window.taskFormEditor) {
                        try {
                            window.taskFormEditor = null;
                        } catch (e) {
                            console.warn('Error destroying existing editor:', e);
                        }
                    }
                    // Create new editor
                    window.taskFormEditor = new Quill('#task-form-template-editor', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'script': 'sub'}, { 'script': 'super' }],
                                [{ 'indent': '-1'}, { 'indent': '+1' }],
                                [{ 'align': [] }],
                                ['link', 'image'],
                                [{ 'table': true }],
                                ['clean']
                            ]
                        }
                    });
                }
            }, 100);
        }
        
        function setupCustomerEmailAutoFill() {
            const customerSelect = document.getElementById('task-form-customer');
            const emailInput = document.getElementById('task-form-email');
            
            if (!customerSelect || !emailInput) return;
            
            customerSelect.addEventListener('change', function() {
                const selectedEmailSuffix = this.value;
                
                if (!selectedEmailSuffix) {
                    // If no customer selected, clear email field
                    emailInput.value = '';
                    return;
                }
                
                // Find the customer in cache
                const selectedCustomer = customerCache.find(c => c.email_suffix === selectedEmailSuffix);
                
                if (selectedCustomer) {
                    // Use the stored email address directly
                    const storedEmail = (selectedCustomer.email_suffix || '').trim();
                    
                    if (storedEmail.includes('@')) {
                        // If it's a full email address (new format), use it directly
                        emailInput.value = storedEmail;
                    } else {
                        // Backward compatibility: if it's old format without @, build email from name
                        const customerName = (selectedCustomer.name || '').trim();
                        let emailAddress = '';
                        
                        if (customerName.includes('@')) {
                            // If customer name already contains @, use it as email
                            emailAddress = customerName;
                        } else {
                            // Convert customer name to email username (lowercase, remove spaces and special chars)
                            let username = customerName
                                .toLowerCase()
                                .replace(/\s+/g, '')  // Remove spaces
                                .replace(/[^a-z0-9._-]/g, '');  // Remove special chars except . _ -
                            
                            // If username is empty after processing, use a default value
                            if (!username) {
                                username = 'customer';
                            }
                            
                            // Combine username with email suffix
                            if (storedEmail.startsWith('@')) {
                                emailAddress = username + storedEmail;
                            } else {
                                emailAddress = username + '@' + storedEmail;
                            }
                        }
                        
                        emailInput.value = emailAddress;
                    }
                }
            });
        }

        function setupTaskDragAndDrop() {
            const dropzone = document.getElementById('task-form-dropzone');
            const fileInput = document.getElementById('task-form-file-input');
            
            if (!dropzone || !fileInput) return;
            
            // Click to select files
            dropzone.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Drag and drop handlers
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.style.backgroundColor = '#e9e9e9';
            });
            
            dropzone.addEventListener('dragleave', () => {
                dropzone.style.backgroundColor = '#f9f9f9';
            });
            
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.style.backgroundColor = '#f9f9f9';
                const files = Array.from(e.dataTransfer.files);
                handleTaskFiles(files);
            });
        }

        function handleTaskFileSelect(event) {
            const files = Array.from(event.target.files);
            handleTaskFiles(files);
        }

        function handleTaskFiles(files) {
            if (!window.taskFormAttachments) {
                window.taskFormAttachments = [];
            }
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64Data = e.target.result.split(',')[1];
                    window.taskFormAttachments.push({
                        filename: file.name,
                        content_type: file.type || 'application/octet-stream',
                        size: file.size,
                        data: base64Data,
                        caption: ''
                    });
                    renderTaskAttachmentsList();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderTaskAttachmentsList() {
            const container = document.getElementById('task-form-attachments-list');
            if (!container) return;
            
            if (!window.taskFormAttachments || window.taskFormAttachments.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = window.taskFormAttachments.map((att, idx) => {
                const filename = escapeHtml(att.filename || 'attachment');
                const size = formatAttachmentSize(att.size || 0);
                return `
                    <div class="task-attachment-display" style="margin-bottom: 10px;">
                        <div class="task-attachment-info" style="flex: 1;">
                            <div style="font-weight: bold;">${filename}</div>
                            <div style="font-size: 12px; color: #666;">${att.content_type || 'application/octet-stream'} ‚Ä¢ ${size}</div>
                            <input type="text" class="task-attachment-caption" data-index="${idx}" placeholder="Enter caption for this attachment" style="width: 100%; margin-top: 5px; padding: 5px; border: 1px solid #000000;" value="${escapeHtml(att.caption || '')}">
                        </div>
                        <div class="task-attachment-actions">
                            <button type="button" class="form-button" onclick="removeTaskFormAttachment(${idx})" style="font-size: 12px; background-color: #dc3545; color: white;">X</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Attach caption input handlers
            container.querySelectorAll('.task-attachment-caption').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    if (window.taskFormAttachments && window.taskFormAttachments[index]) {
                        window.taskFormAttachments[index].caption = e.target.value;
                    }
                });
            });
        }

        function removeTaskFormAttachment(index) {
            if (!window.taskFormAttachments || !window.taskFormAttachments[index]) {
                return;
            }
            window.taskFormAttachments.splice(index, 1);
            renderTaskAttachmentsList();
        }

        function submitTaskFromForm(event) {
            event.preventDefault();
            
            const customerInput = document.getElementById('task-form-customer');
            const customerValueInput = document.getElementById('task-form-customer-value');
            const emailInput = document.getElementById('task-form-email');
            const catalogueSelect = document.getElementById('task-form-catalogue');
            
            if (!customerInput || !customerValueInput || !emailInput || !catalogueSelect) {
                alert('Form fields not found');
                return;
            }
            
            // Get content from Quill editor
            let template = '';
            if (window.taskFormEditor) {
                template = window.taskFormEditor.root.innerHTML;
            }
            
            const customerEmailSuffix = customerValueInput.value;
            const customerName = customerInput.value;
            const email = emailInput.value.trim();
            const catalogue = catalogueSelect.value;
            
            if (!customerEmailSuffix || !customerName) {
                alert('Please select a customer');
                return;
            }
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            if (!catalogue) {
                alert('Please select a type');
                return;
            }
            
            if (!template || template.trim() === '' || template === '<p><br></p>') {
                alert('Please enter template content');
                return;
            }
            
            // Generate sequence code (yyyymmdd_hhmmss)
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const mi = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            const sequence = `${yyyy}${mm}${dd}_${hh}${mi}${ss}`;
            
            // Prepare task data
            const taskData = {
                sequence: sequence,
                customer: customerName,
                email: email,
                catalogue: catalogue,
                template: template,
                attachments: (window.taskFormAttachments || []).map(att => ({
                    filename: att.filename,
                    content_type: att.content_type,
                    size: att.size,
                    data: att.data,
                    caption: att.caption || ''
                }))
            };
            
            // Save to database
            fetch('/api/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(taskData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error saving task: ' + data.error);
                } else {
                    alert('Task saved successfully!');
                    // Reset form
                    document.getElementById('task-form').reset();
                    window.taskFormAttachments = [];
                    renderTaskAttachmentsList();
                    // Refresh task list if it's displayed
                    if (document.getElementById('task-list-content') && !document.getElementById('task-list-content').classList.contains('hidden')) {
                        loadTaskList();
                    }
                }
            })
            .catch(error => {
                alert('Error saving task: ' + error.message);
            });
        }

        function showDropdownList() {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('send-mail-content').classList.add('hidden');
            document.getElementById('create-customer-content').classList.add('hidden');
            document.getElementById('task-list-content').classList.add('hidden');
            document.getElementById('dropdown-list-content').classList.remove('hidden');
            document.getElementById('content-title').textContent = 'Dropdown List';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
            // Load task types list
            loadTaskTypes();
        }

        function showSettings() {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('settings-content').classList.remove('hidden');
            document.getElementById('send-mail-content').classList.add('hidden');
            document.getElementById('create-customer-content').classList.add('hidden');
            document.getElementById('dropdown-list-content').classList.add('hidden');
            document.getElementById('task-list-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Settings';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
            event.target.classList.add('active');
            }
            showProfileList();
        }

        // Task Types Management Functions
        let taskTypesCache = [];

        function loadTaskTypes() {
            fetch('/api/task-types')
                .then(response => response.json())
                .then(types => {
                    taskTypesCache = types;
                    renderTaskTypesList(types);
                    updateTaskTypeDropdowns(types);
                })
                .catch(error => {
                    console.error('Error loading task types:', error);
                    document.getElementById('task-types-list').innerHTML = '<div style="padding: 20px; color: #dc3545;">Error loading task types</div>';
                });
        }

        let currentTaskTypeDragId = null;

        function renderTaskTypesList(types) {
            const container = document.getElementById('task-types-list');
            if (!container) return;
            
            if (!types || types.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No task types found. Add one above.</div>';
                return;
            }
            
            // Sort by display_order
            const sortedTypes = [...types].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            
            container.innerHTML = sortedTypes.map((type, index) => `
                <div class="task-type-row" draggable="true"
                     data-type-id="${type.id}"
                     ondragstart="onTaskTypeDragStart(event, ${type.id})"
                     ondragover="onTaskTypeDragOver(event, ${type.id})"
                     ondrop="onTaskTypeDrop(event, ${type.id})"
                     ondragend="onTaskTypeDragEnd(event)"
                     style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #f0f0f0;">
                    <div class="task-type-handle">
                        <div class="task-type-handle-icon">‚â°</div>
                        <div class="task-type-seq">#${index + 1}</div>
                    </div>
                    <div style="flex: 1;">
                        <input type="text" value="${escapeHtml(type.name)}" 
                               id="task-type-name-${type.id}" 
                               style="width: 100%; padding: 5px; border: 1px solid #000000; font-size: 14px;"
                               onblur="updateTaskType(${type.id})">
                    </div>
                    <div style="margin-left: 15px; display: flex; gap: 5px;">
                        <button class="form-button" onclick="updateTaskType(${type.id})" style="padding: 5px 15px; font-size: 12px;">Save</button>
                        <button class="form-button" onclick="deleteTaskType(${type.id})" style="padding: 5px 15px; font-size: 12px; background-color: #dc3545; color: white;">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function addTaskType() {
            const input = document.getElementById('new-task-type-input');
            const name = input.value.trim();
            
            if (!name) {
                alert('Please enter a task type name');
                return;
            }
            
            fetch('/api/task-types', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: name })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    input.value = '';
                    loadTaskTypes();
                }
            })
            .catch(error => {
                alert('Error adding task type: ' + error.message);
            });
        }

        function updateTaskType(typeId) {
            const nameInput = document.getElementById(`task-type-name-${typeId}`);
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Task type name cannot be empty');
                loadTaskTypes(); // Reload to reset
                return;
            }
            
            // Find current type to preserve display_order
            const currentType = taskTypesCache.find(t => t.id === typeId);
            const displayOrder = currentType ? (currentType.display_order || 0) : 0;
            
            fetch(`/api/task-types/${typeId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: name, display_order: displayOrder })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    loadTaskTypes(); // Reload to reset
                } else {
                    loadTaskTypes();
                }
            })
            .catch(error => {
                alert('Error updating task type: ' + error.message);
                loadTaskTypes(); // Reload to reset
            });
        }

        function deleteTaskType(typeId) {
            if (!confirm('Are you sure you want to delete this task type?')) {
                return;
            }
            
            fetch(`/api/task-types/${typeId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    loadTaskTypes();
                }
            })
            .catch(error => {
                alert('Error deleting task type: ' + error.message);
            });
        }

        function onTaskTypeDragStart(event, typeId) {
            currentTaskTypeDragId = typeId;
            event.dataTransfer.effectAllowed = 'move';
        }

        function onTaskTypeDragOver(event, typeId) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            const row = event.currentTarget;
            row.classList.add('drag-over');
        }

        function onTaskTypeDragEnd(event) {
            document.querySelectorAll('.task-type-row.drag-over').forEach(row => {
                row.classList.remove('drag-over');
            });
        }

        function onTaskTypeDrop(event, targetTypeId) {
            event.preventDefault();
            const targetRow = event.currentTarget;
            targetRow.classList.remove('drag-over');
            
            if (!currentTaskTypeDragId || currentTaskTypeDragId === targetTypeId) {
                currentTaskTypeDragId = null;
                return;
            }
            
            // Reorder in memory
            const sortedTypes = [...taskTypesCache].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            const fromIndex = sortedTypes.findIndex(t => t.id === currentTaskTypeDragId);
            const toIndex = sortedTypes.findIndex(t => t.id === targetTypeId);
            
            if (fromIndex < 0 || toIndex < 0 || fromIndex === toIndex) {
                currentTaskTypeDragId = null;
                return;
            }
            
            const [moved] = sortedTypes.splice(fromIndex, 1);
            sortedTypes.splice(toIndex, 0, moved);
            
            // Re-assign display_order sequentially
            sortedTypes.forEach((type, index) => {
                type.display_order = index + 1;
            });
            
            // Persist all updated orders
            Promise.all(sortedTypes.map(type => 
                fetch(`/api/task-types/${type.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: type.name,
                        display_order: type.display_order
                    })
                })
            ))
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(results => {
                if (results.some(r => r.error)) {
                    alert('Error updating order');
                } else {
                    loadTaskTypes();
                }
            })
            .catch(error => {
                alert('Error reordering task types: ' + error.message);
            })
            .finally(() => {
                currentTaskTypeDragId = null;
            });
        }

        function loadTaskTypesForDropdown() {
            if (taskTypesCache && taskTypesCache.length > 0) {
                updateTaskTypeDropdowns(taskTypesCache);
            } else {
                fetch('/api/task-types')
                    .then(response => response.json())
                    .then(types => {
                        taskTypesCache = types;
                        updateTaskTypeDropdowns(types);
                    })
                    .catch(error => {
                        console.error('Error loading task types:', error);
                    });
            }
        }

        function updateTaskTypeDropdowns(types) {
            // Sort by display_order
            const sortedTypes = [...types].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            
            // Update task form dropdown
            const taskFormCatalogue = document.getElementById('task-form-catalogue');
            if (taskFormCatalogue) {
                const currentValue = taskFormCatalogue.value;
                taskFormCatalogue.innerHTML = '<option value="">-- Select Type --</option>' + 
                    sortedTypes.map(type => `<option value="${escapeHtml(type.name)}">${escapeHtml(type.name)}</option>`).join('');
                if (currentValue) {
                    taskFormCatalogue.value = currentValue;
                }
            }
            
            // Update task modal dropdown
            const taskCatalogueSelect = document.getElementById('task-catalogue');
            if (taskCatalogueSelect) {
                const currentValue = taskCatalogueSelect.value;
                taskCatalogueSelect.innerHTML = sortedTypes.map(type => 
                    `<option value="${escapeHtml(type.name)}">${escapeHtml(type.name)}</option>`
                ).join('');
                if (currentValue) {
                    taskCatalogueSelect.value = currentValue;
                }
            }
        }


        function showError(message, isError = true, timeoutMs = 3000) {
            const errorDiv = document.getElementById('error-message');
            if (!errorDiv) return;
            errorDiv.textContent = message;
            errorDiv.className = `message ${isError ? 'error' : 'success'}`;
            errorDiv.classList.remove('hidden');
            if (timeoutMs > 0) {
            setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, timeoutMs);
            }
        }

        function showMessage(message, type = 'info', timeoutMs = 5000) {
            // Use error-message div or create a new one
            let messageDiv = document.getElementById('error-message');
            if (!messageDiv) {
                // Create message div if it doesn't exist
                messageDiv = document.createElement('div');
                messageDiv.id = 'error-message';
                messageDiv.className = 'message';
                const contentArea = document.getElementById('content-area');
                if (contentArea) {
                    contentArea.insertBefore(messageDiv, contentArea.firstChild);
                }
            }
            messageDiv.textContent = message;
            const typeClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            messageDiv.className = `message ${typeClass}`;
            messageDiv.classList.remove('hidden');
            if (timeoutMs > 0) {
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, timeoutMs);
            }
        }

        function hideMessage() {
            const messageDiv = document.getElementById('error-message');
            if (messageDiv) {
                messageDiv.classList.add('hidden');
            }
        }

        function showEmailLoadingOverlay() {
            const overlay = document.getElementById('email-loading-overlay');
            if (overlay) {
                overlay.classList.add('active');
            }
        }

        function hideEmailLoadingOverlay() {
            const overlay = document.getElementById('email-loading-overlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
        }

        function getCurrentProfile() {
            // Get selected profile from localStorage or default to profile1
            const selectedProfile = localStorage.getItem('selectedProfile') || 'profile1';
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            return profiles[selectedProfile] || profiles.profile1 || {};
        }

        function setCurrentProfile(profileKey) {
            localStorage.setItem('selectedProfile', profileKey);
            updateComposeDefaults();
        }

        function updateComposeDefaults() {
            const profile = getCurrentProfile();
            const senderInput = document.getElementById('compose-sender-name');
            if (!senderInput) return;
            const defaultName = profile.smtp?.sender_name || profile.name || 'Mail Task';
            senderInput.placeholder = defaultName;
            if (!senderInput.value.trim()) {
                senderInput.value = defaultName;
            }
        }

        function authenticateGmail() {
            // Get values from form fields (in case user just entered them)
            const clientId = document.getElementById('gmail-oauth-client-id').value.trim();
            const clientSecret = document.getElementById('gmail-oauth-client-secret').value.trim();
            const redirectUri = document.getElementById('gmail-oauth-redirect-uri').value.trim() || 'http://localhost:5000/oauth2callback';
            
            // If form fields are empty, try to get from profile
            const profile = getCurrentProfile();
            const gmail = profile.gmail || {};
            const finalClientId = clientId || gmail.oauth_client_id || '';
            const finalClientSecret = clientSecret || gmail.oauth_client_secret || '';
            const finalRedirectUri = redirectUri || gmail.oauth_redirect_uri || 'http://localhost:5000/oauth2callback';
            
            const statusDiv = document.getElementById('gmail-auth-status');
            if (statusDiv) {
                statusDiv.innerHTML = '<span style="color: #0066cc;">Starting authentication...</span>';
            }
            
            if (!finalClientId || !finalClientSecret) {
                const msg = 'Please enter Gmail OAuth Client ID and Client Secret in the fields above first.';
                if (statusDiv) {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå ${msg}</span>`;
                } else {
                    alert(msg);
                }
                return;
            }
            
            // Validate format
            if (!finalClientId.includes('.apps.googleusercontent.com')) {
                const msg = 'Client ID should end with .apps.googleusercontent.com';
                if (statusDiv) {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå ${msg}</span>`;
                } else {
                    alert(msg);
                }
                return;
            }
            
            const params = new URLSearchParams({
                client_id: finalClientId,
                client_secret: finalClientSecret,
                redirect_uri: finalRedirectUri
            });
            
            fetch(`/api/gmail-auth?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        const msg = `Authentication error: ${data.error}`;
                        if (statusDiv) {
                            statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå ${msg}</span>`;
                        } else {
                            alert(msg);
                        }
                    } else if (data.auth_url) {
                        if (statusDiv) {
                            statusDiv.innerHTML = '<span style="color: #28a745;">Opening authentication window...</span>';
                        }
                        // Open OAuth window
                        const authWindow = window.open(data.auth_url, 'Gmail Auth', 'width=600,height=700,scrollbars=yes');
                        
                        if (!authWindow) {
                            alert('Popup blocked! Please allow popups for this site and try again.');
                            if (statusDiv) {
                                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Popup blocked. Please allow popups.</span>';
                            }
                            return;
                        }
                        
                        // Check if window was closed (user completed auth)
                        const checkClosed = setInterval(() => {
                            if (authWindow.closed) {
                                clearInterval(checkClosed);
                                if (statusDiv) {
                                    statusDiv.innerHTML = '<span style="color: #0066cc;">Checking authentication...</span>';
                                }
                                // Check status after a delay
                                setTimeout(() => {
                                    checkGmailStatus();
                                    // Try fetching emails after auth
                                    setTimeout(() => {
                                        if (window.location.hash !== '#settings') {
                                            fetchGmailEmails();
                                        }
                                    }, 2000);
                                }, 1000);
                            }
                        }, 500);
                    }
                })
                .catch(error => {
                    const msg = `Error starting authentication: ${error.message}`;
                    if (statusDiv) {
                        statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå ${msg}</span>`;
                    } else {
                        alert(msg);
                    }
                });
        }

        function checkGmailStatus() {
            const statusDiv = document.getElementById('gmail-auth-status');
            if (statusDiv) {
                statusDiv.innerHTML = '<span style="color: #0066cc;">Checking...</span>';
            }
            
            fetch('/api/gmail-status')
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        const msg = `‚úÖ Authenticated!\nEmail: ${data.email}\nTotal messages: ${data.messages_total}`;
                        if (statusDiv) {
                            statusDiv.innerHTML = `<span style="color: #28a745;">${msg.replace(/\n/g, '<br>')}</span>`;
                        } else {
                            alert(msg);
                        }
                    } else {
                        const msg = data.message || 'Gmail OAuth is not authenticated. Please configure it above.';
                        if (statusDiv) {
                            statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå ${msg}</span>`;
                        } else {
                            alert(msg);
                        }
                    }
                })
                .catch(error => {
                    const msg = `Error checking status: ${error.message}`;
                    if (statusDiv) {
                        statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå ${msg}</span>`;
                    } else {
                        alert(msg);
                    }
                });
        }

        function fetchGmailEmails() {
            const emailList = document.getElementById('email-list');
            
            // Show loading overlay
            showEmailLoadingOverlay();
            
            // Create a set of unique identifiers for existing emails
            // Use multiple fields to catch duplicates: sequence code, ID, or subject+date+from
            const existingEmailKeys = new Set();
            (currentEmails || []).forEach(email => {
                const emailObj = ensureEmailSequence({ ...email });
                registerEmailKeys(emailObj, existingEmailKeys);
            });
            
            const existingCount = existingEmailKeys.size;
            
            // Show popup message: "Checking for new emails from web page"
            showMessage('Checking for new emails from web page...', 'info');
            
            // If no emails are displayed, load from cache first
            if (existingCount === 0) {
                const cached = loadCachedEmails('gmail');
                if (cached && Array.isArray(cached) && cached.length > 0) {
                    const uniqueCached = deduplicateEmails(cached);
                    displayEmails(uniqueCached, { provider: 'gmail', cached: true });
                    // Update existing keys after displaying cached emails
                    currentEmails.forEach(email => {
                        const emailObj = ensureEmailSequence({ ...email });
                        registerEmailKeys(emailObj, existingEmailKeys);
                    });
                }
            }
            
            const gmailDaysBack = 1; // fetch today + previous day
            fetch('/api/fetch-gmail', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ limit: 50, days_back: gmailDaysBack })
            })
                .then(async response => {
                    const data = await response.json();
                    if (response.status === 401 && data.needs_auth) {
                        const errorMsg = data.error || 'Gmail OAuth authentication required.';
                        emailList.innerHTML = `
                            <div class="message error" style="white-space: pre-line;">
                                <p><strong>Gmail OAuth Setup Required</strong></p>
                                <p>${escapeHtml(errorMsg)}</p>
                                <div style="margin-top: 15px;">
                                    <button class="form-button" onclick="showSettings(); setTimeout(() => { const detail = document.getElementById('profile-detail-view'); if (detail && !detail.classList.contains('hidden')) { detail.scrollIntoView({ behavior: 'smooth', block: 'start' }); } }, 500);" style="margin-right: 10px;">Go to Settings</button>
                                    <button class="form-button" onclick="authenticateGmail()">Authenticate Gmail</button>
                                </div>
                                <p style="margin-top: 15px; font-size: 12px;">
                                    <a href="${data.setup_url || 'https://console.cloud.google.com/'}" target="_blank">Get OAuth Credentials from Google Cloud Console</a>
                                </p>
                            </div>
                        `;
                        hideMessage();
                        hideEmailLoadingOverlay();
                    } else if (data.error) {
                        // Check if authentication is needed
                        if (data.needs_auth) {
                            emailList.innerHTML = `
                                <div class="message error" style="white-space: pre-line;">
                                    <p><strong>Gmail Authentication Required</strong></p>
                                    <p>${escapeHtml(data.error)}</p>
                                    <div style="margin-top: 15px;">
                                        <button class="form-button" onclick="showSettings(); setTimeout(() => { const detail = document.getElementById('profile-detail-view'); if (detail && !detail.classList.contains('hidden')) { detail.scrollIntoView({ behavior: 'smooth', block: 'start' }); } }, 500);" style="margin-right: 10px;">Go to Settings</button>
                                        <button class="form-button" onclick="authenticateGmail()">Re-authenticate Gmail</button>
                                    </div>
                                </div>
                            `;
                    } else {
                            showMessage(`Error: ${escapeHtml(data.error)}`, 'error');
                        }
                        hideEmailLoadingOverlay();
                    } else {
                        const fetchedEmails = (data.emails || []).map(item => ensureEmailSequence({ ...item }));
                        
                        // Filter out emails that are already displayed using multiple criteria
                        const newEmails = fetchedEmails.filter(email => {
                            const emailObj = ensureEmailSequence({ ...email });
                            
                            const id = (emailObj.id || emailObj.email_uid || '').trim();
                            if (id) {
                                if (existingEmailKeys.has(`id:${id}`)) {
                                    return false;
                                }
                            } else {
                                const sequenceKey = (emailObj.sequence || '').trim();
                                if (sequenceKey && existingEmailKeys.has(`seq:${sequenceKey}`)) {
                                    return false;
                                }
                            }
                            
                            const subject = (emailObj.subject || '').trim();
                            const date = (emailObj.date || '').trim();
                            const from = (emailObj.from || '').trim();
                            if (subject && date && from) {
                                const fallbackKey = `key:${subject}|${date}|${from}`;
                                if (existingEmailKeys.has(fallbackKey)) {
                                    return false;
                                }
                            }
                            
                            registerEmailKeys(emailObj, existingEmailKeys);
                            return true;
                        });
                        
                        // Merge new emails with existing ones
                        const mergedEmails = [...currentEmails, ...newEmails];
                        
                        // Deduplicate the merged list to remove any duplicates
                        const uniqueEmails = deduplicateEmails(mergedEmails);
                        
                        // Sort by date (newest first)
                        uniqueEmails.sort((a, b) => {
                            const dateA = new Date(a.date || 0);
                            const dateB = new Date(b.date || 0);
                            return dateB - dateA;
                        });
                        
                        // Update cache with deduplicated emails
                        cacheEmails('gmail', uniqueEmails);
                        
                        // Display deduplicated emails
                        displayEmails(uniqueEmails, { provider: 'gmail' });
                        
                        // Show result message
                        if (newEmails.length > 0) {
                            showMessage(`Found ${newEmails.length} new email(s) and added to the list.`, 'success');
                        } else {
                            showMessage('No new emails found. All emails are up to date.', 'info');
                        }
                        hideEmailLoadingOverlay();
                    }
                })
                .catch(error => {
                    showMessage(`Error fetching emails: ${escapeHtml(error.message)}`, 'error');
                    hideEmailLoadingOverlay();
                });
        }

        function fetchQQEmails() {
            const profile = getCurrentProfile();
            const qq = profile.qq || {};
            
            if (!qq.username || !qq.password) {
                showError('Please save QQ settings first in Settings page');
                return;
            }

            // Show loading overlay
            showEmailLoadingOverlay();

            const emailList = document.getElementById('email-list');
            emailList.innerHTML = '<div class="loading">Loading QQ emails...</div>';
            const cached = loadCachedEmails('qq');
            if (cached && Array.isArray(cached)) {
                const uniqueCached = deduplicateEmails(cached);
                displayEmails(uniqueCached, { provider: 'qq', cached: true });
            }
            
            fetch('/api/fetch-qq', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    imap_server: qq.imap_server || 'imap.qq.com',
                    port: qq.port || 993,
                    username: qq.username,
                    password: qq.password,
                    use_ssl: qq.use_ssl !== undefined ? qq.use_ssl : true,
                    use_tls: qq.use_tls || false,
                    limit: 50
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        emailList.innerHTML = `<div class="message error">Error: ${escapeHtml(data.error)}</div>`;
                    } else {
                        const list = (data.emails || []).map(item => ensureEmailSequence({ ...item }));
                        const uniqueList = deduplicateEmails(list);
                        cacheEmails('qq', uniqueList);
                        displayEmails(uniqueList, { provider: 'qq' });
                    }
                    hideEmailLoadingOverlay();
                })
                .catch(error => {
                    emailList.innerHTML = `<div class="message error">Error fetching emails: ${escapeHtml(error.message)}</div>`;
                    hideEmailLoadingOverlay();
                });
        }

        function fetch163Emails() {
            // Show loading overlay
            showEmailLoadingOverlay();

            const emailList = document.getElementById('email-list');
            emailList.innerHTML = '<div class="loading">Loading 163.com emails...</div>';
            const cached = loadCachedEmails('163');
            if (cached && Array.isArray(cached)) {
                const uniqueCached = deduplicateEmails(cached);
                displayEmails(uniqueCached, { provider: '163', cached: true });
            }
            
            const profile = getCurrentProfile();
            const email163 = profile.email163 || {};
            const requestData = {
                limit: 50,
                imap_server: email163.imap_server || 'imap.163.com',
                port: email163.port || 993,
                username: email163.username || '',
                password: email163.password || '',
                use_ssl: email163.use_ssl !== undefined ? email163.use_ssl : true,
                use_tls: email163.use_tls || false
            };
            
            fetch('/api/fetch-163', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        emailList.innerHTML = `<div class="message error">Error: ${escapeHtml(data.error)}</div>`;
                    } else {
                        const list = (data.emails || []).map(item => ensureEmailSequence({ ...item }));
                        const uniqueList = deduplicateEmails(list);
                        cacheEmails('163', uniqueList);
                        displayEmails(uniqueList, { provider: '163' });
                    }
                    hideEmailLoadingOverlay();
                })
                .catch(error => {
                    emailList.innerHTML = `<div class="message error">Error fetching emails: ${escapeHtml(error.message)}</div>`;
                    hideEmailLoadingOverlay();
                });
        }

        function parseEmailList(value) {
            if (!value) {
                return [];
            }
            return value
                .split(/[;,]+/)
                .map(addr => addr.trim())
                .filter(addr => addr.length > 0);
        }

        function showSendStatus(message, state = 'info', timeoutMs = 4000) {
            const statusDiv = document.getElementById('send-email-status');
            if (!statusDiv) return;
            statusDiv.textContent = message;
            statusDiv.className = `message ${state}`;
            statusDiv.classList.remove('hidden');
            if (timeoutMs > 0) {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, timeoutMs);
            }
        }

        function sendEmail() {
            const recipientsValue = document.getElementById('compose-to').value;
            const subjectValue = document.getElementById('compose-subject').value;
            const bodyValue = document.getElementById('compose-body').value;
            const senderNameInput = document.getElementById('compose-sender-name').value.trim();
            const sendAsHtml = document.getElementById('compose-is-html').checked;
            const usePrimary = document.getElementById('use-primary-smtp').checked;
            const useBackup = document.getElementById('use-backup-smtp').checked;

            const recipients = parseEmailList(recipientsValue);
            if (recipients.length === 0) {
                showSendStatus('Please enter at least one recipient email address.', 'error');
                return;
            }

            if (!bodyValue.trim()) {
                showSendStatus('Email body cannot be empty.', 'error');
                return;
            }

            const profile = getCurrentProfile();
            const smtpConfig = profile.smtp || {};
            const configs = [];

            const primary = smtpConfig.primary || {};
            if (usePrimary && primary.server && primary.username && primary.password) {
                configs.push({
                    name: 'Primary SMTP',
                    server: primary.server,
                    port: primary.port,
                    username: primary.username,
                    password: primary.password,
                    use_ssl: !!primary.use_ssl,
                    use_tls: !!primary.use_tls,
                    sender_name: smtpConfig.sender_name,
                    from_address: primary.username
                });
            }

            const backup = smtpConfig.backup || {};
            if (useBackup && backup.server && backup.username && backup.password) {
                configs.push({
                    name: 'Backup SMTP',
                    server: backup.server,
                    port: backup.port,
                    username: backup.username,
                    password: backup.password,
                    use_ssl: !!backup.use_ssl,
                    use_tls: !!backup.use_tls,
                    sender_name: smtpConfig.sender_name,
                    from_address: backup.username
                });
            }

            const payload = {
                to: recipients,
                subject: subjectValue,
                body: bodyValue,
                is_html: sendAsHtml,
                sender_name: senderNameInput || smtpConfig.sender_name || profile.name || 'Mail Task'
            };

            if (configs.length > 0) {
                payload.configs = configs;
            }

            showSendStatus('Sending email...', 'info', 0);

            fetch('/api/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
                .then(async response => {
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to send email');
                    }
                    document.getElementById('compose-body').value = '';
                    showSendStatus(`Email sent via ${data.provider || 'SMTP provider'}.`, 'success');
                })
                .catch(error => {
                    showSendStatus(`Send failed: ${error.message}`, 'error');
                });
        }

        function formatAttachmentSize(bytes) {
            const size = Number(bytes) || 0;
            if (size >= 1024 * 1024) {
                return `${(size / (1024 * 1024)).toFixed(1)} MB`;
            }
            return `${(size / 1024).toFixed(1)} KB`;
        }

        function displayEmails(emails, options = {}) {
            const emailList = document.getElementById('email-list');
            currentEmails = Array.isArray(emails) ? emails.map(email => ensureEmailSequence({ ...email })) : [];
            const provider = options.provider || currentProvider;
            const isCached = !!options.cached;
            if (provider) {
                currentProvider = provider;
                updateContentTitle(provider, isCached);
            }
            if (!emailList) {
                return;
            }
            emailList.dataset.cached = isCached ? 'true' : 'false';

            if (currentEmails.length === 0) {
                emailList.innerHTML = '<div class="loading">No emails found for today or yesterday</div>';
                return;
            }
            
            emailList.innerHTML = currentEmails.map((email, index) => `
                <div class="email-item" data-index="${index}">
                    <div class="email-content">
                    <div class="email-header">
                            <div class="email-subject">
                                ${escapeHtml(email.subject || 'No Subject')}
                                ${email.sequence ? `<span class="email-sequence-inline">${escapeHtml(email.sequence)}</span>` : ''}
                            </div>
                        <div class="email-date">${escapeHtml(email.date || '')}</div>
                    </div>
                    <div class="email-from">From: ${escapeHtml(email.from || '')}</div>
                        <div class="email-preview">${escapeHtml(email.preview || '')}</div>
                        ${Array.isArray(email.attachments) && email.attachments.length > 0 ? `
                            <div class="email-attachments">
                                ${email.attachments.map(att => `
                                    <a class="attachment-chip" href="data:${att.content_type || 'application/octet-stream'};base64,${att.data}" download="${escapeHtml(att.filename || 'attachment')}">
                                        üìé ${escapeHtml(att.filename || 'attachment')} (${formatAttachmentSize(att.size || 0)})
                                    </a>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="email-actions">
                        ${Array.isArray(email.attachments) && email.attachments.length > 0 ? `
                            <button class="form-button email-action-button attachment-button" data-index="${index}" data-attachment="true" title="View attachments">
                                üìé (${email.attachments.length})
                            </button>
                        ` : ''}
                        <button class="form-button email-action-button" data-index="${index}">Task</button>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.email-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.getAttribute('data-index'), 10);
                    openEmailModal(index);
                });
            });

            document.querySelectorAll('.email-action-button').forEach(button => {
                button.addEventListener('click', (evt) => {
                    evt.stopPropagation();
                    const index = parseInt(button.getAttribute('data-index'), 10);
                    if (button.dataset.attachment === 'true') {
                        openAttachmentModal(index);
                    } else {
                        openTaskModal(index);
                    }
                });
            });
        }

        function openEmailModal(index) {
            if (Number.isNaN(index)) {
                return;
            }
            const email = currentEmails[index];
            if (!email) {
                return;
            }

            emailModalSubject.textContent = email.subject || 'No Subject';
            const metaLines = [
                `From: ${email.from || 'Unknown sender'}`,
                `Date: ${email.date || 'Unknown date'}`
            ];
            emailModalMeta.textContent = metaLines.join('\n');

            if (email.html_body) {
                // Wrap HTML content with proper styling for scrolling
                emailModalFrame.srcdoc = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body {
                                margin: 0;
                                padding: 20px;
                                font-family: Arial, sans-serif;
                                overflow-y: auto;
                                overflow-x: hidden;
                            }
                        </style>
                    </head>
                    <body>
                        ${email.html_body}
                    </body>
                    </html>
                `;
            } else {
                const plain = email.plain_body || '';
                emailModalFrame.srcdoc = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body {
                                margin: 0;
                                padding: 20px;
                                font-family: Arial, sans-serif;
                                overflow-y: auto;
                                overflow-x: hidden;
                            }
                            pre {
                                white-space: pre-wrap;
                                word-wrap: break-word;
                            }
                        </style>
                    </head>
                    <body>
                        <pre>${escapeHtml(plain)}</pre>
                    </body>
                    </html>
                `;
            }

            emailModal.classList.remove('hidden');
        }

        function closeEmailModal() {
            emailModal.classList.add('hidden');
            emailModalFrame.srcdoc = '';
        }

        function openAttachmentModal(index) {
            if (Number.isNaN(index)) {
                return;
            }
            const email = currentEmails[index];
            if (!email || !Array.isArray(email.attachments) || email.attachments.length === 0) {
                return;
            }
            attachmentList.innerHTML = email.attachments.map((att, idx) => `
                <div class="attachment-row">
                    <div class="attachment-row-info">
                        <strong>${escapeHtml(att.filename || `Attachment ${idx + 1}`)}</strong>
                        <span>${att.content_type || 'application/octet-stream'} ‚Ä¢ ${formatAttachmentSize(att.size || 0)}</span>
                    </div>
                    <a class="form-button" href="data:${att.content_type || 'application/octet-stream'};base64,${att.data}" download="${escapeHtml(att.filename || `attachment-${idx + 1}`)}">
                        Download
                    </a>
                </div>
            `).join('');
            attachmentModal.classList.remove('hidden');
        }

        function closeAttachmentModal() {
            attachmentModal.classList.add('hidden');
            attachmentList.innerHTML = '';
        }

        function openTaskModal(index) {
            if (Number.isNaN(index)) {
                return;
            }
            const email = currentEmails[index];
            if (!email) {
                return;
            }

            // Populate customer autocomplete
            const populateCustomerAutocomplete = () => {
                if (!taskCustomerSelect) return;
                
                // Setup autocomplete
                setupAutocomplete('task-customer-select', 'task-customer-dropdown', 'task-customer-value', 'task-email');
                
                // Try to find and select matching customer
                const match = findCustomerByEmail(email.from || '');
                if (match) {
                    taskCustomerSelect.value = match.name || match.email_suffix || '';
                    const valueInput = document.getElementById('task-customer-value');
                    if (valueInput) {
                        valueInput.value = match.email_suffix || '';
                    }
                    // Auto-fill email
                    const storedEmail = (match.email_suffix || '').trim();
                    if (storedEmail.includes('@')) {
                        taskEmailInput.value = storedEmail;
                    } else {
                        taskEmailInput.value = extractEmailAddress(email.from || '');
                    }
                } else {
                    taskCustomerSelect.value = '';
                    const valueInput = document.getElementById('task-customer-value');
                    if (valueInput) {
                        valueInput.value = '';
                    }
                    taskEmailInput.value = extractEmailAddress(email.from || '');
                }
            };

            // Load customers if needed
            if (!customerCache || customerCache.length === 0) {
                loadCustomers(false).then(() => populateCustomerAutocomplete()).catch(() => {
                    populateCustomerAutocomplete();
                });
            } else {
                populateCustomerAutocomplete();
            }

            // Load task types for dropdown
            loadTaskTypesForDropdown();

            taskSequenceInput.value = email.sequence || 'N/A';
            // Set default value after types are loaded
            setTimeout(() => {
                if (taskTypesCache && taskTypesCache.length > 0) {
                    taskCatalogueSelect.value = taskTypesCache[0].name || '';
                }
            }, 100);
            
            // Clear rich text editor
            if (taskNotesEditor) {
                taskNotesEditor.setContents([]);
            }

            // Display attachments
            if (taskAttachmentsDiv) {
                if (Array.isArray(email.attachments) && email.attachments.length > 0) {
                    taskAttachmentsDiv.innerHTML = email.attachments.map((att, idx) => {
                        const contentType = att.content_type || 'application/octet-stream';
                        const isImage = contentType.startsWith('image/');
                        const isPDF = contentType === 'application/pdf' || (att.filename && att.filename.toLowerCase().endsWith('.pdf'));
                        const dataUrl = `data:${contentType};base64,${att.data}`;
                        const filename = escapeHtml(att.filename || `Attachment ${idx + 1}`);
                        const attachmentIndex = idx;
                        
                        return `
                            <div class="attachment-row" data-attachment-index="${idx}">
                                <div class="attachment-row-info">
                                    <strong>${filename}</strong>
                                    <span>${contentType} ‚Ä¢ ${formatAttachmentSize(att.size || 0)}</span>
                                </div>
                                <div class="attachment-actions">
                                    ${(isImage || isPDF) ? `<button class="form-button" onclick="openTaskAttachmentPreview(${attachmentIndex})" style="font-size: 12px;">View</button>` : ''}
                                    <a class="form-button" href="${dataUrl}" download="${escapeHtml(att.filename || `attachment-${idx + 1}`)}" style="font-size: 12px;">
                                        Download
                                    </a>
                                    <button class="form-button" onclick="removeTaskAttachment(${idx})" style="font-size: 12px; background-color: #dc3545; color: white;">X</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Store attachment data for preview and submission
                    if (!window.taskModalAttachments) {
                        window.taskModalAttachments = [];
                    }
                    window.taskModalAttachments = email.attachments;
                    window.taskModalEmailIndex = index;
                } else {
                    taskAttachmentsDiv.innerHTML = '<div style="padding: 10px; color: #666; font-style: italic;">No attachments</div>';
                }
            }

            taskModal.classList.remove('hidden');
        }

        function closeTaskModal() {
            taskModal.classList.add('hidden');
            // Clear attachments display
            if (taskAttachmentsDiv) {
                taskAttachmentsDiv.innerHTML = '';
            }
            window.taskModalAttachments = [];
            window.taskModalEmailIndex = null;
        }

        function removeTaskAttachment(index) {
            if (!window.taskModalAttachments || !window.taskModalAttachments[index]) {
                return;
            }
            
            // Remove attachment from array
            window.taskModalAttachments.splice(index, 1);
            
            // Re-render attachments list
            const email = currentEmails[window.taskModalEmailIndex];
            if (!email) return;
            
            if (taskAttachmentsDiv) {
                if (window.taskModalAttachments.length > 0) {
                    taskAttachmentsDiv.innerHTML = window.taskModalAttachments.map((att, idx) => {
                        const contentType = att.content_type || 'application/octet-stream';
                        const isImage = contentType.startsWith('image/');
                        const isPDF = contentType === 'application/pdf' || (att.filename && att.filename.toLowerCase().endsWith('.pdf'));
                        const dataUrl = `data:${contentType};base64,${att.data}`;
                        const filename = escapeHtml(att.filename || `Attachment ${idx + 1}`);
                        
                        return `
                            <div class="attachment-row" data-attachment-index="${idx}">
                                <div class="attachment-row-info">
                                    <strong>${filename}</strong>
                                    <span>${contentType} ‚Ä¢ ${formatAttachmentSize(att.size || 0)}</span>
                                </div>
                                <div class="attachment-actions">
                                    ${(isImage || isPDF) ? `<button class="form-button" onclick="openTaskAttachmentPreview(${idx})" style="font-size: 12px;">View</button>` : ''}
                                    <a class="form-button" href="${dataUrl}" download="${escapeHtml(att.filename || `attachment-${idx + 1}`)}" style="font-size: 12px;">
                                        Download
                                    </a>
                                    <button class="form-button" onclick="removeTaskAttachment(${idx})" style="font-size: 12px; background-color: #dc3545; color: white;">X</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    taskAttachmentsDiv.innerHTML = '<div style="padding: 10px; color: #666; font-style: italic;">No attachments</div>';
                }
            }
        }

        function submitTask() {
            const catalogue = taskCatalogueSelect.value;
            // Get content from Quill editor
            let template = '';
            if (taskNotesEditor) {
                const delta = taskNotesEditor.getContents();
                template = taskNotesEditor.root.innerHTML;
            }
            const sequence = taskSequenceInput.value;
            const customerValueInput = document.getElementById('task-customer-value');
            const customerEmailSuffix = customerValueInput ? customerValueInput.value : '';
            const customer = taskCustomerSelect ? taskCustomerSelect.value : '';
            const email = taskEmailInput.value;
            
            // Validate required fields
            if (!catalogue || catalogue === '') {
                alert('Please select a Type');
                return;
            }
            
            if (!template || template.trim() === '' || template === '<p><br></p>') {
                alert('Please enter Template content');
                return;
            }
            
            // Prepare task data
            const taskData = {
                sequence: sequence,
                customer: customer,
                email: email,
                catalogue: catalogue,
                template: template,
                attachments: window.taskModalAttachments || []
            };
            
            // Save to database
            fetch('/api/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(taskData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error saving task: ' + data.error);
                } else {
                    alert('Task saved successfully!');
                    closeTaskModal();
                    // Refresh task list if it's displayed
                    if (document.getElementById('task-list-content') && !document.getElementById('task-list-content').classList.contains('hidden')) {
                        loadTaskList();
                    }
                }
            })
            .catch(error => {
                alert('Error saving task: ' + error.message);
            });
        }

        function showTaskList(event) {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('send-mail-content').classList.add('hidden');
            document.getElementById('create-customer-content').classList.add('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('task-list-content').classList.remove('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('dropdown-list-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Task List';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            } else if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            loadTaskList();
        }

        function loadTaskList() {
            const container = document.getElementById('task-list-container');
            if (!container) return;

            container.innerHTML = '<div class="loading">Loading tasks...</div>';

            fetch('/api/tasks')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        container.innerHTML = `<div class="message error">Error: ${escapeHtml(data.error)}</div>`;
                    } else {
                        const tasks = data.tasks || [];
                        window.taskListCache = tasks;
                        if (tasks.length === 0) {
                            container.innerHTML = '<div class="message info">No tasks found.</div>';
                        } else {
                            const tableHtml = `
                                <div style="margin-bottom: 10px; font-family: Arial, sans-serif; font-size: 14px;">
                                    <strong>Filters:</strong> type to filter rows
                                </div>
                                <table class="customer-table task-table">
                                    <thead>
                                        <tr>
                                            <th>Sequence</th>
                                            <th>Customer</th>
                                            <th>Email</th>
                                            <th>Type</th>
                                            <th>Template</th>
                                            <th>Created At</th>
                                            <th>Attachments</th>
                                            <th>Delete</th>
                                        </tr>
                                        <tr>
                                            <th><input type="text" class="task-filter-input" data-field="sequence" placeholder="Filter sequence"></th>
                                            <th><input type="text" class="task-filter-input" data-field="customer" placeholder="Filter customer"></th>
                                            <th><input type="text" class="task-filter-input" data-field="email" placeholder="Filter email"></th>
                                            <th><input type="text" class="task-filter-input" data-field="catalogue" placeholder="Filter type"></th>
                                            <th><input type="text" class="task-filter-input" data-field="template" placeholder="Filter template"></th>
                                            <th><input type="text" class="task-filter-input" data-field="created_at" placeholder="Filter date"></th>
                                            <th><input type="text" class="task-filter-input" data-field="attachments" placeholder="Filter attachments"></th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="task-table-body">
                                        ${tasks.map(task => {
                                            const attachmentsText = (task.attachments || []).map(att => att.filename || 'attachment').join(', ');
                                            return `
                                                <tr
                                                    data-sequence="${escapeHtml(task.sequence || '')}"
                                                    data-customer="${escapeHtml(task.customer || '')}"
                                                    data-email="${escapeHtml(task.email || '')}"
                                                    data-catalogue="${escapeHtml(task.catalogue || '')}"
                                                    data-template="${escapeHtml(task.template || '')}"
                                                    data-created_at="${escapeHtml(task.created_at || '')}"
                                                    data-attachments="${escapeHtml(attachmentsText)}"
                                                >
                                                    <td>${escapeHtml(task.sequence || '')}</td>
                                                    <td>${escapeHtml(task.customer || '')}</td>
                                                    <td>${escapeHtml(task.email || '')}</td>
                                                    <td>${escapeHtml(task.catalogue || '')}</td>
                                                    <td class="task-template-cell" title="${escapeHtml(task.template || '')}">
                                                        ${task.template || ''}
                                                    </td>
                                                    <td>${escapeHtml(task.created_at || '')}</td>
                                                    <td>${renderTaskAttachments(task)}</td>
                                                    <td>
                                                        <button class="form-button" onclick="deleteTask(${task.id})" style="font-size: 12px; padding: 5px 10px;">Delete</button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            `;
                            container.innerHTML = tableHtml;

                            // Attach filter handlers
                            const filterInputs = container.querySelectorAll('.task-filter-input');
                            filterInputs.forEach(input => {
                                input.addEventListener('input', applyTaskTableFilters);
                            });
                        }
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="message error">Error loading tasks: ${escapeHtml(error.message)}</div>`;
                });
        }

        function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }
            
            fetch(`/api/tasks/${taskId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error deleting task: ' + data.error);
                } else {
                    // Reload task list
                    loadTaskList();
                }
            })
            .catch(error => {
                alert('Error deleting task: ' + error.message);
            });
        }

        function applyTaskTableFilters() {
            const container = document.getElementById('task-list-container');
            const tbody = container ? container.querySelector('#task-table-body') : null;
            if (!tbody) return;

            const filters = {};
            const filterInputs = container.querySelectorAll('.task-filter-input');
            filterInputs.forEach(input => {
                const field = input.dataset.field;
                const value = (input.value || '').trim().toLowerCase();
                if (field) {
                    filters[field] = value;
                }
            });

            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.forEach(row => {
                let visible = true;
                for (const [field, value] of Object.entries(filters)) {
                    if (!value) continue;
                    const dataValue = (row.dataset[field] || '').toLowerCase();
                    if (!dataValue.includes(value)) {
                        visible = false;
                        break;
                    }
                }
                row.style.display = visible ? '' : 'none';
            });
        }

        function isImageContent(filename, contentType) {
            const name = (filename || '').toLowerCase();
            const type = (contentType || '').toLowerCase();
            return type.startsWith('image/') || /\.(png|jpe?g|gif|bmp|webp|svg)$/.test(name);
        }

        function isPDFContent(filename, contentType) {
            const name = (filename || '').toLowerCase();
            const type = (contentType || '').toLowerCase();
            return type.includes('pdf') || name.endsWith('.pdf');
        }

        function isTextContent(filename, contentType) {
            const name = (filename || '').toLowerCase();
            const type = (contentType || '').toLowerCase();
            return type.startsWith('text/') || /\.(txt|text|log|md|markdown|json|xml|html|htm|css|js|ts|py|java|cpp|c|h|sh|bat|cmd)$/.test(name);
        }

        function renderTaskAttachments(task) {
            const attachments = task.attachments || [];
            if (attachments.length === 0) {
                return '';
            }
            return attachments.map((att, idx) => {
                const filename = escapeHtml(att.filename || 'attachment');
                const contentType = att.content_type || 'application/octet-stream';
                const isImage = isImageContent(att.filename, contentType);
                const isPDF = isPDFContent(att.filename, contentType);
                const isText = isTextContent(att.filename, contentType);
                const isViewable = Boolean(isImage || isPDF || isText);
                const viewLink = isViewable
                    ? `<span class="attachment-view-link" onclick="openTaskListAttachment(${task.id}, ${idx})" style="text-decoration: underline; cursor: pointer; color: #0066cc;">${filename}</span>`
                    : `<span>${filename}</span>`;
                const downloadLink = `<a class="attachment-download-link" href="data:${contentType};base64,${att.data}" download="${escapeHtml(att.filename || `attachment-${idx + 1}`)}">üìé</a>`;
                return `
                    <div class="task-attachment-entry">
                        ${viewLink}
                        ${downloadLink}
                    </div>
                `;
            }).join('');
        }

        function openTaskListAttachment(taskId, attachmentIndex) {
            const tasks = window.taskListCache || [];
            const task = tasks.find(t => t.id === taskId);
            if (!task) {
                return;
            }
            const attachments = task.attachments || [];
            const att = attachments[attachmentIndex];
            if (!att) {
                return;
            }
            const contentType = att.content_type || 'application/octet-stream';
            const filename = att.filename || `Attachment ${attachmentIndex + 1}`;
            openPreviewModal(att.data || '', contentType, filename);
        }

        function openCustomerAttachment(customerId, attachmentIndex) {
            const customers = customerCache || [];
            const customer = customers.find(c => c.id === customerId);
            if (!customer || !customer.attachments) {
                return;
            }
            let attachments;
            try {
                attachments = JSON.parse(customer.attachments) || [];
            } catch (e) {
                console.error('Error parsing customer attachments for preview:', e);
                return;
            }
            const att = attachments[attachmentIndex];
            if (!att) {
                return;
            }
            const contentType = att.content_type || 'application/octet-stream';
            const filename = att.filename || `Attachment ${attachmentIndex + 1}`;
            openPreviewModal(att.data || '', contentType, filename);
        }

        function openTaskAttachmentPreview(attachmentIndex) {
            if (!window.taskModalAttachments || !window.taskModalAttachments[attachmentIndex]) {
                return;
            }
            
            const att = window.taskModalAttachments[attachmentIndex];
            const contentType = att.content_type || 'application/octet-stream';
            const filename = att.filename || `Attachment ${attachmentIndex + 1}`;
            
            openPreviewModal(att.data || '', contentType, filename);
        }

        function revokePreviewObjectUrl() {
            if (window.currentPreviewObjectUrl) {
                try {
                    URL.revokeObjectURL(window.currentPreviewObjectUrl);
                } catch (err) {
                    console.warn('Error revoking preview URL:', err);
                }
                window.currentPreviewObjectUrl = null;
            }
        }

        function createObjectUrlFromBase64(base64Data, contentType) {
            try {
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: contentType || 'application/octet-stream' });
                return URL.createObjectURL(blob);
            } catch (error) {
                console.warn('Failed to convert base64 to object URL:', error);
                return null;
            }
        }

        function openPreviewModal(base64Data, contentType, filename) {
            if (!previewModal || !previewModalContent || !previewModalTitle) {
                return;
            }

            revokePreviewObjectUrl();
            
            const isImage = isImageContent(filename, contentType);
            const isPDF = isPDFContent(filename, contentType);
            const isText = isTextContent(filename, contentType);
            
            previewModalTitle.textContent = filename || 'Preview';
            
            let previewContent = '';
            const dataUrl = `data:${contentType};base64,${base64Data}`;
            if (isImage) {
                previewContent = `<img src="${dataUrl}" alt="${escapeHtml(filename || 'image')}" id="preview-image">`;
            } else if (isPDF) {
                const pdfContentType = contentType && contentType.toLowerCase().includes('pdf')
                    ? contentType
                    : 'application/pdf';
                const objectUrl = createObjectUrlFromBase64(base64Data, pdfContentType);
                if (objectUrl) {
                    window.currentPreviewObjectUrl = objectUrl;
                    previewContent = `<iframe src="${objectUrl}" type="${pdfContentType}" style="width: 100%; height: 100%; border: none; display: block; position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></iframe>`;
                } else {
                    previewContent = `<p>Unable to preview PDF. <a href="${dataUrl}" download="${escapeHtml(filename || 'document.pdf')}">Download PDF</a></p>`;
                }
            } else if (isText) {
                try {
                    // Decode base64 text content
                    const textContent = atob(base64Data);
                    // Escape HTML but preserve line breaks
                    const escapedText = escapeHtml(textContent).replace(/\n/g, '<br>').replace(/\r/g, '');
                    previewContent = `<pre style="white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace; padding: 15px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; max-height: 80vh; overflow: auto; margin: 0;">${escapedText}</pre>`;
                } catch (error) {
                    console.warn('Failed to decode text content:', error);
                    previewContent = `<p>Unable to preview text file. <a href="${dataUrl}" download="${escapeHtml(filename)}">Download file</a></p>`;
                }
            } else {
                previewContent = `<p>Preview not available for this file type. <a href="${dataUrl}" download="${escapeHtml(filename)}">Download file</a></p>`;
            }
            
            previewModalContent.innerHTML = previewContent;
            
            // Set container style based on content type
            if (isImage) {
                previewModalContent.style.alignItems = 'center';
                previewModalContent.style.justifyContent = 'center';
                previewModalContent.style.overflow = 'auto';
                previewModalContent.style.cursor = 'grab';
                initImageDrag();
            } else if (isPDF) {
                previewModalContent.style.alignItems = 'stretch';
                previewModalContent.style.justifyContent = 'stretch';
                previewModalContent.style.overflow = 'hidden';
                previewModalContent.style.cursor = 'default';
                previewModalContent.style.position = 'relative';
                previewModalContent.style.width = '100%';
                previewModalContent.style.height = '100%';
            } else if (isText) {
                previewModalContent.style.alignItems = 'flex-start';
                previewModalContent.style.justifyContent = 'flex-start';
                previewModalContent.style.overflow = 'auto';
                previewModalContent.style.cursor = 'default';
                previewModalContent.style.padding = '20px';
            } else {
                previewModalContent.style.alignItems = 'center';
                previewModalContent.style.justifyContent = 'center';
                previewModalContent.style.overflow = 'auto';
                previewModalContent.style.cursor = 'default';
            }
            
            previewModal.classList.remove('hidden');
        }

        function initImageDrag() {
            const img = document.getElementById('preview-image');
            const container = previewModalContent;
            if (!img || !container) return;
            
            let isDragging = false;
            let startX, startY;
            let imgX = 0, imgY = 0;
            let scale = 1;
            
            // Reset image position and scale
            img.style.transform = 'translate(0, 0) scale(1)';
            img.style.position = 'relative';
            img.style.display = 'block';
            img.style.margin = 'auto';
            container.style.overflow = 'auto';
            imgX = 0;
            imgY = 0;
            scale = 1;
            
            // Mouse events
            img.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return; // Only left mouse button
                isDragging = true;
                img.classList.add('dragging');
                startX = e.pageX - imgX;
                startY = e.pageY - imgY;
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                imgX = e.pageX - startX;
                imgY = e.pageY - startY;
                img.style.transform = `translate(${imgX}px, ${imgY}px) scale(${scale})`;
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    img.classList.remove('dragging');
                }
            });
            
            // Touch events for mobile
            img.addEventListener('touchstart', (e) => {
                if (e.touches.length !== 1) return;
                isDragging = true;
                img.classList.add('dragging');
                const touch = e.touches[0];
                startX = touch.pageX - imgX;
                startY = touch.pageY - imgY;
                e.preventDefault();
            });
            
            document.addEventListener('touchmove', (e) => {
                if (!isDragging || e.touches.length !== 1) return;
                const touch = e.touches[0];
                imgX = touch.pageX - startX;
                imgY = touch.pageY - startY;
                img.style.transform = `translate(${imgX}px, ${imgY}px) scale(${scale})`;
                e.preventDefault();
            });
            
            document.addEventListener('touchend', () => {
                if (isDragging) {
                    isDragging = false;
                    img.classList.remove('dragging');
                }
            });
            
            // Zoom with mouse wheel
            img.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                scale = Math.max(0.5, Math.min(5, scale * delta));
                img.style.transform = `translate(${imgX}px, ${imgY}px) scale(${scale})`;
            }, { passive: false });
            
            // Double click to reset
            img.addEventListener('dblclick', () => {
                imgX = 0;
                imgY = 0;
                scale = 1;
                img.style.transform = 'translate(0, 0) scale(1)';
            });
        }

        function closePreviewModal() {
            if (previewModal) {
                previewModal.classList.add('hidden');
            }
            if (previewModalContent) {
                previewModalContent.innerHTML = '';
            }
            revokePreviewObjectUrl();
        }

        function formatText(command) {
            document.execCommand(command, false, null);
            const remarkDiv = document.getElementById('customer-remark');
            if (remarkDiv) {
                remarkDiv.focus();
            }
        }

        // Country dropdown functions
        function filterCountries() {
            const input = document.getElementById('customer-country');
            const dropdown = document.getElementById('country-dropdown');
            if (!input || !dropdown) return;
            
            const searchTerm = input.value.toLowerCase().trim();
            const filtered = COUNTRIES.filter(country => 
                country.toLowerCase().includes(searchTerm)
            ).slice(0, 10); // Show max 10 results
            
            if (filtered.length === 0 || searchTerm === '') {
                dropdown.classList.add('hidden');
                return;
            }
            
            dropdown.innerHTML = filtered.map(country => 
                `<div class="country-dropdown-item" onclick="selectCountry('${country.replace(/'/g, "\\'")}')">${escapeHtml(country)}</div>`
            ).join('');
            dropdown.classList.remove('hidden');
        }

        function showCountryDropdown() {
            const input = document.getElementById('customer-country');
            const dropdown = document.getElementById('country-dropdown');
            if (!input || !dropdown) return;
            
            if (input.value.trim() === '') {
                const topCountries = COUNTRIES.slice(0, 10);
                dropdown.innerHTML = topCountries.map(country => 
                    `<div class="country-dropdown-item" onclick="selectCountry('${country.replace(/'/g, "\\'")}')">${escapeHtml(country)}</div>`
                ).join('');
                dropdown.classList.remove('hidden');
            } else {
                filterCountries();
            }
        }

        function hideCountryDropdown() {
            const dropdown = document.getElementById('country-dropdown');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
        }

        function selectCountry(country) {
            const input = document.getElementById('customer-country');
            if (input) {
                input.value = country;
            }
            hideCountryDropdown();
        }

        // Attachment handling functions
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            const dropArea = document.getElementById('customer-attachment-area');
            if (dropArea) {
                dropArea.classList.add('drag-over');
            }
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            const dropArea = document.getElementById('customer-attachment-area');
            if (dropArea) {
                dropArea.classList.remove('drag-over');
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            const dropArea = document.getElementById('customer-attachment-area');
            if (dropArea) {
                dropArea.classList.remove('drag-over');
            }
            
            const files = event.dataTransfer.files;
            addAttachments(Array.from(files));
        }

        function handleAttachmentSelect(event) {
            const files = event.target.files;
            if (files && files.length > 0) {
                addAttachments(Array.from(files));
            }
        }

        function addAttachments(files) {
            files.forEach(file => {
                // Check if file already exists
                if (customerAttachments.some(att => att.name === file.name && att.size === file.size)) {
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Data = e.target.result.split(',')[1]; // Remove data:type;base64, prefix
                    customerAttachments.push({
                        filename: file.name,
                        size: file.size,
                        content_type: file.type || 'application/octet-stream',
                        data: base64Data
                    });
                    updateAttachmentList();
                };
                reader.readAsDataURL(file);
            });
        }

        function removeAttachment(index) {
            customerAttachments.splice(index, 1);
            updateAttachmentList();
        }

        function updateAttachmentList() {
            const listDiv = document.getElementById('customer-attachment-list');
            if (!listDiv) return;
            
            if (customerAttachments.length === 0) {
                listDiv.innerHTML = '';
                return;
            }
            
            listDiv.innerHTML = customerAttachments.map((att, index) => {
                const sizeStr = formatAttachmentSize(att.size);
                return `
                    <div class="attachment-item">
                        <span class="attachment-item-name">üìé ${escapeHtml(att.filename)}</span>
                        <span class="attachment-item-size">${sizeStr}</span>
                        <span class="attachment-item-remove" onclick="removeAttachment(${index})" title="Remove">‚úï</span>
                    </div>
                `;
            }).join('');
        }

        function formatAttachmentSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function saveCustomer() {
            const nameInput = document.getElementById('customer-name');
            const companyInput = document.getElementById('company-name');
            const emailInput = document.getElementById('customer-email-address');
            const countryInput = document.getElementById('customer-country');
            const websiteInput = document.getElementById('customer-website');
            const remarkDiv = document.getElementById('customer-remark');
            
            const name = (nameInput.value || '').trim();
            const companyName = (companyInput && companyInput.value || '').trim();
            const emailAddress = (emailInput.value || '').trim();
            const country = (countryInput.value || '').trim();
            const website = (websiteInput.value || '').trim();
            const remark = remarkDiv ? remarkDiv.innerHTML.trim() : '';

            if (!name) {
                showCustomerStatus('Customer name is required.', true);
                return;
            }
            if (!emailAddress) {
                showCustomerStatus('Please enter an email address.', true);
                return;
            }
            
            // Email validation regex
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailRegex.test(emailAddress)) {
                showCustomerStatus('Please enter a valid email address (e.g. customer@example.com).', true);
                return;
            }

            // Website validation (optional, but if provided, should be valid URL)
            if (website && website.trim() !== '' && !website.match(/^https?:\/\/.+/)) {
                showCustomerStatus('Please enter a valid website URL (e.g. https://example.com) or leave it empty.', true);
                return;
            }

            showCustomerStatus('Saving customer...', false, 'info');

            fetch('/api/customers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name,
                    email_address: emailAddress,
                    country: country || null,
                    website: website && website.trim() !== '' ? website : null,
                    remark: remark || null,
                    attachments: customerAttachments.length > 0 ? JSON.stringify(customerAttachments) : null,
                    company_name: companyName || null
                })
            })
                .then(async response => {
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to save customer');
                    }
                    nameInput.value = '';
                    if (companyInput) companyInput.value = '';
                    emailInput.value = '';
                    if (countryInput) countryInput.value = '';
                    if (websiteInput) websiteInput.value = '';
                    if (remarkDiv) remarkDiv.innerHTML = '';
                    customerAttachments = [];
                    updateAttachmentList();
                    const attachmentInput = document.getElementById('customer-attachment-input');
                    if (attachmentInput) attachmentInput.value = '';
                    showCustomerStatus('Customer saved.', false);
                    loadCustomers(false);
                })
                .catch(error => {
                    showCustomerStatus(`Error: ${error.message}`, true);
                });
        }

        function showCustomerStatus(message, isError = false, statusType = 'auto') {
            if (!customerStatusDiv) return;
            let messageClass = 'info';
            if (statusType === 'auto') {
                messageClass = isError ? 'error' : 'success';
            } else {
                messageClass = statusType;
            }
            customerStatusDiv.textContent = message;
            customerStatusDiv.className = `message ${messageClass}`;
            customerStatusDiv.classList.remove('hidden');
            setTimeout(() => {
                customerStatusDiv.classList.add('hidden');
            }, 3000);
        }

        function deleteCustomer(customerId, customerName) {
            if (!confirm(`Are you sure you want to delete customer "${customerName}"?`)) {
                return;
            }

            showCustomerStatus('Deleting customer...', false, 'info');

            fetch(`/api/customers/${customerId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(async response => {
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to delete customer');
                    }
                    showCustomerStatus('Customer deleted successfully.', false);
                    // Remove from cache
                    if (customerCache) {
                        customerCache = customerCache.filter(c => c.id !== customerId);
                    }
                    // Reload customer list
                    loadCustomers(false);
                })
                .catch(error => {
                    showCustomerStatus(`Error: ${error.message}`, true);
                });
        }

        function renderCustomers(customers) {
            if (!customerListSection || !customerTableBody || !customerEmptyMessage) {
                return;
            }
            customerCache = customers;
            customerTableBody.innerHTML = '';
            if (!customers || customers.length === 0) {
                customerEmptyMessage.classList.remove('hidden');
                customerListSection.classList.remove('hidden');
                return;
            }
            customerEmptyMessage.classList.add('hidden');
            const rows = customers.map(customer => {
                const country = customer.country || '';
                const website = customer.website || '';
                const remark = customer.remark || '';
                const websiteLink = website ? (website.startsWith('http') ? website : `https://${website}`) : '';
                
                // Parse attachments
                let attachmentsHtml = '';
                try {
                    if (customer.attachments) {
                        const attachments = JSON.parse(customer.attachments);
                        if (Array.isArray(attachments) && attachments.length > 0) {
                            attachmentsHtml = attachments.map((att, idx) => {
                                const filename = att.filename || 'attachment';
                                const safeFilename = escapeHtml(filename);
                                const sizeStr = formatAttachmentSize(att.size || 0);
                                const contentType = att.content_type || 'application/octet-stream';
                                const dataUrl = `data:${contentType};base64,${att.data}`;
                                const isImage = isImageContent(att.filename, contentType);
                                const isPDF = isPDFContent(att.filename, contentType);
                                const isText = isTextContent(att.filename, contentType);
                                const isViewable = Boolean(isImage || isPDF || isText);

                                const labelHtml = `
                                    <div class="attachment-filename">üìé ${safeFilename}</div>
                                    <div class="attachment-size">${sizeStr}</div>
                                `;

                                const viewHtml = isViewable
                                    ? `<div class="attachment-view-link" onclick="openCustomerAttachment(${customer.id}, ${idx})" style="font-size: 11px;">${labelHtml}</div>`
                                    : `<div style="font-size: 11px;">${labelHtml}</div>`;

                                const downloadLink = `<a class="attachment-download-link" href="${dataUrl}" download="${escapeHtml(att.filename || 'attachment')}" style="margin-left: 4px; font-size: 14px; text-decoration: none;" title="Download ${safeFilename}">‚¨á</a>`;

                                return `<div class="task-attachment-entry">${viewHtml}${downloadLink}</div>`;
                            }).join('');
                        }
                    }
                } catch (e) {
                    console.error('Error parsing attachments:', e);
                }
                
                return `
                <tr>
                    <td>${escapeHtml(customer.name || '')}</td>
                    <td>${escapeHtml(customer.email_suffix || '')}</td>
                    <td>${escapeHtml(country)}</td>
                    <td>${websiteLink ? `<a href="${escapeHtml(websiteLink)}" target="_blank" rel="noopener noreferrer">${escapeHtml(website)}</a>` : ''}</td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${remark}</td>
                    <td style="max-width: 150px; font-size: 11px;">${attachmentsHtml || '-'}</td>
                    <td>${escapeHtml(customer.created_at ? new Date(customer.created_at).toLocaleString() : '')}</td>
                    <td>
                        <button class="form-button" onclick="deleteCustomer(${customer.id}, '${escapeHtml(customer.name || '')}')" style="padding: 5px 10px; font-size: 12px; cursor: pointer;">Delete</button>
                    </td>
                </tr>
            `;
            }).join('');
            customerTableBody.innerHTML = rows;
            customerListSection.classList.remove('hidden');
        }

        function loadCustomers(showStatus = false) {
            if (!customerListSection) return Promise.resolve([]);
            if (showStatus) {
                showCustomerStatus('Loading customers...', false, 'info');
            }
            return fetch('/api/customers')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    renderCustomers(data.customers || []);
                    return customerCache;
                })
                .catch(error => {
                    showCustomerStatus(`Error: ${error.message}`, true);
                    customerCache = [];
                    return [];
                });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

