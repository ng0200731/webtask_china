<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Receiver - v{{ version }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            color: #000000;
            background-color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .left-menu {
            width: 60px;
            background-color: #ffffff;
            border-right: 2px solid #000000;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: width 0.2s ease;
            overflow: hidden;
        }

        .left-menu:hover {
            width: 220px;
        }

        .menu-button {
            width: 100%;
            padding: 15px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-family: Arial, sans-serif;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
        }

        .menu-button:hover {
            background-color: #f0f0f0;
        }

        .menu-button.active {
            background-color: #000000;
            color: #ffffff;
        }

        .right-content {
            flex: 1;
            background-color: #ffffff;
            padding: 20px;
            overflow-y: auto;
        }

        .content-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000000;
        }

        .content-header h2 {
            font-family: Arial, sans-serif;
            font-size: 24px;
            color: #000000;
            margin-bottom: 5px;
        }

        .version-info {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #000000;
        }

        .email-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .email-item {
            border: 1px solid #000000;
            padding: 15px;
            background-color: #ffffff;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .email-item:hover {
            background-color: #f0f0f0;
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .email-subject {
            font-family: Arial, sans-serif;
            font-size: 18px;
            font-weight: bold;
            color: #000000;
        }

        .email-date {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #000000;
        }

        .email-from {
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
            margin-bottom: 5px;
        }

        .email-preview {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #000000;
            margin-top: 10px;
            max-height: 60px;
            overflow: hidden;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
        }

        .error {
            padding: 15px;
            border: 2px solid #000000;
            background-color: #ffffff;
            color: #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .qq-login-form {
            border: 1px solid #000000;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        .qq-login-form h3 {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #000000;
            background-color: #ffffff;
            color: #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }

        .form-button {
            padding: 10px 20px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            cursor: pointer;
        }

        .form-button:hover {
            background-color: #f0f0f0;
        }

        .hidden {
            display: none;
        }

        .settings-section {
            border: 1px solid #000000;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        .profile-list-view {
            border: 1px solid #000000;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        .profile-list-view h3 {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
            margin-bottom: 15px;
            border-bottom: 1px solid #000000;
            padding-bottom: 10px;
        }

        .profile-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-controls input[type="text"] {
            padding: 10px;
            border: 1px solid #000000;
            background-color: #ffffff;
            color: #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            flex: 1;
        }

        .profile-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .profile-item {
            border: 1px solid #000000;
            padding: 15px;
            background-color: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-item.active {
            background-color: #f0f0f0;
        }

        .profile-item-name {
            font-family: Arial, sans-serif;
            font-size: 16px;
            color: #000000;
        }

        .profile-detail-view {
            border: 1px solid #000000;
            padding: 20px;
            background-color: #ffffff;
        }

        .profile-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-button {
            padding: 10px 20px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            cursor: pointer;
        }

        .back-button:hover {
            background-color: #f0f0f0;
        }

        .profile-detail-title {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
        }

        .profile-detail-actions {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .form-button.danger {
            border-color: #000000;
            color: #000000;
        }

        .message {
            margin-top: 10px;
            padding: 12px;
            border: 1px solid #000000;
            background-color: #f5f5f5;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
        .message.error {
            background-color: #f5dada;
        }
        .message.success {
            background-color: #d8f5d8;
        }
        .message.info {
            background-color: #e8e8e8;
        }

        /* Collapsed vs expanded labels */
        .label-short {
            font-weight: bold;
            width: 24px;
            min-width: 24px;
            text-align: center;
        }
        .label-full {
            white-space: nowrap;
        }
        .left-menu .label-full {
            display: none;
        }
        .left-menu:hover .label-full {
            display: inline;
        }
        .left-menu:hover .menu-button {
            justify-content: flex-start;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.4);
            padding: 40px;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-dialog {
            width: 80vw;
            max-width: 1000px;
            height: 80vh;
            background-color: #ffffff;
            border: 2px solid #000000;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 2px solid #000000;
        }

        .modal-title {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #000000;
        }

        .modal-meta {
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #000000;
            margin-top: 5px;
            white-space: pre-line;
        }

        .modal-close {
            padding: 8px 16px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            cursor: pointer;
        }

        .modal-close:hover {
            background-color: #f0f0f0;
        }

        .modal-body {
            flex: 1;
            overflow: hidden;
        }

        .modal-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background-color: #ffffff;
        }

        .email-compose {
            border: 1px solid #000000;
            padding: 20px;
            background-color: #ffffff;
            margin-bottom: 25px;
        }

        .email-compose h3 {
            font-family: Arial, sans-serif;
            font-size: 18px;
            margin-bottom: 15px;
            color: #000000;
        }

        .compose-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .compose-grid .form-group {
            flex: 1;
            min-width: 200px;
        }

        .email-compose textarea {
            width: 100%;
            min-height: 160px;
            border: 1px solid #000000;
            padding: 10px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000000;
            background-color: #ffffff;
            margin-top: 10px;
        }

        .compose-options {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .compose-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-menu">
            <button class="menu-button active" onclick="showReceiveMail()">
                <span class="label-short">R</span>
                <span class="label-full">Receive Mail</span>
            </button>
            <button class="menu-button" onclick="showTask()">
                <span class="label-short">T</span>
                <span class="label-full">Task</span>
            </button>
            <button class="menu-button" onclick="showSettings()">
                <span class="label-short">S</span>
                <span class="label-full">Settings</span>
            </button>
        </div>
        <div class="right-content">
            <div class="content-header">
                <h2 id="content-title">Receive Mail</h2>
                <div class="version-info">Version: <span id="version">v{{ version }}</span></div>
            </div>
            <div id="receive-mail-content">
                <div class="email-compose">
                    <h3>Send Email (SMTP)</h3>
                    <div class="compose-grid">
                        <div class="form-group">
                            <label for="compose-to">To:</label>
                            <input type="text" id="compose-to" placeholder="recipient@example.com">
                        </div>
                        <div class="form-group">
                            <label for="compose-subject">Subject:</label>
                            <input type="text" id="compose-subject" placeholder="Subject line">
                        </div>
                        <div class="form-group">
                            <label for="compose-sender-name">Sender Name (optional):</label>
                            <input type="text" id="compose-sender-name" placeholder="Mail Task">
                        </div>
                    </div>
                    <textarea id="compose-body" placeholder="Write your email content here..."></textarea>
                    <div class="compose-options">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="compose-is-html">
                            <span>Send as HTML</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="use-primary-smtp" checked>
                            <span>Use Primary SMTP</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="use-backup-smtp" checked>
                            <span>Use Backup SMTP</span>
                        </label>
                    </div>
                    <div class="compose-actions">
                        <button class="form-button" onclick="sendEmail()">Send Email</button>
                        <div id="send-email-status" class="message info hidden"></div>
                    </div>
                </div>
                <button class="form-button" onclick="fetchGmailEmails()" style="margin-bottom: 20px; margin-right: 10px;">Fetch Gmail</button>
                <button class="form-button" onclick="fetch163Emails()" style="margin-bottom: 20px; margin-right: 10px;">Fetch 163.com</button>
                <button class="form-button" onclick="fetchQQEmails()" style="margin-bottom: 20px;">Fetch QQ Email</button>
                <div id="error-message" class="message hidden"></div>
                <div id="email-list" class="email-list"></div>
            </div>
            <div id="task-content" class="hidden">
                <p style="font-family: Arial, sans-serif; font-size: 14px; color: #000000;">Task feature is pending.</p>
            </div>
            <div id="settings-content" class="hidden">
                <div id="profile-list-view" class="profile-list-view">
                    <h3>Profile Management</h3>
                    <div class="profile-controls">
                        <input type="text" id="new-profile-name" placeholder="New profile name">
                        <button class="form-button" onclick="createProfile()">Create Profile</button>
                    </div>
                    <div id="profile-list" class="profile-list"></div>
                </div>
                <div id="profile-detail-view" class="profile-detail-view hidden">
                    <div class="profile-detail-header">
                        <button class="back-button" onclick="showProfileList()">Back</button>
                        <div class="profile-detail-title">Profile: <span id="profile-name-display"></span></div>
                        <div style="width: 120px;"></div>
                    </div>
                    <div class="settings-section">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">Gmail Configuration</h3>
                        <div class="form-group">
                            <label for="gmail-imap-server">IMAP Server:</label>
                            <input type="text" id="gmail-imap-server" placeholder="imap.gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="gmail-port">Port:</label>
                            <input type="number" id="gmail-port" placeholder="993">
                        </div>
                        <div class="form-group">
                            <label for="gmail-username">Username:</label>
                            <input type="text" id="gmail-username" placeholder="your-email@gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="gmail-password">App Password:</label>
                            <input type="password" id="gmail-password" placeholder="Enter app password">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="gmail-use-ssl" checked>
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="gmail-use-tls">
                                <span>Use TLS</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top: 30px;">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">163.com Configuration</h3>
                        <div class="form-group">
                            <label for="163-imap-server">IMAP Server:</label>
                            <input type="text" id="163-imap-server" placeholder="imap.163.com">
                        </div>
                        <div class="form-group">
                            <label for="163-port">Port:</label>
                            <input type="number" id="163-port" placeholder="993">
                        </div>
                        <div class="form-group">
                            <label for="163-username">Username:</label>
                            <input type="text" id="163-username" placeholder="your-email@163.com">
                        </div>
                        <div class="form-group">
                            <label for="163-password">Authorization Code:</label>
                            <input type="password" id="163-password" placeholder="Enter authorization code">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="163-use-ssl" checked>
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="163-use-tls">
                                <span>Use TLS</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top: 30px;">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">QQ Email Configuration</h3>
                        <div class="form-group">
                            <label for="qq-imap-server">IMAP Server:</label>
                            <input type="text" id="qq-imap-server" placeholder="imap.qq.com">
                        </div>
                        <div class="form-group">
                            <label for="qq-port">Port:</label>
                            <input type="number" id="qq-port" placeholder="993">
                        </div>
                        <div class="form-group">
                            <label for="qq-username">Username:</label>
                            <input type="text" id="qq-username" placeholder="your-email@qq.com">
                        </div>
                        <div class="form-group">
                            <label for="qq-password">Authorization Code:</label>
                            <input type="password" id="qq-password" placeholder="Enter authorization code">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="qq-use-ssl" checked>
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="qq-use-tls">
                                <span>Use TLS</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top: 30px;">
                        <h3 style="font-family: Arial, sans-serif; font-size: 18px; color: #000000; margin-bottom: 15px; border-bottom: 1px solid #000000; padding-bottom: 10px;">SMTP Configuration</h3>
                        <div class="form-group">
                            <label for="smtp-sender-name">Default Sender Name:</label>
                            <input type="text" id="smtp-sender-name" placeholder="Mail Task">
                        </div>
                        <div class="form-group">
                            <strong style="font-family: Arial, sans-serif; font-size: 14px;">Primary SMTP (Gmail)</strong>
                        </div>
                        <div class="form-group">
                            <label for="smtp-primary-server">Server:</label>
                            <input type="text" id="smtp-primary-server" placeholder="smtp.gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="smtp-primary-port">Port:</label>
                            <input type="number" id="smtp-primary-port" placeholder="587">
                        </div>
                        <div class="form-group">
                            <label for="smtp-primary-username">Username:</label>
                            <input type="text" id="smtp-primary-username" placeholder="your-email@gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="smtp-primary-password">App Password:</label>
                            <input type="password" id="smtp-primary-password" placeholder="Enter app password">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="smtp-primary-use-ssl">
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="smtp-primary-use-tls" checked>
                                <span>Use TLS</span>
                            </label>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <strong style="font-family: Arial, sans-serif; font-size: 14px;">Backup SMTP (163.com)</strong>
                        </div>
                        <div class="form-group">
                            <label for="smtp-backup-server">Server:</label>
                            <input type="text" id="smtp-backup-server" placeholder="smtp.163.com">
                        </div>
                        <div class="form-group">
                            <label for="smtp-backup-port">Port:</label>
                            <input type="number" id="smtp-backup-port" placeholder="465">
                        </div>
                        <div class="form-group">
                            <label for="smtp-backup-username">Username:</label>
                            <input type="text" id="smtp-backup-username" placeholder="your-email@163.com">
                        </div>
                        <div class="form-group">
                            <label for="smtp-backup-password">Authorization Code:</label>
                            <input type="password" id="smtp-backup-password" placeholder="Enter authorization code">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="smtp-backup-use-ssl" checked>
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="smtp-backup-use-tls">
                                <span>Use TLS</span>
                            </label>
                        </div>
                    </div>
                    <div class="profile-detail-actions">
                        <button class="form-button danger" onclick="deleteCurrentProfile()">Delete Profile</button>
                        <button class="form-button" onclick="saveCurrentProfile()" style="padding: 15px 30px; font-size: 16px;">Save Profile</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="email-modal" class="modal hidden" onclick="closeEmailModal()" role="dialog" aria-modal="true" aria-labelledby="email-modal-subject">
        <div class="modal-dialog" onclick="event.stopPropagation();">
            <div class="modal-header">
                <div>
                    <div class="modal-title" id="email-modal-subject">Email</div>
                    <div class="modal-meta" id="email-modal-meta"></div>
                </div>
                <button class="modal-close" onclick="closeEmailModal()">Close</button>
            </div>
            <div class="modal-body">
                <iframe id="email-modal-frame" class="modal-iframe" title="Email content"></iframe>
            </div>
        </div>
    </div>

    <script>
        const VERSION = '{{ version }}';
        document.getElementById('version').textContent = 'v' + VERSION;
        const emailModal = document.getElementById('email-modal');
        const emailModalSubject = document.getElementById('email-modal-subject');
        const emailModalMeta = document.getElementById('email-modal-meta');
        const emailModalFrame = document.getElementById('email-modal-frame');
        let currentEmails = [];

        // Initialize Profile 1 with default values from configuration
        function initializeProfile1() {
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            // Always set Profile 1 with the correct configuration values
            profiles.profile1 = {
                name: 'Profile 1',
                gmail: {
                    imap_server: 'imap.gmail.com',
                    port: 993,
                    username: 'eric.brilliant@gmail.com',
                    password: 'opqx pfna kagb bznr',
                    use_ssl: true,
                    use_tls: false
                },
                email163: {
                    imap_server: 'imap.163.com',
                    port: 993,
                    username: '19902475292@163.com',
                    password: 'JDy8MigeNmsESZRa',
                    use_ssl: true,
                    use_tls: false
                },
                qq: {
                    imap_server: 'imap.qq.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                },
                smtp: {
                    sender_name: 'Mail Task',
                    primary: {
                        server: 'smtp.gmail.com',
                        port: 587,
                        username: 'eric.brilliant@gmail.com',
                        password: 'opqx pfna kagb bznr',
                        use_ssl: false,
                        use_tls: true
                    },
                    backup: {
                        server: 'smtp.163.com',
                        port: 465,
                        username: '19902475292@163.com',
                        password: 'JDy8MigeNmsESZRa',
                        use_ssl: true,
                        use_tls: false
                    }
                }
            };
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
        }

        // Profile list/detail workflow (Level 1 -> Level 2)
        let currentProfileKey = localStorage.getItem('selectedProfile') || 'profile1';

        function renderProfileList() {
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            const listContainer = document.getElementById('profile-list');
            if (!listContainer) return;

            listContainer.innerHTML = '';
            const selected = localStorage.getItem('selectedProfile') || 'profile1';
            const keys = Object.keys(profiles);
            if (keys.length === 0) {
                const none = document.createElement('div');
                none.className = 'profile-item-name';
                none.textContent = 'No profiles.';
                listContainer.appendChild(none);
                return;
            }
            keys.forEach((key) => {
                const profile = profiles[key];
                const item = document.createElement('div');
                item.className = 'profile-item' + (selected === key ? ' active' : '');

                const name = document.createElement('div');
                name.className = 'profile-item-name';
                name.textContent = profile.name || key;

                const openBtn = document.createElement('button');
                openBtn.className = 'form-button';
                openBtn.textContent = 'Open';
                openBtn.onclick = () => openProfileDetail(key);

                item.appendChild(name);
                item.appendChild(openBtn);
                listContainer.appendChild(item);
            });
        }

        function showProfileList() {
            document.getElementById('profile-list-view').classList.remove('hidden');
            document.getElementById('profile-detail-view').classList.add('hidden');
            renderProfileList();
        }

        function openProfileDetail(profileKey) {
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            const profile = profiles[profileKey];
            if (!profile) return;
            currentProfileKey = profileKey;
            setCurrentProfile(profileKey);
            document.getElementById('profile-name-display').textContent = profile.name || profileKey;
            // Fill fields
            document.getElementById('gmail-imap-server').value = profile.gmail?.imap_server || '';
            document.getElementById('gmail-port').value = profile.gmail?.port || 993;
            document.getElementById('gmail-username').value = profile.gmail?.username || '';
            document.getElementById('gmail-password').value = profile.gmail?.password || '';
            document.getElementById('gmail-use-ssl').checked = profile.gmail?.use_ssl ?? true;
            document.getElementById('gmail-use-tls').checked = profile.gmail?.use_tls ?? false;

            document.getElementById('163-imap-server').value = profile.email163?.imap_server || '';
            document.getElementById('163-port').value = profile.email163?.port || 993;
            document.getElementById('163-username').value = profile.email163?.username || '';
            document.getElementById('163-password').value = profile.email163?.password || '';
            document.getElementById('163-use-ssl').checked = profile.email163?.use_ssl ?? true;
            document.getElementById('163-use-tls').checked = profile.email163?.use_tls ?? false;

            document.getElementById('qq-imap-server').value = profile.qq?.imap_server || '';
            document.getElementById('qq-port').value = profile.qq?.port || 993;
            document.getElementById('qq-username').value = profile.qq?.username || '';
            document.getElementById('qq-password').value = profile.qq?.password || '';
            document.getElementById('qq-use-ssl').checked = profile.qq?.use_ssl ?? true;
            document.getElementById('qq-use-tls').checked = profile.qq?.use_tls ?? false;

            const smtp = profile.smtp || {};
            const primarySmtp = smtp.primary || {};
            const backupSmtp = smtp.backup || {};

            document.getElementById('smtp-sender-name').value = smtp.sender_name || '';

            document.getElementById('smtp-primary-server').value = primarySmtp.server || '';
            document.getElementById('smtp-primary-port').value = primarySmtp.port || 587;
            document.getElementById('smtp-primary-username').value = primarySmtp.username || '';
            document.getElementById('smtp-primary-password').value = primarySmtp.password || '';
            document.getElementById('smtp-primary-use-ssl').checked = primarySmtp.use_ssl ?? false;
            document.getElementById('smtp-primary-use-tls').checked = primarySmtp.use_tls ?? true;

            document.getElementById('smtp-backup-server').value = backupSmtp.server || '';
            document.getElementById('smtp-backup-port').value = backupSmtp.port || 465;
            document.getElementById('smtp-backup-username').value = backupSmtp.username || '';
            document.getElementById('smtp-backup-password').value = backupSmtp.password || '';
            document.getElementById('smtp-backup-use-ssl').checked = backupSmtp.use_ssl ?? true;
            document.getElementById('smtp-backup-use-tls').checked = backupSmtp.use_tls ?? false;

            document.getElementById('profile-list-view').classList.add('hidden');
            document.getElementById('profile-detail-view').classList.remove('hidden');
        }

        // Save current profile
        function saveCurrentProfile() {
            const profileKey = currentProfileKey || (localStorage.getItem('selectedProfile') || 'profile1');
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            
            if (!profiles[profileKey]) {
                profiles[profileKey] = { name: profiles[profileKey]?.name || profileKey };
            }
            
            // Save Gmail settings
            profiles[profileKey].gmail = {
                imap_server: document.getElementById('gmail-imap-server').value.trim(),
                port: parseInt(document.getElementById('gmail-port').value) || 993,
                username: document.getElementById('gmail-username').value.trim(),
                password: document.getElementById('gmail-password').value.trim(),
                use_ssl: document.getElementById('gmail-use-ssl').checked,
                use_tls: document.getElementById('gmail-use-tls').checked
            };
            
            // Save 163.com settings
            profiles[profileKey].email163 = {
                imap_server: document.getElementById('163-imap-server').value.trim(),
                port: parseInt(document.getElementById('163-port').value) || 993,
                username: document.getElementById('163-username').value.trim(),
                password: document.getElementById('163-password').value.trim(),
                use_ssl: document.getElementById('163-use-ssl').checked,
                use_tls: document.getElementById('163-use-tls').checked
            };
            
            // Save QQ settings
            profiles[profileKey].qq = {
                imap_server: document.getElementById('qq-imap-server').value.trim(),
                port: parseInt(document.getElementById('qq-port').value) || 993,
                username: document.getElementById('qq-username').value.trim(),
                password: document.getElementById('qq-password').value.trim(),
                use_ssl: document.getElementById('qq-use-ssl').checked,
                use_tls: document.getElementById('qq-use-tls').checked
            };

            profiles[profileKey].smtp = {
                sender_name: document.getElementById('smtp-sender-name').value.trim(),
                primary: {
                    server: document.getElementById('smtp-primary-server').value.trim(),
                    port: parseInt(document.getElementById('smtp-primary-port').value) || 0,
                    username: document.getElementById('smtp-primary-username').value.trim(),
                    password: document.getElementById('smtp-primary-password').value.trim(),
                    use_ssl: document.getElementById('smtp-primary-use-ssl').checked,
                    use_tls: document.getElementById('smtp-primary-use-tls').checked
                },
                backup: {
                    server: document.getElementById('smtp-backup-server').value.trim(),
                    port: parseInt(document.getElementById('smtp-backup-port').value) || 0,
                    username: document.getElementById('smtp-backup-username').value.trim(),
                    password: document.getElementById('smtp-backup-password').value.trim(),
                    use_ssl: document.getElementById('smtp-backup-use-ssl').checked,
                    use_tls: document.getElementById('smtp-backup-use-tls').checked
                }
            };
            
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
            showError('Profile saved successfully', false);
            renderProfileList();
            updateComposeDefaults();
        }

        // Create new profile
        function createProfile() {
            const newName = document.getElementById('new-profile-name').value.trim();
            if (!newName) {
                showError('Please enter a profile name');
                return;
            }
            
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            const profileKey = 'profile' + Date.now();
            
            profiles[profileKey] = {
                name: newName,
                gmail: {
                    imap_server: 'imap.gmail.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                },
                email163: {
                    imap_server: 'imap.163.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                },
                qq: {
                    imap_server: 'imap.qq.com',
                    port: 993,
                    username: '',
                    password: '',
                    use_ssl: true,
                    use_tls: false
                },
                smtp: {
                    sender_name: '',
                    primary: {
                        server: 'smtp.gmail.com',
                        port: 587,
                        username: '',
                        password: '',
                        use_ssl: false,
                        use_tls: true
                    },
                    backup: {
                        server: 'smtp.163.com',
                        port: 465,
                        username: '',
                        password: '',
                        use_ssl: true,
                        use_tls: false
                    }
                }
            };
            
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
            document.getElementById('new-profile-name').value = '';
            currentProfileKey = profileKey;
            setCurrentProfile(profileKey);
            openProfileDetail(profileKey);
            renderProfileList();
            showError('Profile created successfully', false);
            updateComposeDefaults();
        }

        // Delete current profile
        function deleteCurrentProfile() {
            const profileKey = currentProfileKey || 'profile1';
            if (profileKey === 'profile1') {
                showError('Cannot delete Profile 1');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this profile?')) {
                return;
            }
            
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            delete profiles[profileKey];
            localStorage.setItem('emailProfiles', JSON.stringify(profiles));
            setCurrentProfile('profile1');
            currentProfileKey = 'profile1';
            showProfileList();
            showError('Profile deleted successfully', false);
        }

        // Load settings on page load
        window.onload = function() {
            initializeProfile1();
            if (!localStorage.getItem('selectedProfile')) {
                setCurrentProfile('profile1');
            }
            showProfileList();
            updateComposeDefaults();
            document.addEventListener('keydown', (evt) => {
                if (evt.key === 'Escape' && !emailModal.classList.contains('hidden')) {
                    closeEmailModal();
                }
            });
        };

        function showReceiveMail() {
            document.getElementById('receive-mail-content').classList.remove('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Receive Mail';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function showTask() {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('task-content').classList.remove('hidden');
            document.getElementById('settings-content').classList.add('hidden');
            document.getElementById('content-title').textContent = 'Task';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function showSettings() {
            document.getElementById('receive-mail-content').classList.add('hidden');
            document.getElementById('task-content').classList.add('hidden');
            document.getElementById('settings-content').classList.remove('hidden');
            document.getElementById('content-title').textContent = 'Settings';
            document.querySelectorAll('.menu-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            showProfileList();
        }


        function showError(message, isError = true, timeoutMs = 3000) {
            const errorDiv = document.getElementById('error-message');
            if (!errorDiv) return;
            errorDiv.textContent = message;
            errorDiv.className = `message ${isError ? 'error' : 'success'}`;
            errorDiv.classList.remove('hidden');
            if (timeoutMs > 0) {
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, timeoutMs);
            }
        }

        function getCurrentProfile() {
            // Get selected profile from localStorage or default to profile1
            const selectedProfile = localStorage.getItem('selectedProfile') || 'profile1';
            const profiles = JSON.parse(localStorage.getItem('emailProfiles') || '{}');
            return profiles[selectedProfile] || profiles.profile1 || {};
        }

        function setCurrentProfile(profileKey) {
            localStorage.setItem('selectedProfile', profileKey);
            updateComposeDefaults();
        }

        function updateComposeDefaults() {
            const profile = getCurrentProfile();
            const senderInput = document.getElementById('compose-sender-name');
            if (!senderInput) return;
            const defaultName = profile.smtp?.sender_name || profile.name || 'Mail Task';
            senderInput.placeholder = defaultName;
            if (!senderInput.value.trim()) {
                senderInput.value = defaultName;
            }
        }

        function fetchGmailEmails() {
            const emailList = document.getElementById('email-list');
            emailList.innerHTML = '<div class="loading">Loading Gmail emails...</div>';
            
            const profile = getCurrentProfile();
            const gmail = profile.gmail || {};
            const requestData = {
                limit: 50,
                imap_server: gmail.imap_server || 'imap.gmail.com',
                port: gmail.port || 993,
                username: gmail.username || '',
                password: gmail.password || '',
                use_ssl: gmail.use_ssl !== undefined ? gmail.use_ssl : true,
                use_tls: gmail.use_tls || false
            };
            
            fetch('/api/fetch-gmail', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        emailList.innerHTML = `<div class="message error">Error: ${escapeHtml(data.error)}</div>`;
                    } else {
                        displayEmails(data.emails || []);
                    }
                })
                .catch(error => {
                    emailList.innerHTML = `<div class="message error">Error fetching emails: ${escapeHtml(error.message)}</div>`;
                });
        }

        function fetchQQEmails() {
            const profile = getCurrentProfile();
            const qq = profile.qq || {};
            
            if (!qq.username || !qq.password) {
                showError('Please save QQ settings first in Settings page');
                return;
            }

            const emailList = document.getElementById('email-list');
            emailList.innerHTML = '<div class="loading">Loading QQ emails...</div>';
            
            fetch('/api/fetch-qq', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    imap_server: qq.imap_server || 'imap.qq.com',
                    port: qq.port || 993,
                    username: qq.username,
                    password: qq.password,
                    use_ssl: qq.use_ssl !== undefined ? qq.use_ssl : true,
                    use_tls: qq.use_tls || false,
                    limit: 50
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        emailList.innerHTML = `<div class="message error">Error: ${escapeHtml(data.error)}</div>`;
                    } else {
                        displayEmails(data.emails || []);
                    }
                })
                .catch(error => {
                    emailList.innerHTML = `<div class="message error">Error fetching emails: ${escapeHtml(error.message)}</div>`;
                });
        }

        function fetch163Emails() {
            const emailList = document.getElementById('email-list');
            emailList.innerHTML = '<div class="loading">Loading 163.com emails...</div>';
            
            const profile = getCurrentProfile();
            const email163 = profile.email163 || {};
            const requestData = {
                limit: 50,
                imap_server: email163.imap_server || 'imap.163.com',
                port: email163.port || 993,
                username: email163.username || '',
                password: email163.password || '',
                use_ssl: email163.use_ssl !== undefined ? email163.use_ssl : true,
                use_tls: email163.use_tls || false
            };
            
            fetch('/api/fetch-163', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        emailList.innerHTML = `<div class="message error">Error: ${escapeHtml(data.error)}</div>`;
                    } else {
                        displayEmails(data.emails || []);
                    }
                })
                .catch(error => {
                    emailList.innerHTML = `<div class="message error">Error fetching emails: ${escapeHtml(error.message)}</div>`;
                });
        }

        function parseEmailList(value) {
            if (!value) {
                return [];
            }
            return value
                .split(/[;,]+/)
                .map(addr => addr.trim())
                .filter(addr => addr.length > 0);
        }

        function showSendStatus(message, state = 'info', timeoutMs = 4000) {
            const statusDiv = document.getElementById('send-email-status');
            if (!statusDiv) return;
            statusDiv.textContent = message;
            statusDiv.className = `message ${state}`;
            statusDiv.classList.remove('hidden');
            if (timeoutMs > 0) {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, timeoutMs);
            }
        }

        function sendEmail() {
            const recipientsValue = document.getElementById('compose-to').value;
            const subjectValue = document.getElementById('compose-subject').value;
            const bodyValue = document.getElementById('compose-body').value;
            const senderNameInput = document.getElementById('compose-sender-name').value.trim();
            const sendAsHtml = document.getElementById('compose-is-html').checked;
            const usePrimary = document.getElementById('use-primary-smtp').checked;
            const useBackup = document.getElementById('use-backup-smtp').checked;

            const recipients = parseEmailList(recipientsValue);
            if (recipients.length === 0) {
                showSendStatus('Please enter at least one recipient email address.', 'error');
                return;
            }

            if (!bodyValue.trim()) {
                showSendStatus('Email body cannot be empty.', 'error');
                return;
            }

            const profile = getCurrentProfile();
            const smtpConfig = profile.smtp || {};
            const configs = [];

            const primary = smtpConfig.primary || {};
            if (usePrimary && primary.server && primary.username && primary.password) {
                configs.push({
                    name: 'Primary SMTP',
                    server: primary.server,
                    port: primary.port,
                    username: primary.username,
                    password: primary.password,
                    use_ssl: !!primary.use_ssl,
                    use_tls: !!primary.use_tls,
                    sender_name: smtpConfig.sender_name,
                    from_address: primary.username
                });
            }

            const backup = smtpConfig.backup || {};
            if (useBackup && backup.server && backup.username && backup.password) {
                configs.push({
                    name: 'Backup SMTP',
                    server: backup.server,
                    port: backup.port,
                    username: backup.username,
                    password: backup.password,
                    use_ssl: !!backup.use_ssl,
                    use_tls: !!backup.use_tls,
                    sender_name: smtpConfig.sender_name,
                    from_address: backup.username
                });
            }

            const payload = {
                to: recipients,
                subject: subjectValue,
                body: bodyValue,
                is_html: sendAsHtml,
                sender_name: senderNameInput || smtpConfig.sender_name || profile.name || 'Mail Task'
            };

            if (configs.length > 0) {
                payload.configs = configs;
            }

            showSendStatus('Sending email...', 'info', 0);

            fetch('/api/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
                .then(async response => {
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to send email');
                    }
                    document.getElementById('compose-body').value = '';
                    showSendStatus(`Email sent via ${data.provider || 'SMTP provider'}.`, 'success');
                })
                .catch(error => {
                    showSendStatus(`Send failed: ${error.message}`, 'error');
                });
        }

        function displayEmails(emails) {
            const emailList = document.getElementById('email-list');
            currentEmails = Array.isArray(emails) ? emails : [];

            if (currentEmails.length === 0) {
                emailList.innerHTML = '<div class="loading">No emails found for today</div>';
                return;
            }

            emailList.innerHTML = currentEmails.map((email, index) => `
                <div class="email-item" data-index="${index}">
                    <div class="email-header">
                        <div class="email-subject">${escapeHtml(email.subject || 'No Subject')}</div>
                        <div class="email-date">${escapeHtml(email.date || '')}</div>
                    </div>
                    <div class="email-from">From: ${escapeHtml(email.from || '')}</div>
                    <div class="email-preview">${escapeHtml(email.preview || '')}</div>
                </div>
            `).join('');

            document.querySelectorAll('.email-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.getAttribute('data-index'), 10);
                    openEmailModal(index);
                });
            });
        }

        function openEmailModal(index) {
            if (Number.isNaN(index)) {
                return;
            }
            const email = currentEmails[index];
            if (!email) {
                return;
            }

            emailModalSubject.textContent = email.subject || 'No Subject';
            const metaLines = [
                `From: ${email.from || 'Unknown sender'}`,
                `Date: ${email.date || 'Unknown date'}`
            ];
            emailModalMeta.textContent = metaLines.join('\n');

            if (email.html_body) {
                emailModalFrame.srcdoc = email.html_body;
            } else {
                const plain = email.plain_body || '';
                emailModalFrame.srcdoc = `<pre style="font-family: Arial, sans-serif; white-space: pre-wrap;">${escapeHtml(plain)}</pre>`;
            }

            emailModal.classList.remove('hidden');
        }

        function closeEmailModal() {
            emailModal.classList.add('hidden');
            emailModalFrame.srcdoc = '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

